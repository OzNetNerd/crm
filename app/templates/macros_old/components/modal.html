{#
    Unified Modal Component Macro
    Single source of truth for all modal implementations
    Uses component classes instead of inline Tailwind
#}

{% from 'macros/base/icons.html' import icon %}

{#
    Main modal macro

    Parameters:
    - id: Unique modal identifier
    - title: Modal title
    - size: 'sm', 'md' (default), 'lg', 'xl', 'full'
    - closable: Allow closing the modal
    - close_on_backdrop: Close when clicking backdrop
    - close_on_escape: Close when pressing ESC
    - footer: Include footer (default true)
    - save_text: Text for save button
    - cancel_text: Text for cancel button
    - class: Additional CSS classes
#}
{% macro modal(
    id='modal',
    title='',
    size='md',
    closable=true,
    close_on_backdrop=true,
    close_on_escape=true,
    footer=true,
    save_text='Save',
    cancel_text='Cancel',
    class=''
) %}

{% set config = {
    'id': id,
    'title': title,
    'size': size,
    'closable': closable,
    'closeOnBackdrop': close_on_backdrop,
    'closeOnEscape': close_on_escape
} %}

<div class="modal {{ class }}"
     x-data="modal({{ config|tojson }})"
     x-show="isOpen"
     x-cloak
     data-modal-id="{{ id }}"
     @keydown.escape.window="close()">

    {# Backdrop #}
    <div class="modal-backdrop"
         x-show="isOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="handleBackdropClick($event)">
    </div>

    {# Content #}
    <div class="modal-content modal-content-{{ size }}"
         x-show="isOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">

        {# Header #}
        {% if title %}
        <div class="modal-header">
            <h3 class="modal-title">{{ title }}</h3>
            {% if closable %}
            <button type="button" @click="close()" class="modal-close">
                {{ icon('x-mark', 'md') }}
            </button>
            {% endif %}
        </div>
        {% endif %}

        {# Body #}
        <div class="modal-body">
            {{ caller() if caller else '' }}
        </div>

        {# Footer #}
        {% if footer %}
        <div class="modal-footer">
            <button type="button" @click="close()" class="modal-btn modal-btn-secondary">
                {{ cancel_text }}
            </button>
            <button type="button" @click="save()" class="modal-btn modal-btn-primary"
                    :disabled="saving">
                <span x-show="!saving">{{ save_text }}</span>
                <span x-show="saving" class="flex items-center">
                    <svg class="modal-spinner mr-2" style="width: 1rem; height: 1rem;" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    </svg>
                    Saving...
                </span>
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
    Modal header component
#}
{% macro modal_header(title='', closable=true) %}
<div class="modal-header">
    <h3 class="modal-title">{{ title }}</h3>
    {% if closable %}
    <button type="button" @click="close()" class="modal-close">
        {{ icon('x-mark', 'md') }}
    </button>
    {% endif %}
</div>
{% endmacro %}

{#
    Modal body component
#}
{% macro modal_body(class='') %}
<div class="modal-body {{ class }}">
    {{ caller() }}
</div>
{% endmacro %}

{#
    Modal footer component
#}
{% macro modal_footer(
    save_text='Save',
    cancel_text='Cancel',
    show_save=true,
    show_cancel=true,
    align='end',
    class=''
) %}
<div class="modal-footer modal-footer-{{ align }} {{ class }}">
    {% if show_cancel %}
    <button type="button" @click="close()" class="modal-btn modal-btn-secondary">
        {{ cancel_text }}
    </button>
    {% endif %}
    {% if show_save %}
    <button type="button" @click="save()" class="modal-btn modal-btn-primary"
            :disabled="saving">
        <span x-show="!saving">{{ save_text }}</span>
        <span x-show="saving" class="flex items-center">
            <svg class="modal-spinner mr-2" style="width: 1rem; height: 1rem;" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            </svg>
            Saving...
        </span>
    </button>
    {% endif %}
    {{ caller() if caller else '' }}
</div>
{% endmacro %}

{#
    Confirmation modal
#}
{% macro confirm_modal(
    id='confirm-modal',
    title='Confirm Action',
    message='Are you sure you want to proceed?',
    confirm_text='Confirm',
    cancel_text='Cancel',
    danger=false
) %}
{% call modal(id=id, title=title, size='sm') %}
    <p class="text-gray-700">{{ message }}</p>
{% endcall %}
{% endmacro %}

{#
    Form modal
#}
{% macro form_modal(
    id='form-modal',
    title='Form',
    form_id='modal-form',
    size='md',
    save_text='Save'
) %}
<div class="modal"
     x-data="modal({
         id: '{{ id }}',
         title: '{{ title }}',
         size: '{{ size }}',
         onSave: async function() {
             if (!this.validateForm()) return false;
             const data = this.getFormData();
             // Handle form submission
             return true;
         }
     })"
     x-show="isOpen"
     x-cloak
     data-modal-id="{{ id }}">

    <div class="modal-backdrop" @click="handleBackdropClick($event)"></div>

    <div class="modal-content modal-content-{{ size }}">
        {{ modal_header(title) }}

        <div class="modal-body">
            <form id="{{ form_id }}" class="modal-form" @submit.prevent="save()">
                {{ caller() }}
            </form>
        </div>

        {{ modal_footer(save_text=save_text) }}
    </div>
</div>
{% endmacro %}
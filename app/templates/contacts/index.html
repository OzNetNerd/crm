{% extends "base/layout.html" %}
{% from "components/contact_card.html" import render_contact %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import building_office_icon, user_icon, chevron_right_icon, check_circle_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, phone_icon, envelope_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, entity_section_group, bulk_selection_checkbox, view_mode_toggle %}

{% block title %}Contacts - CRM{% endblock %}

{% block content %}
{% set contact_stats = {
    'title': 'Contact Overview',
    'stats': [
        {
            'value': contacts|length,
            'label': 'Total Contacts',
            'color_class': 'text-blue-600'
        },
        {
            'value': contacts|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-green-600'
        },
        {
            'value': contacts|selectattr('phone')|list|length,
            'label': 'With Phone',
            'color_class': 'text-purple-600'
        },
        {
            'value': contacts|map(attribute='opportunities')|map('length')|sum,
            'label': 'Total Opportunities',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set contact_buttons = [
    {
        'label': 'New Contact',
        'onclick': 'openNewContactModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Contacts", "Manage your contact relationships", buttons=contact_buttons, summary_data=contact_stats) %}

<div x-data="contactManager()" class="space-y-6">

    <!-- Bulk Actions Bar -->
    <div x-show="selectedItems.length > 0" 
         x-cloak 
         x-transition
         class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <span class="text-blue-800 font-medium" x-text="`${selectedItems.length} contacts selected`"></span>
            <button @click="bulkDelete()" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm hover:bg-red-700">
                Delete Selected
            </button>
            <button @click="bulkCreateTasks()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">
                Create Tasks
            </button>
        </div>
        <button @click="selectedItems = []" class="text-blue-600 hover:text-blue-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Enhanced Filters and Controls -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="flex items-center text-label-dark">Group by:</label>
                {{ dropdown_select('groupBy', [
                    {'value': 'company', 'label': 'Company'},
                    {'value': 'industry', 'label': 'Industry'},
                    {'value': 'role', 'label': 'Role'},
                    {'value': 'contact_info', 'label': 'Contact Info'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" x-model="showIncomplete" class="mr-2">
                    <span class="text-secondary-dark">Show Incomplete Info</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                {{ view_mode_toggle() }}
                
                {{ dropdown_multiselect('industryFilter', [
                    {'value': 'technology', 'label': 'Technology'},
                    {'value': 'finance', 'label': 'Finance'},
                    {'value': 'healthcare', 'label': 'Healthcare'},
                    {'value': 'manufacturing', 'label': 'Manufacturing'}
                ], 'All Industries') }}
                
                {{ dropdown_multiselect('roleFilter', [
                    {'value': 'ceo', 'label': 'CEO'},
                    {'value': 'manager', 'label': 'Manager'},
                    {'value': 'director', 'label': 'Director'},
                    {'value': 'developer', 'label': 'Developer'}
                ], 'All Roles') }}
            </div>
        </div>
    </div>

    <!-- Contacts by Company -->
    <div x-show="groupBy === 'company'" class="space-y-4">
        {% set companies = contacts | groupby('company.name') %}
        {% for company_name, company_contacts in companies %}
            {% call entity_section_group(
                company_name|replace("'", "\\'")|replace('"', '\\"'),
                company_name,
                building_office_icon("w-5 h-5 mr-1"),
                company_contacts|list,
                colors={'badge_color': 'blue', 'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-header'}
            ) %}
                {% for contact in company_contacts %}
                    {{ render_contact(contact) }}
                {% endfor %}
            {% endcall %}
        {% endfor %}
    </div>

    <!-- Contacts by Industry -->
    <div x-show="groupBy === 'industry'" class="space-y-4">
        {% set industries = contacts | groupby('company.industry') %}
        {% for industry, industry_contacts in industries %}
            {% call entity_section_group(
                industry or 'Unknown Industry',
                industry or 'Unknown Industry',
                building_office_icon("w-5 h-5 mr-1"),
                industry_contacts|list,
                colors={'badge_color': 'green', 'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-header'}
            ) %}
                {% for contact in industry_contacts %}
                    {{ render_contact(contact) }}
                {% endfor %}
            {% endcall %}
        {% endfor %}
    </div>

    <!-- Contacts by Role -->
    <div x-show="groupBy === 'role'" class="space-y-4">
        {% set roles = contacts | groupby('role') %}
        {% for role, role_contacts in roles %}
            {% call entity_section_group(
                role or 'No Role Specified',
                role or 'No Role Specified',
                user_icon("w-5 h-5 mr-1"),
                role_contacts|list,
                colors={'badge_color': 'yellow', 'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-header'}
            ) %}
                {% for contact in role_contacts %}
                    {{ render_contact(contact) }}
                {% endfor %}
            {% endcall %}
        {% endfor %}
    </div>

    <!-- Contacts by Contact Info -->
    <div x-show="groupBy === 'contact_info'" class="space-y-4">
        <!-- Complete Contact Info -->
        {% set complete_contacts = contacts|selectattr('email')|selectattr('phone')|list %}
        {% call entity_section_group(
            'complete_info',
            'Complete Info (Email + Phone)',
            check_circle_icon_solid("w-5 h-5 mr-1"),
            complete_contacts,
            card_class='card-success',
            colors={'badge_color': 'green', 'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-success'}
        ) %}
            {% for contact in complete_contacts %}
                {{ render_contact(contact) }}
            {% endfor %}
        {% endcall %}

        <!-- Email Only -->
        {% set email_only_contacts = contacts|selectattr('email')|rejectattr('phone')|list %}
        {% call entity_section_group(
            'with_email',
            'Email Only',
            envelope_icon("w-5 h-5 mr-1"),
            email_only_contacts,
            card_class='card-info',
            colors={'badge_color': 'blue', 'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-info'}
        ) %}
            {% for contact in email_only_contacts %}
                {{ render_contact(contact) }}
            {% endfor %}
        {% endcall %}

        <!-- Phone Only -->
        {% set phone_only_contacts = contacts|selectattr('phone')|rejectattr('email')|list %}
        {% call entity_section_group(
            'with_phone',
            'Phone Only',
            phone_icon("w-5 h-5 mr-1"),
            phone_only_contacts,
            card_class='card-warning',
            colors={'badge_color': 'yellow', 'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-warning'}
        ) %}
            {% for contact in phone_only_contacts %}
                {{ render_contact(contact) }}
            {% endfor %}
        {% endcall %}

        <!-- Missing Contact Info -->
        {% set missing_info_contacts = contacts|rejectattr('email')|rejectattr('phone')|list %}
        {% call entity_section_group(
            'missing_info',
            'Missing Contact Info',
            exclamation_circle_icon_solid("w-5 h-5 mr-1"),
            missing_info_contacts,
            card_class='card-danger',
            colors={'badge_color': 'red', 'border_color': 'red', 'bg_color': 'red', 'hover_color': 'red', 'text_class': 'text-status-overdue'},
            x_show_condition='!showIncomplete || missing_info_contacts|length > 0'
        ) %}
            {% for contact in missing_info_contacts %}
                {{ render_contact(contact) }}
            {% endfor %}
        {% endcall %}
    </div>

    <!-- Fallback for no contacts -->
    {% if not contacts %}
        <div class="card p-8 text-center">
            <p class="text-gray-500 mb-4">No contacts found</p>
            <button onclick="openNewContactModal()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Add Your First Contact
            </button>
        </div>
    {% endif %}

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script>
// Make contacts data available globally
window.contactsData = {{ contacts | tojson }};

// Contact manager Alpine.js component
function contactManager() {
    return {
        // Data management
        allItems: window.contactsData || [],
        selectedItems: [],
        allItemIds: [],
        
        // View and filter states
        viewMode: 'list',
        groupBy: 'company',
        showIncomplete: false,
        industryFilter: [],
        roleFilter: [],
        
        // Existing section states
        expandedSections: {
            {% for contact in contacts %}
                '{{ contact.company.name|replace("'", "\\'")|replace('"', '\\"') }}': true,
            {% endfor %}
            'with_email': true,
            'with_phone': true,
            'complete_info': true,
            'missing_info': true
        },
        
        init() {
            // Initialize all contact IDs for bulk selection
            this.allItemIds = this.allItems.map(item => item.id);
        },

        // Bulk action methods
        bulkDelete() {
            if (this.selectedItems.length === 0) return;
            
            const confirmed = confirm(`Are you sure you want to delete ${this.selectedItems.length} contacts?`);
            if (confirmed) {
                console.log('Bulk deleting contacts:', this.selectedItems);
                // Here you would make API calls to delete the contacts
                this.selectedItems = [];
            }
        },

        bulkCreateTasks() {
            if (this.selectedItems.length === 0) return;
            
            console.log('Creating tasks for contacts:', this.selectedItems);
            // Here you would open a modal to create tasks for selected contacts
        },

        // Existing group expansion methods
        expandAllItemsInGroup(groupName) {
            this.$dispatch('expand-all-contacts', { group: groupName });
        },
        
        collapseAllItemsInGroup(groupName) {
            this.$dispatch('collapse-all-contacts', { group: groupName });
        }
    };
}

// Contact-specific functions that extend the centralized modal system
function createTaskForContact(contactId) {
    createTask('contact', contactId);
}

function createOpportunityForContact(contactId) {
    createOpportunity('contact', contactId);
}
</script>

{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}
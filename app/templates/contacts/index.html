{% extends "base/layout.html" %}
{% from "components/contact_card.html" import render_contact %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import building_office_icon, user_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect %}

{% block title %}Contacts - CRM{% endblock %}

{% block content %}
{% set contact_stats = {
    'title': 'Contact Overview',
    'stats': [
        {
            'value': contacts|length,
            'label': 'Total Contacts',
            'color_class': 'text-blue-600'
        },
        {
            'value': contacts|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-green-600'
        },
        {
            'value': contacts|selectattr('phone')|list|length,
            'label': 'With Phone',
            'color_class': 'text-purple-600'
        },
        {
            'value': contacts|map(attribute='opportunities')|map('length')|sum,
            'label': 'Total Opportunities',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set contact_buttons = [
    {
        'label': 'New Contact',
        'onclick': 'openNewContactModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Contacts", "Manage your contact relationships", buttons=contact_buttons, summary_data=contact_stats) %}

<div x-data="{ 
    groupBy: 'company',
    expandedSections: {
        {% for contact in contacts %}
            '{{ contact.company.name|replace("'", "\\'")|replace('"', '\\"') }}': true,
        {% endfor %}
        'with_email': true,
        'with_phone': true,
        'complete_info': true,
        'missing_info': true
    }
}" class="space-y-6">

    <!-- Enhanced Filters and Controls -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-label-dark">Group by:</label>
                {{ dropdown_select('groupBy', [
                    {'value': 'company', 'label': 'Company'},
                    {'value': 'industry', 'label': 'Industry'},
                    {'value': 'role', 'label': 'Role'},
                    {'value': 'contact_info', 'label': 'Contact Info'}
                ]) }}
                
                {{ expand_collapse_controls('expandedSections') }}
            </div>
        </div>
    </div>

    <!-- Contacts by Company -->
    <div x-show="groupBy === 'company'" class="space-y-4">
        {% set companies = contacts | groupby('company.name') %}
        {% for company_name, company_contacts in companies %}
            <div class="card">
                <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                     @click="expandedSections['{{ company_name|replace("'", "\\'")|replace('"', '\\"') }}'] = !expandedSections['{{ company_name|replace("'", "\\'")|replace('"', '\\"') }}']">                    <h3 class="text-status-header">
                        <span class="mr-2 transition-transform duration-200" :class="expandedSections['{{ company_name|replace("'", "\\'")|replace('"', '\\"') }}'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ building_office_icon("w-5 h-5 mr-1") }} {{ company_name }}<span class="ml-2 badge-standard badge-blue">{{ company_contacts|list|length }}</span>
                    </h3>
                </div>
                <div class="divide-y divide-gray-200" x-show="expandedSections['{{ company_name|replace("'", "\\'")|replace('"', '\\"') }}']" x-transition>
                    {% for contact in company_contacts %}
                        {{ render_contact(contact) }}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Contacts by Industry -->
    <div x-show="groupBy === 'industry'" class="space-y-4">
        {% set industries = contacts | groupby('company.industry') %}
        {% for industry, industry_contacts in industries %}
            <div class="card">
                <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                     @click="expandedSections['{{ industry or 'Unknown Industry' }}'] = !expandedSections['{{ industry or 'Unknown Industry' }}']">                    <h3 class="text-status-header">
                        <span class="mr-2 transition-transform duration-200" :class="expandedSections['{{ industry or 'Unknown Industry' }}'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ building_office_icon("w-5 h-5 mr-1") }} {{ industry or 'Unknown Industry' }}<span class="ml-2 badge-standard badge-green">{{ industry_contacts|list|length }}</span>
                    </h3>
                </div>
                <div class="divide-y divide-gray-200" x-show="expandedSections['{{ industry or 'Unknown Industry' }}']" x-transition>
                    {% for contact in industry_contacts %}
                        {{ render_contact(contact) }}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Contacts by Role -->
    <div x-show="groupBy === 'role'" class="space-y-4">
        {% set roles = contacts | groupby('role') %}
        {% for role, role_contacts in roles %}
            <div class="card">
                <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                     @click="expandedSections['{{ role or 'No Role Specified' }}'] = !expandedSections['{{ role or 'No Role Specified' }}']">                    <h3 class="text-status-header">
                        <span class="mr-2 transition-transform duration-200" :class="expandedSections['{{ role or 'No Role Specified' }}'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} {{ role or 'No Role Specified' }}<span class="ml-2 badge-standard badge-yellow">{{ role_contacts|list|length }}</span>
                    </h3>
                </div>
                <div class="divide-y divide-gray-200" x-show="expandedSections['{{ role or 'No Role Specified' }}']" x-transition>
                    {% for contact in role_contacts %}
                        {{ render_contact(contact) }}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Contacts by Contact Info -->
    <div x-show="groupBy === 'contact_info'" class="space-y-4">
        <!-- Complete Contact Info -->
        <div class="card-success">
            <div class="border-b border-green-200 px-6 py-4 bg-green-50 cursor-pointer hover:bg-green-100" 
                 @click="expandedSections['complete_info'] = !expandedSections['complete_info']">
                <h3 class="text-status-success">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['complete_info'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} Complete Info (Email + Phone)<span class="ml-2 badge-standard badge-green">{{ contacts|selectattr('email')|selectattr('phone')|list|length }}</span>
                </h3>
            </div>
            <div class="divide-y divide-gray-200" x-show="expandedSections['complete_info']" x-transition>
                {% for contact in contacts %}
                    {% if contact.email and contact.phone %}
                        {{ render_contact(contact) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Email Only -->
        <div class="card-info">
            <div class="border-b border-blue-200 px-6 py-4 bg-blue-50 cursor-pointer hover:bg-blue-100" 
                 @click="expandedSections['with_email'] = !expandedSections['with_email']">
                <h3 class="text-status-info">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['with_email'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} Email Only<span class="ml-2 badge-standard badge-blue">{{ contacts|selectattr('email')|rejectattr('phone')|list|length }}</span>
                </h3>
            </div>
            <div class="divide-y divide-gray-200" x-show="expandedSections['with_email']" x-transition>
                {% for contact in contacts %}
                    {% if contact.email and not contact.phone %}
                        {{ render_contact(contact) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Phone Only -->
        <div class="card-warning">
            <div class="border-b border-yellow-200 px-6 py-4 bg-yellow-50 cursor-pointer hover:bg-yellow-100" 
                 @click="expandedSections['with_phone'] = !expandedSections['with_phone']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['with_phone'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} Phone Only<span class="ml-2 badge-standard badge-yellow">{{ contacts|selectattr('phone')|rejectattr('email')|list|length }}</span>
                </h3>
            </div>
            <div class="divide-y divide-gray-200" x-show="expandedSections['with_phone']" x-transition>
                {% for contact in contacts %}
                    {% if contact.phone and not contact.email %}
                        {{ render_contact(contact) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Missing Contact Info -->
        <div class="card-danger">
            <div class="border-b border-red-200 px-6 py-4 bg-red-50 cursor-pointer hover:bg-red-100" 
                 @click="expandedSections['missing_info'] = !expandedSections['missing_info']">
                <h3 class="text-status-overdue">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['missing_info'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} Missing Contact Info<span class="ml-2 badge-standard badge-red">{{ contacts|rejectattr('email')|rejectattr('phone')|list|length }}</span>
                </h3>
            </div>
            <div class="divide-y divide-gray-200" x-show="expandedSections['missing_info']" x-transition>
                {% for contact in contacts %}
                    {% if not contact.email and not contact.phone %}
                        {{ render_contact(contact) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Fallback for no contacts -->
    {% if not contacts %}
        <div class="card p-8 text-center">
            <p class="text-gray-500 mb-4">No contacts found</p>
            <button onclick="openNewContactModal()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Add Your First Contact
            </button>
        </div>
    {% endif %}

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script>
function openNewContactModal() {
    // TODO: Implement new contact modal
    console.log('Opening new contact modal');
}

function openContactModal(contactId) {
    openContactDetailModal(contactId);
}
</script>

{% include "components/modals.html" %}
{% endblock %}
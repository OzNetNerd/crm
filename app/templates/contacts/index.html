{% extends "base/layout.html" %}
{% from "components/contact_card.html" import render_contact %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import building_office_icon, user_icon, chevron_right_icon, check_circle_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, phone_icon, envelope_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_actions_bar %}

{% block title %}Contacts - CRM{% endblock %}

{% block content %}
{% set contact_stats = {
    'title': 'Contact Overview',
    'stats': [
        {
            'value': contacts|length,
            'label': 'Total Contacts',
            'color_class': 'text-blue-600'
        },
        {
            'value': contacts|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-green-600'
        },
        {
            'value': contacts|selectattr('phone')|list|length,
            'label': 'With Phone',
            'color_class': 'text-purple-600'
        },
        {
            'value': contacts|map(attribute='opportunities')|map('length')|sum,
            'label': 'Total Opportunities',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set contact_buttons = [
    {
        'label': 'New Contact',
        'onclick': 'openNewContactModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Contacts", "Manage your contact relationships", buttons=contact_buttons, summary_data=contact_stats) %}

<div x-data="createEntityManager(getContactConfig('{{ today }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar('contact', 'contacts', 
         {'label': 'Create Tasks', 'onclick': 'bulkCreateTasks(selectedItems)', 'color': 'green'},
         {'label': 'Delete Selected', 'onclick': 'bulkDelete(selectedItems)', 'color': 'red'}) }}

    <!-- Enhanced Filters and Controls with Generic DRY Components -->
    <div class="card-padded-lg filter-section-enhanced">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0 lg:gap-6">
            <div class="flex flex-wrap items-center gap-6">
                <label class="text-label-dark">Group by:</label>
                
                {{ generic_group_dropdown('groupBy', [
                    {'value': 'company', 'label': 'Company'},
                    {'value': 'industry', 'label': 'Industry'},
                    {'value': 'role', 'label': 'Role'},
                    {'value': 'contact_info', 'label': 'Contact Info'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           x-model="showCompleted"
                           @change="updateFilters()"
                           name="show_incomplete"
                           value="true"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Incomplete Info</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center gap-6">
                <label class="text-label-dark">Sort by:</label>
                
                {{ generic_sort_dropdown('sortBy', 'sortDirection', [
                    {'value': 'name', 'label': 'Name'},
                    {'value': 'company', 'label': 'Company'},
                    {'value': 'email', 'label': 'Email'},
                    {'value': 'phone', 'label': 'Phone'},
                    {'value': 'role', 'label': 'Role'}
                ]) }}
                
                {{ generic_filter_multiselect('primaryFilter', [
                    {'value': 'complete', 'label': 'Complete Info'},
                    {'value': 'email_only', 'label': 'Email Only'},
                    {'value': 'phone_only', 'label': 'Phone Only'},
                    {'value': 'missing', 'label': 'Missing Info'}
                ], 'All Contact Info', 'togglePrimaryFilter', 'getPrimaryFilterDisplayText') }}
                
                {{ generic_filter_multiselect('secondaryFilter', [
                    {'value': 'technology', 'label': 'Technology'},
                    {'value': 'finance', 'label': 'Finance'},
                    {'value': 'healthcare', 'label': 'Healthcare'},
                    {'value': 'manufacturing', 'label': 'Manufacturing'}
                ], 'All Industries', 'toggleSecondaryFilter', 'getSecondaryFilterDisplayText') }}
                
                {{ generic_filter_multiselect('entityFilter', [
                    {'value': 'ceo', 'label': 'CEO'},
                    {'value': 'manager', 'label': 'Manager'},
                    {'value': 'director', 'label': 'Director'},
                    {'value': 'developer', 'label': 'Developer'}
                ], 'All Roles', 'toggleEntityFilter', 'getEntityFilterDisplayText') }}
            </div>
        </div>
    </div>

    <!-- Dynamic Client-Side Contact Grouping -->
    <div id="contacts-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Default view when no contacts -->
    {% if not contacts %}
        <div class="card p-12 text-center">
            <p class="text-gray-500 mb-4">No contacts found</p>
            <button onclick="openNewContactModal()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Add Your First Contact
            </button>
        </div>
    {% endif %}

    <!-- Hidden pre-rendered contact cards for client-side use -->
    <div style="display: none;" id="contact-cards-cache">
        {% for contact in contacts %}
            <div id="contact-card-{{ contact.id }}">
                {{ render_contact(contact) }}
            </div>
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-configs.js') }}"></script>
<script>
// Make entity data available globally for the entity manager
window.companiesData = {{ companies | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
window.contactsData = {{ contacts_data | tojson }};

// Contact-specific bulk action functions
window.bulkDelete = function(selectedIds) {
    if (selectedIds.length === 0) return;
    
    if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected contacts?`)) {
        return;
    }
    
    // Delete each selected contact
    selectedIds.forEach(async (contactId) => {
        try {
            const response = await fetch(`/api/contacts/${contactId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Remove contact from local data
                window.contactsData = window.contactsData.filter(c => c.id.toString() !== contactId.toString());
            }
        } catch (error) {
            console.error('Error deleting contact:', error);
        }
    });
    
    // Refresh the page to show changes
    setTimeout(() => location.reload(), 1000);
};

window.bulkCreateTasks = function(selectedIds) {
    if (selectedIds.length === 0) return;
    
    console.log('Creating tasks for contacts:', selectedIds);
    // Here you would open a modal to create tasks for selected contacts
    // For now, just redirect to task creation page
    window.location.href = `/tasks/multi_new?contact_ids=${selectedIds.join(',')}`;
};

// Contact-specific functions that extend the centralized modal system
function createTaskForContact(contactId) {
    createTask('contact', contactId);
}

function createOpportunityForContact(contactId) {
    createOpportunity('contact', contactId);
}

// Contacts use the centralized entity manager system
// All modal functions including deleteContact are now handled globally
</script>

{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}
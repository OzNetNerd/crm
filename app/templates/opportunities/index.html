{% extends "base/layout.html" %}
{% from "components/opportunity_card.html" import render_opportunity %}
{% from "components/page_template.html" import page_layout %}
{% from "components/quick_actions.html" import opportunities_page_actions %}
{% from "components/ui_elements.html" import action_button, expand_collapse_controls, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_selection_checkbox, view_mode_toggle, enhanced_filter_controls %}
{% from "components/icons.html" import chevron_right_icon, building_office_icon, currency_dollar_icon, chart_bar_icon, clock_icon %}

{% block title %}Opportunities - CRM{% endblock %}

{% block content %}
{% set pipeline_stats = {
    'title': 'Pipeline Summary',
    'stats': [
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'prospect')|sum(attribute='value') or 0),
            'label': 'Prospect',
            'color_class': 'text-green-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'qualified')|sum(attribute='value') or 0),
            'label': 'Qualified', 
            'color_class': 'text-blue-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'proposal')|sum(attribute='value') or 0),
            'label': 'Proposal',
            'color_class': 'text-yellow-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'negotiation')|sum(attribute='value') or 0),
            'label': 'Negotiation',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set opportunity_buttons = [
    {
        'label': 'New Opportunity',
        'onclick': 'openNewOpportunityModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Opportunities", "Track your sales pipeline", buttons=opportunity_buttons, summary_data=pipeline_stats) %}

<div x-data="createEntityManager(getOpportunityConfig('{{ today }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    <div x-show="selectedItems.length > 0" 
         x-cloak 
         x-transition
         class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <span class="text-blue-800 font-medium" x-text="`${selectedItems.length} opportunities selected`"></span>
            <button @click="bulkUpdateStage()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
                Update Stage
            </button>
            <button @click="bulkDelete()" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm hover:bg-red-700">
                Delete Selected
            </button>
        </div>
        <button @click="selectedItems = []" class="text-blue-600 hover:text-blue-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>


    <!-- Enhanced Filters and Controls with Generic DRY Components -->
    {% set company_options = [] %}
    {% for opportunity in opportunities %}
        {% if opportunity.company and opportunity.company.name not in company_options|map(attribute='value') %}
            {% set _ = company_options.append({'value': opportunity.company.name, 'label': opportunity.company.name}) %}
        {% endif %}
    {% endfor %}
    
    {{ enhanced_filter_controls(
        group_options=get_grouping_options('Opportunity'),
        sort_options=get_sort_options('Opportunity'),
        show_completed_label='Show Closed',
        show_completed_name='show_completed',
        primary_filter_options=get_priority_options('Opportunity'),
        primary_filter_label='All Priorities',
        secondary_filter_options=get_filter_options('Opportunity', 'stage'),
        secondary_filter_label='All Stages',
        entity_filter_options=company_options,
        entity_filter_label='All Companies',
        entity_filter_search=true
    ) }}

    <!-- Dynamic Client-Side Opportunity Grouping -->
    <div id="opportunities-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Default view when no opportunities -->
    {% if not opportunities %}
        <div class="card p-12 text-center">
            <p class="text-gray-500 mb-4">No opportunities found</p>
            <button onclick="openNewOpportunityModal()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Add Your First Opportunity
            </button>
        </div>
    {% endif %}

    <!-- Hidden pre-rendered opportunity cards for client-side use -->
    <div style="display: none;" id="opportunity-cards-cache">
        {% for opportunity in opportunities %}
            <div id="opportunity-card-{{ opportunity.id }}">
                {{ render_opportunity(opportunity, today) }}
            </div>
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-configs.js') }}"></script>

{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block data_attributes %}
data-companies="{{ companies | tojson | forceescape }}"
data-contacts="{{ contacts | tojson | forceescape }}"
data-opportunities="{{ opportunities_data | tojson | forceescape }}"
{% endblock %}
{% extends "base/layout.html" %}
{% from "components/opportunity_card.html" import render_opportunity %}
{% from "components/page_template.html" import page_layout %}
{% from "components/quick_actions.html" import opportunities_page_actions %}
{% from "components/ui_elements.html" import action_button, expand_collapse_controls, dropdown_select, dropdown_multiselect %}
{% from "components/icons.html" import chevron_right_icon, building_office_icon, currency_dollar_icon, chart_bar_icon, clock_icon %}

{% block title %}Opportunities - CRM{% endblock %}

{% block content %}
{% set pipeline_stats = {
    'title': 'Pipeline Summary',
    'stats': [
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'prospect')|sum(attribute='value') or 0),
            'label': 'Prospect',
            'color_class': 'text-green-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'qualified')|sum(attribute='value') or 0),
            'label': 'Qualified', 
            'color_class': 'text-blue-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'proposal')|sum(attribute='value') or 0),
            'label': 'Proposal',
            'color_class': 'text-yellow-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'negotiation')|sum(attribute='value') or 0),
            'label': 'Negotiation',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set opportunity_buttons = [
    {
        'label': 'New Opportunity',
        'onclick': 'openNewOpportunityModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Opportunities", "Track your sales pipeline", buttons=opportunity_buttons, summary_data=pipeline_stats) %}

<div x-data="{ 
    groupBy: 'stage',
    showClosed: false,
    stageFilter: [],
    companyFilter: [],
    expandedSections: {
        'prospect': true,
        'qualified': true,
        'proposal': true,
        'negotiation': true,
        'overdue': true,
        'this_week': true,
        'this_month': true,
        'later': true,
        'no_date': true
    }
}" class="space-y-6">

    <!-- Enhanced Filters and Controls -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-label-dark">Group by:</label>
                {{ dropdown_select('groupBy', [
                    {'value': 'stage', 'label': 'Pipeline Stage'},
                    {'value': 'close_date', 'label': 'Close Date'},
                    {'value': 'value', 'label': 'Deal Value'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" x-model="showClosed" class="mr-2">
                    <span class="text-sm text-gray-700">Show Closed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                {{ dropdown_multiselect('stageFilter', [
                    {'value': 'prospect', 'label': 'Prospect'},
                    {'value': 'qualified', 'label': 'Qualified'},
                    {'value': 'proposal', 'label': 'Proposal'},
                    {'value': 'negotiation', 'label': 'Negotiation'}
                ], 'All Stages') }}
                
                {% set company_options = [] %}
                {% for company in opportunities|map(attribute='company.name')|unique %}
                    {% set _ = company_options.append({'value': company, 'label': company}) %}
                {% endfor %}
                {{ dropdown_multiselect('companyFilter', company_options, 'All Companies', with_search=true) }}
            </div>
        </div>
    </div>

    <!-- Opportunities by Stage -->
    <div x-show="groupBy === 'stage'" class="space-y-4">
        <!-- Prospect -->
        <div class="card-success">
            <div class="border-b border-green-200 px-6 py-4 bg-green-50 cursor-pointer hover:bg-green-100" 
                 @click="expandedSections['prospect'] = !expandedSections['prospect']">
                <h3 class="text-status-success">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['prospect'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ building_office_icon("w-5 h-5 mr-1") }} Prospect<span class="ml-2 badge-standard badge-green">{{ opportunities|selectattr('stage', 'equalto', 'prospect')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['prospect']" x-transition>
                {% set prospect_opportunities = opportunities|selectattr('stage', 'equalto', 'prospect')|list %}
                {% for opportunity in prospect_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if prospect_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- Qualified -->
        <div class="card-info">
            <div class="border-b border-blue-200 px-6 py-4 bg-blue-50 cursor-pointer hover:bg-blue-100" 
                 @click="expandedSections['qualified'] = !expandedSections['qualified']">
                <h3 class="text-status-info">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['qualified'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ chart_bar_icon("w-5 h-5 mr-1") }} Qualified<span class="ml-2 badge-standard badge-blue">{{ opportunities|selectattr('stage', 'equalto', 'qualified')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['qualified']" x-transition>
                {% set qualified_opportunities = opportunities|selectattr('stage', 'equalto', 'qualified')|list %}
                {% for opportunity in qualified_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if qualified_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- Proposal -->
        <div class="card-warning">
            <div class="border-b border-yellow-200 px-6 py-4 bg-yellow-50 cursor-pointer hover:bg-yellow-100" 
                 @click="expandedSections['proposal'] = !expandedSections['proposal']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['proposal'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ currency_dollar_icon("w-5 h-5 mr-1") }} Proposal<span class="ml-2 badge-standard badge-yellow">{{ opportunities|selectattr('stage', 'equalto', 'proposal')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['proposal']" x-transition>
                {% set proposal_opportunities = opportunities|selectattr('stage', 'equalto', 'proposal')|list %}
                {% for opportunity in proposal_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if proposal_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- Negotiation -->
        <div class="card-orange">
            <div class="border-b border-orange-200 px-6 py-4 bg-orange-50 cursor-pointer hover:bg-orange-100" 
                 @click="expandedSections['negotiation'] = !expandedSections['negotiation']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['negotiation'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} Negotiation<span class="ml-2 badge-standard badge-orange">{{ opportunities|selectattr('stage', 'equalto', 'negotiation')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['negotiation']" x-transition>
                {% set negotiation_opportunities = opportunities|selectattr('stage', 'equalto', 'negotiation')|list %}
                {% for opportunity in negotiation_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if negotiation_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Opportunities by Close Date -->
    <div x-show="groupBy === 'close_date'" class="space-y-4">
        <!-- Overdue -->
        <div class="card-danger">
            <div class="border-b border-red-200 px-6 py-4 bg-red-50 cursor-pointer hover:bg-red-100" 
                 @click="expandedSections['overdue'] = !expandedSections['overdue']">
                <h3 class="text-status-overdue">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['overdue'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} Overdue<span class="ml-2 badge-standard badge-red">{{ opportunities|selectattr('expected_close_date')|selectattr('expected_close_date', 'lt', today)|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['overdue']" x-transition>
                {% set overdue_opportunities = [] %}
                {% for opp in opportunities %}
                    {% if opp.expected_close_date and opp.expected_close_date < today %}
                        {% set _ = overdue_opportunities.append(opp) %}
                    {% endif %}
                {% endfor %}
                {% for opportunity in overdue_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if overdue_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- This Week -->
        <div class="card-orange">
            <div class="border-b border-orange-200 px-6 py-4 bg-orange-50 cursor-pointer hover:bg-orange-100" 
                 @click="expandedSections['this_week'] = !expandedSections['this_week']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['this_week'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} This Week<span class="ml-2 badge-standard badge-orange">{% set this_week_opps = [] %}{% for opp in opportunities %}{% if opp.expected_close_date and opp.expected_close_date >= today and (opp.expected_close_date - today).days <= 7 %}{% set _ = this_week_opps.append(opp) %}{% endif %}{% endfor %}{{ this_week_opps|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['this_week']" x-transition>
                {% set this_week_opportunities = [] %}
                {% for opp in opportunities %}
                    {% if opp.expected_close_date and opp.expected_close_date >= today and (opp.expected_close_date - today).days <= 7 %}
                        {% set _ = this_week_opportunities.append(opp) %}
                    {% endif %}
                {% endfor %}
                {% for opportunity in this_week_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if this_week_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- This Month -->
        <div class="card-info">
            <div class="border-b border-blue-200 px-6 py-4 bg-blue-50 cursor-pointer hover:bg-blue-100" 
                 @click="expandedSections['this_month'] = !expandedSections['this_month']">
                <h3 class="text-status-info">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['this_month'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} This Month<span class="ml-2 badge-standard badge-blue">{% set this_month_opps = [] %}{% for opp in opportunities %}{% if opp.expected_close_date and opp.expected_close_date >= today and (opp.expected_close_date - today).days > 7 and (opp.expected_close_date - today).days <= 30 %}{% set _ = this_month_opps.append(opp) %}{% endif %}{% endfor %}{{ this_month_opps|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['this_month']" x-transition>
                {% set this_month_opportunities = [] %}
                {% for opp in opportunities %}
                    {% if opp.expected_close_date and opp.expected_close_date >= today and (opp.expected_close_date - today).days > 7 and (opp.expected_close_date - today).days <= 30 %}
                        {% set _ = this_month_opportunities.append(opp) %}
                    {% endif %}
                {% endfor %}
                {% for opportunity in this_month_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if this_month_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- Later -->
        <div class="card-neutral">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100" 
                 @click="expandedSections['later'] = !expandedSections['later']">
                <h3 class="text-status-neutral">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['later'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} Later<span class="ml-2 badge-standard badge-gray">{% set later_opps = [] %}{% for opp in opportunities %}{% if opp.expected_close_date and (opp.expected_close_date - today).days > 30 %}{% set _ = later_opps.append(opp) %}{% endif %}{% endfor %}{{ later_opps|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['later']" x-transition>
                {% set later_opportunities = [] %}
                {% for opp in opportunities %}
                    {% if opp.expected_close_date and (opp.expected_close_date - today).days > 30 %}
                        {% set _ = later_opportunities.append(opp) %}
                    {% endif %}
                {% endfor %}
                {% for opportunity in later_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if later_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>

        <!-- No Close Date -->
        <div class="card-neutral">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100" 
                 @click="expandedSections['no_date'] = !expandedSections['no_date']">
                <h3 class="text-status-neutral">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['no_date'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clock_icon("w-5 h-5 mr-1") }} No Close Date<span class="ml-2 badge-standard badge-gray">{{ opportunities|selectattr('expected_close_date', 'none')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['no_date']" x-transition>
                {% set no_date_opportunities = opportunities|selectattr('expected_close_date', 'none')|list %}
                {% for opportunity in no_date_opportunities %}
                    {{ render_opportunity(opportunity, today) }}
                {% endfor %}
                {% if no_date_opportunities|length == 0 %}
                    <p class="text-empty-state">No opportunities in this category</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Default view when no opportunities -->
    {% if not opportunities %}
        <div class="card p-12 text-center">
            <p class="text-gray-500 mb-4">No opportunities found</p>
            <button onclick="openNewOpportunityModal()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Add Your First Opportunity
            </button>
        </div>
    {% endif %}

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script>
function openNewOpportunityModal() {
    window.dispatchEvent(new CustomEvent('open-new-opportunity-modal'));
}

function openOpportunityModal(opportunityId) {
    openOpportunityDetailModal(opportunityId);
}

async function deleteOpportunity(opportunityId) {
    if (confirm('Are you sure you want to delete this opportunity? This action cannot be undone.')) {
        try {
            const response = await fetch(`/opportunities/${opportunityId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                // Refresh the page to show updated opportunities list
                location.reload();
            } else {
                const error = await response.json();
                alert('Error deleting opportunity: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting opportunity:', error);
            alert('Error deleting opportunity. Please try again.');
        }
    }
}
</script>

{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/task/task_enhanced.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}
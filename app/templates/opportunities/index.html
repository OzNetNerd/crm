{% extends "base/entity_index.html" %}

{# Entity-specific imports #}
{% block entity_imports %}
{% from "components/expandable_card.html" import opportunity_header_content, opportunity_metadata_content, action_buttons_row %}
{% endblock %}

{% block entity_config %}
{% set entity_name = "Opportunities" %}
{% set entity_description = "Track your sales pipeline" %}
{% set entity_type = "opportunity" %}

{% set entity_stats = {
    'title': 'Pipeline Summary',
    'stats': [
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'prospect')|sum(attribute='value') or 0),
            'label': 'Prospect',
            'color_class': 'text-green-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'qualified')|sum(attribute='value') or 0),
            'label': 'Qualified',
            'color_class': 'text-blue-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'proposal')|sum(attribute='value') or 0),
            'label': 'Proposal',
            'color_class': 'text-yellow-600'
        },
        {
            'value': '${:,.0f}'.format(opportunities|selectattr('stage', 'equalto', 'negotiation')|sum(attribute='value') or 0),
            'label': 'Negotiation',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Opportunity',
        'onclick': 'openNewOpportunityModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{# Build unique company options for filtering #}
{% set company_options = [] %}
{% for opportunity in opportunities %}
    {% if opportunity.company and opportunity.company.name not in company_options|map(attribute='value')|list %}
        {% set _ = company_options.append({'value': opportunity.company.name, 'label': opportunity.company.name}) %}
    {% endif %}
{% endfor %}

{% set entity_filter_controls %}
{{ enhanced_filter_controls(
    group_options=get_groupable_fields(Opportunity),
    sort_options=get_sortable_fields(Opportunity),
    show_completed_label='Show Closed',
    show_completed_name='show_completed',
    primary_filter_options=PRIORITY_OPTIONS,
    primary_filter_label='All Priorities',
    secondary_filter_options=get_field_options(Opportunity, 'stage'),
    secondary_filter_label='All Stages',
    entity_filter_options=company_options,
    entity_filter_label='All Companies',
    entity_filter_search=true
) }}
{% endset %}
{% endblock %}

{% block entity_cards %}
{% for opportunity in opportunities %}
    <div id="opportunity-card-{{ opportunity.id }}">
        {% set progress_config = {
            'enabled': opportunity.probability is not none,
            'type': 'probability', 
            'value': opportunity.probability or 0,
            'color_scheme': 'blue',
            'size': 'md'
        } %}
        {{ expandable_card('opportunity', opportunity, opportunity.id,
            expansion_enabled=true,
            progress_config=progress_config,
            badge_content=opportunity_header_content(opportunity),
            title_content=opportunity.name,
            value_content='$' + "{:,.0f}".format(opportunity.value) if opportunity.value else '',
            secondary_info='<span class="text-entity-base text-color-company">' + opportunity.company.name + '</span>',
            metadata_content=opportunity_metadata_content(opportunity),
            action_buttons=action_buttons_row('opportunity', opportunity.id)) }}
    </div>
{% endfor %}
{% endblock %}

{% block entity_data_attributes %}
data-companies="{{ companies | tojson | forceescape }}"
data-contacts="{{ contacts | tojson | forceescape }}"
data-opportunities="{{ opportunities_data | tojson | forceescape }}"
{% endblock %}

{% block entity_scripts %}
<script src="{{ url_for('static', filename='js/features/data-initializer.js') }}"></script>
<script src="{{ url_for('static', filename='js/entities/opportunities.js') }}"></script>
{% endblock %}
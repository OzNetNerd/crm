{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task %}

{% block title %}Dashboard - CRM{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Task Dashboard</h1>
    <p class="text-gray-600">Manage your tasks and stay on top of your opportunities</p>
</div>

<div x-data="{
    sections: {
        overdue: true,
        today: true, 
        thisWeek: false,
        nextWeek: false,
        completedToday: false,
        byCompany: false,
        byPriority: false
    },
    filters: {
        priority: '',
        entity: ''
    },
    selectedTasks: []
}" class="space-y-6">

    <!-- Quick actions and filters -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-4">
                <button onclick="openNewTaskModal()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    + New Task
                </button>
                
                <div class="flex items-center space-x-2">
                    <button @click="Object.keys(sections).forEach(key => sections[key] = true)"
                            class="text-sm text-gray-600 hover:text-gray-900">Expand All</button>
                    <span class="text-gray-400">|</span>
                    <button @click="Object.keys(sections).forEach(key => sections[key] = false); sections.overdue = true; sections.today = true"
                            class="text-sm text-gray-600 hover:text-gray-900">Collapse All</button>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <select x-model="filters.priority" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                
                <select x-model="filters.entity" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">All Entities</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Overdue Section -->
    <div class="section-container">
        <div class="section-header bg-red-50 border border-red-200 rounded-t-lg p-4 cursor-pointer"
             @click="sections.overdue = !sections.overdue">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-red-800 flex items-center">
                    <span x-show="sections.overdue" class="mr-2">▼</span>
                    <span x-show="!sections.overdue" class="mr-2">▶</span>
                    Overdue 
                    {% if sections.overdue|length > 0 %}
                        <span class="ml-2 bg-red-200 text-red-800 px-2 py-1 text-sm rounded-full">{{ sections.overdue|length }}</span>
                    {% endif %}
                </h2>
                <div class="text-sm text-red-600">{{ sections.overdue|length }} tasks</div>
            </div>
        </div>
        
        <div x-show="sections.overdue" class="bg-white border-l border-r border-b border-red-200 rounded-b-lg p-4">
            {% if sections.overdue %}
                {% for task in sections.overdue %}
                    {{ render_task(task) }}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">No overdue tasks</p>
            {% endif %}
        </div>
    </div>

    <!-- Today Section -->
    <div class="section-container">
        <div class="section-header bg-orange-50 border border-orange-200 rounded-t-lg p-4 cursor-pointer"
             @click="sections.today = !sections.today">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-orange-800 flex items-center">
                    <span x-show="sections.today" class="mr-2">▼</span>
                    <span x-show="!sections.today" class="mr-2">▶</span>
                    Today
                    {% if sections.today|length > 0 %}
                        <span class="ml-2 bg-orange-200 text-orange-800 px-2 py-1 text-sm rounded-full">{{ sections.today|length }}</span>
                    {% endif %}
                </h2>
                <div class="text-sm text-orange-600">{{ sections.today|length }} tasks</div>
            </div>
        </div>
        
        <div x-show="sections.today" class="bg-white border-l border-r border-b border-orange-200 rounded-b-lg p-4">
            {% if sections.today %}
                {% for task in sections.today %}
                    {{ render_task(task) }}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">No tasks due today</p>
            {% endif %}
        </div>
    </div>

    <!-- This Week Section -->
    <div class="section-container">
        <div class="section-header bg-blue-50 border border-blue-200 rounded-t-lg p-4 cursor-pointer"
             @click="sections.thisWeek = !sections.thisWeek">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-blue-800 flex items-center">
                    <span x-show="sections.thisWeek" class="mr-2">▼</span>
                    <span x-show="!sections.thisWeek" class="mr-2">▶</span>
                    This Week
                    {% if sections.this_week|length > 0 %}
                        <span class="ml-2 bg-blue-200 text-blue-800 px-2 py-1 text-sm rounded-full">{{ sections.this_week|length }}</span>
                    {% endif %}
                </h2>
                <div class="text-sm text-blue-600">{{ sections.this_week|length }} tasks</div>
            </div>
        </div>
        
        <div x-show="sections.thisWeek" class="bg-white border-l border-r border-b border-blue-200 rounded-b-lg p-4">
            {% if sections.this_week %}
                {% for task in sections.this_week %}
                    {{ render_task(task) }}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">No tasks due this week</p>
            {% endif %}
        </div>
    </div>

    <!-- Next Week Section -->
    <div class="section-container">
        <div class="section-header bg-gray-50 border border-gray-200 rounded-t-lg p-4 cursor-pointer"
             @click="sections.nextWeek = !sections.nextWeek">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                    <span x-show="sections.nextWeek" class="mr-2">▼</span>
                    <span x-show="!sections.nextWeek" class="mr-2">▶</span>
                    Next Week
                    {% if sections.next_week|length > 0 %}
                        <span class="ml-2 bg-gray-200 text-gray-800 px-2 py-1 text-sm rounded-full">{{ sections.next_week|length }}</span>
                    {% endif %}
                </h2>
                <div class="text-sm text-gray-600">{{ sections.next_week|length }} tasks</div>
            </div>
        </div>
        
        <div x-show="sections.nextWeek" class="bg-white border-l border-r border-b border-gray-200 rounded-b-lg p-4">
            {% if sections.next_week %}
                {% for task in sections.next_week %}
                    {{ render_task(task) }}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">No tasks due next week</p>
            {% endif %}
        </div>
    </div>

    <!-- Completed Today Section -->
    <div class="section-container">
        <div class="section-header bg-green-50 border border-green-200 rounded-t-lg p-4 cursor-pointer"
             @click="sections.completedToday = !sections.completedToday">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-green-800 flex items-center">
                    <span x-show="sections.completedToday" class="mr-2">▼</span>
                    <span x-show="!sections.completedToday" class="mr-2">▶</span>
                    Completed Today
                    {% if sections.completed_today|length > 0 %}
                        <span class="ml-2 bg-green-200 text-green-800 px-2 py-1 text-sm rounded-full">{{ sections.completed_today|length }}</span>
                    {% endif %}
                </h2>
                <div class="text-sm text-green-600">{{ sections.completed_today|length }} tasks</div>
            </div>
        </div>
        
        <div x-show="sections.completedToday" class="bg-white border-l border-r border-b border-green-200 rounded-b-lg p-4">
            {% if sections.completed_today %}
                {% for task in sections.completed_today %}
                    {{ render_task(task) }}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">No tasks completed today</p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block modals %}
{% include "components/modals.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Task management functions
async function completeTask(taskId) {
    try {
        const response = await fetch(`/tasks/${taskId}/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            location.reload(); // Simple reload for now
        }
    } catch (error) {
        console.error('Error completing task:', error);
    }
}

async function rescheduleTask(taskId, days) {
    try {
        const response = await fetch(`/tasks/${taskId}/reschedule`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days })
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error rescheduling task:', error);
    }
}

async function updateTask(taskId, updates) {
    try {
        const response = await fetch(`/tasks/${taskId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (response.ok) {
            // Don't reload for inline edits
            console.log('Task updated successfully');
        }
    } catch (error) {
        console.error('Error updating task:', error);
    }
}

function openTaskModal(taskId) {
    // TODO: Implement task details modal
    console.log('Opening task modal for:', taskId);
}

function openNewTaskModal() {
    // TODO: Implement new task modal
    console.log('Opening new task modal');
}

function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        // TODO: Implement delete functionality
        console.log('Deleting task:', taskId);
    }
}
</script>
{% endblock %}
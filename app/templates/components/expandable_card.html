{#
  Expandable Card Component - DRY base component for all entity cards
  
  Creates a standardized card layout with configurable expansion, progress bars, and content.
  Eliminates code duplication between task_card, opportunity_card, and contact_card.
  
  Parameters:
  - card_type (required): 'task' | 'opportunity' | 'contact'
  - entity (required): Entity object (task, opportunity, or contact)
  - entity_id (required): Unique ID of the entity
  - expansion_enabled (optional): Enable expansion functionality (default: true)
  - progress_config (optional): Progress bar configuration object
  - bulk_selection_enabled (optional): Show bulk selection checkbox (default: true)
  - group_key (optional): Group identifier for expand/collapse all events
  - card_classes (optional): Additional CSS classes for the card
  - header_content (required): Header content (use caller for complex layouts)
  - expanded_content (optional): Content shown when expanded
  
  Progress Config Object:
  {
    'enabled': true,
    'type': 'completion' | 'probability' | 'custom',
    'value': number,
    'max_value': number (optional, default 100),
    'color_scheme': 'blue' | 'green' | 'yellow' | 'red' (optional, default 'blue'),
    'label': string (optional)
  }
  
  Usage:
  {% call expandable_card('task', task, task.id, 
       progress_config={'enabled': true, 'type': 'completion', 'value': task.completion_percentage},
       group_key=section_key) %}
    <!-- Header content goes here -->
  {% endcall %}
#}
{% from "components/ui_elements.html" import bulk_selection_checkbox %}
{% from "components/progress_bar.html" import progress_bar %}
{% from "components/card_state_manager.html" import card_state_manager %}

{% macro expandable_card(card_type, entity, entity_id, expansion_enabled=true, progress_config=none, bulk_selection_enabled=true, group_key='', card_classes='', header_content='', expanded_content='') %}
{%- set base_classes = card_type + '-card card-padded relative' -%}
{%- set notes_enabled = card_type == 'task' -%}

<div class="{{ base_classes }} {{ card_classes }}" 
     data-{{ card_type }}-id="{{ entity_id }}"
     {{ card_state_manager(card_type, entity, entity_id, expansion_enabled, notes_enabled, group_key) }}>
    
    {% if bulk_selection_enabled %}
    <!-- Bulk selection checkbox -->
    <div class="absolute top-2 left-2">
        {{ bulk_selection_checkbox(entity_id) }}
    </div>
    {% endif %}
    
    <!-- Card Header Content -->
    <div class="{% if bulk_selection_enabled %}ml-6{% endif %}">
        {{ caller() if caller else header_content|safe }}
    </div>
    
    {% if progress_config and progress_config.enabled %}
    <!-- Progress Bar Section -->
    <div class="mt-3 {% if bulk_selection_enabled %}ml-6{% endif %}">
        {{ progress_bar(
            progress_config.type, 
            progress_config.value,
            max_value=progress_config.get('max_value', 100),
            color_scheme=progress_config.get('color_scheme', 'blue'),
            label=progress_config.get('label', ''),
            size=progress_config.get('size', 'md')
        ) }}
    </div>
    {% endif %}
    
    {% if expansion_enabled and (expanded_content or notes_enabled) %}
    <!-- Expanded Content Section -->
    <div x-show="expanded" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         class="mt-4 pt-4 border-t border-gray-100">
        
        {% if expanded_content %}
        {{ expanded_content|safe }}
        {% endif %}
        
        {% if notes_enabled %}
        {% from "components/card_state_manager.html" import notes_section %}
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-900">Comments & Notes</h4>
            {{ notes_section() }}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endmacro %}

{#
  Card Content Row - Standardized content row layout
  
  Parameters:
  - badge_content (optional): Content for badge/status column
  - main_content (required): Main content area
  - action_content (optional): Action buttons/controls
  - row_classes (optional): Additional CSS classes
  
  Usage:
  {{ card_content_row(badge_content='<span class="badge">High</span>', 
                      main_content='<p>Task description</p>',
                      action_content='<button>Edit</button>') }}
#}
{% macro card_content_row(badge_content='', main_content='', action_content='', row_classes='') %}
<div class="task-content-grid {{ row_classes }}">
    <div class="task-badge-cell">
        {{ badge_content|safe }}
    </div>
    <div class="task-content-cell">
        {{ main_content|safe }}
    </div>
    <div class="task-action-cell">
        {{ action_content|safe }}
    </div>
</div>
{% endmacro %}

{#
  Action Buttons Row - Standardized action buttons for cards
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact'
  - entity_id (required): Entity ID
  - actions (optional): List of action configs
  - disabled_condition (optional): Alpine.js condition for disabling
  
  Action Config:
  {
    'type': 'edit' | 'delete' | 'complete' | 'view' | 'custom',
    'icon': 'icon_html',
    'onclick': 'javascript_function',
    'title': 'tooltip_text',
    'classes': 'additional_css_classes'
  }
  
  Usage:
  {{ action_buttons_row('task', task.id, actions=[
       {'type': 'edit', 'onclick': 'editTask(' + task.id|string + ')'},
       {'type': 'delete', 'onclick': 'deleteTask(' + task.id|string + ')'}
     ]) }}
#}
{% macro action_buttons_row(entity_type, entity_id, actions=none, disabled_condition='') %}
{% from "components/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_actions = {
    'task': [
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteTask(' + entity_id|string + ')', 'title': 'Delete task', 'classes': 'text-danger-hover hover:bg-red-50'},
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'editTask(' + entity_id|string + ')', 'title': 'Edit task', 'classes': 'text-info-hover hover:bg-blue-50'},
        {'type': 'complete', 'icon': check_icon("w-4 h-4"), 'onclick': 'completeTask(' + entity_id|string + ')', 'title': 'Complete task', 'classes': 'text-success-hover hover:bg-green-50'}
    ],
    'opportunity': [
        {'type': 'delete', 'icon': 'Ã—', 'onclick': 'deleteOpportunity(' + entity_id|string + ')', 'title': 'Delete opportunity', 'classes': 'text-danger-hover hover:bg-red-50'},
        {'type': 'view', 'icon': check_icon("w-4 h-4"), 'onclick': 'openOpportunityModal(' + entity_id|string + ')', 'title': 'View opportunity', 'classes': 'text-info-hover hover:bg-blue-50'}
    ],
    'contact': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'openContactModal(' + entity_id|string + ')', 'title': 'Edit contact', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteContact(' + entity_id|string + ')', 'title': 'Delete contact', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ]
} -%}

{%- set button_actions = actions or default_actions.get(entity_type, []) -%}

<div class="flex items-center space-x-1" {% if disabled_condition %}:class="{ 'opacity-50 pointer-events-none': {{ disabled_condition }} }"{% endif %}>
    {% for action in button_actions %}
    <button @click.stop="{{ action.onclick }}" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.classes }}" 
            title="{{ action.title }}">
        {{ action.icon|safe }}
    </button>
    {% endfor %}
</div>
{% endmacro %}
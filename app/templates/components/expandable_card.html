{#
  Expandable Card Component - DRY base component for all entity cards
  
  Creates a standardized card layout matching the opportunity card structure.
  Eliminates code duplication between task_card, opportunity_card, and contact_card.
  
  Parameters:
  - card_type (required): 'task' | 'opportunity' | 'contact'
  - entity (required): Entity object (task, opportunity, or contact)
  - entity_id (required): Unique ID of the entity
  - expansion_enabled (optional): Enable expansion functionality (default: true)
  - progress_config (optional): Progress bar configuration object
  - bulk_selection_enabled (optional): Show bulk selection checkbox (default: true)
  - group_key (optional): Group identifier for expand/collapse all events
  - card_classes (optional): Additional CSS classes for the card
  - badge_content (optional): Badge/status content for header
  - title_content (required): Main title/name content
  - value_content (optional): Value content (deal amount, etc.)
  - secondary_info (optional): Secondary info (company, stakeholder)
  - metadata_content (optional): Metadata text content
  - action_buttons (optional): Action buttons HTML
  - expanded_content (optional): Content shown when expanded
  
  Progress Config Object:
  {
    'enabled': true,
    'type': 'completion' | 'probability' | 'custom',
    'value': number,
    'max_value': number (optional, default 100),
    'color_scheme': 'blue' | 'green' | 'yellow' | 'red' (optional, default 'blue'),
    'label': string (optional)
  }
  
  Usage:
  {{ expandable_card('opportunity', opportunity, opportunity.id, 
       badge_content=opportunity_header_content(opportunity),
       title_content=opportunity.name,
       value_content='$' + "{:,.0f}".format(opportunity.value),
       secondary_info='<span class="text-company-name">' + opportunity.company.name + '</span>',
       metadata_content=opportunity_metadata_content(opportunity),
       action_buttons=action_buttons_row('opportunity', opportunity.id),
       progress_config={'enabled': true, 'type': 'probability', 'value': opportunity.probability},
       expanded_content=opportunity_expanded_content(opportunity)) }}
#}
{% from "components/ui_elements.html" import bulk_selection_checkbox %}
{% from "components/progress_bar.html" import progress_bar %}

{% macro expandable_card(card_type, entity, entity_id, expansion_enabled=true, progress_config=none, bulk_selection_enabled=true, group_key='', card_classes='', badge_content='', title_content='', value_content='', secondary_info='', metadata_content='', action_buttons='', expanded_content='') %}
{%- set base_classes = card_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50',
    'contact': 'ring-2 ring-green-200 bg-green-50'
} -%}
{%- set notes_enabled = card_type == 'task' -%}

<div class="{{ base_classes }} {{ color_classes.get(card_type, '') }} {{ card_classes }}" data-{{ card_type }}-id="{{ entity_id }}" x-data="{ 
    // Core expansion state
    expanded: false,
    
    // Notes and comments (for tasks and other entities that support it)
    {% if notes_enabled %}
    notes: '',
    showNotesInput: false,
    {% endif %}
    
    // Generic editing state
    isEditing: false,
    showSaveButtons: false,
    
    {% if card_type == 'task' %}
    // Task-specific reschedule state
    pendingDays: 0,
    {% endif %}
    
}" @click="expanded = !expanded" :class="{ '{{ color_classes.get(card_type, '') }}': expanded || isEditing }">
    
    {% if bulk_selection_enabled %}
    <!-- Bulk selection checkbox -->
    <div class="absolute top-2 left-2">
        {{ bulk_selection_checkbox(entity_id) }}
    </div>
    {% endif %}
    
    <!-- Card Header Content -->
    <div class="{% if bulk_selection_enabled %}ml-6{% endif %}">
        
        <!-- Header row with badge, title, and value -->
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2 flex-grow">
                {% if badge_content %}
                {{ badge_content|safe }}
                {% endif %}
                <h3 class="{{ 'text-opportunity-name' if card_type == 'opportunity' else 'text-label-primary' }}">{{ title_content|safe }}</h3>
                {% if value_content %}
                <div class="{{ 'text-deal-amount-lg text-success' if card_type == 'opportunity' else 'text-label-primary' }}">
                    {{ value_content|safe }}
                </div>
                {% endif %}
            </div>
            {% if card_type == 'task' %}
            <!-- Task-specific reschedule buttons -->
            {{ task_reschedule_buttons(entity_id) }}
            {% endif %}
        </div>

        <!-- Secondary info (company, stakeholder, etc.) -->
        {% if secondary_info %}
        <div class="mb-2">
            <div class="text-secondary">
                {{ secondary_info|safe }}
            </div>
        </div>
        {% endif %}

        <!-- Metadata and actions -->
        <div class="flex items-center justify-between">
            <div class="text-metadata">
                {% if metadata_content %}
                {{ metadata_content|safe }}
                {% endif %}
            </div>
            
            <!-- Action buttons -->
            {% if action_buttons %}
            {{ action_buttons|safe }}
            {% endif %}
        </div>
    </div>
    
    {% if progress_config and progress_config.enabled %}
    <!-- Progress Bar Section -->
    <div class="mt-3 {% if bulk_selection_enabled %}ml-6{% endif %}">
        {{ progress_bar(
            progress_config.type, 
            progress_config.value,
            max_value=progress_config.get('max_value', 100),
            color_scheme=progress_config.get('color_scheme', 'blue'),
            label=progress_config.get('label', ''),
            size=progress_config.get('size', 'md')
        ) }}
    </div>
    {% endif %}
    
    {% if expansion_enabled and (expanded_content or notes_enabled) %}
    <!-- Expanded Content Section -->
    <div x-show="expanded" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95" class="mt-4 pt-4 border-t border-gray-100">
        
        {% if expanded_content %}
        {{ expanded_content|safe }}
        {% endif %}
        
        {% if notes_enabled %}
        {% from "components/card_state_manager.html" import notes_section %}
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-900">Comments & Notes</h4>
            {{ notes_section() }}
        </div>
        {% endif %}
    </div>
    {% endif %}
    
</div>
{% endmacro %}

{#
  Opportunity Header Content - Standardized opportunity header badge
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_header_content(opportunity) }}
#}
{% macro opportunity_header_content(opportunity) %}
{% from "components/list_section.html" import status_badge %}
{{ status_badge(opportunity.stage, 'green' if opportunity.stage == 'Prospect' else 'blue') }}
{% endmacro %}

{#
  Task Header Content - Standardized task header badge
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_header_content(task) }}
#}
{% macro task_header_content(task) %}
{% from "components/list_section.html" import status_badge %}
{% set priority_color = 'red' if task.priority == 'high' else
                      'yellow' if task.priority == 'medium' else
                      'green' %}
{{ status_badge(task.priority, priority_color) }}
{% endmacro %}

{#
  Action Buttons Row - Standardized action buttons for cards
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact'
  - entity_id (required): Entity ID
  - actions (optional): List of action configs
  - disabled_condition (optional): Alpine.js condition for disabling
  
  Action Config:
  {
    'type': 'edit' | 'delete' | 'complete' | 'view' | 'custom',
    'icon': 'icon_html',
    'onclick': 'javascript_function',
    'title': 'tooltip_text',
    'classes': 'additional_css_classes'
  }
  
  Usage:
  {{ action_buttons_row('task', task.id, actions=[
       {'type': 'edit', 'onclick': 'editTask(' + task.id|string + ')'},
       {'type': 'delete', 'onclick': 'deleteTask(' + task.id|string + ')'} 
     ]) }}
#}
{% macro action_buttons_row(entity_type, entity_id, actions=none, disabled_condition='') %}
{% from "components/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_actions = {
    'task': [
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteTask(' + entity_id|string + ')', 'title': 'Delete task', 'classes': 'text-danger-hover hover:bg-red-50'},
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'editTask(' + entity_id|string + ')', 'title': 'Edit task', 'classes': 'text-info-hover hover:bg-blue-50'},
        {'type': 'complete', 'icon': check_icon("w-4 h-4"), 'onclick': 'completeTask(' + entity_id|string + ')', 'title': 'Complete task', 'classes': 'text-success-hover hover:bg-green-50'}
    ],
    'opportunity': [
        {'type': 'delete', 'icon': '×', 'onclick': 'deleteOpportunity(' + entity_id|string + ')', 'title': 'Delete opportunity', 'classes': 'text-danger-hover hover:bg-red-50'},
        {'type': 'view', 'icon': check_icon("w-4 h-4"), 'onclick': 'openOpportunityModal(' + entity_id|string + ')', 'title': 'View opportunity', 'classes': 'text-info-hover hover:bg-blue-50'}
    ],
    'contact': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'openContactModal(' + entity_id|string + ')', 'title': 'Edit contact', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteContact(' + entity_id|string + ')', 'title': 'Delete contact', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ]
} -%}

{%- set button_actions = actions or default_actions.get(entity_type, []) -%}

<div class="flex items-center space-x-1" {% if disabled_condition %}:class="{ 'opacity-50 pointer-events-none': {{ disabled_condition }} }"{% endif %}>
    {% for action in button_actions %}
    <button @click.stop="{{ action.onclick }}" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.classes }}" 
            title="{{ action.title }}">
        {{ action.icon|safe }}
    </button>
    {% endfor %}
</div>
{% endmacro %}

{#
  Task Title Content - Task description with badges
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_title_content(task) }}
#}
{% macro task_title_content(task) %}
{{ task.description | style_task_description }}
{% if task.next_step_type %}
    <span class="text-badge-tag">{{ task.next_step_type }}</span>
{% endif %}
{% if task.is_overdue %}
    <span class="text-badge-overdue">OVERDUE</span>
{% endif %}
{% endmacro %}

{#
  Task Metadata Content - Standardized task metadata layout
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_metadata_content(task) }}
#}
{% macro task_metadata_content(task) %}
<span class="text-gray-500">
    {% if task.next_step_type %}
    {{ task.next_step_type }}
    {% endif %}
    {% if task.due_date %}
    • Due: {{ task.due_date.strftime('%m/%d/%y') }}
    {% endif %}
    {% if task.is_overdue %}
    • <span class="text-badge-overdue">OVERDUE</span>
    {% endif %}
</span>
{% endmacro %}

{#
  Opportunity Metadata Content - Standardized opportunity metadata layout
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_metadata_content(opportunity) }}
#}
{% macro opportunity_metadata_content(opportunity) %}
<span class="text-gray-500">
    <span class="text-gray-500">
        Close: {{ opportunity.close_date.strftime('%d/%m/%y') if opportunity.close_date else 'TBD' }}
        {% if opportunity.days_until_close %}
            • {{ opportunity.days_until_close }} days to go
        {% endif %}
    </span>
</span>
 • 
<div class="text-metadata">
    {% if opportunity.company %}
        {{ opportunity.company.name }} • 
    {% endif %}
    {{ opportunity.name }} • 
    {{ opportunity.stage }} • 
    ${{ "{:,.0f}".format(opportunity.value) if opportunity.value else '0' }} • 
    {% if opportunity.contact %}
        {{ opportunity.contact.name }} • 
    {% endif %}
    {{ opportunity.created_at.strftime('%d') if opportunity.created_at else '0' }} days old
</div>
{% endmacro %}

{#
  Task Reschedule Buttons - Reschedule functionality for tasks
  
  Parameters:
  - task_id (required): Task ID for the reschedule actions
  
  Usage:
  {{ task_reschedule_buttons(task.id) }}
#}
{% macro task_reschedule_buttons(task_id) %}
<div class="relative flex-shrink-0">
    <div class="flex items-center space-x-1">
        <button @click.stop="adjustDays(-7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button @click.stop="adjustDays(-1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button @click.stop="adjustDays(1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button @click.stop="adjustDays(7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
    
    <!-- Save/Cancel buttons (overlay below with absolute positioning) -->
    <div class="absolute top-full left-0 right-0 mt-2 flex items-center justify-center space-x-1" 
         x-show="showSaveButtons" 
         style="display: none;"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
        <button @click.stop="saveReschedule({{ task_id }}, pendingDays)" 
                class="px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors duration-200" 
                title="Save changes">
            Save
        </button>
        <button @click.stop="cancelChanges()" 
                class="px-3 py-1 rounded border text-gray-600 text-xs hover:bg-gray-50 transition-colors duration-200" 
                title="Cancel changes">
            Cancel
        </button>
    </div>
</div>
{% endmacro %}
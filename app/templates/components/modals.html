<!-- Confirmation Modal Macro -->
{% macro confirmation_modal(modal_id, default_title="Confirm Action") %}
<div x-data="{ 
        show: false, 
        title: '{{ default_title }}', 
        message: '', 
        confirmText: 'Confirm', 
        confirmAction: null,
        confirmClass: 'bg-blue-600 hover:bg-blue-700'
     }" 
     @open-confirmation-modal.window="
        show = true; 
        title = $event.detail.title || '{{ default_title }}';
        message = $event.detail.message || '';
        confirmText = $event.detail.confirmText || 'Confirm';
        confirmAction = $event.detail.confirmAction;
        confirmClass = $event.detail.confirmClass || 'bg-blue-600 hover:bg-blue-700';
     "
     @close-confirmation-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all max-w-lg w-full mx-4">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="title"></h3>
                        <div class="mt-2">
                            <p class="text-secondary" x-text="message"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="confirmAction && confirmAction(); show = false" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-200"
                        :class="confirmClass"
                        x-text="confirmText">
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- Task Details Modal -->
<div x-data="{ show: false, taskId: null, task: { description: '', due_date: '', priority: '', next_step_type: '' } }" 
     @open-task-modal.window="show = true; taskId = $event.detail.taskId; loadTask(taskId)"
     @close-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto hidden"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="text-title-primary leading-6">Task Details</h3>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div x-show="task" class="space-y-4">
                    <div>
                        <label class="text-form-label">Description</label>
                        <textarea x-model="task.description" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  rows="3"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Due Date</label>
                            <input type="date" x-model="task.due_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Priority</label>
                            <select x-model="task.priority" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-form-label">Next Step Type</label>
                        <select x-model="task.next_step_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">None</option>
                            <option value="call">Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="demo">Demo</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="saveTask()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    Save Changes
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div x-data="{ show: false, task: { description: '', due_date: '', priority: 'medium', entity_type: '', entity_id: '' } }" 
     @open-new-task-modal.window="show = true; resetTask()"
     @close-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto hidden"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="text-title-primary leading-6">Create New Task</h3>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-form-label">Description*</label>
                        <textarea x-model="task.description" 
                                  placeholder="What needs to be done?"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  rows="3" required></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Due Date</label>
                            <input type="date" x-model="task.due_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Priority</label>
                            <select x-model="task.priority" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Related To</label>
                            <select x-model="task.entity_type" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">None</option>
                                <option value="company">Company</option>
                                <option value="contact">Contact</option>
                                <option value="opportunity">Opportunity</option>
                            </select>
                        </div>
                        
                        <div x-show="task.entity_type">
                            <label class="text-form-label">Select Item</label>
                            <select x-model="task.entity_id" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">Select...</option>
                                <!-- TODO: Populate dynamically based on entity_type -->
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-form-label">Next Step Type</label>
                        <select x-model="task.next_step_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">None</option>
                            <option value="call">Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="demo">Demo</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="createTask()" 
                        :disabled="!task.description"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 disabled:bg-gray-400 sm:ml-3 sm:w-auto sm:text-sm">
                    Create Task
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Modal helper functions
async function loadTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            headers: { 'Accept': 'application/json' }
        });
        if (response.ok) {
            const task = await response.json();
            // Update Alpine data
            window.dispatchEvent(new CustomEvent('task-loaded', { detail: { task } }));
        }
    } catch (error) {
        console.error('Error loading task:', error);
    }
}

async function saveTask() {
    // TODO: Implement save functionality
    console.log('Saving task...');
    window.dispatchEvent(new CustomEvent('close-modal'));
}

async function createTask() {
    // TODO: Implement create functionality
    console.log('Creating task...');
    window.dispatchEvent(new CustomEvent('close-modal'));
}

function resetTask() {
    // Reset form data when opening new task modal
    return { 
        description: '', 
        due_date: '', 
        priority: 'medium', 
        entity_type: '', 
        entity_id: '',
        next_step_type: ''
    };
}

// Global modal functions
window.openTaskModal = function(taskId) {
    window.dispatchEvent(new CustomEvent('open-task-modal', { detail: { taskId } }));
};

window.openNewTaskModal = function() {
    window.dispatchEvent(new CustomEvent('open-new-task-modal'));
};

// Confirmation modal helper
window.showConfirmationModal = function(options) {
    window.dispatchEvent(new CustomEvent('open-confirmation-modal', { 
        detail: options 
    }));
};

// Enhanced modal functions
window.openTaskDetailModal = function(taskId) {
    window.dispatchEvent(new CustomEvent('open-task-detail-modal', { detail: { taskId } }));
};

window.openContactDetailModal = function(contactId) {
    window.dispatchEvent(new CustomEvent('open-contact-detail-modal', { detail: { contactId } }));
};

window.openCompanyDetailModal = function(companyId) {
    window.dispatchEvent(new CustomEvent('open-company-detail-modal', { detail: { companyId } }));
};

window.openOpportunityDetailModal = function(opportunityId) {
    window.dispatchEvent(new CustomEvent('open-opportunity-detail-modal', { detail: { opportunityId } }));
};

// Task detail modal functions
async function loadTaskDetails(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            // Update Alpine data via custom event
            window.dispatchEvent(new CustomEvent('task-details-loaded', { 
                detail: { task: task } 
            }));
        }
    } catch (error) {
        console.error('Error loading task details:', error);
    }
}

async function saveTaskDetails() {
    // Implementation will be added via Alpine.js scope
    console.log('Save task details functionality');
}


// Contact detail modal functions
async function loadContactDetails(contactId) {
    try {
        const response = await fetch(`/api/contacts/${contactId}`);
        if (response.ok) {
            const data = await response.json();
            window.dispatchEvent(new CustomEvent('contact-details-loaded', { 
                detail: { 
                    contact: data,
                    notes: data.notes || []
                } 
            }));
        }
    } catch (error) {
        console.error('Error loading contact details:', error);
    }
}

async function saveContactDetails() {
    console.log('Save contact details functionality');
}

async function addContactNote() {
    console.log('Add contact note functionality');
}

// Company detail modal functions
async function loadCompanyDetails(companyId) {
    try {
        const response = await fetch(`/api/companies/${companyId}`);
        if (response.ok) {
            const data = await response.json();
            window.dispatchEvent(new CustomEvent('company-details-loaded', { 
                detail: { 
                    company: data,
                    notes: data.notes || []
                } 
            }));
        }
    } catch (error) {
        console.error('Error loading company details:', error);
    }
}

async function saveCompanyDetails() {
    console.log('Save company details functionality');
}

async function addCompanyNote() {
    console.log('Add company note functionality');
}

// Opportunity detail modal functions
async function loadOpportunityDetails(opportunityId) {
    try {
        const response = await fetch(`/api/opportunities/${opportunityId}`);
        if (response.ok) {
            const data = await response.json();
            window.dispatchEvent(new CustomEvent('opportunity-details-loaded', { 
                detail: { 
                    opportunity: data,
                    notes: data.notes || []
                } 
            }));
        }
    } catch (error) {
        console.error('Error loading opportunity details:', error);
    }
}

async function saveOpportunityDetails() {
    console.log('Save opportunity details functionality');
}

async function addOpportunityNote() {
    console.log('Add opportunity note functionality');
}

// Utility functions
function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
</script>

<!-- Include the confirmation modal instance -->
{{ confirmation_modal("task-confirmation") }}

<!-- Enhanced Task Detail Modal with Tabs -->
<div x-data="{
        show: false,
        taskId: null,
        activeTab: 'task',
        task: {
            description: '',
            due_date: '',
            priority: '',
            status: '',
            next_step_type: '',
            company_id: null,
            opportunity_id: null,
            company_name: '',
            opportunity_name: ''
        },
        company: null,
        opportunity: null,
        stakeholders: [],
        originalTask: null,
        loading: false,
        saving: false,
        hasChanges: false,
        
        switchTab(tab) {
            this.activeTab = tab;
            // Load related data when switching to specific tabs
            if (tab === 'company' && this.task.company_name && !this.company) {
                this.loadCompanyData();
            } else if (tab === 'opportunity' && this.task.opportunity_name && !this.opportunity) {
                this.loadOpportunityData();
            } else if (tab === 'stakeholders' && (this.task.company_name || this.task.opportunity_name) && this.stakeholders.length === 0) {
                this.loadStakeholders();
            }
        },
        
        async loadCompanyData() {
            if (!this.task.company_name) return;
            try {
                // Since we only have company_name, we'll need to search or use entity_id if it's a company
                // For now, create a minimal company object from available data
                this.company = {
                    name: this.task.company_name,
                    industry: 'N/A',
                    website: 'N/A'
                };
            } catch (error) {
                console.error('Error loading company data:', error);
            }
        },
        
        async loadOpportunityData() {
            if (!this.task.opportunity_name) return;
            try {
                // Since we only have opportunity_name, create a minimal object
                this.opportunity = {
                    name: this.task.opportunity_name,
                    stage: 'N/A',
                    value: null,
                    probability: null,
                    expected_close_date: null
                };
            } catch (error) {
                console.error('Error loading opportunity data:', error);
            }
        },
        
        async loadStakeholders() {
            try {
                // If the task is related to a contact, show that contact as a stakeholder
                if (this.task.entity_type === 'contact' && this.task.entity_id) {
                    try {
                        const response = await fetch(`/api/contacts/${this.task.entity_id}`);
                        if (response.ok) {
                            const contact = await response.json();
                            this.stakeholders = [contact];
                        }
                    } catch (error) {
                        console.error('Error loading contact:', error);
                    }
                }
            } catch (error) {
                console.error('Error loading stakeholders:', error);
            }
        },
        
        async saveTaskDetails() {
            if (!this.task) return;
            this.saving = true;
            
            try {
                const response = await fetch(`/api/tasks/${this.taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: this.task.description,
                        due_date: this.task.due_date,
                        priority: this.task.priority,
                        status: this.task.status,
                        next_step_type: this.task.next_step_type
                    })
                });
                
                if (response.ok) {
                    // Refresh task list if needed
                    location.reload();
                } else {
                    alert('Failed to save task');
                }
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Failed to save task');
            } finally {
                this.saving = false;
            }
        }
    }"
    @open-task-detail-modal.window="show = true; taskId = $event.detail.taskId; loading = true; loadTaskDetails(taskId)"
    @task-details-loaded.window="task = $event.detail.task; originalTask = JSON.parse(JSON.stringify($event.detail.task)); loading = false; hasChanges = false"
    x-effect="if (task && originalTask) { hasChanges = JSON.stringify(task) !== JSON.stringify(originalTask) }"
    @close-modal.window="show = false"
    x-show="show"
    class="fixed inset-0 z-50 overflow-y-auto"
    style="display: none;"
    x-transition:enter="ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all max-w-4xl w-full mx-4">
            <!-- Header -->
            <div class="bg-white px-6 pt-6 pb-4 border-b border-gray-200">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="text-title-primary leading-6">Task Details</h3>
                        <p class="text-metadata" x-show="task" x-text="task?.company_name ? `${task.company_name}${task.opportunity_name ? ' • ' + task.opportunity_name : ''}` : 'No related entity'"></p>
                    </div>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button @click="switchTab('task')" 
                                :class="activeTab === 'task' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Task Details
                        </button>
                        <button @click="switchTab('company')" 
                                x-show="task?.company_name"
                                :class="activeTab === 'company' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Company
                        </button>
                        <button @click="switchTab('opportunity')" 
                                x-show="task?.opportunity_name"
                                :class="activeTab === 'opportunity' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Opportunity
                        </button>
                        <button @click="switchTab('stakeholders')" 
                                x-show="task?.company_name || task?.opportunity_name"
                                :class="activeTab === 'stakeholders' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Stakeholders
                        </button>
                    </nav>
                </div>
            </div>
            
            <!-- Content -->
            <div class="bg-white px-6 py-4" x-show="!loading">
                <!-- Task Details Tab -->
                <div x-show="activeTab === 'task' && task" class="space-y-6">
                    <!-- Task Information Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Description (Left Column) -->
                        <div>
                            <h4 class="text-section-title">Task Information</h4>
                            <div class="mt-4">
                                <label class="text-form-label">Description</label>
                                <textarea x-model="task.description"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                          rows="5"></textarea>
                            </div>
                        </div>
                        
                        <!-- Task Details (Right Column) -->
                        <div class="space-y-4">
                            <h4 class="text-section-title">Details</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-form-label">Due Date</label>
                                    <input type="date" x-model="task.due_date"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                </div>
                                <div>
                                    <label class="text-form-label">Priority</label>
                                    <select x-model="task.priority"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-form-label">Status</label>
                                    <select x-model="task.status"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="todo">To Do</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="complete">Complete</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-form-label">Next Step</label>
                                    <select x-model="task.next_step_type"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="">None</option>
                                        <option value="call">Call</option>
                                        <option value="email">Email</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="demo">Demo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Company Tab -->
                <div x-show="activeTab === 'company' && company" class="space-y-6">
                    <div>
                        <h4 class="text-section-title">Company Information</h4>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-form-label">Company Name</label>
                                <p class="text-secondary" x-text="company?.name || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Industry</label>
                                <p class="text-secondary" x-text="company?.industry || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Website</label>
                                <p class="text-secondary">
                                    <a x-show="company?.website" :href="company?.website" target="_blank" 
                                       class="text-link hover:underline" x-text="company?.website"></a>
                                    <span x-show="!company?.website">N/A</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Opportunity Tab -->
                <div x-show="activeTab === 'opportunity' && opportunity" class="space-y-6">
                    <div>
                        <h4 class="text-section-title">Opportunity Information</h4>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-form-label">Opportunity Name</label>
                                <p class="text-secondary" x-text="opportunity?.name || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Stage</label>
                                <p class="text-secondary" x-text="opportunity?.stage || 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Value</label>
                                <p class="text-secondary" x-text="opportunity?.value ? '$' + new Intl.NumberFormat().format(opportunity.value) : 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Probability</label>
                                <p class="text-secondary" x-text="opportunity?.probability ? opportunity.probability + '%' : 'N/A'"></p>
                            </div>
                            <div>
                                <label class="text-form-label">Expected Close Date</label>
                                <p class="text-secondary" x-text="opportunity?.expected_close_date || 'N/A'"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stakeholders Tab -->
                <div x-show="activeTab === 'stakeholders'" class="space-y-6">
                    <div>
                        <h4 class="text-section-title">Stakeholders</h4>
                        <div class="mt-4">
                            <div x-show="stakeholders.length > 0" class="space-y-3">
                                <template x-for="contact in stakeholders" :key="contact.id">
                                    <div class="card-padded">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="text-form-label">Name</label>
                                                <p class="text-secondary" x-text="contact.name"></p>
                                            </div>
                                            <div>
                                                <label class="text-form-label">Role</label>
                                                <p class="text-secondary" x-text="contact.role || 'N/A'"></p>
                                            </div>
                                            <div>
                                                <label class="text-form-label">Email</label>
                                                <p class="text-secondary">
                                                    <a x-show="contact.email" :href="'mailto:' + contact.email" 
                                                       class="text-link hover:underline" x-text="contact.email"></a>
                                                    <span x-show="!contact.email">N/A</span>
                                                </p>
                                            </div>
                                            <div>
                                                <label class="text-form-label">Phone</label>
                                                <p class="text-secondary">
                                                    <a x-show="contact.phone" :href="'tel:' + contact.phone" 
                                                       class="text-link hover:underline" x-text="contact.phone"></a>
                                                    <span x-show="!contact.phone">N/A</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="stakeholders.length === 0" class="text-empty-state">
                                No stakeholders found for this task.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div x-show="loading" class="flex items-center justify-center py-8">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                <button @click="saveTaskDetails()"
                        :disabled="saving || !hasChanges"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium sm:ml-3 sm:w-auto sm:text-sm transition-all duration-200"
                        :class="hasChanges ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving">Saving...</span>
                </button>
                <button @click="show = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Contact Detail Modal with Notes -->
<div x-data="{
        show: false,
        contactId: null,
        contact: {
            name: '',
            role: '',
            email: '',
            phone: '',
            opportunities: []
        },
        notes: [],
        newNote: '',
        loading: false,
        saving: false,
        
        async saveContactDetails() {
            if (!this.contact) return;
            this.saving = true;
            
            try {
                const response = await fetch(`/api/contacts/${this.contactId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: this.contact.name,
                        role: this.contact.role,
                        email: this.contact.email,
                        phone: this.contact.phone
                    })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to save contact');
                }
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('Failed to save contact');
            } finally {
                this.saving = false;
            }
        },
        
        async addContactNote() {
            if (!this.newNote.trim()) return;
            
            try {
                const response = await fetch('/api/notes/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.newNote,
                        entity_type: 'contact',
                        entity_id: this.contactId,
                        is_internal: true
                    })
                });
                
                if (response.ok) {
                    const newNote = await response.json();
                    this.notes.unshift(newNote);
                    this.newNote = '';
                } else {
                    alert('Failed to add note');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Failed to add note');
            }
        }
    }"
    @open-contact-detail-modal.window="show = true; contactId = $event.detail.contactId; loading = true; loadContactDetails(contactId)"
    @contact-details-loaded.window="contact = $event.detail.contact; notes = $event.detail.notes; loading = false"
    @close-modal.window="show = false"
    x-show="show"
    class="fixed inset-0 z-50 overflow-y-auto"
    style="display: none;"
    x-transition:enter="ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all max-w-4xl w-full mx-4">
            <!-- Header -->
            <div class="bg-white px-6 pt-6 pb-4 border-b border-gray-200">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-title-primary leading-6">Contact Details</h3>
                        <p class="text-metadata" x-show="contact" x-text="contact?.company_name || 'No company'"></p>
                    </div>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="bg-white px-6 py-4" x-show="!loading">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" x-show="contact">
                    <!-- Contact Details (Left Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Contact Information</h4>
                        
                        <div>
                            <label class="text-form-label">Name</label>
                            <input type="text" x-model="contact.name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Role</label>
                            <input type="text" x-model="contact.role"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="text-form-label">Email</label>
                                <input type="email" x-model="contact.email"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                            <div>
                                <label class="text-form-label">Phone</label>
                                <input type="tel" x-model="contact.phone"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        
                        <!-- Opportunities -->
                        <div x-show="contact?.opportunities?.length > 0">
                            <label class="text-form-label">Opportunities</label>
                            <div class="space-y-2">
                                <template x-for="opp in contact.opportunities" :key="opp.id">
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm" x-text="opp.name"></span>
                                        <span class="text-xs-gray-500" x-text="opp.stage"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section (Right Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Notes & Comments</h4>
                        
                        <!-- Add Note Form -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <textarea x-model="newNote"
                                      placeholder="Add a note or comment..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mb-2"
                                      rows="3"></textarea>
                            <button @click="addContactNote()"
                                    :disabled="!newNote.trim()"
                                    class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:bg-gray-400">
                                Add Note
                            </button>
                        </div>
                        
                        <!-- Notes List -->
                        <div class="max-h-64 overflow-y-auto space-y-3">
                            <template x-for="note in notes" :key="note.id">
                                <div class="bg-white p-3 border border-gray-200 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-xs-gray-500" x-text="formatDate(note.created_at)"></p>
                                        <div class="flex items-center space-x-1">
                                            <button @click="editNote(note)" class="text-xs-gray-400 hover:text-gray-600">Edit</button>
                                            <span class="text-xs-gray-300">|</span>
                                            <button @click="deleteNote(note.id)" class="text-xs-red-400 hover:text-red-600">Delete</button>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-900" x-text="note.content"></p>
                                </div>
                            </template>
                            <div x-show="notes.length === 0" class="text-center text-gray-500 py-8">
                                No notes yet. Add one above to get started.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div x-show="loading" class="flex items-center justify-center py-8">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                <button @click="saveContactDetails()"
                        :disabled="saving"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 disabled:bg-gray-400 sm:ml-3 sm:w-auto sm:text-sm">
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving">Saving...</span>
                </button>
                <button @click="show = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Enhanced Company Detail Modal with Notes -->
<div x-data="{
        show: false,
        companyId: null,
        company: {
            name: '',
            industry: '',
            website: ''
        },
        notes: [],
        newNote: '',
        loading: false,
        saving: false,
        
        async saveCompanyDetails() {
            if (!this.company) return;
            this.saving = true;
            
            try {
                const response = await fetch(`/api/companies/${this.companyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: this.company.name,
                        industry: this.company.industry,
                        website: this.company.website
                    })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to save company');
                }
            } catch (error) {
                console.error('Error saving company:', error);
                alert('Failed to save company');
            } finally {
                this.saving = false;
            }
        },
        
        async addCompanyNote() {
            if (!this.newNote.trim()) return;
            
            try {
                const response = await fetch('/api/notes/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.newNote,
                        entity_type: 'company',
                        entity_id: this.companyId,
                        is_internal: true
                    })
                });
                
                if (response.ok) {
                    const newNote = await response.json();
                    this.notes.unshift(newNote);
                    this.newNote = '';
                } else {
                    alert('Failed to add note');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Failed to add note');
            }
        }
    }"
    @open-company-detail-modal.window="show = true; companyId = $event.detail.companyId; loading = true; loadCompanyDetails(companyId)"
    @company-details-loaded.window="company = $event.detail.company; notes = $event.detail.notes; loading = false"
    @close-modal.window="show = false"
    x-show="show"
    class="fixed inset-0 z-50 overflow-y-auto"
    style="display: none;">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all max-w-4xl w-full mx-4">
            <!-- Header -->
            <div class="bg-white px-6 pt-6 pb-4 border-b border-gray-200">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-title-primary leading-6">Company Details</h3>
                        <p class="text-metadata" x-show="company" x-text="company?.industry || 'No industry specified'"></p>
                    </div>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="bg-white px-6 py-4" x-show="!loading">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" x-show="company">
                    <!-- Company Details (Left Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Company Information</h4>
                        
                        <div>
                            <label class="text-form-label">Company Name</label>
                            <input type="text" x-model="company.name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Industry</label>
                            <input type="text" x-model="company.industry"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Website</label>
                            <input type="url" x-model="company.website"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                    
                    <!-- Notes Section (Right Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Notes & Comments</h4>
                        
                        <!-- Add Note Form -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <textarea x-model="newNote"
                                      placeholder="Add a note or comment..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mb-2"
                                      rows="3"></textarea>
                            <button @click="addCompanyNote()"
                                    :disabled="!newNote.trim()"
                                    class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:bg-gray-400">
                                Add Note
                            </button>
                        </div>
                        
                        <!-- Notes List -->
                        <div class="max-h-64 overflow-y-auto space-y-3">
                            <template x-for="note in notes" :key="note.id">
                                <div class="bg-white p-3 border border-gray-200 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-xs-gray-500" x-text="formatDate(note.created_at)"></p>
                                        <div class="flex items-center space-x-1">
                                            <button @click="editNote(note)" class="text-xs-gray-400 hover:text-gray-600">Edit</button>
                                            <span class="text-xs-gray-300">|</span>
                                            <button @click="deleteNote(note.id)" class="text-xs-red-400 hover:text-red-600">Delete</button>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-900" x-text="note.content"></p>
                                </div>
                            </template>
                            <div x-show="notes.length === 0" class="text-center text-gray-500 py-8">
                                No notes yet. Add one above to get started.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div x-show="loading" class="flex items-center justify-center py-8">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                <button @click="saveCompanyDetails()"
                        :disabled="saving"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 disabled:bg-gray-400 sm:ml-3 sm:w-auto sm:text-sm">
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving">Saving...</span>
                </button>
                <button @click="show = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Opportunity Detail Modal with Notes -->
<div x-data="{
        show: false,
        opportunityId: null,
        opportunity: {
            name: '',
            value: '',
            probability: '',
            stage: '',
            expected_close_date: ''
        },
        notes: [],
        newNote: '',
        loading: false,
        saving: false,
        
        async saveOpportunityDetails() {
            if (!this.opportunity) return;
            this.saving = true;
            
            try {
                const response = await fetch(`/api/opportunities/${this.opportunityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: this.opportunity.name,
                        value: this.opportunity.value,
                        probability: this.opportunity.probability,
                        stage: this.opportunity.stage,
                        expected_close_date: this.opportunity.expected_close_date
                    })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to save opportunity');
                }
            } catch (error) {
                console.error('Error saving opportunity:', error);
                alert('Failed to save opportunity');
            } finally {
                this.saving = false;
            }
        },
        
        async addOpportunityNote() {
            if (!this.newNote.trim()) return;
            
            try {
                const response = await fetch('/api/notes/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.newNote,
                        entity_type: 'opportunity',
                        entity_id: this.opportunityId,
                        is_internal: true
                    })
                });
                
                if (response.ok) {
                    const newNote = await response.json();
                    this.notes.unshift(newNote);
                    this.newNote = '';
                } else {
                    alert('Failed to add note');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Failed to add note');
            }
        }
    }"
    @open-opportunity-detail-modal.window="show = true; opportunityId = $event.detail.opportunityId; loading = true; loadOpportunityDetails(opportunityId)"
    @opportunity-details-loaded.window="opportunity = $event.detail.opportunity; notes = $event.detail.notes; loading = false"
    @close-modal.window="show = false"
    x-show="show"
    class="fixed inset-0 z-50 overflow-y-auto"
    style="display: none;">
    
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all max-w-4xl w-full mx-4">
            <!-- Header -->
            <div class="bg-white px-6 pt-6 pb-4 border-b border-gray-200">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-title-primary leading-6">Opportunity Details</h3>
                        <p class="text-metadata" x-show="opportunity" x-text="opportunity?.company_name || 'No company'"></p>
                    </div>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="bg-white px-6 py-4" x-show="!loading">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" x-show="opportunity">
                    <!-- Opportunity Details (Left Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Opportunity Information</h4>
                        
                        <div>
                            <label class="text-form-label">Name</label>
                            <input type="text" x-model="opportunity.name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-form-label">Value ($)</label>
                                <input type="number" step="0.01" x-model="opportunity.value"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                            <div>
                                <label class="text-form-label">Probability (%)</label>
                                <input type="number" min="0" max="100" x-model="opportunity.probability"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-form-label">Stage</label>
                                <select x-model="opportunity.stage"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="prospect">Prospect</option>
                                    <option value="qualified">Qualified</option>
                                    <option value="proposal">Proposal</option>
                                    <option value="negotiation">Negotiation</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-form-label">Expected Close Date</label>
                                <input type="date" x-model="opportunity.expected_close_date"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section (Right Column) -->
                    <div class="space-y-4">
                        <h4 class="text-section-title">Notes & Comments</h4>
                        
                        <!-- Add Note Form -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <textarea x-model="newNote"
                                      placeholder="Add a note or comment..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mb-2"
                                      rows="3"></textarea>
                            <button @click="addOpportunityNote()"
                                    :disabled="!newNote.trim()"
                                    class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:bg-gray-400">
                                Add Note
                            </button>
                        </div>
                        
                        <!-- Notes List -->
                        <div class="max-h-64 overflow-y-auto space-y-3">
                            <template x-for="note in notes" :key="note.id">
                                <div class="bg-white p-3 border border-gray-200 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-xs-gray-500" x-text="formatDate(note.created_at)"></p>
                                        <div class="flex items-center space-x-1">
                                            <button @click="editNote(note)" class="text-xs-gray-400 hover:text-gray-600">Edit</button>
                                            <span class="text-xs-gray-300">|</span>
                                            <button @click="deleteNote(note.id)" class="text-xs-red-400 hover:text-red-600">Delete</button>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-900" x-text="note.content"></p>
                                </div>
                            </template>
                            <div x-show="notes.length === 0" class="text-center text-gray-500 py-8">
                                No notes yet. Add one above to get started.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div x-show="loading" class="flex items-center justify-center py-8">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                <button @click="saveOpportunityDetails()"
                        :disabled="saving"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 disabled:bg-gray-400 sm:ml-3 sm:w-auto sm:text-sm">
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving">Saving...</span>
                </button>
                <button @click="show = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

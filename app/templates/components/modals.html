<!-- Confirmation Modal Macro -->
{% macro confirmation_modal(modal_id, default_title="Confirm Action") %}
<div x-data="{ 
        show: false, 
        title: '{{ default_title }}', 
        message: '', 
        confirmText: 'Confirm', 
        confirmAction: null,
        confirmClass: 'bg-blue-600 hover:bg-blue-700'
     }" 
     @open-confirmation-modal.window="
        show = true; 
        title = $event.detail.title || '{{ default_title }}';
        message = $event.detail.message || '';
        confirmText = $event.detail.confirmText || 'Confirm';
        confirmAction = $event.detail.confirmAction;
        confirmClass = $event.detail.confirmClass || 'bg-blue-600 hover:bg-blue-700';
     "
     @close-confirmation-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="title"></h3>
                        <div class="mt-2">
                            <p class="text-secondary" x-text="message"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="confirmAction && confirmAction(); show = false" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-200"
                        :class="confirmClass"
                        x-text="confirmText">
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- Task Details Modal -->
<div x-data="{ show: false, taskId: null, task: null }" 
     @open-task-modal.window="show = true; taskId = $event.detail.taskId; loadTask(taskId)"
     @close-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto hidden"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="text-title-primary leading-6">Task Details</h3>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div x-show="task" class="space-y-4">
                    <div>
                        <label class="text-form-label">Description</label>
                        <textarea x-model="task?.description" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  rows="3"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Due Date</label>
                            <input type="date" x-model="task?.due_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Priority</label>
                            <select x-model="task?.priority" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-form-label">Next Step Type</label>
                        <select x-model="task?.next_step_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">None</option>
                            <option value="call">Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="demo">Demo</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="saveTask()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    Save Changes
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div x-data="{ show: false, task: { description: '', due_date: '', priority: 'medium', entity_type: '', entity_id: '' } }" 
     @open-new-task-modal.window="show = true; resetTask()"
     @close-modal.window="show = false"
     x-show="show" 
     class="fixed inset-0 z-50 overflow-y-auto hidden"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="show = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="text-title-primary leading-6">Create New Task</h3>
                    <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-form-label">Description*</label>
                        <textarea x-model="task.description" 
                                  placeholder="What needs to be done?"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                  rows="3" required></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Due Date</label>
                            <input type="date" x-model="task.due_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        
                        <div>
                            <label class="text-form-label">Priority</label>
                            <select x-model="task.priority" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-form-label">Related To</label>
                            <select x-model="task.entity_type" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">None</option>
                                <option value="company">Company</option>
                                <option value="contact">Contact</option>
                                <option value="opportunity">Opportunity</option>
                            </select>
                        </div>
                        
                        <div x-show="task.entity_type">
                            <label class="text-form-label">Select Item</label>
                            <select x-model="task.entity_id" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">Select...</option>
                                <!-- TODO: Populate dynamically based on entity_type -->
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-form-label">Next Step Type</label>
                        <select x-model="task.next_step_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">None</option>
                            <option value="call">Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="demo">Demo</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="createTask()" 
                        :disabled="!task.description"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 disabled:bg-gray-400 sm:ml-3 sm:w-auto sm:text-sm">
                    Create Task
                </button>
                <button @click="show = false" 
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Modal helper functions
async function loadTask(taskId) {
    try {
        const response = await fetch(`/tasks/${taskId}`);
        if (response.ok) {
            const task = await response.json();
            // Update Alpine data
            window.dispatchEvent(new CustomEvent('task-loaded', { detail: { task } }));
        }
    } catch (error) {
        console.error('Error loading task:', error);
    }
}

async function saveTask() {
    // TODO: Implement save functionality
    console.log('Saving task...');
    window.dispatchEvent(new CustomEvent('close-modal'));
}

async function createTask() {
    // TODO: Implement create functionality
    console.log('Creating task...');
    window.dispatchEvent(new CustomEvent('close-modal'));
}

function resetTask() {
    // Reset form data when opening new task modal
    return { 
        description: '', 
        due_date: '', 
        priority: 'medium', 
        entity_type: '', 
        entity_id: '',
        next_step_type: ''
    };
}

// Global modal functions
window.openTaskModal = function(taskId) {
    window.dispatchEvent(new CustomEvent('open-task-modal', { detail: { taskId } }));
};

window.openNewTaskModal = function() {
    window.dispatchEvent(new CustomEvent('open-new-task-modal'));
};

// Confirmation modal helper
window.showConfirmationModal = function(options) {
    window.dispatchEvent(new CustomEvent('open-confirmation-modal', { 
        detail: options 
    }));
};
</script>

<!-- Include the confirmation modal instance -->
{{ confirmation_modal("task-confirmation") }}
{% from "components/icons.html" import check_icon, pencil_icon, document_icon, trash_icon %}
{% from "components/list_section.html" import status_badge %}
{% from "components/metadata_display.html" import standard_card_metadata, format_date_with_status %}
{% from "components/expandable_card.html" import expandable_card, card_content_row, action_buttons_row %}
{% from "components/progress_bar.html" import task_progress_bar %}

{% macro render_task(task, group_key='', current_group_value='', indent_level=0) %}
{%- set child_class = 'border-l-4 border-l-blue-200' if task.task_type == 'child' else '' -%}
{%- set progress_config = {
    'enabled': task.task_type == 'parent',
    'type': 'completion',
    'value': task.child_tasks | selectattr('status', 'equalto', 'complete') | list | length,
    'max_value': task.child_tasks | length,
    'color_scheme': 'blue',
    'label': 'Tasks'
} if task.task_type == 'parent' else none -%}

<div style="margin-left: {{ indent_level * 20 }}px;">
{% call expandable_card('task', task, task.id,
                        expansion_enabled=true,
                        progress_config=progress_config,
                        group_key=group_key,
                        card_classes=child_class) %}
    <!-- Row 1: Priority badge, Company info, Reschedule buttons -->
    {{ card_content_row(
        badge_content='<span class="badge-standard badge-' + ('red' if task.priority == 'high' else 'yellow' if task.priority == 'medium' else 'green') + '">' + task.priority + '</span>',
        main_content=task_entity_info(task),
        action_content=reschedule_buttons(task)
    ) }}

    <!-- Row 2: Task type badge, Description -->
    {{ card_content_row(
        badge_content='<span class="badge-standard badge-gray">' + task.next_step_type + '</span>' if task.next_step_type else '',
        main_content=task_description(task),
        action_content=''
    ) }}

    <!-- Row 3: Metadata and Action buttons -->
    {{ card_content_row(
        badge_content='',
        main_content=task_metadata_section(task),
        action_content=action_buttons_row('task', task.id, disabled_condition='isEditing')
    ) }}

{% endcall %}
</div>
{% endmacro %}

{# Helper macros for task-specific content sections #}
{% macro task_entity_info(task) %}
{% if task.company_name or task.entity_name or task.stakeholder_opportunity_name or task.stakeholder_opportunity_value or task.all_company_names or task.all_contact_names or task.all_opportunity_names %}
    <div class="flex items-center flex-wrap gap-x-2">
        {# Primary entity display (backward compatibility) #}
        {% if task.company_name %}
            <span class="text-company-name">{{ task.company_name }}</span>
        {% endif %}
        
        {% if task.entity_name and task.entity_name != task.company_name %}
            {% if task.company_name %}<span class="text-title-primary">•</span>{% endif %}
            <span class="text-stakeholder-name">{{ task.entity_name }}</span>
        {% endif %}
        
        {% if task.stakeholder_opportunity_name %}
            {% if task.company_name or task.entity_name %}<span class="text-title-primary">•</span>{% endif %}
            <span class="text-opportunity-name">{{ task.stakeholder_opportunity_name }}</span>
        {% endif %}
        
        {% if task.stakeholder_opportunity_value %}
            {% if task.company_name or task.entity_name or task.stakeholder_opportunity_name %}<span class="text-title-primary">•</span>{% endif %}
            <span class="text-deal-amount-lg text-success">
                ${{ "{:,}".format(task.stakeholder_opportunity_value) }}
            </span>
        {% endif %}
        
        {# Related entities badges #}
        {% if task.all_company_names and task.all_company_names|length > 1 %}
            <span class="badge-standard badge-purple">+{{ task.all_company_names|length - 1 }} company</span>
        {% endif %}
        
        {% if task.all_contact_names %}
            {% set contact_count = task.all_contact_names|length %}
            {% if contact_count > 0 %}
                <span class="badge-standard badge-blue">{{ contact_count }} contact{{ 's' if contact_count > 1 }}</span>
            {% endif %}
        {% endif %}
        
        {% if task.all_opportunity_names and task.all_opportunity_names|length > 1 %}
            <span class="badge-standard badge-green">+{{ task.all_opportunity_names|length - 1 }} opp</span>
        {% endif %}
        
        <!-- Task type badges and status indicators -->
        {% if task.task_type == 'child' %}
            <span class="badge-standard badge-green">{{ task.task_type_badge }}</span>
        {% endif %}
        {% if task.task_type == 'child' and not task.can_start %}
            <span class="text-badge-warning">WAITING</span>
        {% endif %}
        {% if task.is_overdue %}
            <span class="text-badge-overdue">OVERDUE</span>
        {% endif %}
    </div>
{% endif %}
{% endmacro %}

{% macro task_description(task) %}
{% if task.company_name or task.entity_name or task.stakeholder_opportunity_name or task.stakeholder_opportunity_value %}
    <p class="text-sm text-gray-600">{{ task.description }}</p>
{% else %}
    <p class="text-label-primary">{{ task.description }}</p>
{% endif %}
{% endmacro %}

{% macro reschedule_buttons(task) %}
<div class="relative">
    <div class="flex items-center space-x-1">
        <button @click.stop="adjustDays(-7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button @click.stop="adjustDays(-1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button @click.stop="adjustDays(1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button @click.stop="adjustDays(7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
    
    <!-- Save/Cancel buttons (overlay below with absolute positioning) -->
    <div class="absolute top-full left-0 right-0 mt-2 flex items-center justify-center space-x-1" 
         x-show="showSaveButtons" 
         style="display: none;"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
        <button @click.stop="saveReschedule({{ task.id }}, pendingDays)" 
                class="px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors duration-200" 
                title="Save changes">
            Save
        </button>
        <button @click.stop="cancelChanges()" 
                class="px-3 py-1 rounded border text-gray-600 text-xs hover:bg-gray-50 transition-colors duration-200" 
                title="Cancel changes">
            Cancel
        </button>
    </div>
</div>
{% endmacro %}

{% macro task_metadata_section(task) %}
{# Standard metadata when not editing or no pending changes #}
<div x-show="!isEditing || pendingDays === 0">
    {{ standard_card_metadata(task, {
        'include_date': true,
        'today': task.due_date.today() if task.due_date else none,
        'include_details_link': true,
        'return_string': false
    }) }}
</div>

{# Due date section when editing with pending changes #}
<div x-show="isEditing && pendingDays !== 0" class="text-metadata">
    {# Custom due date display for editing mode #}
    {% if task.due_date %}
        Due: <span class="line-through text-gray-400">{{ task.due_date.strftime('%d/%m/%y') }}</span>
        <span class="text-blue-600 font-medium" x-text="getNewDueDate()"></span>
        (<span x-text="pendingDays > 0 ? '+' + pendingDays : pendingDays"></span> day<span x-text="Math.abs(pendingDays) === 1 ? '' : 's'"></span>)
        •
    {% endif %}
    
    {# Use macro for remaining metadata without date #}
    {{ standard_card_metadata(task, {
        'include_date': false,
        'include_details_link': true,
        'return_string': true
    }) }}
</div>
{% endmacro %}

{% macro render_task_hierarchy(task, group_key='', current_group_value='') %}
    <!-- Render parent task -->
    {{ render_task(task, group_key, current_group_value, 0) }}
    
    <!-- Render child tasks if this is a parent -->
    {% if task.task_type == 'parent' and task.child_tasks %}
        {% for child in task.child_tasks %}
            {% if show_completed or child.status != 'complete' %}
                {{ render_task(child, group_key, current_group_value, 1) }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}
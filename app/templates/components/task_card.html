{% from "components/icons.html" import check_icon, pencil_icon, document_icon %}
{% from "components/list_section.html" import status_badge %}
{% from "components/metadata_display.html" import standard_card_metadata, format_date_with_status %}
{% macro render_task(task, group_key='', current_group_value='', indent_level=0) %}
<div class="task-card card-padded" 
     data-task-id="{{ task.id }}"
     @click="expanded = !expanded; if (expanded) loadNotes()"
     @expand-all-tasks.window="if ($event.detail.group === '{{ group_key }}' && !expanded) { expanded = true; loadNotes(); }"
     @collapse-all-tasks.window="if ($event.detail.group === '{{ group_key }}' && expanded) { expanded = false; }"
     x-data="{ 
        pendingDays: 0, 
        isEditing: false,
        showSaveButtons: false,
        expanded: false,
        newComment: '',
        editingCommentId: null,
        editingCommentText: '',
        notes: [],
        notesLoaded: false,
        originalDueDate: '{{ task.due_date.strftime('%d/%m/%y') if task.due_date else '' }}',
        getNewDueDate() {
            if (!this.originalDueDate || this.pendingDays === 0) return this.originalDueDate;
            const date = new Date('{{ task.due_date.isoformat() if task.due_date else '' }}');
            date.setDate(date.getDate() + this.pendingDays);
            return date.toLocaleDateString('en-GB');
        },
        adjustDays(days) {
            this.pendingDays += days;
            this.isEditing = true;
            this.showSaveButtons = true;
        },
        cancelChanges() {
            this.pendingDays = 0;
            this.isEditing = false;
            this.showSaveButtons = false;
        },
        async loadNotes() {
            if (this.notesLoaded) return;
            
            try {
                const response = await fetch(`/api/tasks/{{ task.id }}/notes`);
                if (response.ok) {
                    this.notes = await response.json();
                    this.notesLoaded = true;
                } else {
                    console.error('Failed to load notes');
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        },
        startEditComment(commentId, currentText) {
            this.editingCommentId = commentId;
            this.editingCommentText = currentText;
        },
        cancelEditComment() {
            this.editingCommentId = null;
            this.editingCommentText = '';
        },
        async saveEditComment() {
            if (!this.editingCommentText.trim()) return;
            
            try {
                const response = await fetch(`/api/notes/${this.editingCommentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.editingCommentText
                    })
                });
                
                if (response.ok) {
                    // Update the note in the notes array
                    const noteIndex = this.notes.findIndex(note => note.id === this.editingCommentId);
                    if (noteIndex !== -1) {
                        this.notes[noteIndex].content = this.editingCommentText;
                    }
                    this.editingCommentId = null;
                    this.editingCommentText = '';
                } else {
                    alert('Failed to update comment');
                }
            } catch (error) {
                console.error('Error updating comment:', error);
                alert('Failed to update comment');
            }
        },
        async deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            try {
                const response = await fetch(`/api/notes/${commentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove the note from the notes array
                    this.notes = this.notes.filter(note => note.id !== commentId);
                } else {
                    alert('Failed to delete comment');
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment');
            }
        },
        async submitComment() {
            if (!this.newComment.trim()) return;
            
            try {
                const response = await fetch(`/api/tasks/{{ task.id }}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.newComment,
                        is_internal: true
                    })
                });
                
                if (response.ok) {
                    const newNote = await response.json();
                    // Add the new note to the front of the notes array
                    if (!this.notes) this.notes = [];
                    this.notes.unshift(newNote);
                    // Clear the form after successful submission
                    this.newComment = '';
                } else {
                    alert('Failed to add comment');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Failed to add comment');
            }
        }
     }"
     @reschedule-saved.window="cancelChanges()"
     :class="{ 'ring-2 ring-blue-200 bg-blue-50': isEditing }">
    
    <!-- Task description with badges and reschedule buttons -->
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2 flex-grow">
            {% set priority_color = 'red' if task.priority == 'high' else
                                  'yellow' if task.priority == 'medium' else
                                  'green' %}
            {{ status_badge(task.priority, priority_color) }}
            <p class="text-label-primary">{{ task.description | style_task_description }}</p>
            <div class="flex items-center space-x-2 flex-shrink-0">
                {% if task.next_step_type %}
                    <span class="text-badge-tag">{{ task.next_step_type }}</span>
                {% endif %}
                {% if task.is_overdue %}
                    <span class="text-badge-overdue">OVERDUE</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Reschedule buttons (top right) -->
        <div class="relative flex-shrink-0">
            <div class="flex items-center space-x-1">
                <button @click.stop="adjustDays(-7)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule -1 week">
                    -1w
                </button>
                <button @click.stop="adjustDays(-1)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule -1 day">
                    -1d
                </button>
                <button @click.stop="adjustDays(1)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule +1 day">
                    +1d
                </button>
                <button @click.stop="adjustDays(7)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule +1 week">
                    +1w
                </button>
            </div>
            
            <!-- Save/Cancel buttons (overlay below with absolute positioning) -->
            <div class="absolute top-full left-0 right-0 mt-2 flex items-center justify-center space-x-1" 
                 x-show="showSaveButtons" 
                 style="display: none;"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95">
                <button @click.stop="saveReschedule({{ task.id }}, pendingDays)" 
                        class="px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors duration-200" 
                        title="Save changes">
                    Save
                </button>
                <button @click.stop="cancelChanges()" 
                        class="px-3 py-1 rounded border text-gray-600 text-xs hover:bg-gray-50 transition-colors duration-200" 
                        title="Cancel changes">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Task metadata -->
    <div class="flex items-center justify-between">
        {# Standard metadata when not editing or no pending changes #}
        <div x-show="!isEditing || pendingDays === 0">
            {{ standard_card_metadata(task, {
                'include_date': true,
                'today': task.due_date.today() if task.due_date else none,
                'include_details_link': true,
                'return_string': false
            }) }}
        </div>
        
        {# Due date section when editing with pending changes #}
        <div x-show="isEditing && pendingDays !== 0" class="text-metadata">
            {# Custom due date display for editing mode #}
            {% if task.due_date %}
                Due: <span class="line-through text-gray-400">{{ task.due_date.strftime('%d/%m/%y') }}</span>
                <span class="text-blue-600 font-medium" x-text="getNewDueDate()"></span>
                (<span x-text="pendingDays > 0 ? '+' + pendingDays : pendingDays"></span> day<span x-text="Math.abs(pendingDays) === 1 ? '' : 's'"></span>)
                •
            {% endif %}
            
            {# Use macro for remaining metadata without date #}
            {{ standard_card_metadata(task, {
                'include_date': false,
                'include_details_link': true,
                'return_string': true
            }) }}
        </div>
        
        <!-- Action buttons at bottom right -->
        <div class="flex items-center space-x-1" :class="{ 'opacity-50 pointer-events-none': isEditing }">
            <button @click.stop="deleteTask({{ task.id }})" 
                    class="px-2 py-1 rounded text-danger-hover text-action-sm hover:bg-red-50 transition-colors duration-200" 
                    title="Delete task">
                ×
            </button>
            <button @click.stop="completeTask({{ task.id }})" 
                    class="px-2 py-1 rounded text-success-hover text-action-sm hover:bg-green-50 transition-colors duration-200" 
                    title="Complete task">
                {{ check_icon("w-4 h-4") }}
            </button>
        </div>
    </div>
    
    <!-- Expanded Comments Section -->
    <div x-show="expanded" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         class="mt-4 pt-4 border-t border-gray-100">
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-900">Comments & Notes</h4>
            
            <!-- Add Comment Form -->
            <div @click.stop>
                <textarea x-model="newComment"
                          placeholder="Add a comment..." 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mb-2"
                          rows="2"></textarea>
                <button @click.stop="submitComment()"
                        :disabled="!newComment.trim()"
                        class="px-3 py-2 text-sm rounded transition-all duration-200"
                        :class="newComment.trim() ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                    Save
                </button>
            </div>
            
            <!-- Comments List -->
            <div class="space-y-2 max-h-48 overflow-y-auto">
                <template x-for="note in notes" :key="note.id">
                    <div class="bg-gray-50 p-2 rounded text-sm">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs-gray-500" x-text="new Date(note.created_at).toLocaleString()"></span>
                            <div class="flex items-center space-x-1">
                                <button @click.stop="startEditComment(note.id, note.content)" class="text-xs-gray-400 hover:text-gray-600">Edit</button>
                                <span class="text-xs-gray-300">|</span>
                                <button @click.stop="deleteComment(note.id)" class="text-xs-red-400 hover:text-red-600">Delete</button>
                            </div>
                        </div>
                        <div x-show="editingCommentId === note.id" @click.stop>
                            <textarea x-model="editingCommentText" class="w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2" rows="2"></textarea>
                            <div class="flex space-x-2">
                                <button @click.stop="saveEditComment()" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Save</button>
                                <button @click.stop="cancelEditComment()" class="px-2 py-1 border border-gray-300 text-xs rounded hover:bg-gray-50">Cancel</button>
                            </div>
                        </div>
                        <p x-show="editingCommentId !== note.id" class="text-gray-700" x-text="note.content"></p>
                    </div>
                </template>
                
                <div x-show="notes.length === 0" class="text-center text-gray-500 text-sm py-4">
                    No comments yet. Add one above to get started.
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_task_hierarchy(task, group_key='', current_group_value='') %}
    <!-- Render parent task -->
    {{ render_task(task, group_key, current_group_value, 0) }}
    
    <!-- Render child tasks if this is a parent -->
    {% if task.task_type == 'parent' and task.child_tasks %}
        {% for child in task.child_tasks %}
            {% if show_completed or child.status != 'complete' %}
                {{ render_task(child, group_key, current_group_value, 1) }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}
{% from "components/icons.html" import check_icon %}
{% from "components/list_section.html" import status_badge %}
{% macro render_task(task) %}
<div class="task-card bg-white rounded-lg shadow-sm border p-4 mb-3" 
     data-task-id="{{ task.id }}"
     x-data="{ 
        pendingDays: 0, 
        isEditing: false,
        showSaveButtons: false,
        saveTimeout: null,
        originalDueDate: '{{ task.due_date.strftime('%d/%m/%y') if task.due_date else '' }}',
        getNewDueDate() {
            if (!this.originalDueDate || this.pendingDays === 0) return this.originalDueDate;
            const date = new Date('{{ task.due_date.isoformat() if task.due_date else '' }}');
            date.setDate(date.getDate() + this.pendingDays);
            return date.toLocaleDateString('en-GB');
        },
        adjustDays(days) {
            this.pendingDays += days;
            this.isEditing = true;
            
            // Clear existing timeout
            if (this.saveTimeout) {
                clearTimeout(this.saveTimeout);
            }
            
            // Show save buttons after 1 second of no activity
            this.saveTimeout = setTimeout(() => {
                this.showSaveButtons = true;
            }, 1000);
        },
        cancelChanges() {
            this.pendingDays = 0;
            this.isEditing = false;
            this.showSaveButtons = false;
            if (this.saveTimeout) {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = null;
            }
        }
     }"
     @reschedule-saved.window="cancelChanges()"
     :class="{ 'ring-2 ring-blue-200 bg-blue-50': isEditing }">
    
    <!-- Priority indicator -->
    <div class="flex items-center justify-between mb-2">
        <div class="flex items-center space-x-2">
            {% set priority_color = 'red' if task.priority == 'high' else
                                  'yellow' if task.priority == 'medium' else
                                  'green' %}
            {{ status_badge(task.priority, priority_color) }}
            {% if task.is_overdue %}
                <span class="text-badge-overdue">OVERDUE</span>
            {% endif %}
        </div>
        
        <!-- Quick actions -->
        <div class="flex items-center space-x-2">
            <!-- Reschedule buttons -->
            <div class="flex items-center space-x-1 border rounded-md px-1 py-0.5" 
                 x-show="!showSaveButtons">
                <button @click="adjustDays(-7)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule -1 week">
                    -1w
                </button>
                <button @click="adjustDays(-1)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule -1 day">
                    -1d
                </button>
                <button @click="adjustDays(1)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule +1 day">
                    +1d
                </button>
                <button @click="adjustDays(7)" 
                        class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                        title="Reschedule +1 week">
                    +1w
                </button>
            </div>
            
            <!-- Save/Cancel buttons (shown after delay) -->
            <div class="flex items-center space-x-1" x-show="showSaveButtons" x-transition>
                <button @click="saveReschedule({{ task.id }}, pendingDays)" 
                        class="px-2 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors duration-200" 
                        title="Save changes">
                    Save
                </button>
                <button @click="cancelChanges()" 
                        class="px-2 py-1 rounded border text-gray-600 text-xs hover:bg-gray-50 transition-colors duration-200" 
                        title="Cancel changes">
                    Cancel
                </button>
            </div>
            
            <!-- Action buttons (disabled when editing) -->
            <div class="flex items-center space-x-1" :class="{ 'opacity-50 pointer-events-none': isEditing }">
                <button onclick="deleteTask({{ task.id }})" 
                        class="px-2 py-1 rounded text-danger-hover text-action-sm hover:bg-red-50 transition-colors duration-200" 
                        title="Delete task">
                    ×
                </button>
                <button onclick="completeTask({{ task.id }})" 
                        class="px-2 py-1 rounded text-success-hover text-action-sm hover:bg-green-50 transition-colors duration-200" 
                        title="Complete task">
                    {{ check_icon("w-4 h-4") }}
                </button>
            </div>
        </div>
    </div>

    <!-- Task description -->
    <div class="mb-2">
        <p class="text-label-primary">{{ task.description }}</p>
    </div>

    <!-- Task metadata -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="text-metadata">
                {% if task.due_date %}
                    <!-- Show pending changes when editing -->
                    <span x-show="isEditing && pendingDays !== 0">
                        Due: 
                        <span class="line-through text-gray-400">{{ task.due_date.strftime('%d/%m/%y') }}</span>
                        <span class="text-blue-600 font-medium" x-text="getNewDueDate()"></span>
                        (<span x-text="pendingDays > 0 ? '+' + pendingDays : pendingDays"></span> day<span x-text="Math.abs(pendingDays) === 1 ? '' : 's'"></span>)
                    </span>
                    
                    <!-- Show normal date when not editing -->
                    <span x-show="!isEditing || pendingDays === 0">
                        Due: {{ task.due_date.strftime('%d/%m/%y') }}
                        {% if task.is_overdue %}
                            • {{ (task.due_date.today() - task.due_date).days }} day{{ 's' if (task.due_date.today() - task.due_date).days != 1 else '' }} ago
                        {% elif task.due_date > task.due_date.today() %}
                            • {{ (task.due_date - task.due_date.today()).days }} day{{ 's' if (task.due_date - task.due_date.today()).days != 1 else '' }} to go
                        {% endif %}
                    </span>
                {% endif %}
                {% if task.due_date and task.entity_name %} • {% endif %}
                {% if task.entity_name %}{{ task.entity_name }}{% endif %}
            </div>
            {% if task.next_step_type %}
                <span class="text-badge-tag">{{ task.next_step_type }}</span>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}
{% from 'macros/modals/base.html' import htmx_modal_overlay, htmx_modal_header %}
{% from 'macros/modals/field_filter.html' import render_filtered_fields %}
{% from 'macros/modals/footers.html' import render_view_footer, render_form_footer %}
{#
Unified WTForms Modal Template - DRY Refactored Version

This template renders create/edit/view forms using WTForms with HTMX.
Works with ModalService for consistent form handling.

Variables:
- form: WTForms form instance
- modal_title: Title for the modal
- action_url: URL to submit the form to
- model_name: Name of the model being created/edited
- is_edit: Boolean indicating if this is an edit operation
- entity: Entity object (for edit operations)
- mode: 'view', 'create', or 'edit'
#}

{% call htmx_modal_overlay(max_width="max-w-lg") %}
  {{ htmx_modal_header(modal_title, model_name) }}

  {% if mode == 'view' or is_view %}
    {# View Mode - Read Only #}
    <div id="modal-content-area" class="p-6 space-y-4 bg-white">
      {{ render_filtered_fields(form, mode='view') }}
    </div>
    {{ render_view_footer(model_name, entity_id) }}

  {% else %}
    {# Form Mode - Create/Edit #}
    <form method="POST"
          action="{{ action_url }}"
          hx-post="{{ action_url }}"
          hx-target=".modal-overlay"
          hx-swap="outerHTML"
          class="modal-form"
          id="modal-form">

      {{ form.hidden_tag() }}

      <div id="modal-content-area" class="p-6 space-y-4 bg-white">
        {# Global form errors #}
        {% if form.errors %}
          {% for field, errors in form.errors.items() %}
            {% if field == 'csrf_token' or field == '__all__' %}
              {% for error in errors %}
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Render filtered fields #}
        {{ render_filtered_fields(form, mode='form') }}
      </div>

      {{ render_form_footer() }}
    </form>
  {% endif %}
{% endcall %}

<script type="module" src="{{ url_for('static', filename='js/features/modal-validation.js') }}"></script>
{% from 'macros/forms.html' import render_filtered_fields %}
{% from 'macros/ui.html' import icon %}
{#
WTForms Modal Template - Clean DRY Version
Direct modal rendering without wrapper nonsense
#}

<div class="modal"
     x-data="{
         open: true,
         changed: false,
         isEdit: {{ is_edit|lower }},
         checkValidity() {
             if (this.isEdit) {
                 return this.changed;
             }
             const form = document.getElementById('{{ model_name }}-form');
             if (!form) return true;
             const requiredFields = form.querySelectorAll('[required]');
             for (let field of requiredFields) {
                 if (!field.value || field.value.trim() === '') {
                     return false;
                 }
             }
             return true;
         },
         close() {
             htmx.ajax('GET', '/modals/close', {target: '#{{ model_name }}-modal', swap: 'outerHTML'});
         }
     }"
     x-show="open"
     id="{{ model_name }}-modal"
     style="display: block;">

    <div class="modal-backdrop" @click="close()"></div>

    <div class="modal-content modal-content-md">
        <!-- Header -->
        <div class="modal-header">
            <h3 class="modal-title">
                {{ icon(model_name, size='5', class='inline-block mr-2') }}
                {{ modal_title }}
            </h3>
            <button type="button"
                    class="modal-close"
                    hx-get="/modals/close"
                    hx-swap="outerHTML"
                    hx-target="#{{ model_name }}-modal">
                {{ icon('x-mark') }}
            </button>
        </div>

        <!-- Body -->
        <div class="modal-body">
            {% if mode == 'view' %}
                <!-- View Mode -->
                <div class="form-fields">
                    {{ render_filtered_fields(form, mode='view') }}
                </div>
            {% else %}
                <!-- Form Mode -->
                <form id="{{ model_name }}-form"
                      @input="changed = true; $nextTick(() => $dispatch('validate'))"
                      @submit="changed = false"
                      hx-post="{{ action_url }}"
                      hx-target="#{{ model_name }}-modal"
                      hx-swap="outerHTML"
                      class="space-y-4">

                    {{ form.csrf_token }}

                    {% if form.errors %}
                    <div class="modal-message modal-message-error">
                        {% for field, errors in form.errors.items() %}
                            {% for error in errors %}
                                <p>{{ field }}: {{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {{ render_filtered_fields(form, mode='form') }}
                </form>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button type="button"
                    class="btn btn-secondary"
                    hx-get="/modals/close"
                    hx-swap="outerHTML"
                    hx-target="#{{ model_name }}-modal">
                Cancel
            </button>

            {% if mode == 'view' %}
            <button type="button"
                    class="btn btn-primary"
                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/edit"
                    hx-target="#{{ model_name }}-modal"
                    hx-swap="outerHTML">
                Edit
            </button>
            {% else %}
            <button type="submit"
                    form="{{ model_name }}-form"
                    x-bind:disabled="!checkValidity()"
                    @validate.window="$el.disabled = !checkValidity()"
                    class="btn btn-primary">
                {{ 'Save' if is_edit else 'Create' }}
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% from 'macros/forms.html' import render_filtered_fields, render_form_with_layout %}
{% from 'macros/ui.html' import icon %}
{#
WTForms Modal Template - Clean DRY Version
Direct modal rendering without wrapper nonsense
#}

{# Include HTMX and required JS if not already loaded (for standalone modal testing) #}
<script>
if (typeof htmx === 'undefined') {
    document.write('<script src="https://unpkg.com/htmx.org@2.0.3/dist/htmx.min.js"><\/script>');
}
</script>
<script>
if (typeof selectEntity === 'undefined') {
    document.write('<script src="{{ url_for('static', filename='js/features/search-widget.js') }}"><\/script>');
}
</script>

<div class="modal"
     x-data="{
         open: true,
         changed: false,
         isEdit: {{ is_edit|lower }},
         validationErrors: {},
         validationTimer: null,
         isValidating: false,
         taskCategory: 'opportunity',
         dragPosition: { x: 0, y: 0 },
         updateTaskFields(category) {
             this.taskCategory = category;
         },
         async validateField(fieldName, value) {
             // Clear previous timer
             if (this.validationTimer) {
                 clearTimeout(this.validationTimer);
             }

             // Don't validate empty values for non-required fields
             if (!value || value.trim() === '') {
                 delete this.validationErrors[fieldName];
                 return;
             }

             // Debounce validation
             this.validationTimer = setTimeout(async () => {
                 this.isValidating = true;
                 try {
                     const response = await fetch('/api/validate/{{ model_class.__tablename__ }}/' + fieldName, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify({
                             value: value,
                             entity_id: {{ entity_id if entity_id else 'null' }}
                         })
                     });

                     const result = await response.json();

                     if (result.valid) {
                         delete this.validationErrors[fieldName];
                     } else {
                         this.validationErrors[fieldName] = result.message;
                     }

                     // Trigger re-evaluation of button state
                     this.$dispatch('validation-complete');
                 } catch (error) {
                     console.error('Validation error:', error);
                 } finally {
                     this.isValidating = false;
                 }
             }, 500); // 500ms debounce
         },
         checkValidity() {
             if (this.isEdit) {
                 return this.changed && Object.keys(this.validationErrors).length === 0;
             }

             const form = document.getElementById('{{ model_name }}-form');
             if (!form) return true;

             // Check for validation errors
             if (Object.keys(this.validationErrors).length > 0) {
                 return false;
             }

             // Check required fields
             const requiredFields = form.querySelectorAll('[required]');
             for (let field of requiredFields) {
                 if (!field.value || field.value.trim() === '') {
                     return false;
                 }
             }
             return true;
         },
         close() {
             if (window.ModalDraggable) {
                 const modalContent = document.querySelector('#{{ model_name }}-modal .modal-content');
                 if (modalContent) window.ModalDraggable.resetModalPosition(modalContent);
             }
             htmx.ajax('GET', '/modals/close', {target: '#{{ model_name }}-modal', swap: 'outerHTML'});
         }
     }"
     x-show="open"
     id="{{ model_name }}-modal"
>

    <div class="modal-backdrop" @click="close()"></div>

    <div class="modal-content modal-content-md">
        <!-- Header -->
        <div class="modal-header">
            <h3 class="modal-title">
                {{ icon(model_name, size='5', class='inline-block mr-2') }}
                {{ modal_title }}
            </h3>
            <button type="button"
                    class="modal-close"
                    hx-get="/modals/close"
                    hx-swap="outerHTML"
                    hx-target="#{{ model_name }}-modal">
                {{ icon('x-mark') }}
            </button>
        </div>

        <!-- Body -->
        <div class="modal-body">
            {% if mode == 'view' %}
                {% if model_name.lower() == 'company' %}
                    <!-- Company View with Tabs -->
                    <div x-data="{ activeTab: 'about' }">
                        <!-- Tab Navigation -->
                        <div class="modal-nav">
                            <button class="modal-nav-item"
                                    :class="activeTab === 'about' ? 'modal-nav-item-active' : ''"
                                    @click="activeTab = 'about'"
                                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/tab/about"
                                    hx-target="#modal-tab-content"
                                    hx-swap="innerHTML"
                                    hx-trigger="click once">
                                About
                            </button>
                            <button class="modal-nav-item"
                                    :class="activeTab === 'team' ? 'modal-nav-item-active' : ''"
                                    @click="activeTab = 'team'"
                                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/tab/team"
                                    hx-target="#modal-tab-content"
                                    hx-swap="innerHTML"
                                    hx-trigger="click once">
                                Account Team
                            </button>
                            <button class="modal-nav-item"
                                    :class="activeTab === 'opportunities' ? 'modal-nav-item-active' : ''"
                                    @click="activeTab = 'opportunities'; console.log('üîç Modal Tab Debug: Clicked Opportunities tab for entity {{ entity_id }}, URL: /modals/{{ model_name }}/{{ entity_id }}/tab/opportunities')"
                                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/tab/opportunities"
                                    hx-target="#modal-tab-content"
                                    hx-swap="innerHTML"
                                    hx-trigger="click once">
                                Opportunities
                            </button>
                            <button class="modal-nav-item"
                                    :class="activeTab === 'stakeholders' ? 'modal-nav-item-active' : ''"
                                    @click="activeTab = 'stakeholders'"
                                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/tab/stakeholders"
                                    hx-target="#modal-tab-content"
                                    hx-swap="innerHTML"
                                    hx-trigger="click once">
                                Stakeholders
                            </button>
                        </div>

                        <!-- Tab Content Container -->
                        <div class="modal-tab-content" id="modal-tab-content">
                            <!-- Initial content loaded via HTMX on first tab click -->
                            <div class="modal-tab-loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug logging and trigger initial tab load -->
                    <script>
                        console.group('üîç Modal Debug: {{ model_name }} Modal for Entity {{ entity_id }}');
                        console.log('Modal opened for:', {
                            model_name: '{{ model_name }}',
                            entity_id: {{ entity_id if entity_id else 'null' }},
                            entity_name: {{ entity.name|tojson if entity and entity.name else '"N/A"' }},
                            mode: '{{ mode }}',
                            is_view: {{ is_view|lower if is_view is defined else 'false' }}
                        });

                        // Add HTMX event listeners for debugging
                        document.addEventListener('htmx:beforeRequest', function(event) {
                            if (event.target.closest('#{{ model_name }}-modal')) {
                                console.log('üîç HTMX Before Request:', {
                                    url: event.detail.requestConfig.path,
                                    method: event.detail.requestConfig.verb,
                                    target: event.detail.target.id,
                                    trigger: event.detail.triggeringEvent?.type
                                });
                            }
                        });

                        document.addEventListener('htmx:afterRequest', function(event) {
                            if (event.target.closest('#{{ model_name }}-modal')) {
                                console.log('üîç HTMX After Request:', {
                                    url: event.detail.requestConfig.path,
                                    status: event.detail.xhr.status,
                                    success: event.detail.successful,
                                    target: event.detail.target.id,
                                    response_size: event.detail.xhr.responseText?.length || 0
                                });

                                if (!event.detail.successful) {
                                    console.error('üö® HTMX Request Failed:', {
                                        status: event.detail.xhr.status,
                                        statusText: event.detail.xhr.statusText,
                                        response: event.detail.xhr.responseText?.substring(0, 500)
                                    });
                                }
                            }
                        });

                        document.addEventListener('htmx:responseError', function(event) {
                            if (event.target.closest('#{{ model_name }}-modal')) {
                                console.error('üö® HTMX Response Error:', {
                                    url: event.detail.requestConfig.path,
                                    status: event.detail.xhr.status,
                                    error: event.detail.xhr.responseText
                                });
                            }
                        });

                        console.groupEnd();

                        // Load the About tab immediately when modal opens
                        console.log('üîç Loading initial About tab for entity {{ entity_id }}');
                        htmx.ajax('GET', '/modals/{{ model_name }}/{{ entity_id }}/tab/about', '#modal-tab-content');
                    </script>
                {% else %}
                    <!-- Standard View Mode - Using unified layout renderer -->
                    <div class="form-fields">
                        {{ render_form_with_layout(form, mode='view') }}
                    </div>
                {% endif %}
            {% else %}
                <!-- Form Mode - Using unified layout renderer -->
                <form id="{{ model_name }}-form"
                      @input="changed = true;
                              // Trigger validation for name field on company forms
                              if ('{{ model_name.lower() }}' === 'company' && $event.target.name === 'name') {
                                  validateField('name', $event.target.value);
                              }
                              $nextTick(() => $dispatch('validate'))"
                      @submit="changed = false"
                      hx-post="{{ action_url }}"
                      hx-target="#{{ model_name }}-modal"
                      hx-swap="outerHTML"
                      class="space-y-4">

                    {{ form.csrf_token }}

                    {{ render_form_with_layout(form, mode='form') }}
                </form>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button type="button"
                    class="btn btn-secondary"
                    hx-get="/modals/close"
                    hx-swap="outerHTML"
                    hx-target="#{{ model_name }}-modal">
                Cancel
            </button>

            {% if mode == 'view' %}
            <button type="button"
                    class="btn btn-primary"
                    hx-get="/modals/{{ model_name }}/{{ entity_id }}/edit"
                    hx-target="#{{ model_name }}-modal"
                    hx-swap="outerHTML">
                Edit
            </button>
            {% else %}
            <button type="submit"
                    form="{{ model_name }}-form"
                    x-bind:disabled="!checkValidity()"
                    @validate.window="$el.disabled = !checkValidity()"
                    @validation-complete.window="$el.disabled = !checkValidity()"
                    class="btn btn-primary">
                {{ 'Save' if is_edit else 'Create' }}
            </button>
            {% endif %}
        </div>
    </div>
</div>
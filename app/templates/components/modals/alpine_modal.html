{% from 'macros/ui.html' import icon %}
{#
  Alpine.js Dynamic Modal Template

  Replaces wtforms_modal.html with client-side form rendering.
  Works with formBuilder.js Alpine.js component.
#}
<div x-data="formBuilder({ modelName: '{{ model_name }}', entityId: {{ entity_id or 'null' }}, formType: '{{ form_type or 'create' }}' })"
     x-show="isOpen"
     x-cloak
     @open-modal.window="openModal($event.detail.type, $event.detail.id)"
     class="modal">

    <!-- Modal Backdrop -->
    <div x-show="isOpen"
         @click="closeModal()"
         class="modal-backdrop"></div>

    <!-- Modal Content -->
    <div x-show="isOpen"
         @click.stop
         class="modal-content modal-content-md">

        <!-- Enhanced Loading State -->
        <div x-show="loading" class="modal-loading">
            <div class="modal-spinner"></div>
        </div>

        <!-- Form Content -->
        <div x-show="!loading && formConfig">

            <!-- Modal Header -->
            <div class="modal-header">
                <h3 x-text="title" class="modal-title"></h3>
                <button @click="closeModal()" class="modal-close">
                    {{ icon('x-mark', 'lg') }}
                </button>
            </div>

            <!-- Form Body -->
            <div class="modal-body">

                <!-- General Error with icon -->
                <div x-show="errors.general" class="form-error-message">
                    {{ icon('exclamation-circle', 'md') }}
                    <span x-text="errors.general"></span>
                </div>

                <!-- Dynamic Form Fields -->
                <div>
                    <template x-for="field in fields" :key="field.name || field.type">

                        <!-- Text Input Fields -->
                        <div x-show="isTextField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <input :type="field.type"
                                   :id="field.name"
                                   :name="field.name"
                                   :placeholder="field.placeholder"
                                   :required="field.required"
                                   x-model="formData[field.name]"
                                   @blur="validateField(field.name)"
                                   :class="{'error': errors[field.name]}"
                                   class="form-input">
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Select Fields -->
                        <div x-show="isSelectField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <!-- Fast native select for modal performance -->
                            <select :id="field.name"
                                    :name="field.name"
                                    :required="field.required"
                                    x-model="formData[field.name]"
                                    @change="validateField(field.name)"
                                    :class="{'error': errors[field.name]}"
                                    class="form-select">
                                <template x-for="option in field.options" :key="option.value">
                                    <option :value="option.value" x-text="option.label"></option>
                                </template>
                            </select>
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Textarea Fields -->
                        <div x-show="isTextareaField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <textarea :id="field.name"
                                      :name="field.name"
                                      :placeholder="field.placeholder"
                                      :required="field.required"
                                      x-model="formData[field.name]"
                                      @blur="validateField(field.name)"
                                      :rows="field.rows || 3"
                                      :class="{'error': errors[field.name]}"
                                      class="form-textarea"></textarea>
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Grid Layout Fields -->
                        <div x-show="isGridField(field)" class="space-y-4">
                            <div :class="`grid grid-cols-${field.columns || 2} gap-4`">
                                <template x-for="subField in field.fields" :key="subField.name">
                                    <div class="form-field">
                                        <label :for="subField.name"
                                               x-text="subField.label"
                                               :class="{'form-label-required': subField.required}"
                                               class="form-label"></label>

                                        <!-- Sub-field input (simplified - could be extended) -->
                                        <input :type="subField.type"
                                               :id="subField.name"
                                               :name="subField.name"
                                               :placeholder="subField.placeholder"
                                               :required="subField.required"
                                               x-model="formData[subField.name]"
                                               @blur="validateField(subField.name)"
                                               :class="{'error': errors[subField.name]}"
                                               class="form-input">

                                        <p x-show="errors[subField.name]"
                                           x-text="errors[subField.name]"
                                           class="form-error"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </template>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button @click="closeModal()"
                        :disabled="saving"
                        class="modal-btn modal-btn-cancel">
                    Cancel
                </button>
                <button @click="submitForm()"
                        :disabled="saving || Object.keys(errors).length > 0"
                        class="modal-btn modal-btn-primary">
                    <span x-show="!saving">Save</span>
                    <span x-show="saving" class="modal-btn-loading">
                        {{ icon('spinner', 'sm') }}
                        Saving...
                    </span>
                </button>
            </div>

        </div>
    </div>
</div>

<script type="module" src="{{ url_for('static', filename='js/alpine/formBuilder.js') }}"></script>
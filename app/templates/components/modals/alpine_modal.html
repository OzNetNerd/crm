{% from 'macros/base/icons.html' import icon %}
{#
  Alpine.js Dynamic Modal Template

  Replaces wtforms_modal.html with client-side form rendering.
  Works with formBuilder.js Alpine.js component.
#}
<div x-data="formBuilder({ modelName: '{{ model_name }}', entityId: {{ entity_id or 'null' }}, formType: '{{ form_type or 'create' }}' })"
     x-show="isOpen"
     x-cloak
     @open-modal.window="openModal($event.detail.type, $event.detail.id)"
     class="fixed inset-0 z-50 flex items-center justify-center">

    <!-- Modal Backdrop -->
    <div x-show="isOpen"
         @click="closeModal()"
         class="fixed inset-0 bg-gray-900/60"></div>

    <!-- Modal Content -->
    <div x-show="isOpen"
         @click.stop
         class="relative bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden border border-gray-200">

        <!-- Enhanced Loading State -->
        <div x-show="loading" class="p-8 text-center">
            <div class="inline-flex items-center justify-center w-12 h-12 mb-4 bg-blue-100 rounded-full">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            </div>
            <p class="text-gray-600 font-medium">Loading form...</p>
            <p class="text-sm text-gray-500 mt-1">Please wait</p>
        </div>

        <!-- Form Content -->
        <div x-show="!loading && formConfig" class="flex flex-col max-h-[90vh]">

            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center">
                    <div class="text-2xl mr-3">
                        <i :class="`icon-${modelName}`" class="text-blue-600"></i>
                    </div>
                    <h3 x-text="title" class="text-lg font-semibold text-gray-900"></h3>
                </div>
                <button @click="closeModal()"
                        class="text-gray-400 hover:text-gray-600">
                    {{ icon('x-mark', 'lg') }}
                </button>
            </div>

            <!-- Form Body -->
            <div class="flex-1 overflow-y-auto p-6">

                <!-- General Error with icon -->
                <div x-show="errors.general"
                     class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-4 flex items-start">
                    {{ icon('exclamation-circle', 'md', 'text-red-500 mr-2 mt-0.5 flex-shrink-0') }}
                    <span x-text="errors.general"></span>
                </div>

                <!-- Dynamic Form Fields -->
                <div class="space-y-4">
                    <template x-for="field in fields" :key="field.name || field.type">

                        <!-- Text Input Fields -->
                        <div x-show="isTextField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <input :type="field.type"
                                   :id="field.name"
                                   :name="field.name"
                                   :placeholder="field.placeholder"
                                   :required="field.required"
                                   x-model="formData[field.name]"
                                   @blur="validateField(field.name)"
                                   :class="{'error': errors[field.name]}"
                                   class="form-input">
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Select Fields -->
                        <div x-show="isSelectField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <!-- Fast native select for modal performance -->
                            <select :id="field.name"
                                    :name="field.name"
                                    :required="field.required"
                                    x-model="formData[field.name]"
                                    @change="validateField(field.name)"
                                    :class="{'error': errors[field.name]}"
                                    class="form-select">
                                <template x-for="option in field.options" :key="option.value">
                                    <option :value="option.value" x-text="option.label"></option>
                                </template>
                            </select>
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Textarea Fields -->
                        <div x-show="isTextareaField(field)" class="form-field">
                            <label :for="field.name"
                                   x-text="field.label"
                                   :class="{'form-label-required': field.required}"
                                   class="form-label"></label>
                            <textarea :id="field.name"
                                      :name="field.name"
                                      :placeholder="field.placeholder"
                                      :required="field.required"
                                      x-model="formData[field.name]"
                                      @blur="validateField(field.name)"
                                      :rows="field.rows || 3"
                                      :class="{'error': errors[field.name]}"
                                      class="form-textarea"></textarea>
                            <p x-show="errors[field.name]"
                               x-text="errors[field.name]"
                               class="form-error"></p>
                        </div>

                        <!-- Grid Layout Fields -->
                        <div x-show="isGridField(field)" class="space-y-4">
                            <div :class="`grid grid-cols-${field.columns || 2} gap-4`">
                                <template x-for="subField in field.fields" :key="subField.name">
                                    <div class="form-field">
                                        <label :for="subField.name"
                                               x-text="subField.label"
                                               :class="{'form-label-required': subField.required}"
                                               class="form-label"></label>

                                        <!-- Sub-field input (simplified - could be extended) -->
                                        <input :type="subField.type"
                                               :id="subField.name"
                                               :name="subField.name"
                                               :placeholder="subField.placeholder"
                                               :required="subField.required"
                                               x-model="formData[subField.name]"
                                               @blur="validateField(subField.name)"
                                               :class="{'error': errors[subField.name]}"
                                               class="form-input">

                                        <p x-show="errors[subField.name]"
                                           x-text="errors[subField.name]"
                                           class="form-error"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </template>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button @click="closeModal()"
                        :disabled="saving"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 shadow-sm">
                    Cancel
                </button>
                <button @click="submitForm()"
                        :disabled="saving || Object.keys(errors).length > 0"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">
                    <span x-show="!saving">Save</span>
                    <span x-show="saving" class="flex items-center">
                        {{ icon('spinner', 'sm', 'animate-spin -ml-1 mr-2 text-white') }}
                        Saving...
                    </span>
                </button>
            </div>

        </div>
    </div>
</div>

<script type="module" src="{{ url_for('static', filename='js/alpine/formBuilder.js') }}"></script>
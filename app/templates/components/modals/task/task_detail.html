{% from "components/modals/base/modal_base.html" import base_modal, modal_header, modal_footer %}
{% from "components/modals/base/notes_section.html" import notes_section %}
{% from "components/modals/base/crud_operations.html" import crud_operations_js, notes_operations_js %}

<div x-data="{
        show: false,
        taskId: null,
        loading: false,
        saving: false,
        activeTab: 'details',
        task: {
            description: '',
            due_date: '',
            priority: 'medium',
            next_step_type: '',
            status: 'pending',
            task_type: 'single',
            child_tasks: []
        },
        notes: [],
        newNote: '',
        
        {{ crud_operations_js('task', '/api/tasks') }},
        {{ notes_operations_js('task') }},
        
        async loadTask(id) {
            await this.loadTaskDetails(id);
            this.show = true;
        },
        
        async toggleChildTask(childId) {
            try {
                const response = await fetch(`/api/tasks/${childId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Reload task to get updated child status
                    await this.loadTaskDetails(this.taskId);
                }
            } catch (error) {
                console.error('Error toggling child task:', error);
            }
        }
     }" 
     @open-task-detail-modal.window="loadTask($event.detail.taskId)"
     @close-modal.window="show = false">

    {% call base_modal('task-detail-modal', backdrop_click_close=false) %}
        {{ modal_header('Task Details') }}
        
        <div x-show="loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
        
        <div x-show="!loading && task" class="space-y-4">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button @click="activeTab = 'details'" 
                            :class="activeTab === 'details' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Details
                    </button>
                    <button @click="activeTab = 'subtasks'" 
                            x-show="task.task_type === 'parent'"
                            :class="activeTab === 'subtasks' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Sub-tasks
                        <span class="ml-1 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs" x-text="task.child_tasks ? task.child_tasks.length : 0"></span>
                    </button>
                    <button @click="activeTab = 'notes'" 
                            :class="activeTab === 'notes' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Notes
                        <span class="ml-1 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs" x-text="notes.length"></span>
                    </button>
                </nav>
            </div>
            
            <!-- Details Tab -->
            <div x-show="activeTab === 'details'" class="space-y-4">
                <div>
                    <label class="text-form-label">Description</label>
                    <textarea x-model="task.description" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              rows="3"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-form-label">Due Date</label>
                        <input type="date" x-model="task.due_date" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="text-form-label">Priority</label>
                        <select x-model="task.priority" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-form-label">Next Step Type</label>
                        <select x-model="task.next_step_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">None</option>
                            <option value="call">Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="demo">Demo</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-form-label">Status</label>
                        <select x-model="task.status" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="complete">Complete</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Subtasks Tab -->
            <div x-show="activeTab === 'subtasks'" class="space-y-3">
                <template x-for="childTask in task.child_tasks" :key="childTask.id">
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-grow">
                                <input type="checkbox" 
                                       :checked="childTask.status === 'complete'"
                                       @change="toggleChildTask(childTask.id)"
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300">
                                <div class="flex-grow">
                                    <p class="text-sm font-medium text-gray-900" x-text="childTask.description"></p>
                                    <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                                        <span x-show="childTask.due_date" x-text="new Date(childTask.due_date).toLocaleDateString()"></span>
                                        <span class="capitalize" x-text="childTask.priority"></span>
                                        <span x-show="childTask.next_step_type" class="uppercase" x-text="childTask.next_step_type"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span :class="childTask.status === 'complete' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                      class="px-2 py-1 text-xs font-medium rounded-full capitalize" 
                                      x-text="childTask.status.replace('_', ' ')"></span>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div x-show="!task.child_tasks || task.child_tasks.length === 0" 
                     class="text-gray-500 text-sm italic text-center py-4">
                    No sub-tasks
                </div>
            </div>
            
            <!-- Notes Tab -->
            <div x-show="activeTab === 'notes'">
                {{ notes_section('task') }}
            </div>
        </div>
        
        {{ modal_footer(save_action="saveTaskDetails()", save_text="Save Changes") }}
    {% endcall %}
</div>
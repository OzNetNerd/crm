{% from "components/modals/base/modal_base.html" import base_modal, modal_header, modal_footer %}
{% from "components/modals/base/form_fields.html" import text_input, select_input, url_input, tel_input, textarea_input, date_input, email_input %}

{% macro generic_new_modal(entity_type, config) %}
<div x-data="createCRUDMixin('{{ entity_type }}', {{ config.default_values | tojson }}, {
            {% if config.required_fields %}
            getRequiredFields() {
                return {{ config.required_fields | tojson }};
            },
            {% endif %}
            
            {% if config.custom_methods %}
            {{ config.custom_methods }},
            {% endif %}
            
            async saveNew{{ entity_type|title }}() {
                return await this.saveEntity();
            }
        })" 
     @open-new-{{ entity_type }}-modal.window="openModal(); resetForm()"
     @close-modal.window="closeModal()">

    {% call base_modal('new-' + entity_type + '-modal', backdrop_click_close=false) %}
        {{ modal_header(config.title) }}
        
        <div class="{{ config.spacing_class | default('space-y-4') }}">
            {{ render_form_fields(entity_type, config.fields) }}
        </div>
        
        {{ modal_footer(save_action="saveNew" + entity_type|title + "()", save_text=config.save_text | default("Create " + entity_type|title)) }}
    {% endcall %}
</div>
{% endmacro %}

{% macro render_form_fields(entity_type, fields) %}
    {% for field in fields %}
        {% if field.type == 'text' %}
            {{ text_input(field.name, field.label, entity_type + "." + field.name, field.placeholder | default(""), field.required | default(false)) }}
        {% elif field.type == 'email' %}
            {{ email_input(field.name, field.label, entity_type + "." + field.name, field.placeholder | default("email@example.com"), field.required | default(false)) }}
        {% elif field.type == 'tel' %}
            {{ tel_input(field.name, field.label, entity_type + "." + field.name, field.placeholder | default("Phone number"), field.required | default(false)) }}
        {% elif field.type == 'url' %}
            {{ url_input(field.name, field.label, entity_type + "." + field.name, field.placeholder | default("https://example.com"), field.required | default(false)) }}
        {% elif field.type == 'textarea' %}
            {{ textarea_input(field.name, field.label, entity_type + "." + field.name, field.placeholder | default(""), field.rows | default(2), field.required | default(false)) }}
        {% elif field.type == 'date' %}
            {{ date_input(field.name, field.label, entity_type + "." + field.name, field.required | default(false)) }}
        {% elif field.type == 'select' %}
            {{ select_input(field.name, field.label, entity_type + "." + field.name, field.options, field.required | default(false), field.empty_option | default("")) }}
        {% elif field.type == 'grid' %}
            <div class="{{ field.grid_class | default('grid grid-cols-2 gap-4') }}">
                {% for subfield in field.fields %}
                    <div>{{ render_form_fields(entity_type, [subfield]) }}</div>
                {% endfor %}
            </div>
        {% elif field.type == 'custom' %}
            {{ field.template | safe }}
        {% endif %}
    {% endfor %}
{% endmacro %}
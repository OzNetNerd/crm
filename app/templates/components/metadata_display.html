{% macro format_date_with_status(date_value, date_label="Due", today=none) %}
    {% if date_value %}
        {% set is_overdue = today and date_value < today %}
        {% set is_today = today and date_value == today %}
        
        <span class="{{ 'text-red-600' if is_overdue else 'text-gray-500' }}">
            {{ date_label }}: {{ date_value.strftime('%d/%m/%y') }}
            {% if is_overdue %}
                • {{ (today - date_value).days }} day{{ 's' if (today - date_value).days != 1 else '' }} ago
            {% elif is_today %}
                • Due today
            {% elif today and date_value > today %}
                • {{ (date_value - today).days }} day{{ 's' if (date_value - today).days != 1 else '' }} to go
            {% endif %}
        </span>
    {% endif %}
{% endmacro %}

{% macro entity_link_display(entity_name, entity_type=none) %}
    {% if entity_name %}
        {% if entity_type == 'company' %}
            <span class="text-metadata">{{ entity_name }}</span>
        {% elif entity_type == 'contact' %}
            <span class="text-metadata">{{ entity_name }}</span>
        {% elif entity_type == 'opportunity' %}
            <span class="text-metadata">{{ entity_name }}</span>
        {% else %}
            <span class="text-metadata">{{ entity_name }}</span>
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro contact_count_display(contacts) %}
    {% if contacts %}
        {{ contacts|length }} contact{{ 's' if contacts|length != 1 else '' }}
        {% if contacts|length <= 3 %}
            ({% for contact in contacts %}{{ contact.name }}{% if not loop.last %}, {% endif %}{% endfor %})
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro age_display(age_value, age_label="days old") %}
    {% if age_value is defined and age_value is not none %}
        {{ age_value }} {{ age_label }}
    {% endif %}
{% endmacro %}

{% macro metadata_separator() %}•{% endmacro %}

{% macro build_metadata_parts(parts_list) %}
    {% for part in parts_list %}
        {% if part %}{{ part | safe }}{% if not loop.last %} {{ metadata_separator() }} {% endif %}{% endif %}
    {% endfor %}
{% endmacro %}

{% macro standard_card_metadata(entity_data, options={}) %}
    {% set metadata_parts = [] %}
    
    {# Company Name #}
    {% if entity_data.company_name %}
        {% set _ = metadata_parts.append(entity_data.company_name) %}
    {% elif entity_data.company and entity_data.company.name %}
        {% set _ = metadata_parts.append(entity_data.company.name) %}
    {% endif %}
    
    {# Opportunity Name #}
    {% if entity_data.opportunity_name %}
        {% set _ = metadata_parts.append(entity_data.opportunity_name) %}
    {% elif entity_data.name and options.get('entity_type') == 'opportunity' %}
        {% set _ = metadata_parts.append(entity_data.name) %}
    {% endif %}
    
    {# Opportunity Stage #}
    {% if entity_data.opportunity_stage %}
        {% set _ = metadata_parts.append(entity_data.opportunity_stage|title) %}
    {% elif entity_data.stage and options.get('entity_type') == 'opportunity' %}
        {% set _ = metadata_parts.append(entity_data.stage|title) %}
    {% endif %}
    
    {# Opportunity Size #}
    {% if entity_data.value %}
        {% set _ = metadata_parts.append('$' + "{:,.0f}".format(entity_data.value)) %}
    {% elif entity_data.opportunity_value %}
        {% set _ = metadata_parts.append('$' + "{:,.0f}".format(entity_data.opportunity_value)) %}
    {% endif %}
    
    {# Stakeholder Name #}
    {% if entity_data.entity_name and entity_data.entity_type == 'contact' %}
        {% set _ = metadata_parts.append(entity_data.entity_name) %}
    {% elif entity_data.name and options.get('entity_type') == 'contact' %}
        {% set _ = metadata_parts.append(entity_data.name) %}
    {% elif entity_data.contacts and entity_data.contacts|length == 1 %}
        {% set _ = metadata_parts.append(entity_data.contacts[0].name) %}
    {% endif %}
    
    {# Additional context items if specified in options #}
    {% if options.get('include_date') and entity_data.due_date %}
        {% set date_part = format_date_with_status(entity_data.due_date, "Due", options.get('today')) %}
        {% set _ = metadata_parts.insert(0, date_part) %}
    {% endif %}
    
    {% if options.get('include_contact_count') and entity_data.contacts and entity_data.contacts|length > 1 %}
        {% set _ = metadata_parts.append(contact_count_display(entity_data.contacts)) %}
    {% endif %}
    
    {% if options.get('include_age') and entity_data.deal_age is defined %}
        {% set _ = metadata_parts.append(age_display(entity_data.deal_age)) %}
    {% endif %}
    
    {# Details link #}
    {% if options.get('include_details_link') and entity_data.id %}
        {% set details_onclick = options.get('details_onclick', 'openTaskDetailModal(' + entity_data.id|string + ')') %}
        {% set _ = metadata_parts.append('<span class="text-link-interactive" onclick="event.stopPropagation(); ' + details_onclick + '">Details</span>') %}
    {% endif %}
    
    {% if options.get('return_string') %}
        {{ build_metadata_parts(metadata_parts) }}
    {% else %}
        <div class="text-metadata">
            {{ build_metadata_parts(metadata_parts) }}
        </div>
    {% endif %}
{% endmacro %}
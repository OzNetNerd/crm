{% from "components/icons.html" import check_icon %}
{% from "components/list_section.html" import status_badge %}
{% from "components/expandable_card.html" import expandable_card, card_content_row, action_buttons_row %}
{% from "components/metadata_display.html" import standard_card_metadata, format_date_with_status %}

{% macro render_opportunity(opportunity, today) %}
{% set progress_config = {
    'enabled': opportunity.probability is not none,
    'type': 'probability', 
    'value': opportunity.probability or 0,
    'color_scheme': 'blue',
    'size': 'md'
} %}

{% call expandable_card('opportunity', opportunity, opportunity.id, 
                        expansion_enabled=true,
                        progress_config=progress_config,
                        card_classes='mb-3',
                        expanded_content=opportunity_expanded_content(opportunity, today)) %}
    
    <!-- Opportunity header with value and stage -->
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2 flex-grow">
            {% set stage_color = 'green' if opportunity.stage == 'prospect' else
                                'blue' if opportunity.stage == 'qualified' else
                                'yellow' if opportunity.stage == 'proposal' else
                                'orange' if opportunity.stage == 'negotiation' else
                                'gray' %}
            {{ status_badge(opportunity.stage, stage_color) }}
            <h3 class="text-opportunity-name">{{ opportunity.name }}</h3>
            
            {% if opportunity.value %}
                <div class="text-deal-amount-lg text-success">
                    ${{ "{:,.0f}".format(opportunity.value) }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Company info -->
    <div class="mb-2">
        <div class="text-secondary">
            <span class="text-company-name">{{ opportunity.company.name }}</span>
        </div>
    </div>

    <!-- Opportunity metadata and actions -->
    <div class="flex items-center justify-between">
        <div class="text-metadata">
            {# Close date with status #}
            {% if opportunity.expected_close_date %}
                <span class="{{ 'text-red-600' if opportunity.expected_close_date < today else 'text-gray-500' }}">
                    {{ format_date_with_status(opportunity.expected_close_date, "Close", today) }}
                </span>
            {% endif %}
            
            {# Standard metadata #}
            {% if opportunity.expected_close_date %} â€¢ {% endif %}
            {{ standard_card_metadata(opportunity, {'entity_type': 'opportunity', 'include_contact_count': true, 'include_age': true}) }}
        </div>
        
        <!-- Action buttons -->
        {{ action_buttons_row('opportunity', opportunity.id) }}
    </div>
    
{% endcall %}
{% endmacro %}

{% macro opportunity_expanded_content(opportunity, today) %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Deal Details -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Deal Information</h4>
        <div class="space-y-2 text-sm">
            {% if opportunity.value %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Deal Value:</span>
                    <span class="text-deal-amount font-semibold">${{ "{:,.0f}".format(opportunity.value) }}</span>
                </div>
            {% endif %}
            {% if opportunity.probability %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Success Probability:</span>
                    <span class="text-blue-600 font-medium">{{ opportunity.probability }}%</span>
                </div>
            {% endif %}
            {% if opportunity.expected_close_date %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Expected Close:</span>
                    <span class="{{ 'text-red-600' if opportunity.expected_close_date < today else 'text-gray-700' }}">
                        {{ opportunity.expected_close_date.strftime('%B %d, %Y') }}
                    </span>
                </div>
            {% endif %}
            <div class="flex items-center justify-between">
                <span class="text-gray-600">Stage:</span>
                <span class="badge-standard badge-{{ 'green' if opportunity.stage == 'prospect' else 'blue' if opportunity.stage == 'qualified' else 'yellow' if opportunity.stage == 'proposal' else 'orange' if opportunity.stage == 'negotiation' else 'gray' }}">
                    {{ opportunity.stage|title }}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Quick Actions</h4>
        <div class="flex flex-wrap gap-2">
            <button @click.stop="createTask({{ opportunity.id }})" 
                    class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm hover:bg-blue-200 transition-colors">
                Add Task
            </button>
            <button @click.stop="updateStage({{ opportunity.id }})" 
                    class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm hover:bg-green-200 transition-colors">
                Update Stage
            </button>
            <button @click.stop="scheduleFollowUp({{ opportunity.id }})" 
                    class="px-3 py-1 bg-purple-100 text-purple-800 rounded-md text-sm hover:bg-purple-200 transition-colors">
                Schedule Follow-up
            </button>
        </div>
    </div>
</div>
{% endmacro %}
{% from "components/ui_elements.html" import action_button, pluralized_count, contact_info_badge %}
{% from "components/metadata_display.html" import standard_card_metadata %}
{% from "components/icons.html" import envelope_icon, phone_icon, pencil_icon, trash_icon, user_plus_icon %}

{% macro render_contact(contact) %}
<div class="contact-card px-6 py-4 hover:bg-gray-50 cursor-pointer" 
     data-contact-id="{{ contact.id }}"
     @click="expanded = !expanded" 
     @expand-all-contacts.window="if ($event.detail.group === '{{ group_key }}' && !expanded) { expanded = true; }"
     @collapse-all-contacts.window="if ($event.detail.group === '{{ group_key }}' && expanded) { expanded = false; }"
     x-data="{
         expanded: false,
         isEditing: false
     }"
     :class="{ 'ring-2 ring-blue-200 bg-blue-50': expanded }">
    
    <!-- Main contact info row -->
    <div class="flex items-center justify-between">
        <div class="flex items-center flex-grow">
            <div class="flex-shrink-0">
                {% set avatar_color = 'blue' if contact.email and contact.phone 
                                      else 'green' if contact.email 
                                      else 'yellow' if contact.phone 
                                      else 'red' %}
                <div class="h-10 w-10 bg-{{ avatar_color }}-500 rounded-full flex items-center justify-center text-white font-medium">
                    {{ contact.name[:2].upper() }}
                </div>
            </div>
            <div class="ml-4 flex-grow">
                <div class="flex items-center space-x-2">
                    <div class="text-stakeholder-name">{{ contact.name }}</div>
                    {{ contact_info_badge(contact, 'ml-2') }}
                </div>
                <div class="text-secondary">
                    {% if contact.role %}{{ contact.role }} â€¢ {% endif %}
                    <span class="text-link-interactive" 
                          onclick="event.stopPropagation(); openCompanyDetailModal({{ contact.company.id }})">
                        <span class="text-company-name">{{ contact.company.name }}</span>
                    </span>
                </div>
                {{ standard_card_metadata(contact, {'entity_type': 'contact', 'include_opportunities': true}) }}
            </div>
        </div>
        
        <!-- Contact actions and info on the right -->
        <div class="flex items-center space-x-3 flex-shrink-0">
            <!-- Contact methods -->
            <div class="flex items-center space-x-2">
                {% if contact.email %}
                    <a href="mailto:{{ contact.email }}" 
                       class="text-blue-600 hover:text-blue-800 p-1"
                       title="{{ contact.email }}"
                       onclick="event.stopPropagation()">
                        {{ envelope_icon("w-4 h-4") }}
                    </a>
                {% endif %}
                {% if contact.phone %}
                    <a href="tel:{{ contact.phone }}" 
                       class="text-green-600 hover:text-green-800 p-1"
                       title="{{ contact.phone }}"
                       onclick="event.stopPropagation()">
                        {{ phone_icon("w-4 h-4") }}
                    </a>
                {% endif %}
            </div>
            
            <!-- Action buttons -->
            <div class="flex items-center space-x-1">
                <button @click.stop="openContactModal({{ contact.id }})" 
                        class="px-2 py-1 rounded text-blue-600 hover:text-blue-800 hover:bg-blue-50 transition-colors duration-200" 
                        title="Edit contact">
                    {{ pencil_icon("w-4 h-4") }}
                </button>
                <button @click.stop="deleteContact({{ contact.id }})" 
                        class="px-2 py-1 rounded text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors duration-200" 
                        title="Delete contact">
                    {{ trash_icon("w-4 h-4") }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Expanded details section -->
    <div x-show="expanded" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         class="mt-4 pt-4 border-t border-gray-100">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Contact Details -->
            <div>
                <h4 class="text-sm font-medium text-gray-900 mb-2">Contact Details</h4>
                <div class="space-y-2 text-sm">
                    {% if contact.email %}
                        <div class="flex items-center">
                            {{ envelope_icon("w-4 h-4 text-gray-400 mr-2") }}
                            <a href="mailto:{{ contact.email }}" class="text-blue-600 hover:text-blue-800">
                                {{ contact.email }}
                            </a>
                        </div>
                    {% endif %}
                    {% if contact.phone %}
                        <div class="flex items-center">
                            {{ phone_icon("w-4 h-4 text-gray-400 mr-2") }}
                            <a href="tel:{{ contact.phone }}" class="text-green-600 hover:text-green-800">
                                {{ contact.phone }}
                            </a>
                        </div>
                    {% endif %}
                    {% if not contact.email and not contact.phone %}
                        <p class="text-gray-500 italic">No contact information available</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div>
                <h4 class="text-sm font-medium text-gray-900 mb-2">Quick Actions</h4>
                <div class="flex flex-wrap gap-2">
                    <button @click.stop="createTask({{ contact.id }})" 
                            class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm hover:bg-blue-200 transition-colors">
                        Add Task
                    </button>
                    <button @click.stop="createOpportunity({{ contact.id }})" 
                            class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm hover:bg-green-200 transition-colors">
                        New Opportunity
                    </button>
                    {% if contact.opportunities %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm">
                            {{ pluralized_count(contact.opportunities|length, 'opportunity', short=true) }}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}
{% from "components/ui_elements.html" import action_button, pluralized_count, contact_info_badge %}
{% from "components/metadata_display.html" import standard_card_metadata %}
{% from "components/icons.html" import envelope_icon, phone_icon, pencil_icon, trash_icon, user_plus_icon %}
{% from "components/expandable_card.html" import expandable_card, action_buttons_row %}

{# Helper macro for contact header badge - matches opportunity pattern #}
{% macro contact_header_content(contact) %}
{{ contact_info_badge(contact) }}
{% endmacro %}

{# Helper macro for contact metadata - matches opportunity pattern #}
{% macro contact_metadata_content(contact) %}
{{ standard_card_metadata(contact, {'entity_type': 'contact', 'include_opportunities': true}) }}
{% endmacro %}

{# Helper macro for contact secondary info - company and role #}
{% macro contact_secondary_info(contact) %}
{% if contact.role %}{{ contact.role }} â€¢ {% endif %}
<span class="text-link-interactive" 
      onclick="event.stopPropagation(); openCompanyDetailModal({{ contact.company.id }})">
    <span class="text-company-name">{{ contact.company.name }}</span>
</span>
{% endmacro %}

{% macro render_contact(contact) %}
{{ expandable_card('contact', contact, contact.id,
    expansion_enabled=true,
    badge_content=contact_header_content(contact),
    title_content=contact.name,
    secondary_info=contact_secondary_info(contact),
    metadata_content=contact_metadata_content(contact),
    action_buttons=action_buttons_row('contact', contact.id),
    expanded_content=contact_expanded_content(contact)) }}
{% endmacro %}

{% macro contact_expanded_content(contact) %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Contact Details -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Contact Details</h4>
        <div class="space-y-2 text-sm">
            {% if contact.email %}
                <div class="flex items-center">
                    {{ envelope_icon("w-4 h-4 text-gray-400 mr-2") }}
                    <a href="mailto:{{ contact.email }}" class="text-blue-600 hover:text-blue-800">
                        {{ contact.email }}
                    </a>
                </div>
            {% endif %}
            {% if contact.phone %}
                <div class="flex items-center">
                    {{ phone_icon("w-4 h-4 text-gray-400 mr-2") }}
                    <a href="tel:{{ contact.phone }}" class="text-green-600 hover:text-green-800">
                        {{ contact.phone }}
                    </a>
                </div>
            {% endif %}
            {% if not contact.email and not contact.phone %}
                <p class="text-gray-500 italic">No contact information available</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Quick Actions</h4>
        <div class="flex flex-wrap gap-2">
            <button @click.stop="createTask({{ contact.id }})" 
                    class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm hover:bg-blue-200 transition-colors">
                Add Task
            </button>
            <button @click.stop="createOpportunity({{ contact.id }})" 
                    class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm hover:bg-green-200 transition-colors">
                New Opportunity
            </button>
            {% if contact.opportunities %}
                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm">
                    {{ pluralized_count(contact.opportunities|length, 'opportunity', short=true) }}
                </span>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}
{# Common UI Elements - Reusable macros for consistent interface components #}

{#
  Action Button - Standardized clickable action button with consistent styling
  
  Parameters:
  - onclick (required): JavaScript function call to execute on click
  - icon (optional): Symbol or text to display (default: '')
  - classes (optional): CSS classes for styling (default: standard gray styling)
  - id (optional): HTML id attribute
  
  Usage:
  {{ action_button('openStakeholderModal(' + contact.id|string + ')') }}
  {{ action_button('openModal()', '⋯', 'text-blue-400 hover:text-blue-600') }}
#}
{% macro action_button(onclick, icon='', classes='text-gray-400 hover:text-gray-600', id=None) %}
<button onclick="{{ onclick }}" 
        class="{{ classes }}"
        {% if id %}id="{{ id }}"{% endif %}>
    {{ icon }}
</button>
{% endmacro %}

{#
  Pluralized Count - Smart count display with automatic pluralization
  
  Parameters:
  - count (required): Number to display
  - singular (required): Singular form of the noun (e.g., 'opportunity')
  - plural (optional): Plural form if different from singular + 's' (e.g., 'opportunities')
  - short (optional): Use abbreviated form (e.g., 'opp' instead of 'opportunity')
  - show_zero (optional): Show count even when zero (default: true)
  
  Usage:
  {{ pluralized_count(contact.opportunities|length, 'opportunity', short=true) }}
  {{ pluralized_count(company.contacts|length, 'contact') }}
  {{ pluralized_count(items|length, 'item', 'items') }}
#}
{% macro pluralized_count(count, singular, plural=None, short=false, show_zero=false) %}
{%- if count > 0 or show_zero -%}
    {%- set display_singular = singular -%}
    {%- if plural -%}
        {%- set display_plural = plural -%}
    {%- elif singular == 'opportunity' -%}
        {%- set display_plural = 'opportunities' -%}
    {%- else -%}
        {%- set display_plural = singular + 's' -%}
    {%- endif -%}
    
    {%- if short -%}
        {%- if singular == 'opportunity' -%}
            {%- set display_singular = 'opp' -%}
            {%- set display_plural = 'opps' -%}
        {%- endif -%}
    {%- endif -%}
    
    {{ count }} {{ display_singular if count == 1 else display_plural }}
{%- endif -%}
{% endmacro %}

{#
  Expand/Collapse Controls - Standardized section expansion controls
  
  Parameters:
  - target_sections (required): Alpine.js data object name containing section states
  - additional_classes (optional): Extra CSS classes for the container
  
  Usage:
  {{ expand_collapse_controls('expandedSections') }}
  {{ expand_collapse_controls('sectionStates', 'ml-4') }}
#}
{% macro expand_collapse_controls(target_sections, additional_classes='') %}
<div class="flex items-center gap-4 border-l pl-4 {{ additional_classes }}">
    <button @click="Object.keys({{ target_sections }}).forEach(key => {{ target_sections }}[key] = true)"
            class="text-secondary-dark hover:text-gray-900">Expand All</button>
    <div class="border-l border-gray-300 h-5"></div>
    <button @click="Object.keys({{ target_sections }}).forEach(key => {{ target_sections }}[key] = false)"
            class="text-secondary-dark hover:text-gray-900">Collapse All</button>
</div>
{% endmacro %}

{#
  Stakeholder Info Badge - Display contact information status
  
  Parameters:
  - contact (required): Stakeholder object with email and phone attributes
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ contact_info_badge(contact) }}
#}
{% macro contact_info_badge(contact, additional_classes='') %}
{% set info_type = get_contact_info_type(contact) %}
{% set badge_configs = get_contact_badge_configs() %}
<span class="badge-standard badge-{{ badge_configs[info_type].color }} {{ additional_classes }}">{{ badge_configs[info_type].label }}</span>
{% endmacro %}

{% macro get_contact_info_type(contact) %}
{%- if contact.email and contact.phone -%}complete
{%- elif contact.email -%}email_only
{%- elif contact.phone -%}phone_only
{%- else -%}missing
{%- endif -%}
{% endmacro %}

{% macro get_contact_badge_configs() %}
{
    'complete': {'color': 'green', 'label': 'Complete Info'},
    'email_only': {'color': 'blue', 'label': 'Email Only'}, 
    'phone_only': {'color': 'yellow', 'label': 'Phone Only'},
    'missing': {'color': 'red', 'label': 'Missing Info'}
}
{% endmacro %}

{#
  Entity Link Button - Standardized link button for entity detail pages
  
  Parameters:
  - url (required): URL to navigate to
  - text (optional): Button text (default: 'View Details')
  - classes (optional): CSS classes for styling
  
  Usage:
  {{ entity_link_button(url_for('companies.detail', company_id=company.id)) }}
  {{ entity_link_button('/contacts/' + contact.id|string, 'View Stakeholder') }}
#}
{% macro entity_link_button(url, text='View Details', classes='mt-3 block w-full text-center bg-gray-50 text-gray-700 py-2 rounded-md hover:bg-gray-100') %}
<a href="{{ url }}" class="{{ classes }}">{{ text }}</a>
{% endmacro %}

{#
  Dropdown Select - Single-select dropdown with consistent styling
  
  Parameters:
  - model (required): Alpine.js x-model binding name
  - options (required): List of options as [{'value': 'val', 'label': 'Label'}] or simple strings
  - placeholder (optional): Placeholder text for empty option (default: 'Select...')
  - classes (optional): Additional CSS classes (default: standard input styling)
  
  Usage:
  {{ dropdown_select('groupBy', [{'value': 'stage', 'label': 'Pipeline Stage'}], 'Group by:') }}
  {{ dropdown_select('sortBy', ['name', 'date', 'priority']) }}
#}
{% macro dropdown_select(model, options, placeholder='Select...', classes='px-3 py-2 border border-gray-300 rounded-md text-sm') %}
<div class="multiselect-custom" x-data="{ open: false }" @click.away="open = false">
    <button type="button" 
            class="select-custom {{ classes }}" 
            @click="open = !open"
            x-cloak
            x-init="if (typeof {{ model }} === 'undefined' || {{ model }} === null) { {{ model }} = '{{ options[0].value if options[0] is mapping else options[0] }}' }">
        <span x-text="
                  {% for option in options %}
                  {% if option is mapping %}
                  {{ model }} === '{{ option.value }}' ? '{{ option.label }}' :
                  {% else %}
                  {{ model }} === '{{ option }}' ? '{{ option|title }}' :
                  {% endif %}
                  {% endfor %}
                  '{{ options[0].label if options[0] is mapping else options[0]|title }}'
              ">
                  {{ options[0].label if options[0] is mapping else options[0]|title }}
              </span>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" 
                 @click="setSortBy ? setSortBy('{{ option.value if option is mapping else option }}') : ({{ model }} = '{{ option.value if option is mapping else option }}'); open = false">
                <span>{{ option.label if option is mapping else option|title }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  Section Group Header - DRY implementation for consistent expandable section headers
  
  Parameters:
  - section_key (required): Unique key for expand/collapse state
  - title (required): Display title for the section
  - icon_html (required): HTML for the icon (use icon macros)
  - badge_html (required): HTML for the count badge
  - border_color (required): Border color class name (e.g., 'blue', 'red')
  - bg_color (required): Background color class name
  - hover_color (required): Hover background color class name
  - text_class (required): Text styling class
  - with_buttons (optional): Show expand/collapse all buttons (default: true)
  
  Usage:
  {{ section_group_header('todo', 'To Do', clipboard_icon("w-5 h-5 mr-1"), '<span class="badge-blue">5</span>', 'blue', 'blue', 'blue', 'text-status-header') }}
#}
{% macro section_group_header(section_key, title, icon_html, badge_html, border_color, bg_color, hover_color, text_class, with_buttons=true) %}
{% from "components/icons.html" import chevron_right_icon %}
<div class="border-b border-{{ border_color }}-200 px-6 py-4 bg-{{ bg_color }}-50 cursor-pointer hover:bg-{{ hover_color }}-100" 
     @click="expandedSections['{{ section_key }}'] = !expandedSections['{{ section_key }}']">
    <div class="flex items-center justify-between">
        <h3 class="{{ text_class }}">
            <span class="mr-2 transition-transform duration-200" :class="expandedSections['{{ section_key }}'] ? 'rotate-90' : ''">
                {{ chevron_right_icon("w-4 h-4") }}
            </span>{{ icon_html|safe }} {{ title }}{{ badge_html|safe }}
        </h3>
        {% if with_buttons %}
        <div class="flex items-center space-x-2 text-sm text-gray-500" x-show="expandedSections['{{ section_key }}']">
            <button @click.stop="expandAllItemsInGroup('{{ section_key }}')" class="hover:text-blue-600 transition-colors">Expand All</button>
            <span>|</span>
            <button @click.stop="collapseAllItemsInGroup('{{ section_key }}')" class="hover:text-blue-600 transition-colors">Collapse All</button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  Dropdown Multi-Select - Multi-select dropdown with search and Select All/Deselect All
  
  Parameters:
  - model (required): Alpine.js x-model binding name (should be an array)
  - options (required): List of options as [{'value': 'val', 'label': 'Label'}] or simple strings
  - placeholder (optional): Button text when no items selected (default: 'Select...')
  - with_search (optional): Include search functionality (default: false)
  - classes (optional): Additional CSS classes for the button
  
  Usage:
  {{ dropdown_multiselect('priorityFilter', [{'value': 'high', 'label': 'High'}], 'All Priorities') }}
  {{ dropdown_multiselect('companyFilter', companies, 'All Companies', with_search=true) }}
#}
{% macro dropdown_multiselect(model, options, placeholder='Select...', with_search=false, classes='px-3 py-2 border border-gray-300 rounded-md text-sm') %}
<div class="multiselect-custom" 
     x-data="{ 
         open: false, 
         searchTerm: '',
         init() {
             // Ensure model is initialized as an array
             if (!{{ model }}) {
                 {{ model }} = [];
             }
         }
     }" 
     @click.away="open = false">
    <button type="button" 
            class="multiselect-button {{ classes }}" 
            x-cloak
            @click="open = !open">
        <span x-text="{{ model }}.length === 0 ? '{{ placeholder }}' : {{ model }}.length + ' selected'">{{ placeholder }}</span>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        
        <div class="multiselect-header">
            {% if with_search %}
            <input type="text" 
                   x-model="searchTerm" 
                   class="multiselect-search" 
                   placeholder="Search..."
                   @click.stop>
            {% endif %}
            <div class="multiselect-controls">
                <span class="multiselect-control-btn" 
                      @click="{{ model }} = [{% for option in options %}'{{ option.value if option is mapping else option }}'{% if not loop.last %}, {% endif %}{% endfor %}]">Select All</span>
                <span class="multiselect-control-btn" 
                      @click="{{ model }} = []">Deselect All</span>
            </div>
        </div>
        
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" 
                 {% if with_search %}x-show="!searchTerm || '{{ option.label if option is mapping else option }}'.toLowerCase().includes(searchTerm.toLowerCase())"{% endif %}
                 @click="
                    const value = '{{ option.value if option is mapping else option }}';
                    const index = {{ model }}.indexOf(value);
                    if (index === -1) {
                        {{ model }}.push(value);
                    } else {
                        {{ model }}.splice(index, 1);
                    }
                 ">
                <input type="checkbox" 
                       class="multiselect-checkbox"
                       :checked="{{ model }}.includes('{{ option.value if option is mapping else option }}')"
                       @click.stop>
                <span>{{ option.label if option is mapping else option }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
<<<<<<< HEAD
  Entity Section Group - DRY macro for entity index page sections
  
  Creates complete expandable sections with header, content area, and filtering.
  Optimized for contacts, opportunities, and similar entity groupings.
  
  Parameters:
  - section_key (required): Unique key for expand/collapse state
  - title (required): Section display title
  - icon_html (required): Icon HTML for section header
  - items (required): List of items to render in section
  - card_class (optional): CSS class for card wrapper (default: 'card')
  - colors (required): Dict with badge_color, border_color, bg_color, hover_color, text_class
  - x_show_condition (optional): Additional Alpine.js x-show condition
  - empty_message (optional): Message when no items (default: 'No items found')
  
  Usage:
  {% call entity_section_group('company', 'Companies', building_icon(...), companies, colors=company_colors) %}
    <!-- render items here using caller() -->
  {% endcall %}
#}
{% macro entity_section_group(section_key, title, icon_html, items, card_class='card', colors=None, x_show_condition='', empty_message='No items found') %}
<div {% if x_show_condition %}x-show="{{ x_show_condition }}" x-cloak {% endif %}class="{{ card_class }}">
    {{ section_group_header(
        section_key,
        title,
        icon_html|safe, 
        '<span class="ml-2 badge-standard badge-' + colors.badge_color + '">' + items|length|string + '</span>',
        colors.border_color,
        colors.bg_color,
        colors.hover_color, 
        colors.text_class,
        with_buttons=false
    ) }}
    <div class="divide-y divide-gray-200" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% if items %}
            {{ caller() }}
        {% else %}
            <div class="p-6 text-center text-empty-state">
                {{ empty_message }}
            </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  Badge Count Helper - DRY macro for task count badges with consistent formatting
  
  Parameters:
  - filter_type (required): Type of filtering ('status', 'priority', 'due_date', 'entity', 'overdue', 'custom')
  - filter_value (optional): Specific value to filter by (e.g., 'todo', 'high', 'company')
  - color (required): Badge color class ('blue', 'red', 'green', etc.)
  - tasks_list (optional): Tasks list to use (default: 'tasks')
  - show_completed (optional): Whether to include completed tasks (default: varies by type)
  - custom_count (optional): Pre-calculated count for complex filters
  
  Usage:
  {{ badge_count_helper('status', 'todo', 'blue') }}
  {{ badge_count_helper('priority', 'high', 'red') }}
  {{ badge_count_helper('custom', color='gray', custom_count=custom_task_list|length) }}
#}
{% macro badge_count_helper(filter_type, filter_value=None, color='gray', tasks_list='tasks_objects', show_completed=None, custom_count=None) %}
{%- if custom_count is not none -%}
    {%- set count = custom_count -%}
{%- elif filter_type == 'status' -%}
    {%- set count = (tasks_objects|selectattr('status', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'priority' -%}
    {%- set count = (tasks_objects|selectattr('priority', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'overdue' -%}
    {%- set count = (tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length) -%}
{%- elif filter_type == 'due_today' -%}
    {%- set count = (tasks_objects|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length) -%}
{%- elif filter_type == 'no_date' -%}
    {%- if show_completed -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|list|length) -%}
    {%- else -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
    {%- endif -%}
{%- elif filter_type == 'entity' -%}
    {%- if filter_value == 'unrelated' -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- else -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- endif -%}
{%- else -%}
    {%- set count = 0 -%}
{%- endif -%}
<span class="ml-2 badge-standard badge-{{ color }}">{{ count }}</span>
{%- endmacro %}

{#
  Task Section Group - DRY macro for complete task sections with filtering
  
  Comprehensive macro that handles all task grouping types and eliminates repetitive code.
  
  Parameters:
  - section_key (required): Key for expandedSections and group identifier
  - title (required): Section title
  - icon_html (required): Icon HTML from icon macros
  - card_class (optional): Card CSS class (default: 'card')
  - colors (required): Object with {badge_color, border_color, bg_color, hover_color, text_class}
  - x_show_condition (optional): Additional x-show condition (e.g., 'showCompleted')
  - filter_config (required): Object with filtering configuration
    - {type: 'status', value: 'todo'} - Filter by status
    - {type: 'priority', value: 'high'} - Filter by priority  
    - {type: 'entity', value: 'company'} - Filter by entity type
    - {type: 'overdue'} - Filter overdue tasks
    - {type: 'due_today'} - Filter tasks due today
    - {type: 'no_date'} - Filter tasks with no due date
    - {type: 'custom', filter_func: 'custom_filter_function'} - Custom filtering
  - additional_classes (optional): Extra CSS classes for rendered tasks
  
  Usage:
  {{ task_section_group('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), 
       colors={badge_color: 'blue', border_color: 'blue', bg_color: 'blue', hover_color: 'blue', text_class: 'text-status-header'}, 
       filter_config={type: 'status', value: 'todo'}) }}
#}
{% macro task_section_group(section_key, title, icon_html, card_class='card', colors=None, x_show_condition='', filter_config=None, additional_classes='') %}
<div {% if x_show_condition %}x-show="{{ x_show_condition }}" x-cloak {% endif %}class="{{ card_class }}">
    {{ section_group_header(
        section_key,
        title,
        icon_html|safe, 
        '<span class="ml-2 badge-standard badge-' + colors.badge_color + '">' + (
            (tasks_objects|selectattr('status', 'equalto', filter_config.value)|list|length)|string if filter_config and filter_config.type == 'status' else
            (tasks_objects|selectattr('priority', 'equalto', filter_config.value)|list|length)|string if filter_config and filter_config.type == 'priority' else
            (tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length)|string if filter_config and filter_config.type == 'overdue' else
            (tasks_objects|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length)|string if filter_config and filter_config.type == 'due_today' else
            (filter_config.custom_count|string if filter_config.custom_count is defined else '0') if filter_config and (filter_config.type == 'custom_due_week' or filter_config.type == 'custom_due_later') else
            '0'
        ) + '</span>',
        colors.border_color,
        colors.bg_color,
        colors.hover_color, 
        colors.text_class
    ) }}
    <div class="p-6" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% set has_tasks = [] %}
        {% for task in tasks_objects %}
            {% set show_task = false %}
            {# Apply filtering logic based on filter_config #}
            {%- if filter_config -%}
                {%- if filter_config.type == 'status' and task.status == filter_config.value and task.task_type != 'child' -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'priority' and task.priority == filter_config.value -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'overdue' and task.is_overdue -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'due_today' and task.due_date == today -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'no_date' and not task.due_date -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'entity' -%}
                    {%- if filter_config.value == 'unrelated' and not task.entity_type -%}
                        {% set show_task = true %}
                    {%- elif task.entity_type == filter_config.value -%}
                        {% set show_task = true %}
                    {%- endif -%}
                {%- elif filter_config.type == 'custom_due_week' and task.due_date and task.due_date > today and (task.due_date - today).days <= 7 -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'custom_due_later' and task.due_date and (task.due_date - today).days > 7 -%}
                    {% set show_task = true %}
                {%- endif -%}
            {%- endif -%}
            
            {% if show_task %}
                {% set _ = has_tasks.append(task) %}
                <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'})" {% if additional_classes %}class="{{ additional_classes }}"{% endif %}>
                    {% if task.task_type == 'parent' %}
                        {% call expandable_card('task', task, task.id,
                                               expansion_enabled=true,
                                               group_key=section_key,
                                               action_content=task_reschedule_buttons(task.id)) %}
                            {{ task_header_content(task) }}
                        {% endcall %}
                    {% else %}
                        {% call expandable_card('task', task, task.id,
                                               expansion_enabled=true,
                                               group_key=section_key,
                                               action_content=task_reschedule_buttons(task.id)) %}
                            {{ task_header_content(task) }}
                        {% endcall %}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
        {% if has_tasks|length == 0 %}
            <p class="text-empty-state">No matching tasks found</p>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  View Mode Toggle - Switch between grid and list views
  
  Parameters:
  - current_mode (optional): Current view mode ('grid' or 'list')
  - grid_icon (optional): Custom grid view icon
  - list_icon (optional): Custom list view icon
  
  Usage:
  {{ view_mode_toggle() }}
  {{ view_mode_toggle('grid', custom_grid_icon, custom_list_icon) }}
#}
{% macro view_mode_toggle(current_mode='grid', grid_icon=None, list_icon=None) %}
<div class="flex items-center bg-gray-100 rounded-md p-1">
    <button @click="viewMode = 'grid'" 
            :class="viewMode === 'grid' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
            class="p-2 rounded transition-colors">
        {% if grid_icon %}
        {{ grid_icon|safe }}
        {% else %}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
        </svg>
        {% endif %}
    </button>
    <button @click="viewMode = 'list'" 
            :class="viewMode === 'list' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
            class="p-2 rounded transition-colors">
        {% if list_icon %}
        {{ list_icon|safe }}
        {% else %}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
        {% endif %}
    </button>
</div>
{% endmacro %}

{#
  Bulk Selection Checkbox - Checkbox with consistent selection styling
  
  Parameters:
  - item_id (required): Unique identifier for the item
  - model (optional): Alpine.js model name (default: 'selectedItems')
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ bulk_selection_checkbox(company.id) }}
  {{ bulk_selection_checkbox(contact.id, 'selectedStakeholders') }}
#}
{% macro bulk_selection_checkbox(item_id, model='selectedItems', additional_classes='') %}
<input type="checkbox" 
       x-model="{{ model }}" 
       value="{{ item_id }}"
       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded {{ additional_classes }}"
       @click.stop>
{% endmacro %}

{#
  Select All Checkbox - Master checkbox for bulk selection
  
  Parameters:
  - total_items (required): Total number of items that can be selected
  - model (optional): Alpine.js model name (default: 'selectedItems')
  - label (optional): Label text for the checkbox
  
  Usage:
  {{ select_all_checkbox(companies|length) }}
  {{ select_all_checkbox(contacts|length, 'selectedStakeholders', 'Select all contacts') }}
#}
{% macro select_all_checkbox(total_items, model='selectedItems', label='Select all') %}
<label class="flex items-center space-x-2">
    <input type="checkbox"
           :checked="{{ model }}.length === {{ total_items }} && {{ total_items }} > 0"
           :indeterminate="{{ model }}.length > 0 && {{ model }}.length < {{ total_items }}"
           @change="{{ model }} = $event.target.checked ? allItemIds : []"
           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
    <span class="text-sm text-gray-700">{{ label }}</span>
</label>
{% endmacro %}

{#
  Search Input - Consistent search input with icon
  
  Parameters:
  - placeholder (optional): Placeholder text
  - model (optional): Alpine.js model binding
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ search_input('Search companies...', 'searchTerm') }}
#}
{% macro search_input(placeholder='Search...', model='searchTerm', additional_classes='') %}
<div class="relative">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>
    <input type="text" 
           x-model="{{ model }}"
           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm {{ additional_classes }}"
           placeholder="{{ placeholder }}">
    <div x-show="{{ model }}.length > 0" class="absolute inset-y-0 right-0 pr-3 flex items-center">
        <button @click="{{ model }} = ''" class="text-gray-400 hover:text-gray-600">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>
{% endmacro %}

{#
  Loading Spinner - Consistent loading indicator
  
  Parameters:
  - size (optional): Size class ('sm', 'md', 'lg')
  - text (optional): Loading text to display
  
  Usage:
  {{ loading_spinner('md', 'Loading companies...') }}
#}
{% macro loading_spinner(size='md', text='') %}
{%- set size_classes = {'sm': 'h-4 w-4', 'md': 'h-6 w-6', 'lg': 'h-8 w-8'} -%}
<div class="flex items-center justify-center space-x-2">
    <svg class="animate-spin {{ size_classes[size] or size_classes['md'] }} text-blue-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    {% if text %}
    <span class="text-sm text-gray-600">{{ text }}</span>
    {% endif %}
</div>
{% endmacro %}

{#
  Empty State - Consistent empty state display
  
  Parameters:
  - title (required): Empty state title
  - description (optional): Empty state description
  - action_button (optional): HTML for action button
  - icon (optional): Custom icon HTML
  
  Usage:
  {{ empty_state('No companies found', 'Get started by adding your first company', '<button>Add Company</button>') }}
#}
{% macro empty_state(title, description='', action_button='', icon='') %}
<div class="text-center py-12">
    {% if icon %}
    <div class="mx-auto h-12 w-12 text-gray-400 mb-4">
        {{ icon|safe }}
    </div>
    {% else %}
    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    {% endif %}
    
    <h3 class="text-lg font-medium text-gray-900 mb-2">{{ title }}</h3>
    
    {% if description %}
    <p class="text-gray-500 mb-6">{{ description }}</p>
    {% endif %}
    
    {% if action_button %}
    {{ action_button|safe }}
    {% endif %}
</div>
{% endmacro %}

{#
  Status Badge - Consistent status indicator
  
  Parameters:
  - status (required): Status value
  - color_map (optional): Dict mapping status to colors
  - size (optional): Badge size ('sm', 'md', 'lg')
  
  Usage:
  {{ status_badge(task.status) }}
  {{ status_badge(company.status, {'active': 'green', 'inactive': 'red'}) }}
#}
{% macro status_badge(status, color_map=None, size='md') %}
{%- set color = get_status_color(status, color_map) -%}

{%- set size_classes = {'sm': 'px-2 py-1 text-xs', 'md': 'px-2.5 py-0.5 text-sm', 'lg': 'px-3 py-1 text-base'} -%}

<span class="inline-flex items-center {{ size_classes[size] or size_classes['md'] }} font-medium rounded-full badge-{{ color }}">
    {{ status|title }}
</span>
{% endmacro %}

{#
  GENERIC ENTITY MANAGER COMPONENTS - DRY multiselect system for all entity types
#}

{#
  Generic Group Dropdown - Reusable group by selector
  
  Parameters:
  - model (required): Alpine.js model binding for groupBy value
  - options (required): List of group options as [{'value': 'key', 'label': 'Display Name'}]
  - on_change (optional): JavaScript function to call on change (default: 'updateFilters()')
  
  Usage:
  {{ generic_group_dropdown('groupBy', [{'value': 'stage', 'label': 'Pipeline Stage'}]) }}
#}
{% macro generic_group_dropdown(model, options, on_change='updateFilters()') %}
<div class="multiselect-custom" x-data="{ open: false }" @click.away="open = false">
    <button type="button" 
            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
            @click="open = !open">
        <span x-text="
            {% for option in options %}
            {{ model }} === '{{ option.value }}' ? '{{ option.label }}' :
            {% endfor %}
            '{{ options[0].label }}'
        "></span>
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" @click="{{ model }} = '{{ option.value }}'; {{ on_change }}; open = false">
                <span>{{ option.label }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  Generic Sort Dropdown - Reusable sort selector with direction indicators
  
  Parameters:
  - sort_model (required): Alpine.js model binding for sortBy value
  - direction_model (required): Alpine.js model binding for sortDirection value
  - options (required): List of sort options as [{'value': 'key', 'label': 'Display Name'}]
  - on_change (optional): JavaScript function to call on change (default: 'updateFilters()')
  
  Usage:
  {{ generic_sort_dropdown('sortBy', 'sortDirection', [{'value': 'name', 'label': 'Name'}]) }}
#}
{% macro generic_sort_dropdown(sort_model, direction_model, options, on_change='updateFilters()') %}
<div class="multiselect-custom" x-data="{ open: false }" @click.away="open = false">
    <button type="button" 
            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
            @click="open = !open">
        <span x-text="
            {% for option in options %}
            {{ sort_model }} === '{{ option.value }}' ? '{{ option.label }}' :
            {% endfor %}
            '{{ options[0].label }}'
        "></span>
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" @click="if ({{ sort_model }} === '{{ option.value }}') { {{ direction_model }} = {{ direction_model }} === 'asc' ? 'desc' : 'asc'; } else { {{ sort_model }} = '{{ option.value }}'; } {{ on_change }}; open = false">
                <span>{{ option.label }}</span>
                <span x-show="{{ sort_model }} === '{{ option.value }}'" x-text="{{ direction_model }} === 'asc' ? '↑' : '↓'" class="ml-auto text-gray-500"></span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  Generic Filter Multiselect - Reusable multiselect filter with search and controls
  
  Parameters:
  - model (required): Alpine.js model binding for filter array
  - options (required): List of filter options as [{'value': 'key', 'label': 'Display Name'}]
  - placeholder (required): Button text when nothing selected
  - toggle_function (required): JavaScript function name to toggle values
  - display_function (required): JavaScript function name to get display text
  - with_search (optional): Include search functionality (default: false)
  - select_all_values (optional): Array of all values for Select All (default: auto-generated)
  - on_change (optional): JavaScript function to call on change (default: 'updateFilters()')
  
  Usage:
  {{ generic_filter_multiselect('priorityFilter', priority_options, 'All Priorities', 'togglePriority', 'getPriorityDisplayText') }}
#}
{% macro generic_filter_multiselect(model, options, placeholder, toggle_function, display_function, with_search=false, select_all_values=none, on_change='updateFilters()') %}
{%- set all_values = select_all_values or options|map(attribute='value')|list -%}
<div class="multiselect-custom" x-data="{ 
    open: false{% if with_search %},
    search: ''{% endif %}
}" @click.away="open = false">
    <button type="button" 
            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
            @click="open = !open">
        <span x-text="{{ display_function }}()">{{ placeholder }}</span>
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        <div class="multiselect-header">
            {% if with_search %}
            <input type="text" 
                   x-model="search" 
                   placeholder="Search..."
                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
            {% endif %}
            <div class="multiselect-controls">
                <span class="multiselect-control-btn" @click="{{ model }} = [{% for value in all_values %}'{{ value }}'{% if not loop.last %}, {% endif %}{% endfor %}]; {{ on_change }}">Select All</span>
                <span class="multiselect-control-btn" @click="{{ model }} = []; {{ on_change }}">Deselect All</span>
            </div>
        </div>
        <div class="multiselect-options">
            <div class="multiselect-option" @click="{{ model }} = []; {{ on_change }}">
                <input type="checkbox" :checked="{{ model }}.length === 0" class="mr-2">
                <span>{{ placeholder }}</span>
            </div>
            {% for option in options %}
            <div class="multiselect-option" 
                 {% if with_search %}x-show="!search || '{{ option.label }}'.toLowerCase().includes(search.toLowerCase())"{% endif %}
                 @click="{{ toggle_function }}('{{ option.value }}')">
                <input type="checkbox" :checked="{{ model }}.includes('{{ option.value }}')" class="mr-2">
                <span>{{ option.label }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  Dynamic Entity Section - Generic expandable section for entity grouping
  
  Parameters:
  - Uses Alpine.js template with x-for to render dynamic sections
  
  Usage:
  <!-- Used with Alpine.js x-for in the entity manager templates -->
  {{ dynamic_entity_section() }}
#}
{% macro dynamic_entity_section() %}
<template x-for="group in getGroupedEntities()" :key="group.key">
    <div class="entity-section-spacing mb-6">
        <!-- Group Section -->
        <div :class="group.containerClass">
            <!-- Group Header -->
            <div :class="group.headerBgClass + ' cursor-pointer'"
                 @click="toggleSection(group.key)">
                <div class="flex items-center justify-between">
                    <h3 :class="group.headerClass">
                        <span class="mr-2 transition-transform duration-200" 
                              :class="expandedSections[group.key] ? 'rotate-90' : ''">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </span>
                        <span x-html="group.icon" class="w-5 h-5 mr-1"></span>
                        <span x-text="group.title"></span>
                        <span class="ml-2" 
                              :class="'badge-standard ' + group.badgeClass" 
                              x-text="group.entities.length"></span>
                    </h3>
                </div>
            </div>
            
            <!-- Group Content -->
            <div class="entity-group-content p-8" 
                 x-show="expandedSections[group.key]" 
                 x-cloak 
                 x-transition>
                <template x-if="group.entities.length > 0">
                    <div class="space-y-4">
                        <template x-for="entity in group.entities" :key="entity.id">
                            <div x-html="renderEntityCard(entity, group.key)"></div>
                        </template>
                    </div>
                </template>
                <template x-if="group.entities.length === 0">
                    <p class="text-empty-state">No matching items found</p>
                </template>
            </div>
        </div>
    </div>
</template>
{% endmacro %}

{#
  Generic Bulk Actions Bar
  
  Displays a blue banner when items are selected for bulk operations.
  Customizable for different entity types and actions.
  
  Parameters:
  - entity_type: Singular name of entity type (e.g., 'task', 'opportunity')
  - entity_plural: Plural name for display (e.g., 'tasks', 'opportunities')  
  - primary_action: Primary bulk action config {label, onclick, color}
  - secondary_action: Secondary bulk action config {label, onclick, color}
  
  Usage:
  {{ bulk_actions_bar('task', 'tasks', 
       {'label': 'Update Status', 'onclick': 'bulkUpdateStatus()', 'color': 'blue'},
       {'label': 'Delete Selected', 'onclick': 'bulkDelete()', 'color': 'red'}) }}
#}
{% macro bulk_actions_bar(entity_type, entity_plural, primary_action, secondary_action) %}
<div x-show="selectedItems.length > 0" 
     x-cloak 
     x-transition
     class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
    <div class="flex items-center space-x-4">
        <span class="text-blue-800 font-medium" x-text="`${selectedItems.length} {{ entity_plural }} selected`"></span>
        
        {% if primary_action %}
        <button @click="{{ primary_action.onclick }}" 
                class="bg-{{ primary_action.color }}-600 text-white px-3 py-1.5 rounded text-sm hover:bg-{{ primary_action.color }}-700">
            {{ primary_action.label }}
        </button>
        {% endif %}
        
        {% if secondary_action %}
        <button @click="{{ secondary_action.onclick }}" 
                class="bg-{{ secondary_action.color }}-600 text-white px-3 py-1.5 rounded text-sm hover:bg-{{ secondary_action.color }}-700">
            {{ secondary_action.label }}
        </button>
        {% endif %}
    </div>
    
    <button @click="selectedItems = []" class="text-blue-600 hover:text-blue-800">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
</div>
{% endmacro %}

{#
  Helper macro for status color determination - eliminates if/elif chains
#}
{% macro get_status_color(status, color_map=None) %}
{%- if color_map -%}
    {{ color_map.get(status, 'gray') }}
{%- else -%}
    {% set default_colors = get_default_status_colors() %}
    {% set found_color = '' %}
    {% for color_group, statuses in default_colors.items() %}
        {% if status in statuses and not found_color %}
            {% set found_color = color_group %}
        {% endif %}
    {% endfor %}
    {{ found_color or 'gray' }}
{%- endif -%}
{% endmacro %}

{% macro get_default_status_colors() %}
{
    'green': ['complete', 'completed', 'done', 'active', 'open'],
    'yellow': ['in-progress', 'in_progress', 'pending', 'working'],
    'red': ['overdue', 'late', 'failed', 'error'],
    'blue': ['todo', 'new', 'draft']
}
{% endmacro %}

{#
  Enhanced Filter Controls Section - DRY component for all entity index pages
  
  Parameters:
  - group_options (required): List of group options as [{'value': 'key', 'label': 'Display Name'}]
  - sort_options (required): List of sort options as [{'value': 'key', 'label': 'Display Name'}]
  - show_completed_label (optional): Label for show completed checkbox (default: 'Show Completed')
  - show_completed_name (optional): Name attribute for checkbox (default: 'show_completed')
  - primary_filter_options (optional): List of options for first filter dropdown
  - primary_filter_label (optional): Label for first filter dropdown (default: 'All Filters')
  - secondary_filter_options (optional): List of options for second filter dropdown  
  - secondary_filter_label (optional): Label for second filter dropdown (default: 'All Filters')
  - entity_filter_options (optional): List of options for entity filter dropdown
  - entity_filter_label (optional): Label for entity filter dropdown (default: 'All Entities')
  - entity_filter_search (optional): Enable search in entity filter (default: false)
  
  Usage:
  {{ enhanced_filter_controls(
      group_options=[{'value': 'stage', 'label': 'Pipeline Stage'}],
      sort_options=[{'value': 'name', 'label': 'Name'}],
      show_completed_label='Show Closed',
      primary_filter_options=[{'value': 'high', 'label': 'High Priority'}],
      primary_filter_label='All Priorities'
  ) }}
#}
{% macro enhanced_filter_controls(
    group_options, 
    sort_options,
    show_completed_label='Show Completed',
    show_completed_name='show_completed',
    primary_filter_options=None,
    primary_filter_label='All Filters', 
    secondary_filter_options=None,
    secondary_filter_label='All Filters',
    entity_filter_options=None,
    entity_filter_label='All Entities',
    entity_filter_search=false
) %}
<div class="card-padded-lg filter-section-enhanced">
    <div class="flex flex-col space-y-4">
        <!-- First row: Group by, Sort by, and Filters -->
        <div class="flex flex-wrap items-center gap-6">
            <label class="text-label-dark">Group by:</label>
            {{ generic_group_dropdown('groupBy', group_options) }}
            
            <label class="text-label-dark">Sort by:</label>
            {{ generic_sort_dropdown('sortBy', 'sortDirection', sort_options) }}
            
            {% if primary_filter_options or secondary_filter_options or entity_filter_options %}
            <label class="text-label-dark">Filters:</label>
            {% endif %}
            
            {% if primary_filter_options %}
            {{ generic_filter_multiselect('primaryFilter', primary_filter_options, primary_filter_label, 'togglePrimaryFilter', 'getPrimaryFilterDisplayText') }}
            {% endif %}
            
            {% if secondary_filter_options %}
            {{ generic_filter_multiselect('secondaryFilter', secondary_filter_options, secondary_filter_label, 'toggleSecondaryFilter', 'getSecondaryFilterDisplayText') }}
            {% endif %}
            
            {% if entity_filter_options %}
            {{ generic_filter_multiselect('entityFilter', entity_filter_options, entity_filter_label, 'toggleEntityFilter', 'getEntityFilterDisplayText', with_search=entity_filter_search) }}
            {% endif %}
        </div>
        
        <!-- Second row: Show completed and Expand/Collapse controls -->
        <div class="flex flex-wrap items-center gap-6">
            <label class="flex items-center">
                <input type="checkbox" 
                       x-model="showCompleted"
                       @change="updateFilters()"
                       name="{{ show_completed_name }}"
                       value="true"
                       class="mr-2">
                <span class="text-secondary-dark">{{ show_completed_label }}</span>
            </label>

            {{ expand_collapse_controls('expandedSections') }}
        </div>
    </div>
</div>
{% endmacro %}
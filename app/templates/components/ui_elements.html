{# Common UI Elements - Reusable macros for consistent interface components #}

{#
  Action Button - Standardized clickable action button with consistent styling
  
  Parameters:
  - onclick (required): JavaScript function call to execute on click
  - icon (optional): Symbol or text to display (default: '')
  - classes (optional): CSS classes for styling (default: standard gray styling)
  - id (optional): HTML id attribute
  
  Usage:
  {{ action_button('openContactModal(' + contact.id|string + ')') }}
  {{ action_button('openModal()', 'â‹¯', 'text-blue-400 hover:text-blue-600') }}
#}
{% macro action_button(onclick, icon='', classes='text-gray-400 hover:text-gray-600', id=None) %}
<button onclick="{{ onclick }}" 
        class="{{ classes }}"
        {% if id %}id="{{ id }}"{% endif %}>
    {{ icon }}
</button>
{% endmacro %}

{#
  Pluralized Count - Smart count display with automatic pluralization
  
  Parameters:
  - count (required): Number to display
  - singular (required): Singular form of the noun (e.g., 'opportunity')
  - plural (optional): Plural form if different from singular + 's' (e.g., 'opportunities')
  - short (optional): Use abbreviated form (e.g., 'opp' instead of 'opportunity')
  - show_zero (optional): Show count even when zero (default: true)
  
  Usage:
  {{ pluralized_count(contact.opportunities|length, 'opportunity', short=true) }}
  {{ pluralized_count(company.contacts|length, 'contact') }}
  {{ pluralized_count(items|length, 'item', 'items') }}
#}
{% macro pluralized_count(count, singular, plural=None, short=false, show_zero=false) %}
{%- if count > 0 or show_zero -%}
    {%- set display_singular = singular -%}
    {%- if plural -%}
        {%- set display_plural = plural -%}
    {%- elif singular == 'opportunity' -%}
        {%- set display_plural = 'opportunities' -%}
    {%- else -%}
        {%- set display_plural = singular + 's' -%}
    {%- endif -%}
    
    {%- if short -%}
        {%- if singular == 'opportunity' -%}
            {%- set display_singular = 'opp' -%}
            {%- set display_plural = 'opps' -%}
        {%- endif -%}
    {%- endif -%}
    
    {{ count }} {{ display_singular if count == 1 else display_plural }}
{%- endif -%}
{% endmacro %}

{#
  Expand/Collapse Controls - Standardized section expansion controls
  
  Parameters:
  - target_sections (required): Alpine.js data object name containing section states
  - additional_classes (optional): Extra CSS classes for the container
  
  Usage:
  {{ expand_collapse_controls('expandedSections') }}
  {{ expand_collapse_controls('sectionStates', 'ml-4') }}
#}
{% macro expand_collapse_controls(target_sections, additional_classes='') %}
<div class="flex items-center gap-4 border-l pl-4 {{ additional_classes }}">
    <button @click="Object.keys({{ target_sections }}).forEach(key => {{ target_sections }}[key] = true)"
            class="text-secondary-dark hover:text-gray-900">Expand All</button>
    <div class="border-l border-gray-300 h-5"></div>
    <button @click="Object.keys({{ target_sections }}).forEach(key => {{ target_sections }}[key] = false)"
            class="text-secondary-dark hover:text-gray-900">Collapse All</button>
</div>
{% endmacro %}

{#
  Contact Info Badge - Display contact information status
  
  Parameters:
  - contact (required): Contact object with email and phone attributes
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ contact_info_badge(contact) }}
#}
{% macro contact_info_badge(contact, additional_classes='') %}
{%- set has_email = contact.email -%}
{%- set has_phone = contact.phone -%}
{%- if has_email and has_phone -%}
    <span class="badge-standard badge-green {{ additional_classes }}">Complete Info</span>
{%- elif has_email -%}
    <span class="badge-standard badge-blue {{ additional_classes }}">Email Only</span>
{%- elif has_phone -%}
    <span class="badge-standard badge-yellow {{ additional_classes }}">Phone Only</span>
{%- else -%}
    <span class="badge-standard badge-red {{ additional_classes }}">Missing Info</span>
{%- endif -%}
{% endmacro %}

{#
  Entity Link Button - Standardized link button for entity detail pages
  
  Parameters:
  - url (required): URL to navigate to
  - text (optional): Button text (default: 'View Details')
  - classes (optional): CSS classes for styling
  
  Usage:
  {{ entity_link_button(url_for('companies.detail', company_id=company.id)) }}
  {{ entity_link_button('/contacts/' + contact.id|string, 'View Contact') }}
#}
{% macro entity_link_button(url, text='View Details', classes='mt-3 block w-full text-center bg-gray-50 text-gray-700 py-2 rounded-md hover:bg-gray-100') %}
<a href="{{ url }}" class="{{ classes }}">{{ text }}</a>
{% endmacro %}

{#
  Dropdown Select - Single-select dropdown with consistent styling
  
  Parameters:
  - model (required): Alpine.js x-model binding name
  - options (required): List of options as [{'value': 'val', 'label': 'Label'}] or simple strings
  - placeholder (optional): Placeholder text for empty option (default: 'Select...')
  - classes (optional): Additional CSS classes (default: standard input styling)
  
  Usage:
  {{ dropdown_select('groupBy', [{'value': 'stage', 'label': 'Pipeline Stage'}], 'Group by:') }}
  {{ dropdown_select('sortBy', ['name', 'date', 'priority']) }}
#}
{% macro dropdown_select(model, options, placeholder='Select...', classes='px-3 py-2 border border-gray-300 rounded-md text-sm') %}
<div class="multiselect-custom" x-data="{ open: false }" @click.away="open = false">
    <button type="button" 
            class="select-custom {{ classes }}" 
            @click="open = !open"
            x-cloak
            x-init="if (typeof {{ model }} === 'undefined' || {{ model }} === null) { {{ model }} = '{{ options[0].value if options[0] is mapping else options[0] }}' }">
        <span x-text="
                  {% for option in options %}
                  {% if option is mapping %}
                  {{ model }} === '{{ option.value }}' ? '{{ option.label }}' :
                  {% else %}
                  {{ model }} === '{{ option }}' ? '{{ option|title }}' :
                  {% endif %}
                  {% endfor %}
                  '{{ options[0].label if options[0] is mapping else options[0]|title }}'
              ">
                  {# Smart fallback: try to match the likely preset value #}
                  {% set smart_fallback = options[0].label if options[0] is mapping else options[0]|title %}
                  {% for option in options %}
                      {% if option is mapping and option.value == 'status' %}
                          {% set smart_fallback = option.label %}
                      {% elif option is mapping and option.value == 'stage' %}
                          {% set smart_fallback = option.label %}  
                      {% elif option is mapping and option.value == 'company' %}
                          {% set smart_fallback = option.label %}
                      {% endif %}
                  {% endfor %}
                  {{ smart_fallback }}
              </span>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" 
                 @click="setSortBy ? setSortBy('{{ option.value if option is mapping else option }}') : ({{ model }} = '{{ option.value if option is mapping else option }}'); open = false">
                <span>{{ option.label if option is mapping else option|title }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  Section Group Header - DRY implementation for consistent expandable section headers
  
  Parameters:
  - section_key (required): Unique key for expand/collapse state
  - title (required): Display title for the section
  - icon_html (required): HTML for the icon (use icon macros)
  - badge_html (required): HTML for the count badge
  - border_color (required): Border color class name (e.g., 'blue', 'red')
  - bg_color (required): Background color class name
  - hover_color (required): Hover background color class name
  - text_class (required): Text styling class
  - with_buttons (optional): Show expand/collapse all buttons (default: true)
  
  Usage:
  {{ section_group_header('todo', 'To Do', clipboard_icon("w-5 h-5 mr-1"), '<span class="badge-blue">5</span>', 'blue', 'blue', 'blue', 'text-status-header') }}
#}
{% macro section_group_header(section_key, title, icon_html, badge_html, border_color, bg_color, hover_color, text_class, with_buttons=true) %}
{% from "components/icons.html" import chevron_right_icon %}
<div class="border-b border-{{ border_color }}-200 px-6 py-4 bg-{{ bg_color }}-50 cursor-pointer hover:bg-{{ hover_color }}-100" 
     @click="expandedSections['{{ section_key }}'] = !expandedSections['{{ section_key }}']">
    <div class="flex items-center justify-between">
        <h3 class="{{ text_class }}">
            <span class="mr-2 transition-transform duration-200" :class="expandedSections['{{ section_key }}'] ? 'rotate-90' : ''">
                {{ chevron_right_icon("w-4 h-4") }}
            </span>{{ icon_html|safe }} {{ title }}{{ badge_html|safe }}
        </h3>
        {% if with_buttons %}
        <div class="flex items-center space-x-2 text-sm text-gray-500" x-show="expandedSections['{{ section_key }}']">
            <button @click.stop="expandAllItemsInGroup('{{ section_key }}')" class="hover:text-blue-600 transition-colors">Expand All</button>
            <span>|</span>
            <button @click.stop="collapseAllItemsInGroup('{{ section_key }}')" class="hover:text-blue-600 transition-colors">Collapse All</button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  Dropdown Multi-Select - Multi-select dropdown with search and Select All/Deselect All
  
  Parameters:
  - model (required): Alpine.js x-model binding name (should be an array)
  - options (required): List of options as [{'value': 'val', 'label': 'Label'}] or simple strings
  - placeholder (optional): Button text when no items selected (default: 'Select...')
  - with_search (optional): Include search functionality (default: false)
  - classes (optional): Additional CSS classes for the button
  
  Usage:
  {{ dropdown_multiselect('priorityFilter', [{'value': 'high', 'label': 'High'}], 'All Priorities') }}
  {{ dropdown_multiselect('companyFilter', companies, 'All Companies', with_search=true) }}
#}
{% macro dropdown_multiselect(model, options, placeholder='Select...', with_search=false, classes='px-3 py-2 border border-gray-300 rounded-md text-sm') %}
<div class="multiselect-custom" 
     x-data="{ 
         open: false, 
         searchTerm: '',
         init() {
             // Ensure model is initialized as an array
             if (!{{ model }}) {
                 {{ model }} = [];
             }
         }
     }" 
     @click.away="open = false">
    <button type="button" 
            class="multiselect-button {{ classes }}" 
            x-cloak
            @click="open = !open">
        <span x-text="{{ model }}.length === 0 ? '{{ placeholder }}' : {{ model }}.length + ' selected'">{{ placeholder }}</span>
    </button>
    
    <div x-show="open" 
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="multiselect-dropdown">
        
        <div class="multiselect-header">
            {% if with_search %}
            <input type="text" 
                   x-model="searchTerm" 
                   class="multiselect-search" 
                   placeholder="Search..."
                   @click.stop>
            {% endif %}
            <div class="multiselect-controls">
                <span class="multiselect-control-btn" 
                      @click="{{ model }} = [{% for option in options %}'{{ option.value if option is mapping else option }}'{% if not loop.last %}, {% endif %}{% endfor %}]">Select All</span>
                <span class="multiselect-control-btn" 
                      @click="{{ model }} = []">Deselect All</span>
            </div>
        </div>
        
        <div class="multiselect-options">
            {% for option in options %}
            <div class="multiselect-option" 
                 {% if with_search %}x-show="!searchTerm || '{{ option.label if option is mapping else option }}'.toLowerCase().includes(searchTerm.toLowerCase())"{% endif %}
                 @click="
                    const value = '{{ option.value if option is mapping else option }}';
                    const index = {{ model }}.indexOf(value);
                    if (index === -1) {
                        {{ model }}.push(value);
                    } else {
                        {{ model }}.splice(index, 1);
                    }
                 ">
                <input type="checkbox" 
                       class="multiselect-checkbox"
                       :checked="{{ model }}.includes('{{ option.value if option is mapping else option }}')"
                       @click.stop>
                <span>{{ option.label if option is mapping else option }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
<<<<<<< HEAD
  Entity Section Group - DRY macro for entity index page sections
  
  Creates complete expandable sections with header, content area, and filtering.
  Optimized for contacts, opportunities, and similar entity groupings.
  
  Parameters:
  - section_key (required): Unique key for expand/collapse state
  - title (required): Section display title
  - icon_html (required): Icon HTML for section header
  - items (required): List of items to render in section
  - card_class (optional): CSS class for card wrapper (default: 'card')
  - colors (required): Dict with badge_color, border_color, bg_color, hover_color, text_class
  - x_show_condition (optional): Additional Alpine.js x-show condition
  - empty_message (optional): Message when no items (default: 'No items found')
  
  Usage:
  {% call entity_section_group('company', 'Companies', building_icon(...), companies, colors=company_colors) %}
    <!-- render items here using caller() -->
  {% endcall %}
#}
{% macro entity_section_group(section_key, title, icon_html, items, card_class='card', colors=None, x_show_condition='', empty_message='No items found') %}
<div {% if x_show_condition %}x-show="{{ x_show_condition }}" x-cloak {% endif %}class="{{ card_class }}">
    {{ section_group_header(
        section_key,
        title,
        icon_html|safe, 
        '<span class="ml-2 badge-standard badge-' + colors.badge_color + '">' + items|length|string + '</span>',
        colors.border_color,
        colors.bg_color,
        colors.hover_color, 
        colors.text_class,
        with_buttons=false
    ) }}
    <div class="divide-y divide-gray-200" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% if items %}
            {{ caller() }}
        {% else %}
            <div class="p-6 text-center text-empty-state">
                {{ empty_message }}
            </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  Badge Count Helper - DRY macro for task count badges with consistent formatting
  
  Parameters:
  - filter_type (required): Type of filtering ('status', 'priority', 'due_date', 'entity', 'overdue', 'custom')
  - filter_value (optional): Specific value to filter by (e.g., 'todo', 'high', 'company')
  - color (required): Badge color class ('blue', 'red', 'green', etc.)
  - tasks_list (optional): Tasks list to use (default: 'tasks')
  - show_completed (optional): Whether to include completed tasks (default: varies by type)
  - custom_count (optional): Pre-calculated count for complex filters
  
  Usage:
  {{ badge_count_helper('status', 'todo', 'blue') }}
  {{ badge_count_helper('priority', 'high', 'red') }}
  {{ badge_count_helper('custom', color='gray', custom_count=custom_task_list|length) }}
#}
{% macro badge_count_helper(filter_type, filter_value=None, color='gray', tasks_list='tasks_objects', show_completed=None, custom_count=None) %}
{%- if custom_count is not none -%}
    {%- set count = custom_count -%}
{%- elif filter_type == 'status' -%}
    {%- set count = (tasks_objects|selectattr('status', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'priority' -%}
    {%- set count = (tasks_objects|selectattr('priority', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'overdue' -%}
    {%- set count = (tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length) -%}
{%- elif filter_type == 'due_today' -%}
    {%- set count = (tasks_objects|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length) -%}
{%- elif filter_type == 'no_date' -%}
    {%- if show_completed -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|list|length) -%}
    {%- else -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
    {%- endif -%}
{%- elif filter_type == 'entity' -%}
    {%- if filter_value == 'unrelated' -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- else -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- endif -%}
{%- else -%}
    {%- set count = 0 -%}
{%- endif -%}
<span class="ml-2 badge-standard badge-{{ color }}">{{ count }}</span>
{%- endmacro %}

{#
  Task Section Group - DRY macro for complete task sections with filtering
  
  Comprehensive macro that handles all task grouping types and eliminates repetitive code.
  
  Parameters:
  - section_key (required): Key for expandedSections and group identifier
  - title (required): Section title
  - icon_html (required): Icon HTML from icon macros
  - card_class (optional): Card CSS class (default: 'card')
  - colors (required): Object with {badge_color, border_color, bg_color, hover_color, text_class}
  - x_show_condition (optional): Additional x-show condition (e.g., 'showCompleted')
  - filter_config (required): Object with filtering configuration
    - {type: 'status', value: 'todo'} - Filter by status
    - {type: 'priority', value: 'high'} - Filter by priority  
    - {type: 'entity', value: 'company'} - Filter by entity type
    - {type: 'overdue'} - Filter overdue tasks
    - {type: 'due_today'} - Filter tasks due today
    - {type: 'no_date'} - Filter tasks with no due date
    - {type: 'custom', filter_func: 'custom_filter_function'} - Custom filtering
  - additional_classes (optional): Extra CSS classes for rendered tasks
  
  Usage:
  {{ task_section_group('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), 
       colors={badge_color: 'blue', border_color: 'blue', bg_color: 'blue', hover_color: 'blue', text_class: 'text-status-header'}, 
       filter_config={type: 'status', value: 'todo'}) }}
#}
{% macro task_section_group(section_key, title, icon_html, card_class='card', colors=None, x_show_condition='', filter_config=None, additional_classes='') %}
{%- from "components/task_card.html" import render_task, render_task_hierarchy -%}
<div {% if x_show_condition %}x-show="{{ x_show_condition }}" x-cloak {% endif %}class="{{ card_class }}">
    {{ section_group_header(
        section_key,
        title,
        icon_html|safe, 
        '<span class="ml-2 badge-standard badge-' + colors.badge_color + '">' + (
            (tasks_objects|selectattr('status', 'equalto', filter_config.value)|list|length)|string if filter_config and filter_config.type == 'status' else
            (tasks_objects|selectattr('priority', 'equalto', filter_config.value)|list|length)|string if filter_config and filter_config.type == 'priority' else
            (tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length)|string if filter_config and filter_config.type == 'overdue' else
            (tasks_objects|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length)|string if filter_config and filter_config.type == 'due_today' else
            (filter_config.custom_count|string if filter_config.custom_count is defined else '0') if filter_config and (filter_config.type == 'custom_due_week' or filter_config.type == 'custom_due_later') else
            '0'
        ) + '</span>',
        colors.border_color,
        colors.bg_color,
        colors.hover_color, 
        colors.text_class
    ) }}
    <div class="p-6" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% set has_tasks = [] %}
        {% for task in tasks_objects %}
            {% set show_task = false %}
            {# Apply filtering logic based on filter_config #}
            {%- if filter_config -%}
                {%- if filter_config.type == 'status' and task.status == filter_config.value and task.task_type != 'child' -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'priority' and task.priority == filter_config.value -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'overdue' and task.is_overdue -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'due_today' and task.due_date == today -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'no_date' and not task.due_date -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'entity' -%}
                    {%- if filter_config.value == 'unrelated' and not task.entity_type -%}
                        {% set show_task = true %}
                    {%- elif task.entity_type == filter_config.value -%}
                        {% set show_task = true %}
                    {%- endif -%}
                {%- elif filter_config.type == 'custom_due_week' and task.due_date and task.due_date > today and (task.due_date - today).days <= 7 -%}
                    {% set show_task = true %}
                {%- elif filter_config.type == 'custom_due_later' and task.due_date and (task.due_date - today).days > 7 -%}
                    {% set show_task = true %}
                {%- endif -%}
            {%- endif -%}
            
            {% if show_task %}
                {% set _ = has_tasks.append(task) %}
                <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'})" {% if additional_classes %}class="{{ additional_classes }}"{% endif %}>
                    {% if task.task_type == 'parent' %}
                        {{ render_task_hierarchy(task, section_key) }}
                    {% else %}
                        {{ render_task(task, section_key) }}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
        {% if has_tasks|length == 0 %}
            <p class="text-empty-state">No matching tasks found</p>
        {% endif %}
    </div>
</div>
{% endmacro %}
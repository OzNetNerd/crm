{#
  HTMX Search Results Component

  Displays search results in a dropdown format
  Used by the global search functionality

  Variables:
  - results: List of search result objects with id, type, title, subtitle, url
  - query: The search query string
#}
{% from 'macros/base/buttons.html' import entity_link %}

{% if results %}
<div class="py-1">
    {% if query %}
    <div class="px-4 py-2 text-xs font-medium text-gray-600 bg-gray-50 border-b">
        {{ results|length }} result{% if results|length != 1 %}s{% endif %} for "{{ query }}"
    </div>
    {% endif %}

    {% for result in results %}
    <div class="border-b border-gray-100 last:border-b-0" data-search-result="{{ result.type }}">
        <a href="#"
           {% if mode == 'select' %}
           onclick="selectEntity('{{ field_id }}', '{{ result.id }}', '{{ result.title }}', '{{ result.type }}'); return false;"
           {% else %}
           hx-get="{{ url_for('modals.view_modal', model_name=result.model_type, entity_id=result.id) }}"
           hx-target="body"
           hx-swap="beforeend"
           {% endif %}
           class="flex items-center space-x-3 px-4 py-3 block hover:bg-blue-50 transition-colors duration-150"
           data-entity-type="{{ result.model_type }}"
           data-entity-id="{{ result.id }}">
            <!-- Type icon -->
            <div class="flex-shrink-0">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm
                    {% if result.type == 'company' %}bg-blue-100 text-blue-600
                    {% elif result.type == 'contact' %}bg-green-100 text-green-600
                    {% elif result.type == 'opportunity' %}bg-purple-100 text-purple-600
                    {% elif result.type == 'task' %}bg-orange-100 text-orange-600
                    {% else %}bg-gray-100 text-gray-600{% endif %}">
{{ result.icon if result.icon else '📄' }}
                </span>
            </div>

            <!-- Content -->
            <div class="min-w-0 flex-1">
                <div class="text-sm font-semibold text-gray-900 truncate hover:text-blue-700 transition-colors">
                    {{ result.title }}
                </div>
                {% if result.subtitle %}
                <div class="text-xs text-gray-500 truncate mt-1">
                    {{ result.subtitle }}
                </div>
                {% endif %}
            </div>

            <!-- Type label -->
            <div class="flex-shrink-0">
                <span class="badge badge-entity-{{ result.type }} capitalize">
                    {{ result.type }}
                </span>
            </div>
        </a>
    </div>
    {% endfor %}
</div>
{% else %}
    {% if query %}
    <div class="px-4 py-6 text-sm text-gray-500 text-center">
        <div class="text-gray-400 text-2xl mb-2">🔍</div>
        No results found for "{{ query }}"
    </div>
    {% else %}
    <div class="px-4 py-6 text-sm text-gray-500 text-center">
        <div class="text-gray-400 text-2xl mb-2">💡</div>
        Start typing to search companies, contacts, opportunities, and tasks
    </div>
    {% endif %}
{% endif %}

{% if mode == 'select' %}
<script>
// Initialize badges on page load if there's existing data
document.addEventListener('DOMContentLoaded', function() {
    const widgets = document.querySelectorAll('.entity-search-widget');
    widgets.forEach(widget => {
        const fieldId = widget.dataset.fieldId;
        const dataField = document.getElementById(fieldId + '-data');
        const badgesDiv = document.getElementById(fieldId + '-badges');

        if (dataField && badgesDiv && dataField.value && dataField.value !== '[]') {
            try {
                const entities = JSON.parse(dataField.value);
                entities.forEach(entity => {
                    createEntityBadge(fieldId, entity.id, entity.name, entity.type);
                });
            } catch (e) {
                console.error('Error loading entity badges:', e);
            }
        }
    });
});

function createEntityBadge(fieldId, entityId, entityName, entityType) {
    const badgesDiv = document.getElementById(fieldId + '-badges');
    if (!badgesDiv) return;

    // Check if badge already exists
    if (badgesDiv.querySelector(`[data-entity-id="${entityId}"][data-entity-type="${entityType}"]`)) {
        return;
    }

    const badge = document.createElement('span');
    badge.className = `inline-flex items-center px-2 py-1 rounded-full text-xs font-medium badge badge-entity-${entityType}`;
    badge.innerHTML = `
        <span class="mr-1">
            ${entityType === 'company' ? '🏢' :
              entityType === 'contact' ? '👤' :
              entityType === 'opportunity' ? '💼' :
              entityType === 'task' ? '📋' : '📄'}
        </span>
        ${entityName}
        <button type="button" onclick="removeEntityBadge('${fieldId}', '${entityId}', '${entityType}')" class="ml-1 text-current hover:text-red-600">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    badge.dataset.entityId = entityId;
    badge.dataset.entityType = entityType;
    badgesDiv.appendChild(badge);
}

function selectEntity(fieldId, entityId, entityName, entityType) {
    // Get elements
    const searchField = document.getElementById(fieldId);
    const dataField = document.getElementById(fieldId + '-data');
    const badgesDiv = document.getElementById(fieldId + '-badges');
    const resultsDiv = document.getElementById(fieldId + '-results');

    if (!dataField || !badgesDiv) return;

    // Parse existing data
    let entities = [];
    try {
        entities = JSON.parse(dataField.value || '[]');
    } catch (e) {
        entities = [];
    }

    // Check if already selected
    if (entities.some(e => e.id == entityId && e.type === entityType)) {
        // Clear search and hide results
        if (searchField) searchField.value = '';
        if (resultsDiv) resultsDiv.classList.add('hidden');
        return;
    }

    // Add new entity
    entities.push({
        id: entityId,
        name: entityName,
        type: entityType
    });

    // Update hidden field
    dataField.value = JSON.stringify(entities);

    // Create badge using helper function
    createEntityBadge(fieldId, entityId, entityName, entityType);

    // Clear search and hide results
    if (searchField) searchField.value = '';
    if (resultsDiv) resultsDiv.classList.add('hidden');
}

function removeEntityBadge(fieldId, entityId, entityType) {
    const dataField = document.getElementById(fieldId + '-data');
    const badgesDiv = document.getElementById(fieldId + '-badges');

    if (!dataField || !badgesDiv) return;

    // Parse and filter entities
    let entities = [];
    try {
        entities = JSON.parse(dataField.value || '[]');
    } catch (e) {
        entities = [];
    }

    entities = entities.filter(e => !(e.id == entityId && e.type === entityType));
    dataField.value = JSON.stringify(entities);

    // Remove badge from display
    const badge = badgesDiv.querySelector(`[data-entity-id="${entityId}"][data-entity-type="${entityType}"]`);
    if (badge) badge.remove();
}
</script>
{% endif %}
{# Universal HTMX Content Partial - Works for ALL entities using new modular card system #}
{% from "macros/cards.html" import card, simple_card %}
{% from "macros/empty_state.html" import empty_state, group_empty_state %}
{% from "macros/task_renderer.html" import render_task_entity %}
{% from 'macros/base/icons.html' import icon %}

{# Pure CSS/HTML version - no Alpine.js needed #}
<div class="space-y-4">

    {# Show total count #}
    {% if total_count > 0 and grouped_entities|length > 0 %}
        <div class="text-sm text-gray-600 mb-4">
            Showing {{ total_count }} {{ entity_name_singular if total_count == 1 else entity_name }}
        </div>
    {% endif %}

    {# Render grouped entities using CSS details/summary #}
    {% for group in grouped_entities %}
        <details class="bg-white rounded-lg shadow-sm border border-gray-200" data-group="{{ group.key }}" open>
            <summary class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg cursor-pointer list-none">
                <div class="flex items-center justify-between">
                    <h3 class="font-medium text-gray-900 flex items-center">
                        <span class="mr-2 text-gray-400 hover:text-gray-600 transition-[transform,translate,scale,rotate] duration-200 details-chevron">
                            {{ icon('chevron-right', 'md') }}
                        </span>
                        {{ group.label }}
                        <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                            {{ group.count }}
                        </span>
                    </h3>
                </div>
            </summary>
            
            {# Group Content #}
            <div class="divide-y divide-gray-200">
                
                {% for entity in group.entities %}
                    {# Use specialized task renderer for tasks, simple rendering for others #}
                    {% if entity_type == 'task' %}
                        {{ render_task_entity(entity) }}
                    {% elif entity.task_type is not defined or entity.task_type != 'child' %}
                        <div class="p-4">
                            {{ card(entity) }}
                        </div>
                    {% endif %}
                {% endfor %}
                
                {% if group.entities|length == 0 %}
                    {{ group_empty_state(entity_name_plural, group.label) }}
                {% endif %}
            </div>
        </details>
    {% endfor %}

    {# No results message - using DRY empty state component #}
    {% if grouped_entities|length == 0 %}
        {{ empty_state(model_class.get_entity_config()) }}
    {% endif %}

</div>

<style>
/* CSS for details chevron rotation in entity groups */
details[data-group] summary::-webkit-details-marker {
    display: none;
}
details[data-group][open] .details-chevron {
    transform: rotate(90deg);
}
</style>
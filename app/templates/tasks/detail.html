{% extends "base/layout.html" %}
{% from "components/page_template.html" import page_layout %}

{% block title %}{{ task.description[:50] }}... - Tasks - CRM{% endblock %}

{% block content %}

{% set task_buttons = [
    {
        'label': 'Edit Task',
        'onclick': 'openTaskDetailModal(' + task.id|string + ')',
        'color': 'blue',
        'icon': ''
    },
    {
        'label': 'All Tasks',
        'onclick': 'window.location.href="/tasks"',
        'color': 'gray',
        'icon': ''
    }
] %}

{% call page_layout(task.description[:50] + ("..." if task.description|length > 50 else ""), "Task Details", buttons=task_buttons) %}

<div class="max-w-4xl mx-auto">
    <!-- Task Overview Card -->
    <div class="card p-6 mb-6">
        <div class="flex items-start justify-between mb-6">
            <div class="flex-1">
                <h2 class="text-entity-base text-color-task mb-2">{{ task.description }}</h2>
                <div class="flex items-center space-x-4 text-secondary">
                    {% if task.related_entities %}
                        {% for entity in task.related_entities %}
                            <span class="text-entity-base text-color-{{ entity.entity_type }}">{{ entity.name }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                {% set status_color = 'blue' if task.status == 'todo' else
                                     'yellow' if task.status == 'in-progress' else
                                     'green' if task.status == 'complete' else
                                     'gray' %}
                <span class="badge-standard badge-{{ status_color }}">{{ task.status|title }}</span>
                
                {% set priority_color = 'red' if task.priority == 'high' else
                                       'yellow' if task.priority == 'medium' else
                                       'blue' %}
                <span class="badge-standard badge-{{ priority_color }}">{{ task.priority|title }}</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% if task.due_date %}
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-semibold text-gray-900">{{ task.due_date.strftime('%B %d, %Y') }}</div>
                <div class="text-sm text-gray-500">Due Date</div>
            </div>
            {% endif %}
            
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-semibold text-gray-900">{{ task.days_until_due if task.days_until_due is not none else 'N/A' }}</div>
                <div class="text-sm text-gray-500">Days {{ 'Overdue' if task.is_overdue else 'Remaining' }}</div>
            </div>
            
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-semibold text-gray-900">{{ task.task_type|title }}</div>
                <div class="text-sm text-gray-500">Task Type</div>
            </div>
        </div>
    </div>
    
    {% if task.task_type == 'parent' and task.child_tasks %}
    <!-- Child Tasks Section -->
    <div class="card p-6 mb-6">
        <h3 class="text-section-title mb-4">Child Tasks</h3>
        <div class="space-y-3">
            {% for child in task.child_tasks %}
                <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">{{ child.description }}</div>
                        <div class="text-sm text-gray-500 flex items-center space-x-4 mt-1">
                            <span>Priority: {{ child.priority|title }}</span>
                            <span>Status: {{ child.status|title }}</span>
                            {% if child.due_date %}
                                <span>Due: {{ child.due_date.strftime('%m/%d/%Y') }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <button onclick="viewTaskDetails({{ child.id }})"
                            class="text-blue-600 hover:text-blue-800 text-sm">
                        View Details
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="card p-6">
            <h3 class="text-section-title mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <button onclick="openTaskDetailModal({{ task.id }})"
                        class="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                    <div class="font-medium text-blue-900">View Full Details</div>
                    <div class="text-sm text-blue-600">Edit, add notes, and view related data</div>
                </button>
                
                {% if task.status != 'complete' %}
                <button onclick="markTaskComplete({{ task.id }})"
                        class="w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                    <div class="font-medium text-green-900">Mark Complete</div>
                    <div class="text-sm text-green-600">Mark this task as completed</div>
                </button>
                {% endif %}
                
                {% if task.related_entities %}
                    {% for entity in task.related_entities %}
                        <button onclick="window.location.href='/{{ entity.entity_type }}s/{{ entity.id }}'"
                                class="w-full text-left px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            <div class="font-medium text-purple-900">View {{ entity.entity_type|title }}</div>
                            <div class="text-sm text-purple-600">{{ entity.name }}</div>
                        </button>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        
        <div class="card p-6">
            <h3 class="text-section-title mb-4">Task Information</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-form-label">Priority</label>
                    <p class="text-secondary font-medium">{{ task.priority|title }}</p>
                </div>
                
                <div>
                    <label class="text-form-label">Status</label>
                    <p class="text-secondary font-medium">{{ task.status|title }}</p>
                </div>
                
                {% if task.next_step_type %}
                <div>
                    <label class="text-form-label">Next Step Type</label>
                    <p class="text-secondary">{{ task.next_step_type|title }}</p>
                </div>
                {% endif %}
                
                <div>
                    <label class="text-form-label">Created</label>
                    <p class="text-secondary">{{ task.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
                
                {% if task.completed_at %}
                <div>
                    <label class="text-form-label">Completed</label>
                    <p class="text-secondary">{{ task.completed_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Navigation hint -->
    <div class="text-center py-8">
        <p class="text-metadata mb-4">For detailed editing and notes, use the modal interface</p>
        <button onclick="openTaskDetailModal({{ task.id }})"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Open Detail Modal
        </button>
    </div>
</div>

{% endcall %}
{% endblock %}

{% block entity_scripts %}
<script src="{{ url_for('static', filename='js/features/tasks.js') }}"></script>
{% endblock %}
{# HTMX Content Partial for Tasks - Now DRY with macro-based sections #}
{% from "components/task_sections.html" import render_status_sections, render_priority_sections, render_due_date_sections, render_entity_sections %}

{# Alpine.js data for expand/collapse state #}
<div x-data="{ 
    expandedSections: {
        'todo': true,
        'in-progress': true,
        'complete': true,
        'high': true,
        'medium': true,
        'low': true,
        'overdue': true,
        'today': true,
        'this_week': true,
        'later': true,
        'no_date': true,
        'company': true,
        'contact': true,
        'opportunity': true,
        'unrelated': true
    },
    
    shouldShowTask(taskData) {
        // Priority filter logic: empty array means show all
        const priorityMatch = this.priorityFilter.length === 0 || this.priorityFilter.includes(taskData.priority);
        
        // Entity filter logic: empty array means show all, null entity_type becomes 'unrelated'
        const taskEntityType = taskData.entity_type || 'unrelated';
        const entityMatch = this.entityFilter.length === 0 || this.entityFilter.includes(taskEntityType);
        
        // Completed task visibility based on showCompleted toggle
        const completedMatch = taskData.status !== 'complete' || this.showCompleted;
        
        return priorityMatch && entityMatch && completedMatch;
    },
    
    expandAllItemsInGroup(groupName) {
        this.$dispatch('expand-all-tasks', { group: groupName });
    },
    
    collapseAllItemsInGroup(groupName) {
        this.$dispatch('collapse-all-tasks', { group: groupName });
    }
}" class="space-y-4">

    <!-- Tasks by Status - DRY macro replaces ~75 lines -->
    {% if group_by == 'status' %}
        {{ render_status_sections(filtered_tasks, today, show_completed) }}
    {% endif %}

    <!-- Tasks by Priority - DRY macro replaces ~75 lines -->
    {% if group_by == 'priority' %}
        {{ render_priority_sections(filtered_tasks, today) }}
    {% endif %}

    <!-- Tasks by Due Date - DRY macro replaces ~150 lines -->
    {% if group_by == 'due_date' %}
        {{ render_due_date_sections(filtered_tasks, today) }}
    {% endif %}

    <!-- Tasks by Related To - DRY macro replaces ~75 lines -->
    {% if group_by == 'entity' %}
        {{ render_entity_sections(filtered_tasks, today) }}
    {% endif %}

</div>
{# HTMX Content Partial for Tasks - Dynamic task sections only #}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/ui_elements.html" import section_group_header %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon %}

{# Alpine.js data for expand/collapse state #}
<div x-data="{ 
    expandedSections: {
        'todo': true,
        'in-progress': true,
        'complete': true,
        'high': true,
        'medium': true,
        'low': true,
        'overdue': true,
        'today': true,
        'this_week': true,
        'later': true,
        'no_date': true,
        'company': true,
        'contact': true,
        'opportunity': true,
        'unrelated': true
    },
    
    shouldShowTask(taskData) {
        // Priority filter logic: empty array means show all
        const priorityMatch = this.priorityFilter.length === 0 || this.priorityFilter.includes(taskData.priority);
        
        // Entity filter logic: empty array means show all, null entity_type becomes 'unrelated'
        const taskEntityType = taskData.entity_type || 'unrelated';
        const entityMatch = this.entityFilter.length === 0 || this.entityFilter.includes(taskEntityType);
        
        // Completed task visibility based on showCompleted toggle
        const completedMatch = taskData.status !== 'complete' || this.showCompleted;
        
        return priorityMatch && entityMatch && completedMatch;
    },
    
    expandAllItemsInGroup(groupName) {
        this.$dispatch('expand-all-tasks', { group: groupName });
    },
    
    collapseAllItemsInGroup(groupName) {
        this.$dispatch('collapse-all-tasks', { group: groupName });
    }
}" class="space-y-4">

    <!-- Tasks by Status -->
    {% if group_by == 'status' %}
        <!-- To Do Tasks -->
        <div class="card">
            {{ section_group_header('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (filtered_tasks|selectattr('status', 'equalto', 'todo')|list|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['todo']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.status == 'todo' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'todo') }}
                        {% else %}
                            {{ render_task(task, 'todo') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- In Progress Tasks -->
        <div class="card">
            {{ section_group_header('in-progress', 'In Progress', bolt_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (filtered_tasks|selectattr('status', 'equalto', 'in-progress')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['in-progress']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.status == 'in-progress' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'in-progress') }}
                        {% else %}
                            {{ render_task(task, 'in-progress') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Completed Tasks (conditional) -->
        {% if show_completed %}
        <div class="card">
            {{ section_group_header('complete', 'Completed', check_circle_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (filtered_tasks|selectattr('status', 'equalto', 'complete')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['complete']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.status == 'complete' and task.task_type != 'child' %}
                        <div class="opacity-60">
                            {% if task.task_type == 'parent' %}
                                {{ render_task_hierarchy(task, 'complete') }}
                            {% else %}
                                {{ render_task(task, 'complete') }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Tasks by Priority -->
    {% if group_by == 'priority' %}
        <!-- High Priority -->
        <div class="card-danger">
            {{ section_group_header('high', 'High Priority', fire_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-red">' + (filtered_tasks|selectattr('priority', 'equalto', 'high')|list|length)|string + '</span>', 'red', 'red', 'red', 'text-status-overdue') }}
            <div class="p-6" x-show="expandedSections['high']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.priority == 'high' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'high') }}
                        {% else %}
                            {{ render_task(task, 'high') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Medium Priority -->
        <div class="card-warning">
            {{ section_group_header('medium', 'Medium Priority', exclamation_triangle_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (filtered_tasks|selectattr('priority', 'equalto', 'medium')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['medium']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.priority == 'medium' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'medium') }}
                        {% else %}
                            {{ render_task(task, 'medium') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Low Priority -->
        <div class="card-success">
            {{ section_group_header('low', 'Low Priority', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (filtered_tasks|selectattr('priority', 'equalto', 'low')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-success') }}
            <div class="p-6" x-show="expandedSections['low']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.priority == 'low' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'low') }}
                        {% else %}
                            {{ render_task(task, 'low') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Tasks by Due Date -->
    {% if group_by == 'due_date' %}
        {# Pre-calculate complex date-based task counts for direct badge calculation #}
        {% set overdue_count = [] %}
        {% set today_count = [] %}
        {% set this_week_count = [] %}
        {% set later_count = [] %}
        {% set no_date_count = [] %}
        {% for task in filtered_tasks %}
            {% if task.due_date %}
                {% set days_diff = (task.due_date - today).days %}
                {% if days_diff < 0 %}{% set _ = overdue_count.append(task) %}
                {% elif days_diff == 0 %}{% set _ = today_count.append(task) %}
                {% elif days_diff <= 7 %}{% set _ = this_week_count.append(task) %}
                {% else %}{% set _ = later_count.append(task) %}
                {% endif %}
            {% else %}
                {% set _ = no_date_count.append(task) %}
            {% endif %}
        {% endfor %}
        
        <!-- Overdue -->
        <div class="card-danger">
            {{ section_group_header('overdue', 'Overdue', exclamation_circle_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-red">' + (overdue_count|length)|string + '</span>', 'red', 'red', 'red', 'text-status-overdue') }}
            <div class="p-6" x-show="expandedSections['overdue']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.due_date and (task.due_date - today).days < 0 and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'overdue') }}
                        {% else %}
                            {{ render_task(task, 'overdue') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Today -->
        <div class="card-orange">
            {{ section_group_header('today', 'Due Today', calendar_days_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-orange">' + (today_count|length)|string + '</span>', 'orange', 'orange', 'orange', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['today']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.due_date and (task.due_date - today).days == 0 and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'today') }}
                        {% else %}
                            {{ render_task(task, 'today') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- This Week -->
        <div class="card-info">
            {{ section_group_header('this_week', 'This Week', calendar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (this_week_count|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-info') }}
            <div class="p-6" x-show="expandedSections['this_week']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.due_date and (task.due_date - today).days > 0 and (task.due_date - today).days <= 7 and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'this_week') }}
                        {% else %}
                            {{ render_task(task, 'this_week') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Later -->
        <div class="card-neutral">
            {{ section_group_header('later', 'Later', chart_bar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (later_count|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['later']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.due_date and (task.due_date - today).days > 7 and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'later') }}
                        {% else %}
                            {{ render_task(task, 'later') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- No Due Date -->
        <div class="card-neutral">
            {{ section_group_header('no_date', 'No Due Date', question_mark_circle_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (no_date_count|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['no_date']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if not task.due_date and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'no_date') }}
                        {% else %}
                            {{ render_task(task, 'no_date') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Tasks by Related To -->
    {% if group_by == 'entity' %}
        <!-- Company Tasks -->
        <div class="card-info">
            {{ section_group_header('company', 'Company Tasks', building_office_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (filtered_tasks|selectattr('entity_type', 'equalto', 'company')|list|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-info') }}
            <div class="p-6" x-show="expandedSections['company']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.entity_type == 'company' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'company') }}
                        {% else %}
                            {{ render_task(task, 'company') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Contact Tasks -->
        <div class="card-success">
            {{ section_group_header('contact', 'Contact Tasks', user_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (filtered_tasks|selectattr('entity_type', 'equalto', 'contact')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-success') }}
            <div class="p-6" x-show="expandedSections['contact']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.entity_type == 'contact' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'contact') }}
                        {% else %}
                            {{ render_task(task, 'contact') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Opportunity Tasks -->
        <div class="card-warning">
            {{ section_group_header('opportunity', 'Opportunity Tasks', currency_dollar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (filtered_tasks|selectattr('entity_type', 'equalto', 'opportunity')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['opportunity']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if task.entity_type == 'opportunity' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'opportunity') }}
                        {% else %}
                            {{ render_task(task, 'opportunity') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Unrelated Tasks -->
        <div class="card-neutral">
            {{ section_group_header('unrelated', 'General Tasks', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (filtered_tasks|selectattr('entity_type', 'equalto', None)|list|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['unrelated']" x-cloak x-transition>
                {% for task in filtered_tasks %}
                    {% if (not task.entity_type or task.entity_type == 'unrelated') and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'unrelated') }}
                        {% else %}
                            {{ render_task(task, 'unrelated') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}

</div>
{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="{ 
    priorityFilter: [],
    entityFilter: []
}" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls with HTMX and Better Styling -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-label-dark">Group by:</label>
                
                <!-- Group By Dropdown with HTMX (Button Style) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false, 
                    groupBy: '{{ group_by }}',
                    updateGroupBy(value) {
                        this.groupBy = value;
                        htmx.ajax('GET', '/tasks/content?group_by=' + value + '&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}&show_completed={{ show_completed }}&priority={{ priority_filter }}&entity={{ entity_filter }}', {
                            target: '#tasks-content',
                            pushUrl: true
                        });
                    }
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            groupBy === 'status' ? 'Status' :
                            groupBy === 'due_date' ? 'Due Date' :
                            groupBy === 'priority' ? 'Priority' :
                            groupBy === 'entity' ? 'Related To' : 'Status'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="updateGroupBy('status'); open = false">
                                <span>Status</span>
                            </div>
                            <div class="multiselect-option" @click="updateGroupBy('due_date'); open = false">
                                <span>Due Date</span>
                            </div>
                            <div class="multiselect-option" @click="updateGroupBy('priority'); open = false">
                                <span>Priority</span>
                            </div>
                            <div class="multiselect-option" @click="updateGroupBy('entity'); open = false">
                                <span>Related To</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           {% if show_completed %}checked{% endif %}
                           hx-get="/tasks/content"
                           hx-target="#tasks-content" 
                           hx-push-url="true"
                           hx-include="[name='group_by'], [name='sort_by'], [name='sort_direction'], [name='priority'], [name='entity']"
                           name="show_completed"
                           value="true"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                <label class="text-label-dark">Sort by:</label>
                
                <!-- Sort By Dropdown with HTMX (Button Style) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false, 
                    sortBy: '{{ sort_by }}',
                    updateSortBy(value) {
                        this.sortBy = value;
                        htmx.ajax('GET', '/tasks/content?group_by={{ group_by }}&sort_by=' + value + '&sort_direction={{ sort_direction }}&show_completed={{ show_completed }}&priority={{ priority_filter }}&entity={{ entity_filter }}', {
                            target: '#tasks-content',
                            pushUrl: true
                        });
                    }
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            sortBy === 'due_date' ? 'Due Date' :
                            sortBy === 'priority' ? 'Priority' :
                            sortBy === 'created' ? 'Created Date' :
                            sortBy === 'title' ? 'Task Title' :
                            sortBy === 'status' ? 'Status' : 'Due Date'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="updateSortBy('due_date'); open = false">
                                <span>Due Date</span>
                            </div>
                            <div class="multiselect-option" @click="updateSortBy('priority'); open = false">
                                <span>Priority</span>
                            </div>
                            <div class="multiselect-option" @click="updateSortBy('created'); open = false">
                                <span>Created Date</span>
                            </div>
                            <div class="multiselect-option" @click="updateSortBy('title'); open = false">
                                <span>Task Title</span>
                            </div>
                            <div class="multiselect-option" @click="updateSortBy('status'); open = false">
                                <span>Status</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sort Direction Arrow with HTMX -->
                <button type="button" 
                        class="px-2 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50"
                        hx-get="/tasks/content"
                        hx-target="#tasks-content"
                        hx-push-url="true" 
                        hx-include="[name='group_by'], [name='sort_by'], [name='show_completed'], [name='priority'], [name='entity']"
                        hx-vals='{"sort_direction": "{{ 'desc' if sort_direction == 'asc' else 'asc' }}"}'
                        title="Sort {{ 'Descending' if sort_direction == 'asc' else 'Ascending' }}">
                    <span class="text-gray-600">{{ '↑' if sort_direction == 'asc' else '↓' }}</span>
                </button>
                
                <!-- Priority Filter (Button Style) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false, 
                    priority: '{{ priority_filter }}',
                    updatePriority(value) {
                        this.priority = value;
                        htmx.ajax('GET', '/tasks/content?group_by={{ group_by }}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}&show_completed={{ show_completed }}&priority=' + value + '&entity={{ entity_filter }}', {
                            target: '#tasks-content',
                            pushUrl: true
                        });
                    }
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            priority === 'high' ? 'High' :
                            priority === 'medium' ? 'Medium' :
                            priority === 'low' ? 'Low' : 'All Priorities'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="updatePriority(''); open = false">
                                <span>All Priorities</span>
                            </div>
                            <div class="multiselect-option" @click="updatePriority('high'); open = false">
                                <span>High</span>
                            </div>
                            <div class="multiselect-option" @click="updatePriority('medium'); open = false">
                                <span>Medium</span>
                            </div>
                            <div class="multiselect-option" @click="updatePriority('low'); open = false">
                                <span>Low</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Entity Filter (Button Style) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false, 
                    entity: '{{ entity_filter }}',
                    updateEntity(value) {
                        this.entity = value;
                        htmx.ajax('GET', '/tasks/content?group_by={{ group_by }}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}&show_completed={{ show_completed }}&priority={{ priority_filter }}&entity=' + value, {
                            target: '#tasks-content',
                            pushUrl: true
                        });
                    }
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            entity === 'company' ? 'Companies' :
                            entity === 'contact' ? 'Contacts' :
                            entity === 'opportunity' ? 'Opportunities' :
                            entity === 'unrelated' ? 'General Tasks' : 'All Entities'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="updateEntity(''); open = false">
                                <span>All Entities</span>
                            </div>
                            <div class="multiselect-option" @click="updateEntity('company'); open = false">
                                <span>Companies</span>
                            </div>
                            <div class="multiselect-option" @click="updateEntity('contact'); open = false">
                                <span>Contacts</span>
                            </div>
                            <div class="multiselect-option" @click="updateEntity('opportunity'); open = false">
                                <span>Opportunities</span>
                            </div>
                            <div class="multiselect-option" @click="updateEntity('unrelated'); open = false">
                                <span>General Tasks</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HTMX Content Target - Dynamic task sections loaded here -->
    <div id="tasks-content">
        {% include 'tasks/_content.html' %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Make entity data available globally for the modal
window.companiesData = {{ companies | tojson }};
window.contactsData = {{ contacts | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
// Make tasks data available for client-side sorting
window.tasksData = {{ tasks | tojson }};

// Tasks use the centralized modal system from modal-manager.js
// The global openNewTaskModal function handles task modal opening
</script>
{% endblock %}
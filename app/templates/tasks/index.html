{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="taskManager()" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls with HTMX and Better Styling -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-label-dark">Group by:</label>
                
                <!-- Group By Dropdown (Alpine.js Only) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            groupBy === 'status' ? 'Status' :
                            groupBy === 'due_date' ? 'Due Date' :
                            groupBy === 'priority' ? 'Priority' :
                            groupBy === 'entity' ? 'Related To' : 'Status'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="groupBy = 'status'; updateFilters(); open = false">
                                <span>Status</span>
                            </div>
                            <div class="multiselect-option" @click="groupBy = 'due_date'; updateFilters(); open = false">
                                <span>Due Date</span>
                            </div>
                            <div class="multiselect-option" @click="groupBy = 'priority'; updateFilters(); open = false">
                                <span>Priority</span>
                            </div>
                            <div class="multiselect-option" @click="groupBy = 'entity'; updateFilters(); open = false">
                                <span>Related To</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           x-model="showCompleted"
                           @change="updateFilters()"
                           name="show_completed"
                           value="true"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                <label class="text-label-dark">Sort by:</label>
                
                <!-- Sort By Dropdown (Alpine.js Only) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="
                            sortBy === 'due_date' ? 'Due Date' :
                            sortBy === 'priority' ? 'Priority' :
                            sortBy === 'created' ? 'Created Date' :
                            sortBy === 'title' ? 'Task Title' :
                            sortBy === 'status' ? 'Status' : 'Due Date'
                        "></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="sortBy = 'due_date'; updateFilters(); open = false">
                                <span>Due Date</span>
                            </div>
                            <div class="multiselect-option" @click="sortBy = 'priority'; updateFilters(); open = false">
                                <span>Priority</span>
                            </div>
                            <div class="multiselect-option" @click="sortBy = 'created'; updateFilters(); open = false">
                                <span>Created Date</span>
                            </div>
                            <div class="multiselect-option" @click="sortBy = 'title'; updateFilters(); open = false">
                                <span>Task Title</span>
                            </div>
                            <div class="multiselect-option" @click="sortBy = 'status'; updateFilters(); open = false">
                                <span>Status</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sort Direction Arrow (Alpine.js Only) -->
                <button type="button" 
                        class="px-2 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50"
                        @click="sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; updateFilters()"
                        :title="'Sort ' + (sortDirection === 'asc' ? 'Descending' : 'Ascending')">
                    <span class="text-gray-600" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                </button>
                
                <!-- Priority Filter (Alpine.js Only) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="getPriorityDisplayText()"></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-header">
                            <div class="multiselect-controls">
                                <span class="multiselect-control-btn" @click="priorityFilter = ['high', 'medium', 'low']; updateFilters()">Select All</span>
                                <span class="multiselect-control-btn" @click="priorityFilter = []; updateFilters()">Deselect All</span>
                            </div>
                        </div>
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="priorityFilter = []; updateFilters()">
                                <input type="checkbox" :checked="priorityFilter.length === 0" class="mr-2">
                                <span>All Priorities</span>
                            </div>
                            <div class="multiselect-option" @click="togglePriority('high')">
                                <input type="checkbox" :checked="priorityFilter.includes('high')" class="mr-2">
                                <span>High</span>
                            </div>
                            <div class="multiselect-option" @click="togglePriority('medium')">
                                <input type="checkbox" :checked="priorityFilter.includes('medium')" class="mr-2">
                                <span>Medium</span>
                            </div>
                            <div class="multiselect-option" @click="togglePriority('low')">
                                <input type="checkbox" :checked="priorityFilter.includes('low')" class="mr-2">
                                <span>Low</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Entity Filter (Alpine.js Only) -->
                <div class="multiselect-custom" x-data="{ 
                    open: false
                }" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50 flex items-center justify-between min-w-[120px]" 
                            @click="open = !open">
                        <span x-text="getEntityDisplayText()"></span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-header">
                            <div class="multiselect-controls">
                                <span class="multiselect-control-btn" @click="entityFilter = ['company', 'contact', 'opportunity', 'unrelated']; updateFilters()">Select All</span>
                                <span class="multiselect-control-btn" @click="entityFilter = []; updateFilters()">Deselect All</span>
                            </div>
                        </div>
                        <div class="multiselect-options">
                            <div class="multiselect-option" @click="entityFilter = []; updateFilters()">
                                <input type="checkbox" :checked="entityFilter.length === 0" class="mr-2">
                                <span>All Entities</span>
                            </div>
                            <div class="multiselect-option" @click="toggleEntity('company')">
                                <input type="checkbox" :checked="entityFilter.includes('company')" class="mr-2">
                                <span>Companies</span>
                            </div>
                            <div class="multiselect-option" @click="toggleEntity('contact')">
                                <input type="checkbox" :checked="entityFilter.includes('contact')" class="mr-2">
                                <span>Contacts</span>
                            </div>
                            <div class="multiselect-option" @click="toggleEntity('opportunity')">
                                <input type="checkbox" :checked="entityFilter.includes('opportunity')" class="mr-2">
                                <span>Opportunities</span>
                            </div>
                            <div class="multiselect-option" @click="toggleEntity('unrelated')">
                                <input type="checkbox" :checked="entityFilter.includes('unrelated')" class="mr-2">
                                <span>General Tasks</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js Rendered Content - Dynamic task sections rendered here -->
    <div id="tasks-content">
        <!-- Render based on current groupBy selection -->
        <div x-show="groupBy === 'status'">
            {% include 'tasks/_content_status.html' %}
        </div>
        
        <div x-show="groupBy === 'priority'">
            {% include 'tasks/_content_priority.html' %}
        </div>
        
        <div x-show="groupBy === 'due_date'">
            {% include 'tasks/_content_due_date.html' %}
        </div>
        
        <div x-show="groupBy === 'entity'">
            {% include 'tasks/_content_entity.html' %}
        </div>
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Make entity data available globally for the modal
window.companiesData = {{ companies | tojson }};
window.contactsData = {{ contacts | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
// Make tasks data available for client-side sorting
window.tasksData = {{ tasks | tojson }};

// Tasks use the centralized modal system from modal-manager.js
// The global openNewTaskModal function handles task modal opening

// Alpine.js Task Manager Component
function taskManager() {
    return {
        // All tasks data
        allTasks: window.tasksData || [],
        filteredTasks: [],
        
        // Filter states (initialized from backend)
        showCompleted: {{ show_completed | lower }},
        groupBy: '{{ group_by }}',
        sortBy: '{{ sort_by }}',
        sortDirection: '{{ sort_direction }}',
        priorityFilter: {{ priority_filter | tojson }},
        entityFilter: {{ entity_filter | tojson }},
        
        // Today's date for calculations
        today: new Date('{{ today }}'),
        
        // Expanded sections state
        expandedSections: {
            'todo': true,
            'in-progress': true,
            'complete': true,
            'high': true,
            'medium': true,
            'low': true,
            'overdue': true,
            'today': true,
            'this_week': true,
            'later': true,
            'no_date': true,
            'company': true,
            'contact': true,
            'opportunity': true,
            'unrelated': true
        },

        init() {
            this.updateFilters();
        },

        updateFilters() {
            // Apply all filters and sorting
            let tasks = [...this.allTasks];
            
            // Filter by completed status
            if (!this.showCompleted) {
                tasks = tasks.filter(task => task.status !== 'complete');
            }
            
            // Filter by priority (array of values)
            if (this.priorityFilter.length > 0) {
                tasks = tasks.filter(task => this.priorityFilter.includes(task.priority));
            }
            
            // Filter by entity (array of values)
            if (this.entityFilter.length > 0) {
                tasks = tasks.filter(task => {
                    if (this.entityFilter.includes('unrelated')) {
                        if (!task.entity_type || task.entity_type === null) return true;
                    }
                    return this.entityFilter.includes(task.entity_type);
                });
            }
            
            // Sort tasks
            tasks = this.sortTasks(tasks);
            
            this.filteredTasks = tasks;
            this.updateUrlState();
        },

        sortTasks(tasks) {
            return tasks.sort((a, b) => {
                let comparison = 0;
                
                switch(this.sortBy) {
                    case 'priority':
                        const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
                        const priorityA = priorityOrder[a.priority] || 4;
                        const priorityB = priorityOrder[b.priority] || 4;
                        comparison = priorityA - priorityB;
                        break;
                        
                    case 'status':
                        const statusOrder = { 'todo': 1, 'in-progress': 2, 'complete': 3 };
                        const statusA = statusOrder[a.status] || 4;
                        const statusB = statusOrder[b.status] || 4;
                        comparison = statusA - statusB;
                        break;
                        
                    case 'created':
                        const dateA = new Date(a.created_at);
                        const dateB = new Date(b.created_at);
                        comparison = dateA - dateB;
                        break;
                        
                    case 'title':
                        comparison = (a.description || '').localeCompare(b.description || '');
                        break;
                        
                    case 'due_date':
                    default:
                        // Handle null dates - put them last
                        if (!a.due_date && !b.due_date) comparison = 0;
                        else if (!a.due_date) comparison = 1;
                        else if (!b.due_date) comparison = -1;
                        else {
                            const dueDateA = new Date(a.due_date);
                            const dueDateB = new Date(b.due_date);
                            comparison = dueDateA - dueDateB;
                        }
                        break;
                }
                
                return this.sortDirection === 'desc' ? -comparison : comparison;
            });
        },

        updateUrlState() {
            // Update URL parameters to maintain state on refresh
            const params = new URLSearchParams(window.location.search);
            params.set('group_by', this.groupBy);
            params.set('sort_by', this.sortBy);
            params.set('sort_direction', this.sortDirection);
            params.set('show_completed', this.showCompleted.toString());
            params.set('priority', this.priorityFilter.join(','));
            params.set('entity', this.entityFilter.join(','));
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
        },

        // Get tasks by status for rendering
        getTasksByStatus(status) {
            return this.filteredTasks.filter(task => 
                task.status === status && task.task_type !== 'child'
            );
        },

        // Get tasks by priority for rendering
        getTasksByPriority(priority) {
            return this.filteredTasks.filter(task => 
                task.priority === priority && task.task_type !== 'child'
            );
        },

        // Get tasks by due date category for rendering
        getTasksByDueDate(category) {
            return this.filteredTasks.filter(task => {
                if (task.task_type === 'child') return false;
                
                if (category === 'no_date') {
                    return !task.due_date;
                }
                
                if (!task.due_date) return false;
                
                const dueDate = new Date(task.due_date);
                const daysDiff = Math.ceil((dueDate - this.today) / (1000 * 60 * 60 * 24));
                
                switch(category) {
                    case 'overdue': return daysDiff < 0;
                    case 'today': return daysDiff === 0;
                    case 'this_week': return daysDiff > 0 && daysDiff <= 7;
                    case 'later': return daysDiff > 7;
                    default: return false;
                }
            });
        },

        // Get tasks by entity type for rendering
        getTasksByEntity(entityType) {
            return this.filteredTasks.filter(task => {
                if (task.task_type === 'child') return false;
                
                if (entityType === 'unrelated') {
                    return !task.entity_type || task.entity_type === null;
                }
                
                return task.entity_type === entityType;
            });
        },

        // Helper functions for multiselect
        togglePriority(priority) {
            if (this.priorityFilter.includes(priority)) {
                this.priorityFilter = this.priorityFilter.filter(p => p !== priority);
            } else {
                this.priorityFilter.push(priority);
            }
            this.updateFilters();
        },

        toggleEntity(entity) {
            if (this.entityFilter.includes(entity)) {
                this.entityFilter = this.entityFilter.filter(e => e !== entity);
            } else {
                this.entityFilter.push(entity);
            }
            this.updateFilters();
        },

        getPriorityDisplayText() {
            if (this.priorityFilter.length === 0) return 'All Priorities';
            if (this.priorityFilter.length === 1) {
                return this.priorityFilter[0].charAt(0).toUpperCase() + this.priorityFilter[0].slice(1);
            }
            return `${this.priorityFilter.length} Selected`;
        },

        getEntityDisplayText() {
            if (this.entityFilter.length === 0) return 'All Entities';
            if (this.entityFilter.length === 1) {
                const entity = this.entityFilter[0];
                return entity === 'unrelated' ? 'General Tasks' : 
                       entity === 'company' ? 'Companies' :
                       entity === 'contact' ? 'Contacts' :
                       entity === 'opportunity' ? 'Opportunities' : entity;
            }
            return `${this.entityFilter.length} Selected`;
        },

        // Render a task card (simplified HTML for Alpine.js)
        renderTaskCard(task, context) {
            // This is a simplified version - in production, you'd want to 
            // include the full task card template or use a more sophisticated approach
            const priorityClass = {
                'high': 'border-l-red-500',
                'medium': 'border-l-yellow-500',  
                'low': 'border-l-green-500'
            }[task.priority] || 'border-l-gray-300';
            
            const statusClass = {
                'todo': 'bg-blue-50',
                'in-progress': 'bg-yellow-50',
                'complete': 'bg-green-50'
            }[task.status] || 'bg-gray-50';
            
            const dueDateText = task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date';
            
            return `
                <div class="task-card ${statusClass} ${priorityClass} border-l-4 p-4 mb-3 rounded-r-md">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${task.description}</h4>
                            <div class="mt-1 text-sm text-gray-500">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-100 text-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-800">
                                    ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                </span>
                                <span class="ml-2">${dueDateText}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${task.status === 'complete' ? 'green' : task.status === 'in-progress' ? 'yellow' : 'blue'}-100 text-${task.status === 'complete' ? 'green' : task.status === 'in-progress' ? 'yellow' : 'blue'}-800">
                                ${task.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
    };
}
</script>
{% endblock %}
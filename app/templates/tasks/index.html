{% extends "base/layout.html" %}
{% from "components/expandable_card.html" import expandable_card, task_header_content, task_reschedule_buttons, action_buttons_row %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_actions_bar, enhanced_filter_controls %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="createEntityManager(getTaskConfig('{{ today }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar('task', 'tasks', 
         {'label': 'Update Status', 'onclick': 'bulkUpdateStatus()', 'color': 'blue'},
         {'label': 'Delete Selected', 'onclick': 'bulkDelete()', 'color': 'red'}) }}

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls with Generic DRY Components -->
    {{ enhanced_filter_controls(
        group_options=[
            {'value': 'status', 'label': 'Status'},
            {'value': 'due_date', 'label': 'Due Date'},
            {'value': 'priority', 'label': 'Priority'},
            {'value': 'entity', 'label': 'Related To'}
        ],
        sort_options=[
            {'value': 'due_date', 'label': 'Due Date'},
            {'value': 'priority', 'label': 'Priority'},
            {'value': 'created_at', 'label': 'Created Date'},
            {'value': 'title', 'label': 'Title'},
            {'value': 'status', 'label': 'Status'}
        ],
        show_completed_label='Show Completed',
        show_completed_name='show_completed',
        primary_filter_options=get_filter_options('Task', 'priority'),
        primary_filter_label='All Priorities',
        entity_filter_options=get_filter_options('Task', 'entity_type'),
        entity_filter_label='All Entities'
    ) }}

    <!-- Dynamic Client-Side Task Grouping -->
    <div id="tasks-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Hidden pre-rendered task cards for client-side use -->
    <div style="display: none;" id="task-cards-cache">
        {% from "components/expandable_card.html" import expandable_card, task_header_content, task_title_content, task_metadata_content, task_reschedule_buttons, action_buttons_row %}
        {% for task in tasks_objects %}
            {% if task.task_type != 'child' %}
                <div id="task-card-{{ task.id }}">
                    {{ expandable_card('task', task, task.id,
                        expansion_enabled=true,
                        badge_content=task_header_content(task),
                        title_content=task_title_content(task),
                        metadata_content=task_metadata_content(task),
                        action_buttons=action_buttons_row('task', task.id)) }}
                    
                    <!-- Render child tasks if this is a parent -->
                    {% if task.task_type == 'parent' and task.child_tasks %}
                        {% for child in task.child_tasks %}
                            {% if show_completed or child.status != 'complete' %}
                                {{ expandable_card('task', child, child.id,
                                    expansion_enabled=true,
                                    badge_content=task_header_content(child),
                                    title_content=task_title_content(child),
                                    metadata_content=task_metadata_content(child),
                                    action_buttons=action_buttons_row('task', child.id)) }}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% from "components/modals/confirmation.html" import confirmation_modal %}
{{ confirmation_modal('task-confirmation-modal') }}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block data_attributes %}
data-page-type="tasks-index"
{% endblock %}

{% block scripts %}
<script>
// Initialize data for the tasks page
window.companiesData = {{ companies | tojson | safe }};
window.contactsData = {{ contacts | tojson | safe }};
window.opportunitiesData = {{ opportunities | tojson | safe }};
window.tasksData = {{ tasks | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-configs.js') }}"></script>
<script src="{{ url_for('static', filename='js/tasks-index.js') }}"></script>
{% endblock %}

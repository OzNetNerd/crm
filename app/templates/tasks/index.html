{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="{ 
    groupBy: 'status',
    sortBy: 'due_date',
    sortDirection: 'asc',
    showCompleted: {{ 'true' if show_completed else 'false' }},
    priorityFilter: [],
    entityFilter: [],
    tasks: window.tasksData || [],
    expandedSections: {
        'todo': true,
        'in-progress': true,
        'complete': true,
        'high': true,
        'medium': true,
        'low': true,
        'overdue': true,
        'today': true,
        'this_week': true,
        'later': true,
        'no_date': true,
        'company': true,
        'contact': true,
        'opportunity': true,
        'unrelated': true
    },
    
    shouldShowTask(taskData) {
        // Priority filter logic: empty array means show all
        const priorityMatch = this.priorityFilter.length === 0 || this.priorityFilter.includes(taskData.priority);
        
        // Entity filter logic: empty array means show all, null entity_type becomes 'unrelated'
        const taskEntityType = taskData.entity_type || 'unrelated';
        const entityMatch = this.entityFilter.length === 0 || this.entityFilter.includes(taskEntityType);
        
        // Completed task visibility based on showCompleted toggle
        const completedMatch = taskData.status !== 'complete' || this.showCompleted;
        
        return priorityMatch && entityMatch && completedMatch;
    },
    
    getSortValue(task, sortField) {
        switch (sortField) {
            case 'due_date':
                // Handle null due dates by putting them last
                return task.due_date ? new Date(task.due_date).getTime() : 999999999999;
            case 'priority':
                // Priority order: high=1, medium=2, low=3 for ascending sort
                const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
                return priorityOrder[task.priority] || 4;
            case 'created':
                return task.created_at ? new Date(task.created_at).getTime() : 0;
            case 'title':
                return (task.description || '').toLowerCase();
            case 'status':
                // Status order: todo=1, in-progress=2, complete=3
                const statusOrder = { 'todo': 1, 'in-progress': 2, 'complete': 3 };
                return statusOrder[task.status] || 4;
            default:
                return task.due_date ? new Date(task.due_date).getTime() : 999999999999;
        }
    },
    
    sortedFilteredTasks() {
        // Filter tasks first
        const filtered = this.tasks.filter(task => this.shouldShowTask(task));
        
        // Then sort the filtered tasks
        return filtered.sort((a, b) => {
            const aVal = this.getSortValue(a, this.sortBy);
            const bVal = this.getSortValue(b, this.sortBy);
            
            let comparison = 0;
            
            // Handle string comparison for title
            if (this.sortBy === 'title') {
                comparison = aVal.localeCompare(bVal);
            } else {
                // Numeric comparison for dates, priority, status
                comparison = aVal - bVal;
            }
            
            // Apply sort direction
            return this.sortDirection === 'desc' ? -comparison : comparison;
        });
    },
    
    // Temporarily commented out for testing
    // isDueToday(task) {
    //     if (!task.due_date) return false;
    //     const today = new Date().toISOString().split('T')[0];
    //     return task.due_date === today;
    // },
    
    // isDueThisWeek(task) {
    //     if (!task.due_date) return false;
    //     const today = new Date();
    //     const taskDate = new Date(task.due_date);
    //     const diffTime = taskDate.getTime() - today.getTime();
    //     const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    //     return diffDays > 0 && diffDays <= 7;
    // },
    
    // isDueLater(task) {
    //     if (!task.due_date) return false;
    //     const today = new Date();
    //     const taskDate = new Date(task.due_date);
    //     const diffTime = taskDate.getTime() - today.getTime();
    //     const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    //     return diffDays > 7;
    // },
    
    expandAllItemsInGroup(groupName) {
        this.$dispatch('expand-all-tasks', { group: groupName });
    },
    
    collapseAllItemsInGroup(groupName) {
        this.$dispatch('collapse-all-tasks', { group: groupName });
    },
    
    setSortBy(newSortBy) {
        // If selecting the same field, toggle direction
        if (this.sortBy === newSortBy) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // Different field selected, change field and reset to ascending
            this.sortBy = newSortBy;
            this.sortDirection = 'asc';
        }
    }
}" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="flex items-center text-label-dark">Group by:</label>
                {{ dropdown_select('groupBy', [
                    {'value': 'due_date', 'label': 'Due Date'},
                    {'value': 'priority', 'label': 'Priority'},
                    {'value': 'entity', 'label': 'Related To'},
                    {'value': 'status', 'label': 'Status'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           {% if show_completed %}checked{% endif %}
                           @change="window.location.href = showCompleted ? '/tasks/' : '/tasks/?show_completed=true'"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Sort Dropdown using DRY macro with direction arrows -->
                <div x-data="{ 
                    open: false,
                    sortOptions: [
                        {value: 'due_date', label: 'Due Date'},
                        {value: 'priority', label: 'Priority'}, 
                        {value: 'created', label: 'Created Date'},
                        {value: 'title', label: 'Task Title'},
                        {value: 'status', label: 'Status'}
                    ],
                    getSortLabel(value) {
                        const option = this.sortOptions.find(opt => opt.value === value);
                        const arrow = sortDirection === 'asc' ? ' ↑' : ' ↓';
                        return option ? option.label + arrow : 'Sort By';
                    },
                    handleSortChange(value) {
                        setSortBy(value);
                    }
                }" class="multiselect-custom" @click.away="open = false">
                    <button type="button" 
                            class="select-custom px-3 py-2 border border-gray-300 rounded-md text-sm"
                            x-cloak 
                            @click="open = !open">
                        <span x-text="getSortLabel(sortBy)">Due Date ↑</span>
                    </button>
                    
                    <div x-show="open" 
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="multiselect-dropdown">
                        <div class="multiselect-options">
                            <template x-for="option in sortOptions" :key="option.value">
                                <div class="multiselect-option" 
                                     @click="handleSortChange(option.value); open = false">
                                    <span x-text="option.label + (sortBy === option.value ? (sortDirection === 'asc' ? ' ↑' : ' ↓') : '')"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                {{ dropdown_multiselect('priorityFilter', [
                    {'value': 'high', 'label': 'High'},
                    {'value': 'medium', 'label': 'Medium'},
                    {'value': 'low', 'label': 'Low'}
                ], 'All Priorities') }}
                
                {{ dropdown_multiselect('entityFilter', [
                    {'value': 'company', 'label': 'Companies'},
                    {'value': 'contact', 'label': 'Contacts'},
                    {'value': 'opportunity', 'label': 'Opportunities'},
                    {'value': 'unrelated', 'label': 'General Tasks'}
                ], 'All Entities') }}
            </div>
        </div>
    </div>

    <!-- DEBUG: Check available variables -->
    <div class="bg-red-100 p-4 mb-4 text-sm">
        DEBUG: tasks count = {{ tasks|length if tasks else 'UNDEFINED' }}, 
        tasks_objects count = {{ tasks_objects|length if tasks_objects else 'UNDEFINED' }},
        first task status = {{ tasks_objects[0].status if tasks_objects and tasks_objects|length > 0 else 'NO TASKS' }},
        todo count = {{ (tasks_objects|selectattr('status', 'equalto', 'todo')|list|length) }},
        in-progress count = {{ (tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length) }},
        statuses = {% for task in tasks_objects[:5] %}{{ task.status }},{% endfor %}
    </div>
    
    <!-- Tasks by Status - DRY approach -->
    <div x-show="groupBy === 'status'" x-cloak class="space-y-4">
        <!-- To Do Tasks -->
        <div class="card">
            {{ section_group_header('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (tasks_objects|selectattr('status', 'equalto', 'todo')|list|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['todo']" x-cloak x-transition>
                {% for task in tasks_objects %}
                    {% if task.status == 'todo' and task.task_type != 'child' %}
                        <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'})">
                            {% if task.task_type == 'parent' %}
                                {{ render_task_hierarchy(task, 'todo') }}
                            {% else %}
                                {{ render_task(task, 'todo') }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- In Progress Tasks -->
        <div class="card">
            {{ section_group_header('in-progress', 'In Progress', bolt_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['in-progress']" x-cloak x-transition>
                {% for task in tasks_objects %}
                    {% if task.status == 'in-progress' and task.task_type != 'child' %}
                        <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'})">
                            {% if task.task_type == 'parent' %}
                                {{ render_task_hierarchy(task, 'in-progress') }}
                            {% else %}
                                {{ render_task(task, 'in-progress') }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Completed Tasks (conditional) -->
        <div x-show="showCompleted" x-cloak class="card">
            {{ section_group_header('complete', 'Completed', check_circle_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (tasks_objects|selectattr('status', 'equalto', 'complete')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['complete']" x-cloak x-transition>
                {% for task in tasks_objects %}
                    {% if task.status == 'complete' and task.task_type != 'child' %}
                        <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'}" class="opacity-60">
                            {% if task.task_type == 'parent' %}
                                {{ render_task_hierarchy(task, 'complete') }}
                            {% else %}
                                {{ render_task(task, 'complete') }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tasks by Priority -->
    <div x-show="groupBy === 'priority'" x-cloak class="space-y-4">
        <!-- High Priority -->
        {{ task_section_group('high', 'High Priority', fire_icon_solid("w-5 h-5 mr-1"), 
           card_class='card-danger',
           colors={'badge_color': 'red', 'border_color': 'red', 'bg_color': 'red', 'hover_color': 'red', 'text_class': 'text-status-overdue'}, 
           filter_config={'type': 'priority', 'value': 'high'}) }}

        <!-- Medium Priority -->
        {{ task_section_group('medium', 'Medium Priority', exclamation_triangle_icon("w-5 h-5 mr-1"), 
           card_class='card-warning',
           colors={'badge_color': 'yellow', 'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-warning'}, 
           filter_config={'type': 'priority', 'value': 'medium'}) }}

        <!-- Low Priority -->
        {{ task_section_group('low', 'Low Priority', clipboard_list_icon("w-5 h-5 mr-1"), 
           card_class='card-success',
           colors={'badge_color': 'green', 'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-success'}, 
           filter_config={'type': 'priority', 'value': 'low'}) }}
    </div>

    <!-- Tasks by Due Date -->
    <div x-show="groupBy === 'due_date'" x-cloak class="space-y-4">
        {# Pre-calculate complex date-based task counts #}
        {% set this_week_tasks = [] %}{% for task in tasks_objects %}{% if task.due_date and task.due_date > today and (task.due_date - today).days <= 7 and (task.status != 'complete' or showCompleted) %}{% set _ = this_week_tasks.append(task) %}{% endif %}{% endfor %}
        {% set later_tasks = [] %}{% for task in tasks_objects %}{% if task.due_date and (task.due_date - today).days > 7 and (task.status != 'complete' or showCompleted) %}{% set _ = later_tasks.append(task) %}{% endif %}{% endfor %}
        
        <!-- Overdue -->
        {{ task_section_group('overdue', 'Overdue', exclamation_circle_icon_solid("w-5 h-5 mr-1"), 
           card_class='card-danger',
           colors={'badge_color': 'red', 'border_color': 'red', 'bg_color': 'red', 'hover_color': 'red', 'text_class': 'text-status-overdue'}, 
           filter_config={'type': 'overdue'}) }}

        <!-- Today -->
        {{ task_section_group('today', 'Due Today', calendar_days_icon("w-5 h-5 mr-1"), 
           card_class='card-orange',
           colors={'badge_color': 'orange', 'border_color': 'orange', 'bg_color': 'orange', 'hover_color': 'orange', 'text_class': 'text-status-warning'}, 
           filter_config={'type': 'due_today'}) }}

        <!-- This Week -->
        {{ task_section_group('this_week', 'This Week', calendar_icon("w-5 h-5 mr-1"), 
           card_class='card-info',
           colors={'badge_color': 'blue', 'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-info'}, 
           filter_config={'type': 'custom_due_week', 'custom_count': this_week_tasks|length}) }}

        <!-- Later -->
        {{ task_section_group('later', 'Later', chart_bar_icon("w-5 h-5 mr-1"), 
           card_class='card-neutral',
           colors={'badge_color': 'gray', 'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral'}, 
           filter_config={'type': 'custom_due_later', 'custom_count': later_tasks|length}) }}

        <!-- No Due Date -->
        {{ task_section_group('no_date', 'No Due Date', question_mark_circle_icon("w-5 h-5 mr-1"), 
           card_class='card-neutral',
           colors={'badge_color': 'gray', 'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral'}, 
           filter_config={'type': 'no_date'}) }}
    </div>

    <!-- Tasks by Related To -->
    <div x-show="groupBy === 'entity'" x-cloak class="space-y-4">
        <!-- Company Tasks -->
        {{ task_section_group('company', 'Company Tasks', building_office_icon("w-5 h-5 mr-1"), 
           card_class='card-info',
           colors={'badge_color': 'blue', 'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-info'}, 
           filter_config={'type': 'entity', 'value': 'company'}) }}

        <!-- Contact Tasks -->
        {{ task_section_group('contact', 'Contact Tasks', user_icon("w-5 h-5 mr-1"), 
           card_class='card-success',
           colors={'badge_color': 'green', 'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-success'}, 
           filter_config={'type': 'entity', 'value': 'contact'}) }}

        <!-- Opportunity Tasks -->
        {{ task_section_group('opportunity', 'Opportunity Tasks', currency_dollar_icon("w-5 h-5 mr-1"), 
           card_class='card-warning',
           colors={'badge_color': 'yellow', 'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-warning'}, 
           filter_config={'type': 'entity', 'value': 'opportunity'}) }}

        <!-- Unrelated Tasks -->
        {{ task_section_group('unrelated', 'General Tasks', clipboard_list_icon("w-5 h-5 mr-1"), 
           card_class='card-neutral',
           colors={'badge_color': 'gray', 'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral'}, 
           filter_config={'type': 'entity', 'value': 'unrelated'}) }}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Make entity data available globally for the modal
window.companiesData = {{ companies | tojson }};
window.contactsData = {{ contacts | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
// Make tasks data available for client-side sorting
window.tasksData = {{ tasks | tojson }};

// Tasks use the centralized modal system from modal-manager.js
// The global openNewTaskModal function handles task modal opening
</script>
{% endblock %}
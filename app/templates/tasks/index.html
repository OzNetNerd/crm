{% extends "base/layout.html" %}

{% from "macros/page_template.html" import page_layout %}
{% from "macros/ui_elements.html" import enhanced_filter_controls, dynamic_entity_section, bulk_actions_bar %}
{% from "macros/expandable_card.html" import expandable_card, task_header_content, task_reschedule_buttons, action_buttons_row, task_title_content, task_metadata_content %}
{% from "macros/imports/entity_imports.html" import include_common_modals %}
{% from "macros/icons.html" import plus_icon %}

{% block title %}All Tasks - CRM{% endblock %}

{% block content %}
{% set entity_name = "All Tasks" %}
{% set entity_description = "Manage all your tasks in one place" %}
{% set entity_type = "task" %}

{% set entity_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': plus_icon('w-4 h-4')
    }
] %}

{% set entity_filter_controls %}
{{ enhanced_filter_controls(
    group_options=get_groupable_fields(Task),
    sort_options=get_sortable_fields(Task),
    show_completed_label='Show Completed',
    show_completed_name='show_completed',
    primary_filter_options=PRIORITY_OPTIONS,
    primary_filter_label='All Priorities',
    entity_filter_options=get_field_options(Task, 'entity_type'),
    entity_filter_label='All Entities'
) }}
{% endset %}

{% set entity_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': plus_icon('w-4 h-4')
    }
] %}

{% call page_layout(entity_name, entity_description, buttons=entity_buttons, summary_data=entity_stats) %}

<div class="space-y-6">
    <!-- HTMX-Based Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <form hx-get="{{ url_for('tasks.content') }}" 
              hx-target="#task-content"
              hx-trigger="change, submit"
              hx-indicator="#loading-indicator"
              class="grid grid-cols-1 md:grid-cols-5 gap-4">
            
            <!-- Group By -->
            <div>
                <label for="group_by" class="block text-sm font-medium text-gray-700 mb-1">Group by</label>
                <select name="group_by" id="group_by" 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="status" {{ 'selected' if group_by == 'status' else '' }}>Status</option>
                    <option value="priority" {{ 'selected' if group_by == 'priority' else '' }}>Priority</option>
                    <option value="due_date" {{ 'selected' if group_by == 'due_date' else '' }}>Due Date</option>
                </select>
            </div>

            <!-- Sort By -->
            <div>
                <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                <select name="sort_by" id="sort_by" 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="due_date" {{ 'selected' if sort_by == 'due_date' else '' }}>Due Date</option>
                    <option value="priority" {{ 'selected' if sort_by == 'priority' else '' }}>Priority</option>
                    <option value="created_at" {{ 'selected' if sort_by == 'created_at' else '' }}>Created Date</option>
                </select>
            </div>

            <!-- Sort Direction -->
            <div>
                <label for="sort_direction" class="block text-sm font-medium text-gray-700 mb-1">Order</label>
                <select name="sort_direction" id="sort_direction" 
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="asc" {{ 'selected' if sort_direction == 'asc' else '' }}>Ascending</option>
                    <option value="desc" {{ 'selected' if sort_direction == 'desc' else '' }}>Descending</option>
                </select>
            </div>

            <!-- Priority Filter -->
            <div>
                <label for="priority_filter" class="block text-sm font-medium text-gray-700 mb-1">Priorities</label>
                <select name="priority_filter" id="priority_filter" multiple
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="high" {{ 'selected' if 'high' in priority_filter else '' }}>High</option>
                    <option value="medium" {{ 'selected' if 'medium' in priority_filter else '' }}>Medium</option>
                    <option value="low" {{ 'selected' if 'low' in priority_filter else '' }}>Low</option>
                </select>
            </div>

            <!-- Show Completed -->
            <div class="flex items-center">
                <div class="flex items-center h-5">
                    <input type="checkbox" name="show_completed" id="show_completed" value="true"
                           {{ 'checked' if show_completed else '' }}
                           class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                </div>
                <div class="ml-3 text-sm">
                    <label for="show_completed" class="font-medium text-gray-700">Show Completed</label>
                </div>
            </div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="htmx-indicator">
        <div class="flex items-center justify-center p-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading...</span>
        </div>
    </div>

    <!-- Dynamic Content Area -->
    <div id="task-content" 
         hx-get="{{ url_for('tasks.content') }}?{{ request.query_string.decode('utf-8') }}"
         hx-trigger="load">
        <!-- Content will be loaded here via HTMX -->
        <div class="flex items-center justify-center p-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading tasks...</span>
        </div>
    </div>
</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% from "macros/modals/confirmation.html" import confirmation_modal %}
{{ confirmation_modal('task-confirmation-modal') }}
{{ include_common_modals() }}
{% endblock %}

{% block data_attributes %}
{# No longer need page-type for data initialization since using HTMX #}
{% endblock %}

{% block scripts %}
<!-- Minimal scripts for modal functionality only -->
<script src="{{ url_for('static', filename='js/components/modals/modal-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/features/tasks.js') }}"></script>
{% endblock %}
{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_actions_bar %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="createEntityManager(getTaskConfig('{{ today }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar('task', 'tasks', 
         {'label': 'Update Status', 'onclick': 'bulkUpdateStatus()', 'color': 'blue'},
         {'label': 'Delete Selected', 'onclick': 'bulkDelete()', 'color': 'red'}) }}

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls with HTMX and Better Styling -->
    <div class="card-padded-lg filter-section-enhanced">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0 lg:gap-6">
            <div class="flex flex-wrap items-center gap-6">
                <label class="text-label-dark">Group by:</label>
                
                {{ generic_group_dropdown('groupBy', [
                    {'value': 'status', 'label': 'Status'},
                    {'value': 'due_date', 'label': 'Due Date'},
                    {'value': 'priority', 'label': 'Priority'},
                    {'value': 'entity', 'label': 'Related To'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           x-model="showCompleted"
                           @change="updateFilters()"
                           name="show_completed"
                           value="true"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center gap-6">
                <label class="text-label-dark">Sort by:</label>
                
                {{ generic_sort_dropdown('sortBy', 'sortDirection', [
                    {'value': 'due_date', 'label': 'Due Date'},
                    {'value': 'priority', 'label': 'Priority'},
                    {'value': 'created_at', 'label': 'Created Date'},
                    {'value': 'title', 'label': 'Title'},
                    {'value': 'status', 'label': 'Status'}
                ]) }}
                
                {{ generic_filter_multiselect('primaryFilter', [
                    {'value': 'high', 'label': 'High'},
                    {'value': 'medium', 'label': 'Medium'},
                    {'value': 'low', 'label': 'Low'}
                ], 'All Priorities', 'togglePrimaryFilter', 'getPrimaryFilterDisplayText') }}
                
                {{ generic_filter_multiselect('entityFilter', [
                    {'value': 'company', 'label': 'Company'},
                    {'value': 'contact', 'label': 'Contact'},
                    {'value': 'opportunity', 'label': 'Opportunity'},
                    {'value': 'unrelated', 'label': 'General'}
                ], 'All Entities', 'toggleEntityFilter', 'getEntityFilterDisplayText') }}
            </div>
        </div>
    </div>

    <!-- Dynamic Client-Side Task Grouping -->
    <div id="tasks-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Hidden pre-rendered task cards for client-side use -->
    <div style="display: none;" id="task-cards-cache">
        {% from "components/task_card.html" import render_task, render_task_hierarchy %}
        {% for task in tasks_objects %}
            {% if task.task_type != 'child' %}
                <div id="task-card-{{ task.id }}">
                    {% if task.task_type == 'parent' %}
                        {{ render_task_hierarchy(task) }}
                    {% else %}
                        {{ render_task(task) }}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% from "components/modals/confirmation.html" import confirmation_modal %}
{{ confirmation_modal('task-confirmation-modal') }}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-configs.js') }}"></script>
<script>
// Make entity data available globally for the entity manager
window.companiesData = {{ companies | tojson }};
window.contactsData = {{ contacts | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
window.tasksData = {{ tasks_data | tojson }};

// Tasks use the centralized entity manager system
// Bulk action functions for tasks
window.bulkUpdateTaskStatus = function(selectedIds) {
    if (selectedIds.length === 0) return;
    
    const newStatus = prompt('Enter new status (todo, in-progress, complete):');
    if (!newStatus) return;
    
    if (!['todo', 'in-progress', 'complete'].includes(newStatus)) {
        alert('Invalid status. Please use: todo, in-progress, or complete');
        return;
    }
    
    // Update each selected task
    selectedIds.forEach(async (taskId) => {
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                // Update task in local data
                const taskIndex = window.tasksData.findIndex(t => t.id.toString() === taskId.toString());
                if (taskIndex !== -1) {
                    window.tasksData[taskIndex].status = newStatus;
                }
            }
        } catch (error) {
            console.error('Error updating task:', error);
        }
    });
    
    // Refresh the page to show changes
    setTimeout(() => location.reload(), 1000);
};

window.bulkDeleteTasks = function(selectedIds) {
    if (selectedIds.length === 0) return;
    
    if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected tasks?`)) {
        return;
    }
    
    // Delete each selected task
    selectedIds.forEach(async (taskId) => {
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Remove task from local data
                window.tasksData = window.tasksData.filter(t => t.id.toString() !== taskId.toString());
            }
        } catch (error) {
            console.error('Error deleting task:', error);
        }
    });
    
    // Refresh the page to show changes
    setTimeout(() => location.reload(), 1000);
};
// Tasks use the centralized modal system from modal-manager.js
// All modal functions including deleteTask are now handled globally
</script>
{% endblock %}

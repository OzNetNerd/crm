{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header %}


{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    },
    {
        'label': 'New Multi Task',
        'onclick': 'window.location.href="/tasks/multi/new"',
        'color': 'green',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="{ 
    groupBy: 'status',
    showCompleted: false,
    priorityFilter: [],
    entityFilter: [],
    expandedSections: {
        'todo': true,
        'in-progress': true,
        'complete': true,
        'high': true,
        'medium': true,
        'low': true,
        'overdue': true,
        'today': true,
        'this_week': true,
        'later': true,
        'no_date': true,
        'company': true,
        'contact': true,
        'opportunity': true,
        'unrelated': true
    },
    
    expandAllItemsInGroup(groupName) {
        this.$dispatch('expand-all-tasks', { group: groupName });
    },
    
    collapseAllItemsInGroup(groupName) {
        this.$dispatch('collapse-all-tasks', { group: groupName });
    }
}" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="flex items-center text-label-dark">Group by:</label>
                {{ dropdown_select('groupBy', [
                    {'value': 'due_date', 'label': 'Due Date'},
                    {'value': 'priority', 'label': 'Priority'},
                    {'value': 'entity', 'label': 'Related To'},
                    {'value': 'status', 'label': 'Status'}
                ]) }}
                
                <label class="flex items-center">
                    <input type="checkbox" x-model="showCompleted" class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                {{ dropdown_multiselect('priorityFilter', [
                    {'value': 'high', 'label': 'High'},
                    {'value': 'medium', 'label': 'Medium'},
                    {'value': 'low', 'label': 'Low'}
                ], 'All Priorities') }}
                
                {{ dropdown_multiselect('entityFilter', [
                    {'value': 'company', 'label': 'Companies'},
                    {'value': 'contact', 'label': 'Contacts'},
                    {'value': 'opportunity', 'label': 'Opportunities'}
                ], 'All Entities') }}
            </div>
        </div>
    </div>

    <!-- Tasks by Status -->
    <div x-show="groupBy === 'status'" class="space-y-4">
        <!-- To Do Tasks -->
        <div class="card">
            {{ section_group_header('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (tasks|selectattr('status', 'equalto', 'todo')|list|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['todo']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'todo' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'todo') }}
                        {% else %}
                            {{ render_task(task, 'todo') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- In Progress Tasks -->
        <div class="card">
            {{ section_group_header('in-progress', 'In Progress', bolt_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (tasks|selectattr('status', 'equalto', 'in-progress')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['in-progress']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'in-progress' and task.task_type != 'child' %}
                        {% if task.task_type == 'parent' %}
                            {{ render_task_hierarchy(task, 'in-progress') }}
                        {% else %}
                            {{ render_task(task, 'in-progress') }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Completed Tasks (conditional) -->
        <div x-show="showCompleted" class="card">
            {{ section_group_header('complete', 'Completed', check_circle_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (tasks|selectattr('status', 'equalto', 'complete')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-header') }}
            <div class="p-6" x-show="expandedSections['complete']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'complete' and task.task_type != 'child' %}
                        <div class="opacity-60">
                            {% if task.task_type == 'parent' %}
                                {{ render_task_hierarchy(task, 'complete') }}
                            {% else %}
                                {{ render_task(task, 'complete') }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tasks by Priority -->
    <div x-show="groupBy === 'priority'" class="space-y-4">
        <!-- High Priority -->
        <div class="card-danger">
            {{ section_group_header('high', 'High Priority', fire_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-red">' + (tasks|selectattr('priority', 'equalto', 'high')|list|length)|string + '</span>', 'red', 'red', 'red', 'text-status-overdue') }}
            <div class="p-6" x-show="expandedSections['high']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'high' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'high') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Medium Priority -->
        <div class="card-warning">
            {{ section_group_header('medium', 'Medium Priority', exclamation_triangle_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (tasks|selectattr('priority', 'equalto', 'medium')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['medium']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'medium' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'medium') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Low Priority -->
        <div class="card-success">
            {{ section_group_header('low', 'Low Priority', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (tasks|selectattr('priority', 'equalto', 'low')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-success') }}
            <div class="p-6" x-show="expandedSections['low']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'low' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'low') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tasks by Due Date -->
    <div x-show="groupBy === 'due_date'" class="space-y-4">
        <!-- Overdue -->
        <div class="card-danger">
            {{ section_group_header('overdue', 'Overdue', exclamation_circle_icon_solid("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-red">' + (tasks|selectattr('is_overdue', 'equalto', True)|list|length)|string + '</span>', 'red', 'red', 'red', 'text-status-overdue') }}
            <div class="p-6" x-show="expandedSections['overdue']" x-transition>
                {% set overdue_task_list = [] %}
                {% for task in tasks %}
                    {% if task.is_overdue and (task.status != 'complete' or showCompleted) %}
                        {% set _ = overdue_task_list.append(task) %}
                        {{ render_task(task, 'overdue') }}
                    {% endif %}
                {% endfor %}
                {% if overdue_task_list|length == 0 %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- Today -->
        <div class="card-orange">
            {{ section_group_header('today', 'Due Today', calendar_days_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-orange">' + (tasks|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length)|string + '</span>', 'orange', 'orange', 'orange', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['today']" x-transition>
                {% set today_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date == today and task.status != 'complete' %}
                        {% set _ = today_task_list.append(task) %}
                        {{ render_task(task, 'today') }}
                    {% endif %}
                {% endfor %}
                {% if today_task_list|length == 0 %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- This Week -->
        <div class="card-info">
            {% set this_week_tasks = [] %}{% for task in tasks %}{% if task.due_date and task.due_date > today and (task.due_date - today).days <= 7 and (task.status != 'complete' or showCompleted) %}{% set _ = this_week_tasks.append(task) %}{% endif %}{% endfor %}{{ section_group_header('this_week', 'This Week', calendar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (this_week_tasks|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-info') }}
            <div class="p-6" x-show="expandedSections['this_week']" x-transition>
                {% set this_week_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date and task.due_date > today and (task.due_date - today).days <= 7 and (task.status != 'complete' or showCompleted) %}
                        {% set _ = this_week_task_list.append(task) %}
                        {{ render_task(task, 'this_week') }}
                    {% endif %}
                {% endfor %}
                {% if this_week_task_list|length == 0 %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- Later -->
        <div class="card-neutral">
            {% set later_tasks = [] %}{% for task in tasks %}{% if task.due_date and (task.due_date - today).days > 7 and (task.status != 'complete' or showCompleted) %}{% set _ = later_tasks.append(task) %}{% endif %}{% endfor %}{{ section_group_header('later', 'Later', chart_bar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (later_tasks|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['later']" x-transition>
                {% set later_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date and (task.due_date - today).days > 7 and (task.status != 'complete' or showCompleted) %}
                        {% set _ = later_task_list.append(task) %}
                        {{ render_task(task, 'later') }}
                    {% endif %}
                {% endfor %}
                {% if later_task_list|length == 0 %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- No Due Date -->
        <div class="card-neutral">
            {{ section_group_header('no_date', 'No Due Date', question_mark_circle_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (tasks|selectattr('due_date', 'none')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('due_date', 'none')|list|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['no_date']" x-transition>
                {% set no_date_task_list = [] %}
                {% for task in tasks %}
                    {% if not task.due_date and (task.status != 'complete' or showCompleted) %}
                        {% set _ = no_date_task_list.append(task) %}
                        {{ render_task(task, 'no_date') }}
                    {% endif %}
                {% endfor %}
                {% if no_date_task_list|length == 0 %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tasks by Related To -->
    <div x-show="groupBy === 'entity'" class="space-y-4">
        <!-- Company Tasks -->
        <div class="card-info">
            {{ section_group_header('company', 'Company Tasks', building_office_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-blue">' + (tasks|selectattr('entity_type', 'equalto', 'company')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'company')|list|length)|string + '</span>', 'blue', 'blue', 'blue', 'text-status-info') }}
            <div class="p-6" x-show="expandedSections['company']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'company' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'company') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Contact Tasks -->
        <div class="card-success">
            {{ section_group_header('contact', 'Contact Tasks', user_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-green">' + (tasks|selectattr('entity_type', 'equalto', 'contact')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'contact')|list|length)|string + '</span>', 'green', 'green', 'green', 'text-status-success') }}
            <div class="p-6" x-show="expandedSections['contact']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'contact' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'contact') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Opportunity Tasks -->
        <div class="card-warning">
            {{ section_group_header('opportunity', 'Opportunity Tasks', currency_dollar_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-yellow">' + (tasks|selectattr('entity_type', 'equalto', 'opportunity')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'opportunity')|list|length)|string + '</span>', 'yellow', 'yellow', 'yellow', 'text-status-warning') }}
            <div class="p-6" x-show="expandedSections['opportunity']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'opportunity' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'opportunity') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Unrelated Tasks -->
        <div class="card-neutral">
            {{ section_group_header('unrelated', 'General Tasks', clipboard_list_icon("w-5 h-5 mr-1"), '<span class="ml-2 badge-standard badge-gray">' + (tasks|selectattr('entity_type', 'none')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'none')|list|length)|string + '</span>', 'gray', 'gray', 'gray', 'text-status-neutral') }}
            <div class="p-6" x-show="expandedSections['unrelated']" x-transition>
                {% for task in tasks %}
                    {% if not task.entity_type and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task, 'unrelated') }}
                    {% endif %}
                {% else %}
                    <p class="text-empty-state">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
function openNewTaskModal() {
    console.log('Opening new task modal');
}
</script>
{% endblock %}
{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task, render_task_hierarchy %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, dropdown_select, dropdown_multiselect, section_group_header, task_section_group, badge_count_helper %}





{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="{ 
    priorityFilter: [],
    entityFilter: []
}" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls with HTMX -->
    <div class="card-padded">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="flex items-center text-label-dark">Group by:</label>
                <select class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                        hx-get="/tasks/content" 
                        hx-target="#tasks-content"
                        hx-push-url="true"
                        hx-include="[name='sort_by'], [name='sort_direction'], [name='show_completed'], [name='priority'], [name='entity']"
                        name="group_by">
                    <option value="status" {% if group_by == 'status' %}selected{% endif %}>Status</option>
                    <option value="due_date" {% if group_by == 'due_date' %}selected{% endif %}>Due Date</option>
                    <option value="priority" {% if group_by == 'priority' %}selected{% endif %}>Priority</option>
                    <option value="entity" {% if group_by == 'entity' %}selected{% endif %}>Related To</option>
                </select>
                
                <label class="flex items-center">
                    <input type="checkbox" 
                           {% if show_completed %}checked{% endif %}
                           hx-get="/tasks/content"
                           hx-target="#tasks-content" 
                           hx-push-url="true"
                           hx-include="[name='group_by'], [name='sort_by'], [name='sort_direction'], [name='priority'], [name='entity']"
                           name="show_completed"
                           value="true"
                           class="mr-2">
                    <span class="text-secondary-dark">Show Completed</span>
                </label>

                {{ expand_collapse_controls('expandedSections') }}
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Sort Dropdown with HTMX -->
                <label class="flex items-center text-label-dark">Sort by:</label>
                <select class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                        hx-get="/tasks/content"
                        hx-target="#tasks-content" 
                        hx-push-url="true"
                        hx-include="[name='group_by'], [name='sort_direction'], [name='show_completed'], [name='priority'], [name='entity']"
                        name="sort_by">
                    <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date</option>
                    <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
                    <option value="created" {% if sort_by == 'created' %}selected{% endif %}>Created Date</option>
                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Task Title</option>
                    <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                </select>
                
                <!-- Sort Direction Arrow with HTMX -->
                <button type="button" 
                        class="px-2 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50"
                        hx-get="/tasks/content"
                        hx-target="#tasks-content"
                        hx-push-url="true" 
                        hx-include="[name='group_by'], [name='sort_by'], [name='show_completed'], [name='priority'], [name='entity']"
                        hx-vals='{"sort_direction": "{{ 'desc' if sort_direction == 'asc' else 'asc' }}"}'
                        title="Sort {{ 'Descending' if sort_direction == 'asc' else 'Ascending' }}">
                    <span class="text-gray-600">{{ '↑' if sort_direction == 'asc' else '↓' }}</span>
                </button>
                
                <!-- Priority filter - will implement multiselect later -->
                <select class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                        hx-get="/tasks/content"
                        hx-target="#tasks-content"
                        hx-push-url="true"
                        hx-include="[name='group_by'], [name='sort_by'], [name='sort_direction'], [name='show_completed'], [name='entity']"
                        name="priority">
                    <option value="">All Priorities</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                </select>
                
                <!-- Entity filter - will implement multiselect later -->
                <select class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                        hx-get="/tasks/content"
                        hx-target="#tasks-content"
                        hx-push-url="true"
                        hx-include="[name='group_by'], [name='sort_by'], [name='sort_direction'], [name='show_completed'], [name='priority']"
                        name="entity">
                    <option value="">All Entities</option>
                    <option value="company" {% if entity_filter == 'company' %}selected{% endif %}>Companies</option>
                    <option value="contact" {% if entity_filter == 'contact' %}selected{% endif %}>Contacts</option>
                    <option value="opportunity" {% if entity_filter == 'opportunity' %}selected{% endif %}>Opportunities</option>
                    <option value="unrelated" {% if entity_filter == 'unrelated' %}selected{% endif %}>General Tasks</option>
                </select>
            </div>
        </div>
    </div>

    <!-- HTMX Content Target - Dynamic task sections loaded here -->
    <div id="tasks-content">
        {% include 'tasks/_content.html' %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Make entity data available globally for the modal
window.companiesData = {{ companies | tojson }};
window.contactsData = {{ contacts | tojson }};
window.opportunitiesData = {{ opportunities | tojson }};
// Make tasks data available for client-side sorting
window.tasksData = {{ tasks | tojson }};

// Tasks use the centralized modal system from modal-manager.js
// The global openNewTaskModal function handles task modal opening
</script>
{% endblock %}
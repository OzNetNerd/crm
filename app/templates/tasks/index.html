{% extends "base/entity_index.html" %}

{# Entity-specific imports #}
{% block entity_imports %}
{% from "components/expandable_card.html" import task_header_content, task_reschedule_buttons, action_buttons_row, task_title_content, task_metadata_content %}
{% endblock %}

{% block entity_config %}
{% set entity_name = "All Tasks" %}
{% set entity_description = "Manage all your tasks in one place" %}
{% set entity_type = "task" %}

{% set entity_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks_objects|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% set entity_filter_controls %}
{{ enhanced_filter_controls(
    group_options=get_groupable_fields(Task),
    sort_options=get_sortable_fields(Task),
    show_completed_label='Show Completed',
    show_completed_name='show_completed',
    primary_filter_options=PRIORITY_OPTIONS,
    primary_filter_label='All Priorities',
    entity_filter_options=get_field_options(Task, 'entity_type'),
    entity_filter_label='All Entities'
) }}
{% endset %}
{% endblock %}

{% block entity_cards %}
{% for task in tasks_objects %}
    {% if task.task_type != 'child' %}
        <div id="task-card-{{ task.id }}">
            {{ expandable_card('task', task, task.id,
                expansion_enabled=true,
                badge_content=task_header_content(task),
                title_content=task_title_content(task),
                metadata_content=task_metadata_content(task),
                action_buttons=action_buttons_row('task', task.id)) }}
            
            <!-- Render child tasks if this is a parent -->
            {% if task.task_type == 'parent' and task.child_tasks %}
                {% for child in task.child_tasks %}
                    {% if show_completed or child.status != 'complete' %}
                        {{ expandable_card('task', child, child.id,
                            expansion_enabled=true,
                            badge_content=task_header_content(child),
                            title_content=task_title_content(child),
                            metadata_content=task_metadata_content(child),
                            action_buttons=action_buttons_row('task', child.id)) }}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}
{% endfor %}
{% endblock %}

{% block entity_data_attributes %}
data-page-type="tasks-index"
{% endblock %}

{% block entity_scripts %}
<script>
// Initialize data for the tasks page
window.companiesData = {{ companies | tojson | safe }};
window.contactsData = {{ contacts | tojson | safe }};
window.opportunitiesData = {{ opportunities | tojson | safe }};
window.tasksData = {{ tasks | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/features/tasks.js') }}"></script>
{% endblock %}
{% extends "base/layout.html" %}
{% from "components/task_card.html" import render_task %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon, chevron_right_icon %}

{% block title %}Tasks - CRM{% endblock %}

{% block content %}
{% set task_stats = {
    'title': 'Task Summary',
    'stats': [
        {
            'value': tasks|selectattr('status', 'equalto', 'todo')|list|length,
            'label': 'To Do',
            'color_class': 'text-blue-600'
        },
        {
            'value': tasks|selectattr('status', 'equalto', 'in-progress')|list|length,
            'label': 'In Progress',
            'color_class': 'text-yellow-600'
        },
        {
            'value': tasks|selectattr('status', 'equalto', 'complete')|list|length,
            'label': 'Complete',
            'color_class': 'text-green-600'
        },
        {
            'value': tasks|selectattr('is_overdue', 'equalto', True)|list|length,
            'label': 'Overdue',
            'color_class': 'text-red-600'
        }
    ]
} %}

{% set task_buttons = [
    {
        'label': 'New Task',
        'onclick': 'openNewTaskModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("All Tasks", "Manage all your tasks in one place", buttons=task_buttons, summary_data=task_stats) %}

<div x-data="{ 
    groupBy: 'status',
    showCompleted: false,
    priorityFilter: '',
    entityFilter: '',
    expandedSections: {
        'todo': true,
        'in-progress': true,
        'complete': true,
        'high': true,
        'medium': true,
        'low': true,
        'overdue': true,
        'today': true,
        'this_week': true,
        'later': true,
        'no_date': true,
        'company': true,
        'contact': true,
        'opportunity': true,
        'unrelated': true
    }
}" class="space-y-6">

    <!-- Task Summary now handled by page_layout template -->

    <!-- Enhanced Filters and Controls -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-label-dark">Group by:</label>
                <select x-model="groupBy" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="due_date">Due Date</option>
                    <option value="priority">Priority</option>
                    <option value="entity">Related To</option>
                    <option value="status">Status</option>
                </select>
                
                <label class="flex items-center">
                    <input type="checkbox" x-model="showCompleted" class="mr-2">
                    <span class="text-sm text-gray-700">Show Completed</span>
                </label>

                <div class="flex items-center space-x-2 border-l pl-4">
                    <button @click="Object.keys(expandedSections).forEach(key => expandedSections[key] = true)"
                            class="text-sm text-gray-600 hover:text-gray-900">Expand All</button>
                    <span class="text-gray-400">|</span>
                    <button @click="Object.keys(expandedSections).forEach(key => expandedSections[key] = false)"
                            class="text-sm text-gray-600 hover:text-gray-900">Collapse All</button>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <select x-model="priorityFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                </select>
                
                <select x-model="entityFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">All Entities</option>
                    <option value="company">Companies</option>
                    <option value="contact">Contacts</option>
                    <option value="opportunity">Opportunities</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Tasks by Status -->
    <div x-show="groupBy === 'status'" class="space-y-4">
        <!-- To Do Tasks -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                 @click="expandedSections['todo'] = !expandedSections['todo']">
                <h3 class="text-status-header">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['todo'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clipboard_list_icon("w-5 h-5 mr-1") }} To Do<span class="ml-2 badge-standard badge-blue">{{ tasks|selectattr('status', 'equalto', 'todo')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['todo']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'todo' %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- In Progress Tasks -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                 @click="expandedSections['in-progress'] = !expandedSections['in-progress']">
                <h3 class="text-status-header">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['in-progress'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ bolt_icon("w-5 h-5 mr-1") }} In Progress<span class="ml-2 badge-standard badge-yellow">{{ tasks|selectattr('status', 'equalto', 'in-progress')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['in-progress']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'in-progress' %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Completed Tasks (conditional) -->
        <div x-show="showCompleted" class="bg-white rounded-lg shadow-sm border">
            <div class="border-b border-gray-200 px-6 py-4 cursor-pointer hover:bg-gray-50" 
                 @click="expandedSections['complete'] = !expandedSections['complete']">
                <h3 class="text-status-header">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['complete'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ check_circle_icon_solid("w-5 h-5 mr-1") }} Completed<span class="ml-2 badge-standard badge-green">{{ tasks|selectattr('status', 'equalto', 'complete')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['complete']" x-transition>
                {% for task in tasks %}
                    {% if task.status == 'complete' %}
                        <div class="opacity-60">
                            {{ render_task(task) }}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tasks by Priority -->
    <div x-show="groupBy === 'priority'" class="space-y-4">
        <!-- High Priority -->
        <div class="bg-white rounded-lg shadow-sm border border-red-200">
            <div class="border-b border-red-200 px-6 py-4 bg-red-50 cursor-pointer hover:bg-red-100" 
                 @click="expandedSections['high'] = !expandedSections['high']">
                <h3 class="text-status-overdue">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['high'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ fire_icon_solid("w-5 h-5 mr-1") }} High Priority<span class="ml-2 badge-standard badge-red">{{ tasks|selectattr('priority', 'equalto', 'high')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['high']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'high' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Medium Priority -->
        <div class="bg-white rounded-lg shadow-sm border border-yellow-200">
            <div class="border-b border-yellow-200 px-6 py-4 bg-yellow-50 cursor-pointer hover:bg-yellow-100" 
                 @click="expandedSections['medium'] = !expandedSections['medium']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['medium'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ exclamation_triangle_icon("w-5 h-5 mr-1") }} Medium Priority<span class="ml-2 badge-standard badge-yellow">{{ tasks|selectattr('priority', 'equalto', 'medium')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['medium']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'medium' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Low Priority -->
        <div class="bg-white rounded-lg shadow-sm border border-green-200">
            <div class="border-b border-green-200 px-6 py-4 bg-green-50 cursor-pointer hover:bg-green-100" 
                 @click="expandedSections['low'] = !expandedSections['low']">
                <h3 class="text-status-success">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['low'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clipboard_list_icon("w-5 h-5 mr-1") }} Low Priority<span class="ml-2 badge-standard badge-green">{{ tasks|selectattr('priority', 'equalto', 'low')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['low']" x-transition>
                {% for task in tasks %}
                    {% if task.priority == 'low' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tasks by Due Date -->
    <div x-show="groupBy === 'due_date'" class="space-y-4">
        <!-- Overdue -->
        <div class="bg-white rounded-lg shadow-sm border border-red-200">
            <div class="border-b border-red-200 px-6 py-4 bg-red-50 cursor-pointer hover:bg-red-100" 
                 @click="expandedSections['overdue'] = !expandedSections['overdue']">
                <h3 class="text-status-overdue">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['overdue'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ exclamation_circle_icon_solid("w-5 h-5 mr-1") }} Overdue<span class="ml-2 badge-standard badge-red">{{ tasks|selectattr('is_overdue', 'equalto', True)|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['overdue']" x-transition>
                {% set overdue_task_list = [] %}
                {% for task in tasks %}
                    {% if task.is_overdue and (task.status != 'complete' or showCompleted) %}
                        {% set _ = overdue_task_list.append(task) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% endfor %}
                {% if overdue_task_list|length == 0 %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- Today -->
        <div class="bg-white rounded-lg shadow-sm border border-orange-200">
            <div class="border-b border-orange-200 px-6 py-4 bg-orange-50 cursor-pointer hover:bg-orange-100" 
                 @click="expandedSections['today'] = !expandedSections['today']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['today'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ calendar_days_icon("w-5 h-5 mr-1") }} Due Today<span class="ml-2 badge-standard badge-orange">{% set today_tasks = tasks|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list %}{{ today_tasks|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['today']" x-transition>
                {% set today_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date == today and task.status != 'complete' %}
                        {% set _ = today_task_list.append(task) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% endfor %}
                {% if today_task_list|length == 0 %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- This Week -->
        <div class="bg-white rounded-lg shadow-sm border border-blue-200">
            <div class="border-b border-blue-200 px-6 py-4 bg-blue-50 cursor-pointer hover:bg-blue-100" 
                 @click="expandedSections['this_week'] = !expandedSections['this_week']">
                <h3 class="text-status-info">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['this_week'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ calendar_icon("w-5 h-5 mr-1") }} This Week<span class="ml-2 badge-standard badge-blue">{% set this_week_tasks = [] %}{% for task in tasks %}{% if task.due_date and task.due_date > today and (task.due_date - today).days <= 7 and (task.status != 'complete' or showCompleted) %}{% set _ = this_week_tasks.append(task) %}{% endif %}{% endfor %}{{ this_week_tasks|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['this_week']" x-transition>
                {% set this_week_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date and task.due_date > today and (task.due_date - today).days <= 7 and (task.status != 'complete' or showCompleted) %}
                        {% set _ = this_week_task_list.append(task) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% endfor %}
                {% if this_week_task_list|length == 0 %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- Later -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100" 
                 @click="expandedSections['later'] = !expandedSections['later']">
                <h3 class="text-status-neutral">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['later'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ chart_bar_icon("w-5 h-5 mr-1") }} Later<span class="ml-2 badge-standard badge-gray">{% set later_tasks = [] %}{% for task in tasks %}{% if task.due_date and (task.due_date - today).days > 7 and (task.status != 'complete' or showCompleted) %}{% set _ = later_tasks.append(task) %}{% endif %}{% endfor %}{{ later_tasks|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['later']" x-transition>
                {% set later_task_list = [] %}
                {% for task in tasks %}
                    {% if task.due_date and (task.due_date - today).days > 7 and (task.status != 'complete' or showCompleted) %}
                        {% set _ = later_task_list.append(task) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% endfor %}
                {% if later_task_list|length == 0 %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endif %}
            </div>
        </div>

        <!-- No Due Date -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100" 
                 @click="expandedSections['no_date'] = !expandedSections['no_date']">
                <h3 class="text-status-neutral">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['no_date'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ question_mark_circle_icon("w-5 h-5 mr-1") }} No Due Date<span class="ml-2 badge-standard badge-gray">{{ tasks|selectattr('due_date', 'none')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('due_date', 'none')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['no_date']" x-transition>
                {% set no_date_task_list = [] %}
                {% for task in tasks %}
                    {% if not task.due_date and (task.status != 'complete' or showCompleted) %}
                        {% set _ = no_date_task_list.append(task) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% endfor %}
                {% if no_date_task_list|length == 0 %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tasks by Related To -->
    <div x-show="groupBy === 'entity'" class="space-y-4">
        <!-- Company Tasks -->
        <div class="bg-white rounded-lg shadow-sm border border-blue-200">
            <div class="border-b border-blue-200 px-6 py-4 bg-blue-50 cursor-pointer hover:bg-blue-100" 
                 @click="expandedSections['company'] = !expandedSections['company']">
                <h3 class="text-status-info">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['company'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ building_office_icon("w-5 h-5 mr-1") }} Company Tasks<span class="ml-2 badge-standard badge-blue">{{ tasks|selectattr('entity_type', 'equalto', 'company')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'company')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['company']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'company' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Contact Tasks -->
        <div class="bg-white rounded-lg shadow-sm border border-green-200">
            <div class="border-b border-green-200 px-6 py-4 bg-green-50 cursor-pointer hover:bg-green-100" 
                 @click="expandedSections['contact'] = !expandedSections['contact']">
                <h3 class="text-status-success">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['contact'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ user_icon("w-5 h-5 mr-1") }} Contact Tasks<span class="ml-2 badge-standard badge-green">{{ tasks|selectattr('entity_type', 'equalto', 'contact')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'contact')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['contact']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'contact' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Opportunity Tasks -->
        <div class="bg-white rounded-lg shadow-sm border border-yellow-200">
            <div class="border-b border-yellow-200 px-6 py-4 bg-yellow-50 cursor-pointer hover:bg-yellow-100" 
                 @click="expandedSections['opportunity'] = !expandedSections['opportunity']">
                <h3 class="text-status-warning">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['opportunity'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ currency_dollar_icon("w-5 h-5 mr-1") }} Opportunity Tasks<span class="ml-2 badge-standard badge-yellow">{{ tasks|selectattr('entity_type', 'equalto', 'opportunity')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'equalto', 'opportunity')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['opportunity']" x-transition>
                {% for task in tasks %}
                    {% if task.entity_type == 'opportunity' and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Unrelated Tasks -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100" 
                 @click="expandedSections['unrelated'] = !expandedSections['unrelated']">
                <h3 class="text-status-neutral">
                    <span class="mr-2 transition-transform duration-200" :class="expandedSections['unrelated'] ? 'rotate-90' : ''">{{ chevron_right_icon("w-4 h-4") }}</span>{{ clipboard_list_icon("w-5 h-5 mr-1") }} General Tasks<span class="ml-2 badge-standard badge-gray">{{ tasks|selectattr('entity_type', 'none')|selectattr('status', 'ne', 'complete')|list|length if not showCompleted else tasks|selectattr('entity_type', 'none')|list|length }}</span>
                </h3>
            </div>
            <div class="p-6" x-show="expandedSections['unrelated']" x-transition>
                {% for task in tasks %}
                    {% if not task.entity_type and (task.status != 'complete' or showCompleted) %}
                        {{ render_task(task) }}
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-center py-4">No matching tasks found</p>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% include "components/modals.html" %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
function openNewTaskModal() {
    console.log('Opening new task modal');
}
</script>
{% endblock %}
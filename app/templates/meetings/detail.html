{% extends "base/layout.html" %}

{% block title %}{{ meeting.title }} - CRM{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center space-x-4 mb-4">
        <a href="{{ url_for('meetings.index') }}" class="text-gray-600 hover:text-gray-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-page-title">{{ meeting.title }}</h1>
        
        <!-- Status Badge -->
        {% if meeting.analysis_status == 'completed' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                ✓ Analysis Complete
            </span>
        {% elif meeting.analysis_status == 'processing' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                ⏳ Processing
            </span>
        {% elif meeting.analysis_status == 'pending' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                📝 Pending Analysis
            </span>
        {% elif meeting.analysis_status == 'failed' %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                ❌ Analysis Failed
            </span>
        {% endif %}
    </div>
    
    <div class="flex items-center space-x-6 text-sm text-gray-500">
        <span>{{ meeting.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
        {% if meeting.company %}
            <span>• {{ meeting.company.name }}</span>
        {% endif %}
        {% if meeting.analyzed_at %}
            <span>• Analyzed {{ meeting.analyzed_at.strftime('%B %d at %I:%M %p') }}</span>
        {% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div class="flex justify-end mb-6 space-x-3">
    {% if meeting.analysis_status in ['pending', 'failed'] %}
        <button onclick="triggerAnalysis({{ meeting.id }})" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
            🔄 Analyze Meeting
        </button>
    {% endif %}
    {% if meeting.analysis_status == 'processing' %}
        <button onclick="checkStatus({{ meeting.id }})" 
                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
            🔄 Check Status
        </button>
    {% endif %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- AI Insights -->
        {% if insights %}
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">🤖 AI-Generated Insights</h2>
                </div>
                <div class="px-6 py-6 space-y-6">
                    <!-- Summary -->
                    {% if insights.summary %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-2">Executive Summary</h3>
                            <p class="text-gray-700 bg-blue-50 p-4 rounded-lg">{{ insights.summary.data }}</p>
                            <div class="mt-2 text-xs-gray-500">
                                Confidence: {{ "%.1f"|format(insights.summary.confidence * 100) }}%
                            </div>
                        </div>
                    {% endif %}

                    <!-- Attendees -->
                    {% if insights.attendees %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">👥 Meeting Attendees</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {% for attendee in insights.attendees.data %}
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <div class="font-medium text-gray-900">{{ attendee.name }}</div>
                                        {% if attendee.role %}
                                            <div class="text-sm text-gray-600">{{ attendee.role }}</div>
                                        {% endif %}
                                        {% if attendee.sentiment %}
                                            <div class="text-xs mt-1">
                                                {% if attendee.sentiment == 'positive' %}
                                                    <span class="text-green-600">😊 Positive</span>
                                                {% elif attendee.sentiment == 'negative' %}
                                                    <span class="text-red-600">😟 Concerned</span>
                                                {% else %}
                                                    <span class="text-gray-600">😐 Neutral</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Action Items -->
                    {% if insights.action_items %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">✅ Action Items</h3>
                            <div class="space-y-3">
                                {% for item in insights.action_items.data %}
                                    <div class="border-l-4 border-blue-500 pl-4 py-2 bg-yellow-50 rounded-r">
                                        <div class="font-medium text-gray-900">{{ item.task }}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            {% if item.assignee %}
                                                <span class="font-medium">Assigned to:</span> {{ item.assignee }}
                                            {% endif %}
                                            {% if item.deadline %}
                                                {% if item.assignee %} • {% endif %}
                                                <span class="font-medium">Due:</span> {{ item.deadline }}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Key Decisions -->
                    {% if insights.decisions %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">🎯 Key Decisions</h3>
                            <ul class="space-y-2">
                                {% for decision in insights.decisions.data %}
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2 mt-1">•</span>
                                        <span class="text-gray-700">{{ decision }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Technologies -->
                    {% if insights.technologies %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">💻 Technologies Mentioned</h3>
                            <div class="flex flex-wrap gap-2">
                                {% for tech in insights.technologies.data %}
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">{{ tech }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Topics -->
                    {% if insights.topics %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">💬 Topics Discussed</h3>
                            <div class="flex flex-wrap gap-2">
                                {% for topic in insights.topics.data %}
                                    <span class="px-3 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">{{ topic }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Sentiment Analysis -->
                    {% if insights.sentiment %}
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">🎭 Sentiment Analysis</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-medium">Overall Mood:</span>
                                    {% if insights.sentiment.data.overall == 'positive' %}
                                        <span class="text-green-600 font-medium">😊 Positive</span>
                                    {% elif insights.sentiment.data.overall == 'negative' %}
                                        <span class="text-red-600 font-medium">😟 Negative</span>
                                    {% else %}
                                        <span class="text-gray-600 font-medium">😐 Neutral</span>
                                    {% endif %}
                                </div>
                                {% if insights.sentiment.data.concerns %}
                                    <div>
                                        <span class="font-medium">Concerns raised:</span>
                                        <ul class="list-disc ml-4 mt-1">
                                            {% for concern in insights.sentiment.data.concerns %}
                                                <li class="text-gray-700">{{ concern }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% elif meeting.analysis_status == 'completed' %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">Analysis Complete</h3>
                        <p class="mt-1 text-sm text-yellow-700">Analysis completed but no insights were generated. This may happen with very short or unclear transcripts.</p>
                    </div>
                </div>
            </div>
        {% elif meeting.analysis_status == 'pending' %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 112 0v4a1 1 0 11-2 0V7zM9 15a1 1 0 102 0 1 1 0 00-2 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Analysis Pending</h3>
                        <p class="mt-1 text-sm text-blue-700">This meeting hasn't been analyzed yet. Click "Analyze Meeting" to start AI processing.</p>
                    </div>
                </div>
            </div>
        {% elif meeting.analysis_status == 'processing' %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-yellow-600"></div>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">Processing...</h3>
                        <p class="mt-1 text-sm text-yellow-700">AI is currently analyzing this meeting transcript. This usually takes 1-2 minutes.</p>
                    </div>
                </div>
            </div>
        {% elif meeting.analysis_status == 'failed' %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Analysis Failed</h3>
                        <p class="mt-1 text-sm text-red-700">There was an error analyzing this meeting. Try clicking "Analyze Meeting" to retry.</p>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Original Transcript -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">📄 Original Transcript</h2>
            </div>
            <div class="px-6 py-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ meeting.transcript }}</pre>
                </div>
                <div class="mt-3 text-xs-gray-500">
                    {{ meeting.transcript|length }} characters
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Meeting Info -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Meeting Info</h3>
            </div>
            <div class="px-6 py-4 space-y-3">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Created</dt>
                    <dd class="text-sm text-gray-900">{{ meeting.created_at.strftime('%B %d, %Y at %I:%M %p') }}</dd>
                </div>
                {% if meeting.company %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Company</dt>
                        <dd class="text-sm text-gray-900">
                            <a href="/companies/{{ meeting.company.id }}" class="text-blue-600 hover:text-blue-800">
                                {{ meeting.company.name }}
                            </a>
                        </dd>
                    </div>
                {% endif %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                    <dd class="text-sm text-gray-900">{{ meeting.analysis_status.title() }}</dd>
                </div>
                {% if meeting.analyzed_at %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Analyzed</dt>
                        <dd class="text-sm text-gray-900">{{ meeting.analyzed_at.strftime('%B %d at %I:%M %p') }}</dd>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
            </div>
            <div class="px-6 py-4 space-y-3">
                <a href="{{ url_for('meetings.new') }}" 
                   class="block w-full text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Upload Another Meeting
                </a>
                <a href="{{ url_for('meetings.index') }}" 
                   class="block w-full text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    View All Meetings
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/meetings-detail.js') }}"></script>
{% endblock %}
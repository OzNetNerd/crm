{% extends "base/layout.html" %}

{# Import core components #}
{% from "macros/base/layout.html" import page_layout %}
{% from "macros/ui_elements.html" import enhanced_filter_controls, dynamic_entity_section, bulk_actions_bar %}
{% from "macros/expandable_card.html" import expandable_card, team_header_content, team_title_content, team_metadata_content, action_buttons_row %}
{% from "macros/base/icons.html" import plus_icon %}
{% from "macros/imports/universal.html" import include_common_modals %}
{% from "macros/modals/confirmation.html" import confirmation_modal %}

{% block title %}Account Teams - CRM{% endblock %}

{% block content %}
{% set entity_stats = {
    'title': 'Account Team Overview',
    'stats': [
        {
            'value': team_members|length,
            'label': 'Total Members',
            'color_class': 'text-blue-600'
        },
        {
            'value': team_members|selectattr('job_title')|list|length,
            'label': 'With Job Title',
            'color_class': 'text-green-600'
        },
        {
            'value': team_members|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-purple-600'
        },
        {
            'value': team_members|selectattr('company')|list|length,
            'label': 'With Company',
            'color_class': 'text-yellow-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Team Member',
        'hx_get': '/modals/TeamMember/create',
        'hx_target': 'body',
        'hx_swap': 'beforeend',
        'color': 'blue',
        'icon': plus_icon('w-4 h-4')
    }
] %}

{% call page_layout("Account Teams", "Manage your account team members", buttons=entity_buttons, summary_data=entity_stats) %}

<div x-data="createEntityManager(getTeamConfig('{{ today if today else '' }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar('team', 'teams', 
         {'label': 'Delete Selected', 'onclick': 'bulkDelete()', 'color': 'red'}) }}

    <!-- Enhanced Filters -->
    {{ enhanced_filter_controls(
        group_options=get_groupable_fields(User),
        sort_options=get_sortable_fields(User),
        show_completed_label='Show All',
        show_completed_name='show_all',
        primary_filter_options=get_field_options(User, 'job_title'),
        primary_filter_label='All Roles'
    ) }}

    <!-- Dynamic Entity Section -->
    <div id="team-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Entity Cards Cache -->
    <div style="display: none;" id="team-cards-cache">
{% for member in team_members %}
    <div id="team-card-{{ member.id }}">
        {{ expandable_card('team', member, member.id,
            expansion_enabled=true,
            badge_content=team_header_content(member),
            title_content=team_title_content(member),
            metadata_content=team_metadata_content(member),
            action_buttons=action_buttons_row('team', member.id)) }}
    </div>
{% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block modals %}
{{ confirmation_modal('team-confirmation-modal') }}
{{ include_common_modals() }}
{% endblock %}

{% block data_attributes %}
data-team-members="{{ team_data | tojson | forceescape }}"
data-companies="{{ companies | tojson | forceescape }}"
data-opportunities="{{ opportunities | tojson | forceescape }}"
{% endblock %}

{% block scripts %}
{# Teams requires specific JavaScript functionality #}
<script src="{{ url_for('static', filename='js/features/dashboard/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/entity-configs.js') }}"></script>
<script src="{{ url_for('static', filename='js/entities/teams.js') }}"></script>
{% endblock %}
{% extends "base/layout.html" %}

{# 
  Universal Entity Index Template - Maximum DRY
  
  Eliminates 90% of duplication across all entity index templates.
  Each entity only needs to define their specific configuration.
  
  Usage: Entity templates extend this and define blocks with their config
#}

{# Universal imports - ALL common imports consolidated #}
{% from "macros/imports/universal.html" import include_common_modals %}

{# Import all the core components that every entity needs #}
{% from "macros/base/layout.html" import page_layout %}
{% from "macros/ui_elements.html" import htmx_enhanced_filter_controls, loading_spinner %}
{% from "macros/base/icons.html" import plus_icon %}
{% from "macros/modals/confirmation.html" import confirmation_modal %}


{# Entity-specific imports - only import what each entity needs #}  
{% block entity_imports %}
{# Each entity imports their specific card helpers here #}
{% endblock %}

{% block title %}{{ entity_name }} - CRM{% endblock %}

{% block content %}
{# Execute entity config block for stats and buttons #}
{% block entity_config %}
{# Default values - each entity should override these #}
{% set entity_stats = {} %}
{% set entity_buttons = [] %}
{% endblock %}

{# Get filter controls from entity template #}
{% set entity_filter_controls %}
{% block entity_filter_controls %}
{% from "macros/ui_elements.html" import htmx_enhanced_filter_controls %}
{{ htmx_enhanced_filter_controls(
    group_options=dropdown_configs.group_by.options if dropdown_configs.group_by else [],
    sort_options=dropdown_configs.sort_by.options if dropdown_configs.sort_by else [],
    sort_direction_options=dropdown_configs.sort_direction.options if dropdown_configs.sort_direction else [],
    primary_filter_options=dropdown_configs.primary_filter.options if dropdown_configs.primary_filter else [],
    primary_filter_label=dropdown_configs.primary_filter.button_text if dropdown_configs.primary_filter else 'All Filters',
    primary_filter_values=dropdown_configs.primary_filter.current_values if dropdown_configs.primary_filter else [],
    expand_collapse_controls=true
) }}
{% endblock %}
{% endset %}

{% call page_layout(entity_name, entity_description, buttons=entity_buttons, summary_data=entity_stats) %}

<div class="space-y-6">
    <!-- HTMX Enhanced Filter Controls -->
    <form hx-get="{{ url_for(entity_endpoint + '.content') }}" 
          hx-target="#{{ entity_type }}-content"
          hx-trigger="change, submit">
        {{ entity_filter_controls|safe }}
    </form>

    <!-- Dynamic Content Area -->
    <div id="{{ entity_type }}-content" 
         hx-get="{{ url_for(entity_endpoint + '.content') }}?{{ request.query_string.decode('utf-8') }}"
         hx-trigger="load">
        <!-- Content will be loaded here via HTMX -->
    </div>
</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% from "macros/modals/confirmation.html" import confirmation_modal %}
{{ confirmation_modal(entity_type + '-confirmation-modal') }}
{{ include_common_modals() }}
{% endblock %}

{% block data_attributes %}
{% block entity_data_attributes %}
{# Each entity defines their data attributes here #}
{% endblock %}
{% endblock %}

{% block scripts %}
<!-- Modal functionality now handled by HTMX -->
{% block entity_scripts %}
{# Each entity can include their specific JS here if needed #}
{% endblock %}
{% endblock %}
{# Head includes - All CSS and JavaScript dependencies #}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}CRM{% endblock %}</title>

{# Inter Font for sharp, professional text #}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

{# Tailwind CSS CDN with custom configuration #}
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
        },
        fontSize: {
          'xs': ['0.75rem', { lineHeight: '1rem' }],
          'sm': ['0.875rem', { lineHeight: '1.25rem' }],
          'base': ['1rem', { lineHeight: '1.5rem' }],
        },
        colors: {
          primary: {
            50: '#eff6ff',
            100: '#dbeafe',
            200: '#bfdbfe',
            300: '#93c5fd',
            400: '#60a5fa',
            500: '#3b82f6',
            600: '#2563eb',
            700: '#1d4ed8',
          },
        },
      },
    },
  }
</script>

{# Minimal custom CSS - DRY approach #}

<link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">

{# Core JavaScript Libraries #}
<script src="https://unpkg.com/htmx.org@2.0.3/dist/htmx.min.js"></script>

{# Alpine.js - Load first #}
<script defer src="https://unpkg.com/alpinejs@3.14.3/dist/cdn.min.js"></script>

{# Initialize dropdown before Alpine starts #}
<script>
// Define dropdown function globally before Alpine initializes
window.dropdown = function(config = {}) {
    return {
        // Core state
        open: false,
        selected: config.multi ? (config.selected || []) : (config.selected || ''),
        search: '',

        // Configuration
        name: config.name || 'dropdown',
        options: config.options || [],
        multi: config.multi || false,
        searchable: config.searchable || false,
        placeholder: config.placeholder || 'Select option',
        htmx: config.htmx || {},

        // Computed
        get filteredOptions() {
            if (!this.searchable || !this.search) {
                return this.options;
            }
            const searchLower = this.search.toLowerCase();
            return this.options.filter(opt => {
                const label = this.getOptionLabel(opt);
                return label.toLowerCase().includes(searchLower);
            });
        },

        get displayText() {
            if (this.multi) {
                if (this.selected.length === 0) {
                    return this.placeholder;
                }
                if (this.selected.length === 1) {
                    const option = this.findOption(this.selected[0]);
                    return option ? this.getOptionLabel(option) : this.placeholder;
                }
                return `${this.selected.length} selected`;
            } else {
                if (!this.selected) {
                    return this.placeholder;
                }
                const option = this.findOption(this.selected);
                return option ? this.getOptionLabel(option) : this.placeholder;
            }
        },

        // Methods
        init() {
            // Watch for changes and dispatch events
            this.$watch('selected', (value) => {
                this.$dispatch('dropdown:change', {
                    name: this.name,
                    value: value,
                    multi: this.multi
                });

                // Trigger HTMX if configured
                if (this.htmx.trigger) {
                    this.triggerHtmx();
                }
            });
        },

        toggle() {
            this.open = !this.open;
            if (this.open && this.searchable) {
                this.$nextTick(() => {
                    this.$refs.searchInput?.focus();
                });
            }
        },

        close() {
            this.open = false;
            this.search = '';
        },

        select(value) {
            if (this.multi) {
                const index = this.selected.indexOf(value);
                if (index > -1) {
                    this.selected = this.selected.filter(v => v !== value);
                } else {
                    this.selected = [...this.selected, value];
                }
            } else {
                this.selected = value;
                this.close();
            }
        },

        isSelected(value) {
            if (this.multi) {
                return this.selected.includes(value);
            }
            return this.selected === value;
        },

        selectAll() {
            if (this.multi) {
                if (this.selected.length === this.options.length) {
                    this.selected = [];
                } else {
                    this.selected = this.options.map(opt => this.getOptionValue(opt));
                }
            }
        },

        clearSelection() {
            this.selected = this.multi ? [] : '';
        },

        // Helper methods
        findOption(value) {
            return this.options.find(opt => this.getOptionValue(opt) === value);
        },

        getOptionValue(option) {
            return typeof option === 'object' ? option.value : option;
        },

        getOptionLabel(option) {
            if (typeof option === 'object') {
                return option.label || option.value;
            }
            return option.toString();
        },

        triggerHtmx() {
            // Create a change event on hidden input to trigger HTMX
            const input = this.$refs.hiddenInput;
            if (input) {
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }
        }
    };
};
</script>

{# Application JavaScript - Load after Alpine setup #}
<script src="{{ url_for('static', filename='js/alpine/chatWidget.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
{# search-htmx.js functionality consolidated into search-widget.js #}
<script src="{{ url_for('static', filename='js/features/search-widget.js') }}"></script>
<script src="{{ url_for('static', filename='js/features/form-enhancements.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/modal-handlers.js') }}"></script>
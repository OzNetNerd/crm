{% extends "base/layout.html" %}

{% from "components/page_template.html" import page_layout %}
{% from "components/ui_elements.html" import enhanced_filter_controls, dynamic_entity_section, bulk_actions_bar, htmx_enhanced_filter_controls %}
{% from "components/expandable_card.html" import expandable_card, stakeholder_header_content, stakeholder_title_content, stakeholder_metadata_content, action_buttons_row %}
{% from "components/imports/entity_imports.html" import include_common_modals %}
{% from "components/icons.html" import plus_icon %}

{% block title %}Stakeholders - CRM{% endblock %}

{% block content %}
{% set entity_stats = {
    'title': 'Stakeholder Overview',
    'stats': [
        {
            'value': stakeholders|length,
            'label': 'Total Stakeholders',
            'color_class': 'text-blue-600'
        },
        {
            'value': stakeholders|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-green-600'
        },
        {
            'value': stakeholders|selectattr('phone')|list|length,
            'label': 'With Phone',
            'color_class': 'text-purple-600'
        },
        {
            'value': stakeholders|map(attribute='opportunities')|map('length')|sum if stakeholders|selectattr('opportunities')|list else 0,
            'label': 'Total Opportunities',
            'color_class': 'text-yellow-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Stakeholder',
        'onclick': 'openNewStakeholderModal()',
        'color': 'blue',
        'icon': plus_icon('w-4 h-4')
    }
] %}

{% call page_layout("Stakeholders", "Manage your stakeholder relationships", buttons=entity_buttons, summary_data=entity_stats) %}

<div class="space-y-6">
    <!-- HTMX Enhanced Filter Controls - Pure CSS Components -->
    <form hx-get="{{ url_for('stakeholders.content') }}" 
          hx-target="#stakeholder-content"
          hx-trigger="change, submit"
          hx-indicator="#loading-indicator">
        {{ htmx_enhanced_filter_controls(
            group_options=group_options,
            sort_options=sort_options,
            show_completed_label='Show Incomplete Info',
            show_completed_name='show_incomplete',
            show_completed_value=show_incomplete,
            primary_filter_options=job_title_options,
            primary_filter_label='All Job Titles',
            primary_filter_values=primary_filter,
            secondary_filter_options=company_options,
            secondary_filter_label='All Companies',
            secondary_filter_values=secondary_filter,
            group_by=group_by,
            sort_by=sort_by,
            sort_direction=sort_direction
        ) }}
    </form>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="htmx-indicator">
        <div class="flex items-center justify-center p-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading...</span>
        </div>
    </div>

    <!-- Dynamic Content Area -->
    <div id="stakeholder-content" 
         hx-get="{{ url_for('stakeholders.content') }}?{{ request.query_string.decode('utf-8') }}"
         hx-trigger="load">
        <!-- Content will be loaded here via HTMX -->
        <div class="flex items-center justify-center p-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading stakeholders...</span>
        </div>
    </div>
</div>

{% endcall %}
{% endblock %}

{% block modals %}
{% from "components/modals/confirmation.html" import confirmation_modal %}
{{ confirmation_modal('stakeholder-confirmation-modal') }}
{{ include_common_modals() }}
{% endblock %}

{% block data_attributes %}
{# No longer need data attributes since using HTMX #}
{% endblock %}

{% block scripts %}
<!-- Modal functionality now handled by HTMX -->
{% endblock %}
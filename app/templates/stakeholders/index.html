{% extends "base/layout.html" %}

{# DRY Common Imports - reduced from 15+ lines to this clean set #}
{% from "components/icons.html" import building_office_icon, user_icon, chevron_right_icon, check_circle_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, phone_icon, envelope_icon %}
{% from "components/ui_elements.html" import expand_collapse_controls, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_actions_bar, enhanced_filter_controls %}
{% from "components/page_template.html" import page_layout %}

{# Entity-specific imports #}
{% from "components/expandable_card.html" import expandable_card, action_buttons_row %}
{% from "components/imports/entity_imports.html" import include_common_modals %}
{% from "components/ui_elements.html" import pluralized_count %}
{% from "components/list_section.html" import status_badge %}

{% block title %}Stakeholders - CRM{% endblock %}

{% block content %}

{# Stakeholder Helper Macros - moved from stakeholder_card.html for DRY consistency #}
{% macro stakeholder_header_content(stakeholder) %}
{% if stakeholder.email and stakeholder.phone %}
    {{ status_badge('Complete', 'green') }}
{% elif stakeholder.email or stakeholder.phone %}
    {{ status_badge('Partial', 'yellow') }}
{% else %}
    {{ status_badge('Incomplete', 'red') }}
{% endif %}
{% endmacro %}

{% macro stakeholder_metadata_content(stakeholder) %}
<span class="text-gray-500">
    Added: {{ stakeholder.created_at.strftime('%d/%m/%y') if stakeholder.created_at else 'Unknown' }}
    {% if stakeholder.opportunities %}
    • {{ pluralized_count(stakeholder.opportunities|length, 'opportunity', short=true) }}
    {% endif %}
    {% if stakeholder.email %}
    • {{ envelope_icon("w-3 h-3 inline") }}
    {% endif %}
    {% if stakeholder.phone %}
    • {{ phone_icon("w-3 h-3 inline") }}
    {% endif %}
</span>
{% endmacro %}

{% macro stakeholder_secondary_info(stakeholder) %}
{% if stakeholder.job_title %}{{ stakeholder.job_title }} • {% endif %}
<span class="text-link-interactive" 
      onclick="event.stopPropagation(); openCompanyDetailModal({{ stakeholder.company.id }})">
    <span class="text-entity-base text-color-company">{{ stakeholder.company.name }}</span>
</span>
{% endmacro %}

{% macro stakeholder_expanded_content(stakeholder) %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Stakeholder Details -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Stakeholder Details</h4>
        <div class="space-y-2 text-sm">
            {% if stakeholder.email %}
                <div class="flex items-center">
                    {{ envelope_icon("w-4 h-4 text-gray-400 mr-2") }}
                    <a href="mailto:{{ stakeholder.email }}" class="text-blue-600 hover:text-blue-800">
                        {{ stakeholder.email }}
                    </a>
                </div>
            {% endif %}
            {% if stakeholder.phone %}
                <div class="flex items-center">
                    {{ phone_icon("w-4 h-4 text-gray-400 mr-2") }}
                    <a href="tel:{{ stakeholder.phone }}" class="text-green-600 hover:text-green-800">
                        {{ stakeholder.phone }}
                    </a>
                </div>
            {% endif %}
            {% if not stakeholder.email and not stakeholder.phone %}
                <p class="text-gray-500 italic">No contact information available</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Quick Actions</h4>
        <div class="quick-actions-grid">
            <button @click.stop="createTask({{ stakeholder.id }})" 
                    class="quick-action-btn quick-action-btn-primary">
                Add Task
            </button>
            <button @click.stop="createOpportunity({{ stakeholder.id }})" 
                    class="quick-action-btn quick-action-btn-secondary">
                New Opportunity
            </button>
            {% if stakeholder.opportunities %}
                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm">
                    {{ pluralized_count(stakeholder.opportunities|length, 'opportunity', short=true) }}
                </span>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

{% set entity_name = "Stakeholders" %}
{% set entity_description = "Manage your stakeholder relationships" %}
{% set entity_type = "stakeholder" %}

{% set entity_stats = {
    'title': 'Stakeholder Overview',
    'stats': [
        {
            'value': stakeholders|length,
            'label': 'Total Stakeholders',
            'color_class': 'text-blue-600'
        },
        {
            'value': stakeholders|selectattr('email')|list|length,
            'label': 'With Email',
            'color_class': 'text-green-600'
        },
        {
            'value': stakeholders|selectattr('phone')|list|length,
            'label': 'With Phone',
            'color_class': 'text-purple-600'
        },
        {
            'value': stakeholders|map(attribute='opportunities')|map('length')|sum,
            'label': 'Total Opportunities',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set entity_buttons = [
    {
        'label': 'New Stakeholder',
        'onclick': 'openNewStakeholderModal()',
        'color': 'blue',
        'icon': user_icon("w-4 h-4")
    }
] %}

{% call page_layout(entity_name, entity_description, buttons=entity_buttons, summary_data=entity_stats) %}

<div x-data="createEntityManager(get{{ entity_type|title }}Config('{{ today if today else '' }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar(entity_type, entity_type + 's', 
         {'label': 'Create Tasks', 'onclick': 'bulkCreateTasks(selectedItems)', 'color': 'green'},
         {'label': 'Delete Selected', 'onclick': 'bulkDelete(selectedItems)', 'color': 'red'}) }}

    <!-- Enhanced Filters and Controls with Generic DRY Components -->
    {{ enhanced_filter_controls(
        group_options=get_groupable_fields(Stakeholder),
        sort_options=get_sortable_fields(Stakeholder),
        show_completed_label='Show Incomplete Info',
        show_completed_name='show_incomplete',
        primary_filter_options=PRIORITY_OPTIONS,
        primary_filter_label='All Stakeholder Info',
        secondary_filter_options=get_field_options(Stakeholder, 'job_title'),
        secondary_filter_label='All Job Titles',
        entity_filter_options=[],
        entity_filter_label='All Companies'
    ) }}

    <!-- Dynamic Entity Section -->
    <div id="{{ entity_type }}-content">
        {{ dynamic_entity_section() }}
    </div>
    <!-- Default view when no stakeholders -->
    {% if not stakeholders %}
        <div class="card p-12 text-center">
            <p class="text-gray-500 mb-4">No stakeholders found</p>
            <button onclick="openNewStakeholderModal()" 
                    class="btn-primary">
                Add Your First Stakeholder
            </button>
        </div>
    {% endif %}

    <!-- Entity Cards Cache -->
    <div style="display: none;" id="{{ entity_type }}-cards-cache">
        {% for stakeholder in stakeholders %}
            <div id="{{ entity_type }}-card-{{ stakeholder.id }}">
                {{ expandable_card(entity_type, stakeholder, stakeholder.id,
                    expansion_enabled=true,
                    badge_content=stakeholder_header_content(stakeholder),
                    title_content=stakeholder.name,
                    secondary_info=stakeholder_secondary_info(stakeholder),
                    metadata_content=stakeholder_metadata_content(stakeholder),
                    action_buttons=action_buttons_row(entity_type, stakeholder.id),
                    expanded_content=stakeholder_expanded_content(stakeholder)) }}
            </div>
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/features/dashboard/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/color-scheme-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/entity-configs.js') }}"></script>
<script src="{{ url_for('static', filename='js/entities/stakeholders.js') }}"></script>

{{ include_common_modals() }}
{% endblock %}

{% block data_attributes %}
data-companies="{{ companies | tojson | forceescape }}"
data-opportunities="{{ opportunities | tojson | forceescape }}"
data-contacts="{{ stakeholders_data | tojson | forceescape }}"
{% endblock %}
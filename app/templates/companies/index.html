{% extends "base/layout.html" %}
{% from "components/company_card.html" import render_company %}
{% from "components/page_template.html" import page_layout %}
{% from "components/icons.html" import building_office_icon, user_icon, chevron_right_icon, check_circle_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid %}
{% from "components/ui_elements.html" import expand_collapse_controls, generic_group_dropdown, generic_sort_dropdown, generic_filter_multiselect, dynamic_entity_section, bulk_actions_bar, enhanced_filter_controls %}

{% block title %}Companies - CRM{% endblock %}

{% block content %}
{% set company_stats = {
    'title': 'Company Overview',
    'stats': [
        {
            'value': companies|length,
            'label': 'Total Companies',
            'color_class': 'text-blue-600'
        },
        {
            'value': companies|selectattr('industry')|list|length,
            'label': 'With Industry',
            'color_class': 'text-green-600'
        },
        {
            'value': companies|map(attribute='contacts')|map('length')|sum if companies|selectattr('contacts')|list else 0,
            'label': 'Total Contacts',
            'color_class': 'text-purple-600'
        },
        {
            'value': companies|selectattr('contacts')|list|length,
            'label': 'Active Relationships',
            'color_class': 'text-orange-600'
        }
    ]
} %}

{% set company_buttons = [
    {
        'label': 'New Company',
        'onclick': 'openNewCompanyModal()',
        'color': 'blue',
        'icon': ''
    }
] %}

{% call page_layout("Companies", "Manage your company relationships", buttons=company_buttons, summary_data=company_stats) %}

<div x-data="createEntityManager(getCompanyConfig('{{ today }}'))" class="space-y-6">

    <!-- Bulk Actions Bar -->
    {{ bulk_actions_bar('company', 'companies', 
         {'label': 'Create Tasks', 'onclick': 'bulkCreateTasks(selectedItems)', 'color': 'green'},
         {'label': 'Delete Selected', 'onclick': 'bulkDelete(selectedItems)', 'color': 'red'}) }}

    <!-- Enhanced Filters and Controls with Generic DRY Components -->
    {{ enhanced_filter_controls(
        group_options=[
            {'value': 'industry', 'label': 'Industry'},
            {'value': 'size', 'label': 'Company Size'},
            {'value': 'contacts', 'label': 'Contact Count'},
            {'value': 'opportunities', 'label': 'Opportunities'}
        ],
        sort_options=[
            {'value': 'name', 'label': 'Name'},
            {'value': 'industry', 'label': 'Industry'},
            {'value': 'contacts_count', 'label': 'Contact Count'},
            {'value': 'opportunities_count', 'label': 'Opportunity Count'},
            {'value': 'created_at', 'label': 'Date Added'}
        ],
        show_completed_label='Show Incomplete Info',
        show_completed_name='show_incomplete',
        primary_filter_options=[
            {'value': 'has_industry', 'label': 'Has Industry'},
            {'value': 'has_website', 'label': 'Has Website'},
            {'value': 'has_contacts', 'label': 'Has Contacts'},
            {'value': 'missing_info', 'label': 'Missing Info'}
        ],
        primary_filter_label='All Company Info',
        secondary_filter_options=[
            {'value': 'technology', 'label': 'Technology'},
            {'value': 'finance', 'label': 'Finance'},
            {'value': 'healthcare', 'label': 'Healthcare'},
            {'value': 'manufacturing', 'label': 'Manufacturing'},
            {'value': 'retail', 'label': 'Retail'},
            {'value': 'consulting', 'label': 'Consulting'}
        ],
        secondary_filter_label='All Industries',
        entity_filter_options=[
            {'value': 'small', 'label': 'Small (1-50)'},
            {'value': 'medium', 'label': 'Medium (51-500)'},
            {'value': 'large', 'label': 'Large (500+)'},
            {'value': 'unknown', 'label': 'Unknown Size'}
        ],
        entity_filter_label='All Sizes'
    ) }}

    <!-- Dynamic Client-Side Company Grouping -->
    <div id="companies-content">
        {{ dynamic_entity_section() }}
    </div>

    <!-- Default view when no companies -->
    {% if not companies %}
        <div class="card p-12 text-center">
            <p class="text-gray-500 mb-4">No companies found</p>
            <button onclick="openNewCompanyModal()" 
                    class="btn-primary">
                Add Your First Company
            </button>
        </div>
    {% endif %}

    <!-- Hidden pre-rendered company cards for client-side use -->
    <div style="display: none;" id="company-cards-cache">
        {% for company in companies %}
            <div id="company-card-{{ company.id }}">
                {{ render_company(company) }}
            </div>
        {% endfor %}
    </div>

</div>

{% endcall %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/entity-configs.js') }}"></script>
<script src="{{ url_for('static', filename='js/companies.js') }}"></script>

{% include "components/modals/confirmation.html" %}
{% include "components/modals/task/task_detail.html" %}
{% include "components/modals/task/task_new.html" %}
{% include "components/modals/contact/contact_detail.html" %}
{% include "components/modals/contact/contact_new.html" %}
{% include "components/modals/company/company_detail.html" %}
{% include "components/modals/company/company_new.html" %}
{% include "components/modals/opportunity/opportunity_detail.html" %}
{% include "components/modals/opportunity/opportunity_new.html" %}
{% endblock %}

{% block data_attributes %}
data-companies="{{ companies_data | tojson | forceescape }}"
data-contacts="{{ contacts | tojson | forceescape }}"
data-opportunities="{{ opportunities | tojson | forceescape }}"
{% endblock %}
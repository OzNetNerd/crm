{#
    Unified Dropdown Component Macro
    Single source of truth for all dropdown implementations
    Replaces css_dropdown and form_select_dropdown
#}

{% from 'macros/base/icons.html' import icon %}

{#
    Main dropdown macro - handles all dropdown types

    Parameters:
    - name: Form field name
    - options: List of options (objects with value/label or simple strings)
    - selected: Currently selected value(s)
    - multi: Enable multi-select mode
    - searchable: Enable search functionality
    - placeholder: Placeholder text
    - required: Field is required
    - size: 'sm', 'md' (default), 'lg'
    - error: Show error state
    - disabled: Disable the dropdown
    - htmx: HTMX configuration object {target, get, post, trigger}
    - class: Additional CSS classes
#}
{% macro dropdown(
    name,
    options=[],
    selected=None,
    multi=false,
    searchable=false,
    placeholder='Select option',
    required=false,
    size='md',
    error=false,
    disabled=false,
    htmx=None,
    class=''
) %}

{# Process options to ensure consistent format #}
{% set processed_options = [] %}
{% for opt in options %}
    {% if opt is mapping %}
        {% set _ = processed_options.append(opt) %}
    {% else %}
        {% set _ = processed_options.append({'value': opt, 'label': opt|string|title}) %}
    {% endif %}
{% endfor %}

{# Build configuration object #}
{% set config = {
    'name': name,
    'options': processed_options,
    'selected': selected,
    'multi': multi,
    'searchable': searchable,
    'placeholder': placeholder,
    'htmx': htmx or {}
} %}

<div class="dropdown{{ ' dropdown-' + size if size != 'md' }}{{ ' dropdown-error' if error }}{{ ' dropdown-disabled' if disabled }} {{ class }}"
     x-data="dropdown({{ config|tojson }})"
     x-ref="container"
     @click.away="close()">

    {# Trigger Button #}
    <button type="button"
            @click="toggle()"
            class="dropdown-trigger{{ ' dropdown-trigger--active' if selected }}"
            :class="{'dropdown-trigger--active': open}"
            {% if disabled %}disabled{% endif %}>

        <span class="dropdown-trigger-text" x-text="displayText">
            {{ placeholder }}
        </span>

        {% if multi and selected %}
        <button type="button"
                @click.stop="clearSelection()"
                class="dropdown-clear"
                title="Clear selection">
            {{ icon('x-mark', 'sm') }}
        </button>
        {% endif %}

        <svg class="dropdown-icon" :class="{'rotate-180': open}"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>

    {# Dropdown Menu #}
    <div x-show="open"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="dropdown-menu"
         x-cloak>

        {# Search Input #}
        {% if searchable %}
        <div class="dropdown-search">
            <input type="text"
                   x-model="search"
                   x-ref="searchInput"
                   @click.stop
                   placeholder="Search..."
                   class="dropdown-search-input">
        </div>
        {% endif %}

        {# Select All (for multi-select) #}
        {% if multi %}
        <button type="button"
                @click="selectAll()"
                class="dropdown-select-all">
            <input type="checkbox"
                   :checked="selected.length === options.length"
                   class="dropdown-checkbox">
            <span>Select All</span>
        </button>
        {% endif %}

        {# Options #}
        <template x-for="option in filteredOptions" :key="option.value">
            <button type="button"
                    @click="select(option.value)"
                    class="dropdown-option"
                    :class="{'dropdown-option--selected': isSelected(option.value)}">

                {% if multi %}
                <input type="checkbox"
                       :checked="isSelected(option.value)"
                       class="dropdown-checkbox"
                       @click.stop>
                {% endif %}

                <span x-text="option.label"></span>
            </button>
        </template>

        {# No results message #}
        <div x-show="filteredOptions.length === 0"
             class="dropdown-option dropdown-option--disabled">
            No options found
        </div>
    </div>

    {# Hidden inputs for form submission #}
    {% if multi %}
        <template x-for="value in selected" :key="value">
            <input type="hidden" :name="name + '[]'" :value="value" x-ref="hiddenInput"
                   {% if htmx %}
                   {% if htmx.target %}hx-target="{{ htmx.target }}"{% endif %}
                   {% if htmx.get %}hx-get="{{ htmx.get }}"{% endif %}
                   {% if htmx.post %}hx-post="{{ htmx.post }}"{% endif %}
                   {% if htmx.trigger %}hx-trigger="{{ htmx.trigger }}"{% endif %}
                   {% endif %}>
        </template>
    {% else %}
        <input type="hidden" :name="name" :value="selected" x-ref="hiddenInput"
               {% if required %}required{% endif %}
               {% if htmx %}
               {% if htmx.target %}hx-target="{{ htmx.target }}"{% endif %}
               {% if htmx.get %}hx-get="{{ htmx.get }}"{% endif %}
               {% if htmx.post %}hx-post="{{ htmx.post }}"{% endif %}
               {% if htmx.trigger %}hx-trigger="{{ htmx.trigger }}"{% endif %}
               {% endif %}>
    {% endif %}
</div>
{% endmacro %}

{#
    Convenience macros for common use cases
#}

{# Form select dropdown - simplified interface for form selects #}
{% macro form_select(name, options, selected='', placeholder='Select option', required=false, class='') %}
    {{ dropdown(name, options, selected=selected, placeholder=placeholder, required=required, class=class) }}
{% endmacro %}

{# Multi-select dropdown #}
{% macro multi_select(name, options, selected=[], placeholder='Select options', searchable=true, class='') %}
    {{ dropdown(name, options, selected=selected, multi=true, searchable=searchable, placeholder=placeholder, class=class) }}
{% endmacro %}

{# HTMX-enabled dropdown #}
{% macro htmx_dropdown(name, options, target, endpoint, selected=None, multi=false, class='') %}
    {{ dropdown(
        name=name,
        options=options,
        selected=selected,
        multi=multi,
        htmx={'target': target, 'get': endpoint, 'trigger': 'change'},
        class=class
    ) }}
{% endmacro %}
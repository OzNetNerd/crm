{#
    Forms Macros - All form-related macros
    Handles WTForms rendering, field filters, validation
#}

{% from 'macros/ui.html' import icon %}
{% from 'macros/components.html' import entity_search_dropdown, choice_search_dropdown, multiple_choice_search_dropdown %}

{# ============================================
   WTFORMS FIELD RENDERING
   ============================================ #}
{% macro render_field(field, show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        {{ entity_search_dropdown(
            name=field.name,
            entity_type='company',
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search companies...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {# Special handling for industry fields with choice search #}
    {% elif field.name == 'industry' and field.type == 'SelectField' %}
        {% set industry_choices = {} %}
        {% for value, label in field.choices %}
            {% if value %}
                {% set _ = industry_choices.update({value: {'label': label, 'description': ''}}) %}
            {% endif %}
        {% endfor %}
        {{ choice_search_dropdown(
            name=field.name,
            choices=industry_choices,
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search industries...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {# Special handling for stage fields with choice search #}
    {% elif field.name == 'stage' and field.type == 'SelectField' %}
        {% set stage_choices = {} %}
        {% for value, label in field.choices %}
            {% if value %}
                {% set _ = stage_choices.update({value: {'label': label, 'description': ''}}) %}
            {% endif %}
        {% endfor %}
        {{ choice_search_dropdown(
            name=field.name,
            choices=stage_choices,
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search pipeline stages...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {# Special handling for MEDDPIC roles with multiple choice search #}
    {% elif field.name == 'meddpicc_roles' and field.type == 'HiddenField' %}
        {{ multiple_choice_search_dropdown(
            name=field.name,
            choices={},
            value=field.data or '[]',
            label='MEDDPIC Roles' if show_label else '',
            required=field.flags.required,
            placeholder='Search MEDDPIC roles...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {% else %}
        <div class="form-field-group">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced"
                   style="display: none; margin-left: 4px; font-size: 1.1em;">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   FIELD FILTERING FOR MODALS
   ============================================ #}
{% macro render_filtered_fields(form, mode='form', allowed_fields=None) %}
    {% if not allowed_fields %}
        {% if hasattr(form, 'get_display_fields') %}
            {% set allowed_fields = form.get_display_fields() %}
        {% else %}
            {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
        {% endif %}
    {% endif %}

    {# Special handling for Task forms #}
    {% if hasattr(form, 'task_type') and hasattr(form, 'due_date') and mode == 'form' %}
        {{ render_task_form_fields(form, allowed_fields) }}
    {% else %}
        {% for field_name in allowed_fields %}
            {% set field = form[field_name] %}
            {% if field %}
                {% if mode == 'view' %}
                    {{ render_field_view(field) }}
                {% else %}
                    {{ render_field(field) }}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# ============================================
   FIELD RENDERING WITH CUSTOM CLASSES
   ============================================ #}
{% macro render_field_with_class(field, additional_classes='', show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        {{ entity_search_dropdown(
            name=field.name,
            entity_type='company',
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search companies...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {% else %}
        <div class="form-field-group {{ additional_classes }}">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced"
                   style="display: none; margin-left: 4px; font-size: 1.1em;">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   DYNAMIC SEARCH FIELD RENDERING
   ============================================ #}
{% macro render_dynamic_search_field(field, additional_classes='') %}
    <div class="form-field-group {{ additional_classes }}">
        <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
            {{ field.label.text }}
        </label>
        <div class="relative">
            <input type="text"
                   id="{{ field.id }}_search"
                   name="q"
                   class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="{{ field.render_kw.placeholder if field.render_kw and field.render_kw.placeholder else 'Search...' }}"
                   autocomplete="off"
                   hx-get="{{ url_for('search.htmx_search') }}"
                   hx-trigger="input changed delay:300ms, focus"
                   hx-target="#{{ field.id }}_results"
                   hx-swap="innerHTML"
                   hx-vals='{"mode": "select", "type": "{{ field.render_kw.get('data-search-type', 'task_field') if field.render_kw else 'task_field' }}", "field_name": "{{ field.name }}"}'>
            <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                {{ icon('magnifying-glass') }}
            </button>
            <input type="hidden" name="{{ field.name }}" id="{{ field.id }}" value="{{ field.data or '' }}">
            <div id="{{ field.id }}_results"
                 class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto"
                 style="display: none;"></div>
        </div>
        {% if field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   TASK FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_task_form_fields(form, allowed_fields) %}
    {% for field_name in allowed_fields %}
        {% set field = form[field_name] %}

        {# Handle conditional fields based on task category #}
        {% if field_name == 'company_id' %}
            <div x-show="taskCategory === 'opportunity'" class="conditional-field">
                {{ render_dynamic_search_field(field) }}
            </div>
        {% elif field_name == 'opportunity_id' %}
            <div x-show="taskCategory === 'opportunity'" class="conditional-field">
                {{ render_dynamic_search_field(field) }}
            </div>
        {# Handle inline group: task_type, priority, status with proper structure #}
        {% elif field_name == 'task_type' %}
            <div class="form-fields-inline-container">
                {{ render_dynamic_search_field(form.task_type, 'form-field-inline-item') }}
                {{ render_dynamic_search_field(form.priority, 'form-field-inline-item') }}
                {{ render_dynamic_search_field(form.status, 'form-field-inline-item') }}
            </div>
        {% elif field_name == 'priority' or field_name == 'status' %}
            {# Skip - already rendered in inline group #}
        {% elif field_name == 'assigned_to_id' %}
            {{ render_dynamic_search_field(field) }}
        {% elif field_name == 'due_date' %}
            {{ render_enhanced_date_field(field) }}
        {% else %}
            {{ render_field(field) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   ENHANCED DATE FIELD
   ============================================ #}
{% macro render_enhanced_date_field(field) %}
    <div class="form-field-group">
        <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
            {{ field.label.text }}
        </label>
        <div class="form-date-enhanced">
            <div class="form-date-input-container">
                {{ field(class="form-input form-date-compact" + (" error" if field.errors else "")) }}
                <div class="form-date-buttons">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addDaysToDate('{{ field.id }}', 1)">+1 Day</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addDaysToDate('{{ field.id }}', 7)">+1 Week</button>
                </div>
            </div>
            <div class="form-date-countdown" id="{{ field.id }}_countdown" style="display: none;">
                <span class="countdown-text"></span>
            </div>
        </div>

        {% if field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   VIEW MODE FIELDS
   ============================================ #}
{% macro render_field_view(field) %}
    <div class="form-field-group">
        <label class="form-label">{{ field.label.text }}</label>
        <div class="form-field-view">
            {% if field.type == 'SelectField' %}
                {% for value, label in field.choices %}
                    {% if value == field.data %}{{ label }}{% endif %}
                {% endfor %}
                {% if not field.data %}
                    <span class="form-field-view-empty">Not set</span>
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {{ field.data if field.data else '' }}
            {% elif field.type == 'BooleanField' %}
                {{ 'Yes' if field.data else 'No' }}
            {% else %}
                {{ field.data if field.data else '-' }}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   FORM ACTIONS
   ============================================ #}
{% macro form_actions(submit_text='Save', cancel_url=None, cancel_text='Cancel') %}
    <div class="form-actions">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-secondary">{{ cancel_text }}</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
{% endmacro %}

{# ============================================
   INLINE ERRORS
   ============================================ #}
{% macro field_errors(field) %}
    {% if field.errors %}
        {% for error in field.errors %}
            <p class="form-error">{{ error }}</p>
        {% endfor %}
    {% endif %}
{% endmacro %}
{#
    Forms Macros - All form-related macros
    Handles WTForms rendering, field filters, validation
#}

{% from 'macros/ui.html' import icon %}

{# ============================================
   WTFORMS FIELD RENDERING
   ============================================ #}
{% macro render_field(field, show_label=true, show_errors=true) %}
    <div class="form-field-group">
        {% if show_label and field.label.text %}
            <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                {{ field.label.text }}
            </label>
        {% endif %}

        {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
            {{ field(class="form-input" + (" error" if field.errors else "")) }}
        {% elif field.type == 'TextAreaField' %}
            {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
        {% elif field.type == 'SelectField' %}
            {{ field(class="form-select" + (" error" if field.errors else "")) }}
        {% elif field.type == 'BooleanField' %}
            <label class="form-checkbox">
                {{ field }}
                <span>{{ field.label.text }}</span>
            </label>
        {% else %}
            {{ field(class="form-input") }}
        {% endif %}

        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   FIELD FILTERING FOR MODALS
   ============================================ #}
{% macro render_filtered_fields(form, mode='form', allowed_fields=None) %}
    {% if not allowed_fields %}
        {% if hasattr(form, 'get_display_fields') %}
            {% set allowed_fields = form.get_display_fields() %}
        {% else %}
            {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
        {% endif %}
    {% endif %}

    {% for field in form %}
        {% if field.name in allowed_fields %}
            {% if mode == 'view' %}
                {{ render_field_view(field) }}
            {% else %}
                {{ render_field(field) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   VIEW MODE FIELDS
   ============================================ #}
{% macro render_field_view(field) %}
    <div class="form-field-group">
        <label class="form-label">{{ field.label.text }}</label>
        <div class="form-field-view">
            {% if field.type == 'SelectField' %}
                {% for value, label in field.choices %}
                    {% if value == field.data %}{{ label }}{% endif %}
                {% endfor %}
                {% if not field.data %}
                    <span class="form-field-view-empty">Not set</span>
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {{ field.data if field.data else '' }}
            {% elif field.type == 'BooleanField' %}
                {{ 'Yes' if field.data else 'No' }}
            {% else %}
                {{ field.data if field.data else '-' }}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   FORM ACTIONS
   ============================================ #}
{% macro form_actions(submit_text='Save', cancel_url=None, cancel_text='Cancel') %}
    <div class="form-actions">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-secondary">{{ cancel_text }}</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
{% endmacro %}

{# ============================================
   INLINE ERRORS
   ============================================ #}
{% macro field_errors(field) %}
    {% if field.errors %}
        {% for error in field.errors %}
            <p class="form-error">{{ error }}</p>
        {% endfor %}
    {% endif %}
{% endmacro %}
{#
    Forms Macros - All form-related macros
    Handles WTForms rendering, field filters, validation
#}

{% from 'macros/ui.html' import icon, priority_badge, status_badge %}
{% from 'macros/components.html' import entity_search_dropdown, choice_search_dropdown, multiple_choice_search_dropdown, multi_select_dropdown %}

{# ============================================
   WTFORMS FIELD RENDERING
   ============================================ #}
{% macro render_field(field, show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        <div class="form-field-group">
            {{ entity_search_dropdown(
                name=field.name,
                entity_type='company',
                value=field.data or '',
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Search companies...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {# Special handling for industry fields with choice search #}
    {% elif field.name == 'industry' and field.type == 'SelectField' %}
        <div class="form-field-group">
            {% set industry_choices = {} %}
            {% for value, label in field.choices %}
                {% if value %}
                    {% set _ = industry_choices.update({value: {'label': label, 'description': ''}}) %}
                {% endif %}
            {% endfor %}
            {{ choice_search_dropdown(
                name=field.name,
                choices=industry_choices,
                value=field.data or '',
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Search industries...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {# Special handling for stage fields with choice search #}
    {% elif field.name == 'stage' and field.type == 'SelectField' %}
        <div class="form-field-group">
            {% set stage_choices = {} %}
            {% for value, label in field.choices %}
                {% if value %}
                    {% set _ = stage_choices.update({value: {'label': label, 'description': ''}}) %}
                {% endif %}
            {% endfor %}
            {{ choice_search_dropdown(
                name=field.name,
                choices=stage_choices,
                value=field.data or '',
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Search pipeline stages...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {# Special handling for MEDDPICC roles with multi-select dropdown #}
    {% elif field.name == 'meddpicc_roles_select' %}
        <div class="form-field-group">
            {% set meddpicc_choices = {
                'economic_buyer': {'label': 'Economic Buyer', 'description': 'Person who controls the budget'},
                'decision_maker': {'label': 'Decision Maker', 'description': 'Person who makes the final decision'},
                'influencer': {'label': 'Influencer', 'description': 'Person who influences the decision'},
                'champion': {'label': 'Champion', 'description': 'Internal advocate for the solution'},
                'user': {'label': 'User', 'description': 'End user of the solution'},
                'other': {'label': 'Other', 'description': 'Other role type'}
            } %}
            {# Convert the field data list to JSON for the Alpine component #}
            {% set selected_values = field.data|tojson if field.data else '[]' %}
            {{ multi_select_dropdown(
                name='meddpicc_roles',
                choices=meddpicc_choices,
                value=selected_values,
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Select MEDDPICC roles...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {# Special handling for relationship owners with multiple entity search #}
    {% elif field.name == 'relationship_owners' %}
        <div class="form-field-group">
            {% if show_label %}
                <label for="{{ field.name }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}
            <input type="text"
                   id="{{ field.name }}_search"
                   class="form-input"
                   placeholder="Search team members..."
                   autocomplete="off"
                   hx-get="/search/htmx"
                   hx-trigger="input changed delay:300ms, focus"
                   hx-target="#{{ field.name }}_results"
                   hx-swap="innerHTML"
                   hx-vals='{"mode": "select", "type": "user", "field_name": "{{ field.name }}", "multiple": "true"}'>
            <input type="hidden" id="{{ field.name }}-data" name="{{ field.name }}" value="{{ field.data or '[]' }}">
            <div id="{{ field.name }}_results"
                 class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto"
                 hidden></div>
            <div id="{{ field.name }}-badges" class="mt-2 flex flex-wrap gap-1"></div>
        </div>
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {# Special handling for MEDDPIC roles with multiple choice search #}
    {% elif field.name == 'meddpicc_roles' and field.type == 'HiddenField' %}
        <div class="form-field-group">
            {{ multiple_choice_search_dropdown(
                name=field.name,
                choices={},
                value=field.data or '[]',
                label='MEDDPIC Roles' if show_label else '',
                required=field.flags.required,
                placeholder='Search MEDDPIC roles...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {% else %}
        <div class="form-field-group">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced"
                   class="field-check-icon">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   TWO-COLUMN INLINE FIELDS
   ============================================ #}
{% macro render_inline_fields_2col(field1, field2) %}
    <div class="grid grid-cols-2 gap-4">
        {{ render_field(field1) }}
        {{ render_field(field2) }}
    </div>
{% endmacro %}

{# ============================================
   FIELD FILTERING FOR MODALS
   ============================================ #}
{% macro render_filtered_fields(form, mode='form', allowed_fields=None) %}
    {% if not allowed_fields %}
        {% if hasattr(form, 'get_display_fields') %}
            {% set allowed_fields = form.get_display_fields() %}
        {% else %}
            {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
        {% endif %}
    {% endif %}

    {# Special handling for Task forms #}
    {% if hasattr(form, 'task_type') and hasattr(form, 'due_date') and mode == 'form' %}
        {{ render_task_form_fields(form, allowed_fields) }}
    {# Special handling for Company forms #}
    {% elif form.__class__.__name__ == 'CompanyForm' and mode == 'form' %}
        {{ render_company_form_fields(form, allowed_fields) }}
    {# Special handling for Stakeholder forms #}
    {% elif form.__class__.__name__ == 'StakeholderForm' and mode == 'form' %}
        {{ render_stakeholder_form_fields(form, allowed_fields) }}
    {# Special handling for User forms #}
    {% elif form.__class__.__name__ in ['UserForm', 'UserModalForm'] and mode == 'form' %}
        {{ render_user_form_fields(form, allowed_fields) }}
    {% else %}
        {% for field_name in allowed_fields %}
            {% set field = form[field_name] %}
            {% if field %}
                {% if mode == 'view' %}
                    {{ render_field_view(field) }}
                {% else %}
                    {{ render_field(field) }}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# ============================================
   FIELD RENDERING WITH CUSTOM CLASSES
   ============================================ #}
{% macro render_field_with_class(field, additional_classes='', show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        <div class="form-field-group">
            {{ entity_search_dropdown(
                name=field.name,
                entity_type='company',
                value=field.data or '',
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Search companies...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {% else %}
        <div class="form-field-group {{ additional_classes }}">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced"
                   class="field-check-icon">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   DYNAMIC SEARCH FIELD RENDERING
   ============================================ #}
{% macro render_dynamic_search_field(field, additional_classes='') %}
    <div class="form-field-group {{ additional_classes }}">
        <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
            {{ field.label.text }}
        </label>
        <div class="relative">
            <input type="text"
                   id="{{ field.id }}_search"
                   name="q"
                   class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="{{ field.render_kw.placeholder if field.render_kw and field.render_kw.placeholder else 'Search...' }}"
                   autocomplete="off"
                   hx-get="{{ url_for('search.htmx_search') }}"
                   hx-trigger="input changed delay:300ms, focus"
                   hx-target="#{{ field.id }}_results"
                   hx-swap="innerHTML"
                   hx-vals='{"mode": "select", "type": "{{ field.render_kw.get('data-search-type', 'task_field') if field.render_kw else 'task_field' }}", "field_name": "{{ field.name }}"}'>
            <input type="hidden" name="{{ field.name }}" id="{{ field.id }}" value="{{ field.data or '' }}">
            <div id="{{ field.id }}_results"
                 class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto"
                 hidden></div>
        </div>
        {% if field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   TASK FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_task_form_fields(form, allowed_fields) %}
    {% for field_name in allowed_fields %}
        {% set field = form[field_name] %}

        {# Handle conditional fields based on task category #}
        {% if field_name == 'company_id' %}
            <div x-show="taskCategory === 'opportunity'" class="conditional-field">
                <div class="grid grid-cols-2 gap-4">
                    {{ render_dynamic_search_field(field) }}
                    {{ render_dynamic_search_field(form.opportunity_id) }}
                </div>
            </div>
        {% elif field_name == 'opportunity_id' %}
            {# Skip - already rendered with company_id #}
        {# Handle inline group: task_type, priority, status with proper structure #}
        {% elif field_name == 'task_type' %}
            <div class="form-fields-inline-container">
                {{ render_dynamic_search_field(form.task_type, 'form-field-inline-item') }}
                {{ render_dynamic_search_field(form.priority, 'form-field-inline-item') }}
                {{ render_dynamic_search_field(form.status, 'form-field-inline-item') }}
            </div>
        {% elif field_name == 'priority' or field_name == 'status' %}
            {# Skip - already rendered in inline group #}
        {# Handle name and due_date side by side - more space for name #}
        {% elif field_name == 'name' %}
            <div class="flex gap-4">
                <div class="flex-1">
                    {{ render_field(field) }}
                </div>
                <div class="flex-shrink-0" style="width: auto; max-width: 50%;">
                    {{ render_enhanced_date_field(form.due_date) }}
                </div>
            </div>
        {% elif field_name == 'due_date' %}
            {# Skip - already rendered with name #}
        {% elif field_name == 'assigned_to_id' %}
            {{ render_dynamic_search_field(field) }}
        {% else %}
            {{ render_field(field) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   STAKEHOLDER FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_stakeholder_form_fields(form, allowed_fields) %}
    {# First row: Company and Job Title side by side #}
    {% if 'company' in allowed_fields and 'job_title' in allowed_fields %}
        {{ render_inline_fields_2col(form.company, form.job_title) }}
    {% elif 'company' in allowed_fields %}
        {{ render_field(form.company) }}
    {% elif 'job_title' in allowed_fields %}
        {{ render_field(form.job_title) }}
    {% endif %}

    {# Render remaining fields in order #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['company', 'job_title'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   USER FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_user_form_fields(form, allowed_fields) %}
    {# Special rendering for User forms in modals.
       Displays Full Name and Job Title side by side for a streamlined user creation experience.
       This layout provides a clean, efficient interface for adding team members. #}

    {# Display Name and Job Title side by side at 50/50 width #}
    {% if 'name' in allowed_fields and 'job_title' in allowed_fields %}
        {{ render_inline_fields_2col(form.name, form.job_title) }}
    {% elif 'name' in allowed_fields %}
        {{ render_field(form.name) }}
    {% elif 'job_title' in allowed_fields %}
        {{ render_field(form.job_title) }}
    {% endif %}

    {# Render any remaining fields that might be added in the future #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['name', 'job_title'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   COMPANY FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_company_form_fields(form, allowed_fields) %}
    {# First row: Company Name and Industry side by side #}
    {% if 'name' in allowed_fields and 'industry' in allowed_fields %}
        {{ render_inline_fields_2col(form.name, form.industry) }}
    {% elif 'name' in allowed_fields %}
        {{ render_field(form.name) }}
    {% elif 'industry' in allowed_fields %}
        {{ render_field(form.industry) }}
    {% endif %}

    {# Second row: Core Rep and Core SC side by side #}
    {% if 'core_rep' in allowed_fields and 'core_sc' in allowed_fields %}
        {{ render_inline_fields_2col(form.core_rep, form.core_sc) }}
    {% elif 'core_rep' in allowed_fields %}
        {{ render_field(form.core_rep) }}
    {% elif 'core_sc' in allowed_fields %}
        {{ render_field(form.core_sc) }}
    {% endif %}

    {# Render remaining fields #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['name', 'industry', 'core_rep', 'core_sc'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   ENHANCED DATE FIELD
   ============================================ #}
{% macro render_enhanced_date_field(field, additional_classes='') %}
    <div class="form-field-group {{ additional_classes }}">
        <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
            {{ field.label.text }}
        </label>
        <div class="form-date-enhanced flex items-center gap-2">
            {{ field(class="form-input form-date-compact" + (" error" if field.errors else "")) }}
            <div class="form-date-buttons grid grid-cols-2 gap-1 flex-shrink-0">
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', 1)">+1d</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', 7)">+1w</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', -1)">-1d</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', -7)">-1w</button>
            </div>
            <div class="form-date-countdown hidden" id="{{ field.id }}_countdown">
                <span class="countdown-text"></span>
            </div>
        </div>

        {% if field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   VIEW MODE FIELDS
   ============================================ #}
{% macro render_field_view(field) %}
    <div class="form-field-group">
        <label class="form-label">{{ field.label.text }}</label>
        <div class="form-field-view">
            {# Special handling for company field #}
            {% if field.name == 'company' %}
                {% if field.data %}
                    {% if field.data is string %}
                        {{ field.data }}
                    {% else %}
                        {{ field.data.name if field.data.name else field.data }}
                    {% endif %}
                {% else %}
                    <span class="form-field-view-empty">Not set</span>
                {% endif %}
            {# Special handling for relationship owners field #}
            {% elif field.name == 'relationship_owners' %}
                {% if field.data %}
                    {% if field.data is iterable and field.data is not string %}
                        <div class="flex flex-wrap gap-1">
                            {% for owner in field.data %}
                                <span class="badge badge-info badge-sm">
                                    {{ owner.name if owner.name else owner }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <span class="form-field-view-empty">None assigned</span>
                    {% endif %}
                {% else %}
                    <span class="form-field-view-empty">None assigned</span>
                {% endif %}
            {# Special handling for MEDDPICC roles #}
            {% elif field.name == 'meddpicc_roles_select' %}
                {% if field.data %}
                    <div class="flex flex-wrap gap-1">
                        {% for role in field.data %}
                            <span class="badge badge-primary badge-sm">
                                {{ role.replace('_', ' ').title() if role is string else role }}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <span class="form-field-view-empty">No roles assigned</span>
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {# DRY badge rendering based on field name patterns #}
                {% set field_lower = field.name.lower() %}
                {% if field.data %}
                    {% if 'priority' in field_lower %}
                        {{ priority_badge(field.data) }}
                    {% elif 'status' in field_lower %}
                        {{ status_badge(field.data) }}
                    {% elif 'stage' in field_lower %}
                        {# Opportunity stages get badges too #}
                        <span class="badge badge-{{ field.data|badge_class }}">
                            {{ field.data }}
                        </span>
                    {% else %}
                        {# Default select field display #}
                        {% for value, label in field.choices %}
                            {% if value == field.data %}{{ label }}{% endif %}
                        {% endfor %}
                    {% endif %}
                {% else %}
                    <span class="form-field-view-empty">Not set</span>
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {{ field.data if field.data else '' }}
            {% elif field.type == 'BooleanField' %}
                {{ 'Yes' if field.data else 'No' }}
            {% else %}
                {{ field.data if field.data else '-' }}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   FORM ACTIONS
   ============================================ #}
{% macro form_actions(submit_text='Save', cancel_url=None, cancel_text='Cancel') %}
    <div class="form-actions">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-secondary">{{ cancel_text }}</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
{% endmacro %}

{# ============================================
   INLINE ERRORS
   ============================================ #}
{% macro field_errors(field) %}
    {% if field.errors %}
        {% for error in field.errors %}
            <p class="form-error">{{ error }}</p>
        {% endfor %}
    {% endif %}
{% endmacro %}
{#
    Forms Macros - All form-related macros
    Handles WTForms rendering, field filters, validation
#}

{% from 'macros/ui.html' import icon %}
{% from 'macros/components.html' import entity_search_dropdown, choice_search_dropdown %}

{# ============================================
   WTFORMS FIELD RENDERING
   ============================================ #}
{% macro render_field(field, show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        {{ entity_search_dropdown(
            name=field.name,
            entity_type='company',
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search companies...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {# Special handling for industry fields with choice search #}
    {% elif field.name == 'industry' and field.type == 'SelectField' %}
        {% set industry_choices = {} %}
        {% for value, label in field.choices %}
            {% if value %}
                {% set _ = industry_choices.update({value: {'label': label, 'description': ''}}) %}
            {% endif %}
        {% endfor %}
        {{ choice_search_dropdown(
            name=field.name,
            choices=industry_choices,
            value=field.data or '',
            label=field.label.text if show_label else '',
            required=field.flags.required,
            placeholder='Search industries...'
        ) }}
        {% if show_errors and field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    {% else %}
        <div class="form-field-group">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {{ field(class="form-input" + (" error" if field.errors else "")) }}
            {% elif field.type == 'TextAreaField' %}
                {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced"
                   style="display: none; margin-left: 4px; font-size: 1.1em;">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   FIELD FILTERING FOR MODALS
   ============================================ #}
{% macro render_filtered_fields(form, mode='form', allowed_fields=None) %}
    {% if not allowed_fields %}
        {% if hasattr(form, 'get_display_fields') %}
            {% set allowed_fields = form.get_display_fields() %}
        {% else %}
            {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
        {% endif %}
    {% endif %}

    {% for field_name in allowed_fields %}
        {% set field = form[field_name] %}
        {% if field %}
            {% if mode == 'view' %}
                {{ render_field_view(field) }}
            {% else %}
                {{ render_field(field) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   VIEW MODE FIELDS
   ============================================ #}
{% macro render_field_view(field) %}
    <div class="form-field-group">
        <label class="form-label">{{ field.label.text }}</label>
        <div class="form-field-view">
            {% if field.type == 'SelectField' %}
                {% for value, label in field.choices %}
                    {% if value == field.data %}{{ label }}{% endif %}
                {% endfor %}
                {% if not field.data %}
                    <span class="form-field-view-empty">Not set</span>
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {{ field.data if field.data else '' }}
            {% elif field.type == 'BooleanField' %}
                {{ 'Yes' if field.data else 'No' }}
            {% else %}
                {{ field.data if field.data else '-' }}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   FORM ACTIONS
   ============================================ #}
{% macro form_actions(submit_text='Save', cancel_url=None, cancel_text='Cancel') %}
    <div class="form-actions">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-secondary">{{ cancel_text }}</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
{% endmacro %}

{# ============================================
   INLINE ERRORS
   ============================================ #}
{% macro field_errors(field) %}
    {% if field.errors %}
        {% for error in field.errors %}
            <p class="form-error">{{ error }}</p>
        {% endfor %}
    {% endif %}
{% endmacro %}
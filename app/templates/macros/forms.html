{#
    Forms Macros - All form-related macros
    Handles WTForms rendering, field filters, validation
    DRY APPROACH: Single render_field macro handles both view and edit modes
#}

{% from 'macros/ui.html' import icon, priority_badge, status_badge %}
{% from 'macros/components.html' import entity_search_dropdown, choice_search_dropdown %}

{# ============================================
   UNIVERSAL FIELD RENDERING - Handles both view and edit modes
   ============================================ #}
{% macro render_field(field, mode='edit', show_label=true, show_errors=true) %}
    <div class="form-field-group">
        {# Always show label consistently #}
        {% if show_label and field.label.text and field.name != 'relationship_owners' %}
            <label class="form-label{% if field.flags.required and mode == 'edit' %} form-label-required{% endif %}">
                {{ field.label.text }}
            </label>
        {% endif %}

        {# VIEW MODE #}
        {% if mode == 'view' %}
            <div class="form-field-view">
                {# Special handling for company field #}
                {% if field.name == 'company' %}
                    {% if field.data %}
                        {% if field.data is string %}
                            {{ field.data }}
                        {% else %}
                            {{ field.data.name if field.data.name else field.data }}
                        {% endif %}
                    {% else %}
                        <span class="form-field-view-empty">Not set</span>
                    {% endif %}
                {# Special handling for Core Rep and Core SC fields #}
                {% elif field.name in ['core_rep', 'core_sc'] %}
                    {% if field.data %}
                        {{ field.data }}
                    {% else %}
                        <span class="form-field-view-empty">Not assigned</span>
                    {% endif %}
                {# Special handling for relationship owners field #}
                {% elif field.name == 'relationship_owners' %}
                    {% if field.data %}
                        {% if field.data is iterable and field.data is not string %}
                            <div class="flex flex-wrap gap-1">
                                {% for owner in field.data %}
                                    <span class="badge badge-info badge-sm">
                                        {{ owner.name if owner.name else owner }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="form-field-view-empty">None assigned</span>
                        {% endif %}
                    {% else %}
                        <span class="form-field-view-empty">None assigned</span>
                    {% endif %}
                {# Special handling for MEDDPICC roles #}
                {% elif field.name in ['meddpicc_roles_select', 'meddpicc_roles'] %}
                    {% if field.data %}
                        <div class="flex flex-wrap gap-1">
                            {% for role in field.data %}
                                <span class="badge badge-primary badge-sm">
                                    {{ role.replace('_', ' ').title() if role is string else role }}
                                </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <span class="form-field-view-empty">No roles assigned</span>
                    {% endif %}
                {% elif field.type == 'SelectField' %}
                    {# DRY badge rendering based on field name patterns #}
                    {% set field_lower = field.name.lower() %}
                    {% if field.data %}
                        {% if 'priority' in field_lower %}
                            {{ priority_badge(field.data) }}
                        {% elif 'status' in field_lower %}
                            {{ status_badge(field.data) }}
                        {% elif 'stage' in field_lower %}
                            <span class="badge badge-{{ field.data|badge_class }}">
                                {{ field.data }}
                            </span>
                        {% else %}
                            {# Default select field display - show label not value #}
                            {% for value, label in field.choices %}
                                {% if value == field.data %}{{ label }}{% endif %}
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <span class="form-field-view-empty">Not set</span>
                    {% endif %}
                {% elif field.type == 'TextAreaField' %}
                    {{ field.data if field.data else '' }}
                {% elif field.type == 'BooleanField' %}
                    {{ 'Yes' if field.data else 'No' }}
                {% elif field.type == 'DateField' %}
                    {{ field.data.strftime('%Y-%m-%d') if field.data else '-' }}
                {% else %}
                    {{ field.data if field.data else '-' }}
                {% endif %}
            </div>

        {# EDIT MODE #}
        {% else %}
            {# Special handling for company fields #}
            {% if field.name == 'company' and field.type == 'StringField' %}
                {{ entity_search_dropdown(
                    name=field.name,
                    entity_type='company',
                    value=field.data or '',
                    search_value=field.search_display_value or '',
                    label='',
                    required=field.flags.required,
                    placeholder='Search companies...'
                ) }}
            {# Special handling for Core Rep and Core SC fields as entity search #}
            {% elif field.name in ['core_rep', 'core_sc'] %}
                {{ entity_search_dropdown(
                    name=field.name,
                    entity_type='user',
                    value=field.data or '',
                    search_value=field.search_display_value or '',
                    label='',
                    required=field.flags.required,
                    placeholder='Search team members...'
                ) }}
            {# Special handling for industry fields with choice search #}
            {% elif field.name == 'industry' and field.type == 'SelectField' %}
                {% set industry_choices = {} %}
                {% for value, label in field.choices %}
                    {% if value %}
                        {% set _ = industry_choices.update({value: {'label': label, 'description': ''}}) %}
                    {% endif %}
                {% endfor %}
                {{ choice_search_dropdown(
                    name=field.name,
                    choices=industry_choices,
                    value=field.data or '',
                    search_value=field.search_display_value or '',
                    label='',
                    required=field.flags.required,
                    placeholder='Search industries...'
                ) }}
            {# Special handling for stage fields with choice search #}
            {% elif field.name == 'stage' and field.type == 'SelectField' %}
                {% set stage_choices = {} %}
                {% for value, label in field.choices %}
                    {% if value %}
                        {% set _ = stage_choices.update({value: {'label': label, 'description': ''}}) %}
                    {% endif %}
                {% endfor %}
                {{ choice_search_dropdown(
                    name=field.name,
                    choices=stage_choices,
                    value=field.data or '',
                    search_value=field.search_display_value or '',
                    label='',
                    required=field.flags.required,
                    placeholder='Search pipeline stages...'
                ) }}
            {# Special handling for MEDDPICC roles with multi-select dropdown #}
            {% elif field.name == 'meddpicc_roles_select' %}
                {% set meddpicc_choices = {
                    'economic_buyer': {'label': 'Economic Buyer', 'description': 'Person who controls the budget'},
                    'decision_maker': {'label': 'Decision Maker', 'description': 'Person who makes the final decision'},
                    'influencer': {'label': 'Influencer', 'description': 'Person who influences the decision'},
                    'champion': {'label': 'Champion', 'description': 'Internal advocate for the solution'},
                    'user': {'label': 'User', 'description': 'End user of the solution'},
                    'other': {'label': 'Other', 'description': 'Other role type'}
                } %}
                <div class="relative" x-data="{ open: false, selected: {{ (field.data or [])|tojson }} }">
                    <button type="button"
                            @click="open = !open"
                            class="dropdown-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex items-center justify-between">
                        <span x-show="selected.length === 0">Select MEDDPIC roles...</span>
                        <span x-show="selected.length > 0" x-text="selected.length + ' roles selected'"></span>
                        <span class="ml-2 pointer-events-none">
                            {{ icon('chevron-down') }}
                        </span>
                    </button>
                    <div x-show="open"
                         @click.away="open = false"
                         class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                        {% for key, choice in meddpicc_choices.items() %}
                        <label class="flex items-center px-3 py-2 hover:bg-gray-100">
                            <input type="checkbox"
                                   value="{{ key }}"
                                   x-model="selected"
                                   class="mr-2">
                            <span>{{ choice.label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="meddpicc_roles" :value="JSON.stringify(selected)">
                </div>
            {# Special handling for relationship owners with multiple entity search #}
            {% elif field.name == 'relationship_owners' %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text if show_label else 'Relationship Owners' }}
                </label>
                {{ entity_search_dropdown(
                    name=field.name,
                    entity_type='user',
                    value=field.data or '',
                    search_value='',
                    label='',
                    required=field.flags.required,
                    placeholder='Search team members...'
                ) }}
            {# Special handling for MEDDPIC roles with multiple choice search #}
            {% elif field.name == 'meddpicc_roles' and field.type == 'HiddenField' %}
                {{ field(class="form-input") }}
            {% elif field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectMultipleField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {# Show errors in edit mode #}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   UNIVERSAL FORM LAYOUT RENDERER - DRY
   ============================================ #}
{% macro render_form_with_layout(form, mode='form') %}
    {# Get layout configuration from form #}
    {% set layout = form.get_field_layout() if hasattr(form, 'get_field_layout') else [] %}

    {# If no layout defined, fall back to filtered fields #}
    {% if not layout %}
        {{ render_filtered_fields(form, mode) }}
    {% else %}
        {# Render fields according to layout configuration #}
        {% for row in layout %}
            {% if row.type == 'single' %}
                {# Single field on its own row #}
                {% set field = form[row.field] %}
                {% if field %}
                    {{ render_field(field, mode) }}
                {% endif %}
            {% elif row.type == 'inline-2col' %}
                {# Two fields side by side #}
                {% if row.fields|length == 2 %}
                    {% set field1 = form[row.fields[0]] %}
                    {% set field2 = form[row.fields[1]] %}
                    {% if field1 and field2 %}
                        <div class="grid grid-cols-2 gap-4">
                            {{ render_field(field1, mode) }}
                            {{ render_field(field2, mode) }}
                        </div>
                    {% endif %}
                {% endif %}
            {% elif row.type == 'inline-3col' %}
                {# Three fields side by side #}
                {% if row.fields|length == 3 %}
                    {% set field1 = form[row.fields[0]] %}
                    {% set field2 = form[row.fields[1]] %}
                    {% set field3 = form[row.fields[2]] %}
                    {% if field1 and field2 and field3 %}
                        <div class="grid grid-cols-3 gap-4">
                            {{ render_field(field1, mode) }}
                            {{ render_field(field2, mode) }}
                            {{ render_field(field3, mode) }}
                        </div>
                    {% endif %}
                {% endif %}
            {% elif row.type == 'heading' %}
                {# Section heading #}
                <h4 class="text-sm font-semibold text-gray-900 mb-3">{{ row.text }}</h4>
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# ============================================
   TWO-COLUMN INLINE FIELDS
   ============================================ #}
{% macro render_inline_fields_2col(field1, field2, mode='edit') %}
    <div class="grid grid-cols-2 gap-4">
        {{ render_field(field1, mode) }}
        {{ render_field(field2, mode) }}
    </div>
{% endmacro %}

{# ============================================
   FIELD FILTERING FOR MODALS
   ============================================ #}
{% macro render_filtered_fields(form, mode='form', allowed_fields=None) %}
    {% if not allowed_fields %}
        {% if hasattr(form, 'get_display_fields') %}
            {% set allowed_fields = form.get_display_fields() %}
        {% else %}
            {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
        {% endif %}
    {% endif %}

    {# Special handling for Task forms - works in both view and edit modes #}
    {% if hasattr(form, 'task_type') and hasattr(form, 'due_date') %}
        {{ render_task_form_fields(form, allowed_fields, mode) }}
    {# Special handling for Company forms #}
    {% elif form.__class__.__name__ == 'CompanyForm' %}
        {{ render_company_form_fields(form, allowed_fields, mode) }}
    {# Special handling for Stakeholder forms #}
    {% elif form.__class__.__name__ == 'StakeholderForm' %}
        {{ render_stakeholder_form_fields(form, allowed_fields, mode) }}
    {# Special handling for User forms #}
    {% elif form.__class__.__name__ in ['UserForm', 'UserModalForm'] %}
        {{ render_user_form_fields(form, allowed_fields, mode) }}
    {% else %}
        {% for field_name in allowed_fields %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field, mode) }}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# ============================================
   FIELD RENDERING WITH CUSTOM CLASSES
   ============================================ #}
{% macro render_field_with_class(field, additional_classes='', show_label=true, show_errors=true) %}
    {# Special handling for company fields #}
    {% if field.name == 'company' and field.type == 'StringField' %}
        <div class="form-field-group">
            {{ entity_search_dropdown(
                name=field.name,
                entity_type='company',
                value=field.data or '',
                search_value=field.search_display_value or '',
                label=field.label.text if show_label else '',
                required=field.flags.required,
                placeholder='Search companies...'
            ) }}
            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {% else %}
        <div class="form-field-group {{ additional_classes }}">
            {% if show_label and field.label.text %}
                <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                    {{ field.label.text }}
                </label>
            {% endif %}

            {% if field.type == 'StringField' or field.type == 'PasswordField' or field.type == 'EmailField' %}
                {% if field.flags.required %}
                    {{ field(class="form-input" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-input" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'TextAreaField' %}
                {% if field.flags.required %}
                    {{ field(class="form-textarea" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-textarea" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'SelectField' %}
                {% if field.flags.required %}
                    {{ field(class="form-select" + (" error" if field.errors else ""), required=true) }}
                {% else %}
                    {{ field(class="form-select" + (" error" if field.errors else "")) }}
                {% endif %}
            {% elif field.type == 'BooleanField' %}
                <label class="form-checkbox">
                    {{ field }}
                    <span>{{ field.label.text }}</span>
                </label>
            {% elif field.type == 'RadioField' %}
                <div class="form-radio-group">
                    {% for value, label in field.choices %}
                        <label class="form-radio">
                            <input type="radio" name="{{ field.name }}" value="{{ value }}"
                                   {% if field.data == value %}checked{% endif %}
                                   {% if field.name == 'task_category' %}@change="updateTaskFields($event.target.value)"{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                {{ field(class="form-input") }}
            {% endif %}

            {% if show_errors and field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}

            {# Client-side validation errors #}
            {% if field.name == 'name' %}
                <p x-show="validationErrors.name"
                   class="form-error form-error-enhanced">
                    <strong>Error:</strong> <span x-text="validationErrors.name"></span>
                </p>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   DYNAMIC SEARCH FIELD RENDERING (Edit mode only)
   ============================================ #}
{% macro render_dynamic_search_field(field, mode='edit', additional_classes='', entity_type='') %}
    {% if mode == 'view' %}
        {# In view mode, just render the field normally #}
        {{ render_field(field, mode) }}
    {% else %}
        <div class="form-field-group {{ additional_classes }}">
            <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
                {{ field.label.text }}
            </label>
            <div class="relative">
                <input type="text"
                       id="{{ field.id }}_search"
                       name="q"
                       class="search-input form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="{{ field.render_kw.placeholder if field.render_kw and field.render_kw.placeholder else 'Search...' }}"
                       autocomplete="off"
                       hx-get="{{ url_for('search.htmx_search') }}"
                       hx-trigger="input changed delay:300ms, focus"
                       hx-target="#{{ field.id }}_search-results"
                       hx-swap="innerHTML"
                       hx-vals='{"mode": "select", "type": "{{ entity_type or field.render_kw.get('data-search-type', 'task_field') if field.render_kw else 'task_field' }}", "field_name": "{{ field.name }}"}'>
                <input type="hidden" name="{{ field.name }}" id="{{ field.id }}" value="{{ field.data or '' }}">
                <div id="{{ field.id }}_search-results"
                     class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"
                     ></div>
            </div>
            {% if field.errors %}
                {% for error in field.errors %}
                    <p class="form-error">{{ error }}</p>
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# ============================================
   TASK FORM SPECIAL RENDERING - Works in both view and edit modes
   ============================================ #}
{% macro render_task_form_fields(form, allowed_fields, mode='edit') %}
    {% for field_name in allowed_fields %}
        {% set field = form[field_name] %}

        {# Handle conditional fields based on task category #}
        {% if field_name == 'company_id' %}
            <div x-show="taskCategory === 'opportunity'" class="conditional-field">
                <div class="grid grid-cols-2 gap-4">
                    {{ render_dynamic_search_field(field, mode, entity_type='company') }}
                    {{ render_dynamic_search_field(form.opportunity_id, mode, entity_type='opportunity') }}
                </div>
            </div>
        {% elif field_name == 'opportunity_id' %}
            {# Skip - already rendered with company_id #}
        {# Handle inline group: task_type, priority, status with proper structure #}
        {% elif field_name == 'task_type' %}
            <div class="form-fields-inline-container">
                {{ render_field(form.task_type, mode) }}
                {{ render_field(form.priority, mode) }}
                {{ render_field(form.status, mode) }}
            </div>
        {% elif field_name == 'priority' or field_name == 'status' %}
            {# Skip - already rendered in inline group #}
        {# Handle name and due_date side by side - more space for name #}
        {% elif field_name == 'name' %}
            <div class="flex gap-4">
                <div class="flex-1">
                    {{ render_field(field, mode) }}
                </div>
                <div class="flex-shrink-0" style="width: auto; max-width: 50%;">
                    {% if mode == 'view' %}
                        {{ render_field(form.due_date, mode) }}
                    {% else %}
                        {{ render_enhanced_date_field(form.due_date) }}
                    {% endif %}
                </div>
            </div>
        {% elif field_name == 'due_date' %}
            {# Skip - already rendered with name #}
        {% elif field_name == 'assigned_to_id' %}
            {{ render_dynamic_search_field(field, mode, entity_type='user') }}
        {% else %}
            {{ render_field(field, mode) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   STAKEHOLDER FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_stakeholder_form_fields(form, allowed_fields, mode='edit') %}
    {# First row: Company and Job Title side by side #}
    {% if 'company' in allowed_fields and 'job_title' in allowed_fields %}
        {{ render_inline_fields_2col(form.company, form.job_title, mode) }}
    {% elif 'company' in allowed_fields %}
        {{ render_field(form.company, mode) }}
    {% elif 'job_title' in allowed_fields %}
        {{ render_field(form.job_title, mode) }}
    {% endif %}

    {# Render remaining fields in order #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['company', 'job_title'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field, mode) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   USER FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_user_form_fields(form, allowed_fields, mode='edit') %}
    {# Display Name and Job Title side by side at 50/50 width #}
    {% if 'name' in allowed_fields and 'job_title' in allowed_fields %}
        {{ render_inline_fields_2col(form.name, form.job_title, mode) }}
    {% elif 'name' in allowed_fields %}
        {{ render_field(form.name, mode) }}
    {% elif 'job_title' in allowed_fields %}
        {{ render_field(form.job_title, mode) }}
    {% endif %}

    {# Render any remaining fields that might be added in the future #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['name', 'job_title'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field, mode) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   COMPANY FORM SPECIAL RENDERING
   ============================================ #}
{% macro render_company_form_fields(form, allowed_fields, mode='edit') %}
    {# First row: Company Name and Industry side by side #}
    {% if 'name' in allowed_fields and 'industry' in allowed_fields %}
        {{ render_inline_fields_2col(form.name, form.industry, mode) }}
    {% elif 'name' in allowed_fields %}
        {{ render_field(form.name, mode) }}
    {% elif 'industry' in allowed_fields %}
        {{ render_field(form.industry, mode) }}
    {% endif %}

    {# Second row: Core Rep and Core SC side by side #}
    {% if 'core_rep' in allowed_fields and 'core_sc' in allowed_fields %}
        {{ render_inline_fields_2col(form.core_rep, form.core_sc, mode) }}
    {% elif 'core_rep' in allowed_fields %}
        {{ render_field(form.core_rep, mode) }}
    {% elif 'core_sc' in allowed_fields %}
        {{ render_field(form.core_sc, mode) }}
    {% endif %}

    {# Render remaining fields #}
    {% for field_name in allowed_fields %}
        {% if field_name not in ['name', 'industry', 'core_rep', 'core_sc'] %}
            {% set field = form[field_name] %}
            {% if field %}
                {{ render_field(field, mode) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================
   ENHANCED DATE FIELD - Edit mode only
   ============================================ #}
{% macro render_enhanced_date_field(field, additional_classes='') %}
    <div class="form-field-group {{ additional_classes }}">
        <label for="{{ field.id }}" class="form-label{% if field.flags.required %} form-label-required{% endif %}">
            {{ field.label.text }}
        </label>
        <div class="form-date-enhanced flex items-center gap-2">
            {{ field(class="form-input form-date-compact" + (" error" if field.errors else "")) }}
            <div class="form-date-buttons grid grid-cols-2 gap-1 flex-shrink-0">
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', 1)">+1d</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', 7)">+1w</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', -1)">-1d</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="addDaysToDate('{{ field.id }}', -7)">-1w</button>
            </div>
            <div class="form-date-countdown hidden" id="{{ field.id }}_countdown">
                <span class="countdown-text"></span>
            </div>
        </div>

        {% if field.errors %}
            {% for error in field.errors %}
                <p class="form-error">{{ error }}</p>
            {% endfor %}
        {% endif %}
    </div>
{% endmacro %}

{# ============================================
   FORM ACTIONS
   ============================================ #}
{% macro form_actions(submit_text='Save', cancel_url=None, cancel_text='Cancel') %}
    <div class="form-actions">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-secondary">{{ cancel_text }}</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
{% endmacro %}

{# ============================================
   INLINE ERRORS
   ============================================ #}
{% macro field_errors(field) %}
    {% if field.errors %}
        {% for error in field.errors %}
            <p class="form-error">{{ error }}</p>
        {% endfor %}
    {% endif %}
{% endmacro %}
{#
  Expandable Card Component - htmx-driven DRY component for all entity cards
  
  Creates a standardized card layout with server-side state management via htmx.
  Supports expansion, dynamic content loading, and interactive features.
  
  Parameters:
  - card_type (required): 'task' | 'opportunity' | 'contact' | 'stakeholder' | 'company'
  - entity (required): Entity object 
  - entity_id (required): Unique ID of the entity
  - expansion_enabled (optional): Enable expansion functionality (default: true)
  - progress_config (optional): Progress bar configuration object
  - bulk_selection_enabled (optional): Show bulk selection checkbox (default: true)
  - card_classes (optional): Additional CSS classes for the card
  - badge_content (optional): Badge/status content for header
  - title_content (required): Main title/name content
  - value_content (optional): Value content (deal amount, etc.)
  - secondary_info (optional): Secondary info (company, stakeholder)
  - metadata_content (optional): Metadata text content
  - action_buttons (optional): Action buttons HTML
  - expanded_content (optional): Content shown when expanded
  - notes_enabled (optional): Enable notes/comments section (default: false)
  
  Progress Config Object:
  {
    'enabled': true,
    'type': 'completion' | 'probability' | 'custom',
    'value': number,
    'max_value': number (optional, default 100),
    'color_scheme': 'blue' | 'green' | 'yellow' | 'red' (optional, default 'blue'),
    'label': string (optional)
  }
  
  Usage:
  {{ expandable_card('opportunity', opportunity, opportunity.id, 
       badge_content=opportunity_header_content(opportunity),
       title_content=opportunity.name,
       value_content='$' + "{:,.0f}".format(opportunity.value),
       secondary_info='<span class="text-entity-base text-color-company">' + opportunity.company.name + '</span>',
       metadata_content=opportunity_metadata_content(opportunity),
       action_buttons=action_buttons_row('opportunity', opportunity.id),
       progress_config={'enabled': true, 'type': 'probability', 'value': opportunity.probability},
       expanded_content=opportunity_expanded_content(opportunity)) }}
#}
{% from "macros/ui_elements.html" import bulk_selection_checkbox, pluralized_count %}
{% from "macros/ui/progress.html" import progress_bar %}

{# Main expandable card macro - htmx-enhanced with server-side state management #}
{% macro expandable_card(card_type, entity, entity_id, expansion_enabled=true, progress_config=none, bulk_selection_enabled=true, card_classes='', field_config={}, model_class=none, badge_content='', title_content='', value_content='', secondary_info='', metadata_content='', action_buttons='', expanded_content='', notes_enabled=false) %}
{# Setup card styling and auto-field extraction #}
{%- set base_classes = card_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50',
    'contact': 'ring-2 ring-green-200 bg-green-50',
    'stakeholder': 'ring-2 ring-green-200 bg-green-50',
    'company': 'ring-2 ring-blue-200 bg-blue-50'
} -%}

{# Auto-extract fields when field_config is provided #}
{{ auto_extract_fields(entity, field_config, title_content, badge_content, value_content, secondary_info, metadata_content) }}

{% if expansion_enabled %}
<details class="{{ base_classes }} {{ color_classes.get(card_type, '') }} {{ card_classes }}" 
         data-{{ card_type }}-id="{{ entity_id }}" 
         {% if notes_enabled %}hx-trigger="toggle" hx-get="/api/{{ card_type }}s/{{ entity_id }}/notes" hx-target="#notes-{{ entity_id }}"{% endif %}>
    <summary class="cursor-pointer list-none flex items-center justify-between">
        <div class="flex-1 flex items-center justify-between">
            <!-- Left side content -->
            <div class="flex items-center space-x-3">
                {% if bulk_selection_enabled %}
                {{ bulk_selection_checkbox(entity_id) }}
                {% endif %}
                
                {{ card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) }}
            </div>
            
            <!-- Right side actions -->
            {% if action_buttons %}
            <div class="flex items-center space-x-2">{{ action_buttons|safe }}</div>
            {% endif %}
            
            <!-- Task-specific reschedule buttons -->
            {% if card_type == 'task' %}
            {{ task_reschedule_buttons_htmx(entity_id) }}
            {% endif %}
            
            <!-- Expand chevron -->
            <div class="ml-4 transition-transform duration-200 details-chevron">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </summary>
    
    <!-- Expanded content -->
    <div class="mt-4 pt-4 border-t border-gray-200">
        {% if expanded_content %}
        {{ expanded_content|safe }}
        {% endif %}
        
        {% if notes_enabled %}
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-900">Comments & Notes</h4>
            <div id="notes-{{ entity_id }}">
                <!-- Notes loaded via htmx -->
            </div>
            {{ notes_form_htmx(card_type, entity_id) }}
        </div>
        {% endif %}
        
        {% if caller %}
        {{ caller() }}
        {% endif %}
    </div>
</details>
{% else %}
<!-- Non-expandable version -->
<div class="{{ base_classes }} {{ color_classes.get(card_type, '') }} {{ card_classes }}" data-{{ card_type }}-id="{{ entity_id }}">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-1">
            {% if bulk_selection_enabled %}
            {{ bulk_selection_checkbox(entity_id) }}
            {% endif %}
            
            {{ card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) }}
        </div>
        
        {% if action_buttons %}
        <div class="flex items-center space-x-2">{{ action_buttons|safe }}</div>
        {% endif %}
        
        {% if card_type == 'task' %}
        {{ task_reschedule_buttons_htmx(entity_id) }}
        {% endif %}
    </div>
</div>
{% endif %}

<style>
/* CSS for details chevron rotation - supports all card types */
details[data-task-id] summary::-webkit-details-marker,
details[data-opportunity-id] summary::-webkit-details-marker,
details[data-contact-id] summary::-webkit-details-marker,
details[data-stakeholder-id] summary::-webkit-details-marker,
details[data-company-id] summary::-webkit-details-marker {
    display: none;
}

details[open] .details-chevron {
    transform: rotate(180deg);
}
</style>
{% endmacro %}

{# ========== HELPER MACROS ========== #}

{# Auto-extract fields from entity when field_config is provided #}
{% macro auto_extract_fields(entity, field_config, title_content, badge_content, value_content, secondary_info, metadata_content) %}
{%- if field_config -%}
  {# Auto-extract title content #}
  {%- if not title_content -%}
    {%- set title_content = entity.name|default('') -%}
  {%- endif -%}
  
  {# Badge content based on entity type #}
  {%- if not badge_content -%}
    {%- set badge_value = entity.stage|default('') or entity.status|default('') or entity.job_title|default('') or entity.industry|default('') or entity.priority|default('') -%}
    {%- if badge_value -%}
      {%- set badge_css_class = 'bg-blue-100 text-blue-800' -%}
      {%- set badge_content = '<span class="px-2 py-1 text-xs font-medium rounded-full ' + badge_css_class + '">' + (badge_value|string|title) + '</span>' -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Value content (currency formatting for deals) #}
  {%- if not value_content -%}
    {%- set raw_value = entity.value|default(none) -%}
    {%- if raw_value is number -%}
      {%- set value_content = '${:,.0f}'.format(raw_value) -%}
    {%- elif raw_value -%}
      {%- set value_content = raw_value|string -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Secondary info from relationships #}
  {%- if not secondary_info -%}
    {%- set secondary_parts = [] -%}
    {%- if entity.company and entity.company.name -%}
      {%- set _ = secondary_parts.append('<span class="text-gray-600">' + entity.company.name + '</span>') -%}
    {%- endif -%}
    {%- if entity.email -%}
      {%- set _ = secondary_parts.append('<a href="mailto:' + entity.email + '" class="text-blue-600 hover:text-blue-800">' + entity.email + '</a>') -%}
    {%- endif -%}
    {%- if secondary_parts -%}
      {%- set secondary_info = secondary_parts | join(' • ') -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Metadata from date fields #}
  {%- if not metadata_content -%}
    {%- set metadata_parts = [] -%}
    {%- if entity.created_at -%}
      {%- set _ = metadata_parts.append(entity.created_at.strftime('%m/%d/%y')) -%}
    {%- endif -%}
    {%- if entity.due_date -%}
      {%- set _ = metadata_parts.append('Due: ' + entity.due_date.strftime('%m/%d/%y')) -%}
    {%- endif -%}
    {%- if entity.expected_close_date -%}
      {%- set _ = metadata_parts.append('Close: ' + entity.expected_close_date.strftime('%m/%d/%y')) -%}
    {%- endif -%}
    {%- if metadata_parts -%}
      {%- set metadata_content = metadata_parts | join(' • ') -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}
{% endmacro %}

{# Reusable card content section #}
{% macro card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) %}
<div class="flex-1">
    <!-- Badge content -->
    {% if badge_content %}
    <div class="mb-1">{{ badge_content|safe }}</div>
    {% endif %}
    
    <!-- Title and Value -->
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ title_content|safe }}</h3>
        {% if value_content %}
        <span class="text-lg font-semibold text-gray-700">{{ value_content|safe }}</span>
        {% endif %}
    </div>
    
    <!-- Secondary info -->
    {% if secondary_info %}
    <div class="mt-1">{{ secondary_info|safe }}</div>
    {% endif %}
    
    <!-- Progress bar -->
    {% if progress_config and progress_config.enabled %}
    <div class="mt-2">
        {{ progress_bar(progress_config.value, progress_config.max_value or 100, progress_config.color_scheme or 'blue', progress_config.label) }}
    </div>
    {% endif %}
    
    <!-- Metadata -->
    {% if metadata_content %}
    <div class="mt-2 text-sm text-gray-500">{{ metadata_content|safe }}</div>
    {% endif %}
</div>
{% endmacro %}

{# htmx-powered notes form #}
{% macro notes_form_htmx(card_type, entity_id) %}
<form hx-post="/api/{{ card_type }}s/{{ entity_id }}/notes" 
      hx-target="#notes-{{ entity_id }}" 
      hx-swap="afterbegin"
      hx-on::after-request="this.reset()">
    <div class="flex space-x-2">
        <input type="text" 
               name="content" 
               placeholder="Add a comment..." 
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               required>
        <input type="hidden" name="is_internal" value="true">
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Add
        </button>
    </div>
</form>
{% endmacro %}

{# htmx-powered task reschedule buttons #}
{% macro task_reschedule_buttons_htmx(task_id) %}
<div class="relative flex-shrink-0">
    <div class="flex items-center space-x-1">
        <button hx-post="/tasks/{{ task_id }}/reschedule" 
                hx-vals='{"days": -7}'
                hx-target="#task-metadata-{{ task_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button hx-post="/tasks/{{ task_id }}/reschedule" 
                hx-vals='{"days": -1}'
                hx-target="#task-metadata-{{ task_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button hx-post="/tasks/{{ task_id }}/reschedule" 
                hx-vals='{"days": 1}'
                hx-target="#task-metadata-{{ task_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button hx-post="/tasks/{{ task_id }}/reschedule" 
                hx-vals='{"days": 7}'
                hx-target="#task-metadata-{{ task_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
</div>
{% endmacro %}

{#
  Universal Field Renderer - Simplified approach for now
  
  We'll use the simplest working approach first, then optimize later.
  The goal was to eliminate if/elif chains in templates, but sometimes
  a small chain in infrastructure code is acceptable to keep the API clean.
#}
{% macro render_field(entity, field_config) %}
{%- if field_config.type == 'text' -%}
    {{ field_config.get('prefix', '') }}{{ entity[field_config.field] }}
{%- elif field_config.type == 'count' -%}
    {{ pluralized_count(entity[field_config.field]|length, field_config.label) }}
{%- elif field_config.type == 'link' -%}
    {%- if entity[field_config.field] -%}
    <a href="{{ entity[field_config.field] }}" target="_blank" class="text-link hover:text-link-hover" onclick="event.stopPropagation()">{{ entity[field_config.field] }}</a>
    {%- else -%}
    <span class="text-gray-500">No link provided</span>
    {%- endif -%}
{%- elif field_config.type == 'badge' -%}
    <span class="badge-standard badge-{{ field_config.style }}">{{ entity[field_config.field] }}</span>
{%- elif field_config.type == 'date' -%}
    {{ entity[field_config.field].strftime(field_config.get('format', '%m/%d/%y')) if entity[field_config.field] }}
{%- else -%}
    {{ entity[field_config.field] }}
{%- endif -%}
{% endmacro %}

{# ========== ENTITY-SPECIFIC CONTENT HELPERS ========== #}

{#
  Opportunity Header Content - Standardized opportunity header badge
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_header_content(opportunity) }}
#}
{% macro opportunity_header_content(opportunity) %}
{% from "macros/list_section.html" import status_badge %}
{{ status_badge(opportunity.stage, 'green' if opportunity.stage == 'Prospect' else 'blue') }}
{% endmacro %}

{#
  Task Header Content - Standardized task header badge
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_header_content(task) }}
#}
{% macro task_header_content(task) %}
{% from "macros/list_section.html" import status_badge %}
{% set priority_color = 'red' if task.priority == 'high' else
                      'yellow' if task.priority == 'medium' else
                      'green' %}
{{ status_badge(task.priority, priority_color) }}
{% endmacro %}

{# ========== ACTION BUTTON HELPERS ========== #}

{#
  Action Buttons Row - Standardized action buttons for cards
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact'
  - entity_id (required): Entity ID
  - actions (optional): List of action configs
  - disabled_condition (optional): Alpine.js condition for disabling
  
  Action Config:
  {
    'type': 'edit' | 'delete' | 'complete' | 'view' | 'custom',
    'icon': 'icon_html',
    'onclick': 'javascript_function',
    'title': 'tooltip_text',
    'classes': 'additional_css_classes'
  }
  
  Usage:
  {{ action_buttons_row('task', task.id, actions=[
       {'type': 'edit', 'onclick': 'editTask(' + task.id|string + ')'},
       {'type': 'delete', 'onclick': 'deleteTask(' + task.id|string + ')'} 
     ]) }}
#}
{% macro action_buttons_row(entity_type, entity_id, actions=none, disabled_condition='') %}
{% from "macros/base/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_actions = {
    'task': [
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteTask(' + entity_id|string + ')', 'title': 'Delete task', 'classes': 'text-danger-hover hover:bg-red-50'},
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'editTask(' + entity_id|string + ')', 'title': 'Edit task', 'classes': 'text-info-hover hover:bg-blue-50'},
        {'type': 'complete', 'icon': check_icon("w-4 h-4"), 'onclick': 'completeTask(' + entity_id|string + ')', 'title': 'Complete task', 'classes': 'text-success-hover hover:bg-green-50'}
    ],
    'opportunity': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'editOpportunity(' + entity_id|string + ')', 'title': 'Edit opportunity', 'classes': 'text-info-hover hover:bg-blue-50'}
    ],
    'contact': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'openStakeholderModal(' + entity_id|string + ')', 'title': 'Edit contact', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteStakeholder(' + entity_id|string + ')', 'title': 'Delete contact', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ],
    'stakeholder': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'onclick': 'openStakeholderModal(' + entity_id|string + ')', 'title': 'Edit stakeholder', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'onclick': 'deleteStakeholder(' + entity_id|string + ')', 'title': 'Delete stakeholder', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ]
} -%}

{%- set button_actions = actions or default_actions.get(entity_type, []) -%}

<div class="flex items-center space-x-1" {% if disabled_condition %}:class="{ 'opacity-50 pointer-events-none': {{ disabled_condition }} }"{% endif %}>
    {% for action in button_actions %}
    <button @click.stop="{{ action.onclick }}" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.classes }}" 
            title="{{ action.title }}">
        {{ action.icon|safe }}
    </button>
    {% endfor %}
</div>
{% endmacro %}

{# ========== CONTENT GENERATION HELPERS ========== #}

{#
  Task Title Content - Task description with badges
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_title_content(task) }}
#}
{% macro task_title_content(task) %}
{{ task.description | style_task_description }}
{% if task.next_step_type %}
    <span class="text-badge-tag">{{ task.next_step_type }}</span>
{% endif %}
{% if task.is_overdue %}
    <span class="text-badge-overdue">OVERDUE</span>
{% endif %}
{% endmacro %}

{#
  Task Metadata Content - Standardized task metadata layout
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_metadata_content(task) }}
#}
{% macro task_metadata_content(task) %}
<span class="text-gray-500">
    {% if task.next_step_type %}
    {{ task.next_step_type }}
    {% endif %}
    {% if task.due_date %}
    • Due: <span x-text="getNewDueDate ? getNewDueDate() : '{{ task.due_date.strftime('%d/%m/%y') }}'">{{ task.due_date.strftime('%d/%m/%y') }}</span>
    {% endif %}
    {% if task.is_overdue %}
    • <span class="text-badge-overdue">OVERDUE</span>
    {% endif %}
</span>
{% endmacro %}

{#
  Opportunity Metadata Content - Standardized opportunity metadata layout
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_metadata_content(opportunity) }}
#}
{% macro opportunity_metadata_content(opportunity) %}
<span class="text-gray-500">
    <span class="text-gray-500">
        Close: {{ opportunity.close_date.strftime('%d/%m/%y') if opportunity.close_date else 'TBD' }}
        {% if opportunity.days_until_close %}
            • {{ opportunity.days_until_close }} days to go
        {% endif %}
    </span>
</span>
 • 
<div class="text-metadata">
    {% if opportunity.company %}
        <span class="text-entity-base text-color-company">{{ opportunity.company.name }}</span> • 
    {% endif %}
    <span class="text-entity-base text-color-opportunity">{{ opportunity.name }}</span> • 
    {{ opportunity.stage }} • 
    <span class="text-entity-base text-color-deal">${{ "{:,.0f}".format(opportunity.value) if opportunity.value else '0' }}</span> • 
    {% if opportunity.contact %}
        <span class="text-entity-base text-color-stakeholder">{{ opportunity.contact.name }}</span> • 
    {% endif %}
    {{ opportunity.created_at.strftime('%d') if opportunity.created_at else '0' }} days old
</div>
{% endmacro %}

{#
  Task Reschedule Buttons - Reschedule functionality for tasks
  
  Parameters:
  - task_id (required): Task ID for the reschedule actions
  
  Usage:
  {{ task_reschedule_buttons(task.id) }}
#}
{% macro task_reschedule_buttons(task_id) %}
<div class="relative flex-shrink-0">
    <div class="flex items-center space-x-1">
        <button @click.stop="adjustDays(-7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button @click.stop="adjustDays(-1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button @click.stop="adjustDays(1)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button @click.stop="adjustDays(7)" 
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
    
    <!-- Save/Cancel buttons (overlay below with absolute positioning) -->
    <div class="absolute top-full left-0 right-0 mt-2 flex items-center justify-center space-x-1" 
         x-show="showSaveButtons" 
         style="display: none;"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
        <button @click.stop="saveReschedule({{ task_id }}, pendingDays)" 
                class="px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors duration-200" 
                title="Save changes">
            Save
        </button>
        <button @click.stop="cancelChanges()" 
                class="px-3 py-1 rounded border text-gray-600 text-xs hover:bg-gray-50 transition-colors duration-200" 
                title="Cancel changes">
            Cancel
        </button>
    </div>
</div>
{% endmacro %}

{# ========== ENTITY-SPECIFIC HELPERS ========== #}

{# Company Helper Functions - for DRY entity system #}
{# Generic badge content for any field #}
{% macro entity_badge_content(entity, field, color='blue') %}
{% if entity[field] %}
    <span class="badge-standard badge-{{ color }}">{{ entity[field] }}</span>
{% endif %}
{% endmacro %}

{% macro company_header_content(company) %}
{{ entity_badge_content(company, 'industry') }}
{% endmacro %}

{# Generic title content for entities with 'name' field #}
{% macro entity_title_content(entity) %}
{{ entity.name }}
{% endmacro %}

{# Legacy aliases for backwards compatibility #}
{% macro company_title_content(company) %}{{ entity_title_content(company) }}{% endmacro %}
{% macro stakeholder_title_content(stakeholder) %}{{ entity_title_content(stakeholder) }}{% endmacro %}
{% macro opportunity_title_content(opportunity) %}{{ entity_title_content(opportunity) }}{% endmacro %}

{% macro company_metadata_content(company) %}
<div class="text-sm text-gray-500 flex items-center space-x-4">
    {% if company.contacts %}
        <span>{{ company.contacts|length }} contact{{ 's' if company.contacts|length != 1 else '' }}</span>
    {% endif %}
    {% if company.opportunities %}  
        <span>{{ company.opportunities|length }} opportunit{{ 'ies' if company.opportunities|length != 1 else 'y' }}</span>
    {% endif %}
    <span>{{ company.created_at.strftime('%m/%d/%y') if company.created_at else 'N/A' }}</span>
</div>
{% endmacro %}

{# Team Helper Functions #}
{% macro team_header_content(member) %}
{{ entity_badge_content(member, 'job_title') }}
{% endmacro %}

{% macro team_title_content(member) %}{{ entity_title_content(member) }}{% endmacro %}

{% macro team_metadata_content(member) %}
<div class="text-sm text-gray-500 flex items-center space-x-4">
    {% if member.email %}
        <span>{{ member.email }}</span>
    {% endif %}
    {% if member.company %}
        <span>{{ member.company.name }}</span>
    {% endif %}
    <span>{{ member.created_at.strftime('%m/%d/%y') if member.created_at else 'N/A' }}</span>
</div>
{% endmacro %}

{# ========== ADVANCED AUTOMATION ========== #}

{#
  Automatic Expandable Card - Fully DRY using Model Metadata
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'stakeholder' | 'company'  
  - entity (required): Entity object
  - entity_id (required): Unique ID of the entity
  - expansion_enabled (optional): Enable expansion functionality (default: true)
  - bulk_selection_enabled (optional): Show bulk selection checkbox (default: true)
  
  This macro automatically:
  - Gets model configuration via ModelIntrospector
  - Extracts badge, title, secondary, metadata fields from model metadata
  - Uses appropriate CSS classes and icons from model.info
  - Generates correct action buttons for entity type
  
  Usage:
  {{ expandable_card_auto('stakeholder', stakeholder, stakeholder.id) }}
#}
{% macro expandable_card_auto(entity_type, entity, entity_id, expansion_enabled=true, bulk_selection_enabled=true) %}
{% set model_config = get_model_config(entity.__class__) %}

{# Auto-generate field configuration from model metadata #}
{% set auto_config = {
    'badge_field': none,
    'badge_style': 'blue',
    'title_field': 'name',
    'secondary_fields': [],
    'metadata_fields': []
} %}

{# Extract badge field from model metadata - look for groupable fields with choices #}
{% for field_name, field_info in model_config.fields.items() %}
    {% if field_info.choices and field_info.groupable and not auto_config.badge_field %}
        {% set _ = auto_config.update({'badge_field': field_name}) %}
    {% endif %}
{% endfor %}

{# Build secondary fields - look for relationship and contact fields #}
{% if entity_type == 'stakeholder' %}
    {% set _ = auto_config.secondary_fields.append({'field': 'company.name', 'type': 'text'}) %}
    {% set _ = auto_config.secondary_fields.append({'field': 'email', 'type': 'text'}) %}
{% elif entity_type == 'opportunity' %}
    {% set _ = auto_config.secondary_fields.append({'field': 'company.name', 'type': 'text'}) %}
    {% set _ = auto_config.secondary_fields.append({'field': 'contact.name', 'type': 'text'}) %}
{% elif entity_type == 'task' %}
    {# Tasks have special handling in template already #}
{% endif %}

{# Build metadata fields - look for date and status fields #}
{% for field_name, field_info in model_config.fields.items() %}
    {% if field_name in ['phone', 'created_at', 'due_date', 'close_date'] %}
        {% if field_name == 'created_at' %}
            {% set _ = auto_config.metadata_fields.append({'field': field_name, 'type': 'date', 'format': '%m/%d/%y'}) %}
        {% elif 'date' in field_name %}
            {% set _ = auto_config.metadata_fields.append({'field': field_name, 'type': 'date', 'format': '%d/%m/%y'}) %}
        {% else %}
            {% set _ = auto_config.metadata_fields.append({'field': field_name, 'type': 'text'}) %}
        {% endif %}
    {% endif %}
{% endfor %}

{{ expandable_card(entity_type, entity, entity_id,
    expansion_enabled=expansion_enabled,
    bulk_selection_enabled=bulk_selection_enabled,
    field_config=auto_config,
    action_buttons=action_buttons_row(entity_type, entity_id)) }}
{% endmacro %}
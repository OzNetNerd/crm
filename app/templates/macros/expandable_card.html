{% from 'macros/base/icons.html' import icon %}
{#
  Modern Card System - Container-based architecture with composable content
  
  NEW CONTAINER SYSTEM (RECOMMENDED):
  {{ card('task', task) }}
  {{ card('opportunity', opportunity, content=custom_content_object) }}
  
  LEGACY COMPATIBILITY (still supported):
  {{ auto_card('task', task) }}
  {{ expandable_card('task', task, task.id, title_content=task.name, ...) }}
  
  Architecture:
  - Universal card container that accepts content objects
  - Composable content blocks (header, body, actions, footer)
  - Field renderers for all common data types
  - Smart entity configuration system
  - Icon positioning fix: actions grouped with chevron
#}
{% from "macros/base/forms.html" import bulk_selection_checkbox %}
{% from "macros/ui/progress.html" import progress_bar %}

{# ========== CONTAINER SYSTEM ========== #}

{#
  Universal Card Container - The foundation of the modern card system
  
  This replaces the legacy expandable_card macro with a clean, flexible container
  that accepts content objects to define what gets displayed.
  
  Parameters:
  - card_type (required): Entity type for styling and data attributes
  - entity_id (required): Unique identifier
  - expansion_enabled (optional): Allow expand/collapse (default: true)
  - card_classes (optional): Additional CSS classes
  - content (required): Content object with sections
  
  Content Object Structure:
  {
    'header': { /* header content config */ },
    'body': { /* body content config */ },
    'actions': { /* action buttons config */ },
    'footer': { /* footer content config */ },
    'expanded': { /* expanded content config */ }
  }
  
  Usage:
  {{ card_container('task', task.id, content=task_content_config) }}
#}
{% macro card_container(card_type, entity_id, expansion_enabled=true, card_classes='', content={}) %}
{%- set base_classes = card_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50', 
    'contact': 'ring-2 ring-green-200 bg-green-50',
    'stakeholder': 'ring-2 ring-green-200 bg-green-50',
    'company': 'ring-2 ring-blue-200 bg-blue-50'
} -%}

{% if expansion_enabled %}
<details class="{{ base_classes }} {{ color_classes.get(card_type, 'ring-2 ring-gray-200 bg-gray-50') }} {{ card_classes }}" 
         data-{{ card_type }}-id="{{ entity_id }}">
    <summary class="cursor-pointer list-none flex items-center justify-between">
        <div class="flex-1 flex items-center justify-between">
            <!-- Header content -->
            <div class="flex items-center space-x-3">
                {% if content.get('bulk_selection', true) %}
                {{ bulk_selection_checkbox(entity_id) }}
                {% endif %}
                
                {% if content.header %}
                {{ render_content_section(content.header) }}
                {% endif %}
            </div>
            
            <!-- Action buttons and chevron grouped together (ICON FIX) -->
            <div class="flex items-center space-x-2">
                {% if content.actions %}
                {{ render_action_section(content.actions) }}
                {% endif %}
                
                <!-- Expand chevron -->
                <div class="transition-transform duration-200 details-chevron">
                    {{ icon('chevron-down', 'md', 'text-gray-400') }}
                </div>
            </div>
        </div>
    </summary>
    
    <!-- Expanded content -->
    <div class="mt-4 pt-4 border-t border-gray-200">
        {% if content.body %}
        {{ render_content_section(content.body) }}
        {% endif %}
        
        {% if content.expanded %}
        {{ render_content_section(content.expanded) }}
        {% endif %}
        
        {% if content.footer %}
        {{ render_content_section(content.footer) }}
        {% endif %}
        
        {% if caller %}
        {{ caller() }}
        {% endif %}
    </div>
</details>
{% else %}
<!-- Non-expandable version -->
<div class="{{ base_classes }} {{ color_classes.get(card_type, 'ring-2 ring-gray-200 bg-gray-50') }} {{ card_classes }}" 
     data-{{ card_type }}-id="{{ entity_id }}">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-1">
            {% if content.get('bulk_selection', true) %}
            {{ bulk_selection_checkbox(entity_id) }}
            {% endif %}
            
            {% if content.header %}
            {{ render_content_section(content.header) }}
            {% endif %}
        </div>
        
        <!-- Action buttons (no chevron in non-expandable) -->
        {% if content.actions %}
        <div class="flex items-center space-x-2">
            {{ render_action_section(content.actions) }}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<style>
/* Universal chevron rotation for all card types */
details[data-task-id] summary::-webkit-details-marker,
details[data-opportunity-id] summary::-webkit-details-marker,
details[data-contact-id] summary::-webkit-details-marker,
details[data-stakeholder-id] summary::-webkit-details-marker,
details[data-company-id] summary::-webkit-details-marker {
    display: none;
}
details[open] .details-chevron {
    transform: rotate(90deg);
}
</style>
{% endmacro %}

{# ========== CONTENT RENDERERS ========== #}

{#
  Content Section Renderer - Renders any content section based on its configuration
#}
{% macro render_content_section(section_config) %}
{% if section_config.type == 'fields' %}
    {{ render_field_section(section_config) }}
{% elif section_config.type == 'html' %}
    {{ section_config.content|safe }}
{% elif section_config.type == 'template' %}
    {% include section_config.template %}
{% elif section_config.type == 'composite' %}
    {% for subsection in section_config.sections %}
        {{ render_content_section(subsection) }}
    {% endfor %}
{% else %}
    {{ render_field_section(section_config) }}
{% endif %}
{% endmacro %}

{#
  Field Section Renderer - Renders an array of fields with layout
#}
{% macro render_field_section(section_config) %}
{%- set layout = section_config.get('layout', 'stacked') -%}
{%- set entity = section_config.entity -%}

{% if layout == 'inline' %}
<div class="flex items-center space-x-2">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% elif layout == 'grid' %}
<div class="grid grid-cols-2 gap-4">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% else %} {# stacked layout #}
<div class="space-y-2">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% endif %}
{% endmacro %}

{#
  Enhanced Universal Field Renderer
#}
{% macro render_field(entity, field_config) %}
{%- set field_name = field_config.name -%}
{%- set field_value = entity[field_name] if entity and field_name else None -%}
{%- set field_type = field_config.get('type', 'text') -%}
{%- set default_value = field_config.get('default', '') -%}

{% if not field_value and field_type != 'custom' %}
    {% if default_value %}
        <span class="text-gray-500">{{ default_value }}</span>
    {% endif %}
{% else %}
    {% if field_type == 'text' %}
        {{ field_config.get('prefix', '') }}{{ field_value }}{{ field_config.get('suffix', '') }}
    
    {% elif field_type == 'badge' %}
        <span class="badge-standard badge-{{ field_config.get('style', 'blue') }}">
            {{ field_value }}
        </span>
    
    {% elif field_type == 'date' %}
        {% if field_value %}
            {{ entity[field_config.field + '_formatted'] or '' }}
        {% endif %}
    
    {% elif field_type == 'currency' %}
        {% if field_value is number %}
            {{ entity[field_config.field + '_formatted'] or '$0' }}
        {% else %}
            {{ field_value }}
        {% endif %}
    
    {% elif field_type == 'count' %}
        {% if field_value is iterable %}
            {% set count = field_value|length %}
            {{ count }} {{ field_config.get('label', 'item') }}{{ '' if count == 1 else 's' }}
        {% else %}
            {% set count = field_value %}
            {{ count }} {{ field_config.get('label', 'item') }}{{ '' if count == 1 else 's' }}
        {% endif %}
    
    {% elif field_type == 'link' %}
        {% if field_value %}
            <a href="{{ field_value }}" target="_blank" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_config.get('text', field_value) }}
            </a>
        {% endif %}
    
    {% elif field_type == 'email' %}
        {% if field_value %}
            <a href="mailto:{{ field_value }}" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_value }}
            </a>
        {% endif %}
    
    {% elif field_type == 'phone' %}
        {% if field_value %}
            <a href="tel:{{ field_value }}" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_value }}
            </a>
        {% endif %}
    
    {% elif field_type == 'progress' %}
        {% if field_value is number %}
            {{ progress_bar(
                field_value, 
                field_config.get('max_value', 100),
                field_config.get('color_scheme', 'blue'),
                field_config.get('label')
            ) }}
        {% endif %}
    
    {% elif field_type == 'relationship' %}
        {% set related_object = field_value %}
        {% set related_field = field_config.get('related_field', 'name') %}
        {% if related_object %}
            {{ related_object[related_field] }}
        {% endif %}
    
    {% else %}
        {# Fallback to simple text display #}
        {{ field_value }}
    {% endif %}
{% endif %}
{% endmacro %}

{#
  Action Section Renderer - Renders action buttons based on configuration
#}
{% macro render_action_section(action_config) %}
{% if action_config.type == 'buttons' %}
    <div class="flex items-center space-x-1">
        {% for action in action_config.actions %}
            {{ render_action_button(action) }}
        {% endfor %}
    </div>
{% elif action_config.type == 'dropdown' %}
    {# Future enhancement: dropdown action menus #}
    <!-- Dropdown actions not yet implemented -->
{% elif action_config.type == 'custom' %}
    {{ action_config.content|safe }}
{% endif %}
{% endmacro %}

{#
  Individual Action Button Renderer
#}
{% macro render_action_button(action) %}
{% from "macros/base/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_icons = {
    'edit': pencil_icon("w-4 h-4"),
    'delete': trash_icon("w-4 h-4"), 
    'complete': check_icon("w-4 h-4")
} -%}

{%- set default_classes = {
    'edit': 'text-info-hover hover:bg-blue-50',
    'delete': 'text-danger-hover hover:bg-red-50',
    'complete': 'text-success-hover hover:bg-green-50'
} -%}

<button onclick="event.stopPropagation(); {{ action.onclick }}" 
        class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.get('classes', default_classes.get(action.type, '')) }}" 
        title="{{ action.get('title', action.type.title()) }}">
    {{ action.get('icon', default_icons.get(action.type, ''))|safe }}
</button>
{% endmacro %}

{# ========== CONTENT BUILDERS ========== #}

{#
  Main Card Macro - The new recommended API
  
  This is the primary interface for the new card system. It automatically
  builds content objects based on entity type and renders using the container.
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact' | 'stakeholder' | 'company'
  - entity (required): Entity object
  - expansion_enabled (optional): Enable expand/collapse (default: true)
  - card_classes (optional): Additional CSS classes
  - content (optional): Override with custom content object
  - overrides (optional): Override specific content sections
  
  Usage:
  {{ card('task', task) }}
  {{ card('opportunity', opportunity, expansion_enabled=false) }}
  {{ card('task', task, content=custom_content, overrides={'actions': custom_actions}) }}
#}
{% macro card(entity_type, entity, expansion_enabled=true, card_classes='', content=none, overrides={}) %}
{% if content %}
    {# Use provided content object #}
    {% set final_content = content %}
{% else %}
    {# Build content object automatically based on entity type #}
    {% if entity_type == 'task' %}
        {% set final_content = {
            'header': {
                'type': 'fields',
                'layout': 'stacked', 
                'entity': entity,
                'fields': [
                    {'name': 'priority', 'type': 'badge', 'style': ('red' if entity.priority == 'high' else ('yellow' if entity.priority == 'medium' else 'green'))},
                    {'name': 'description', 'type': 'text', 'classes': 'text-lg font-medium text-gray-900'},
                    {'name': 'next_step_type', 'type': 'text', 'classes': 'text-gray-600'},
                    {'name': 'due_date', 'type': 'date', 'format': '%d/%m/%y', 'prefix': 'Due: ', 'classes': 'text-sm text-gray-500'},
                    {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y', 'classes': 'text-sm text-gray-500'}
                ]
            },
            'actions': {
                'type': 'buttons',
                'actions': [
                    {
                        'type': 'complete',
                        'onclick': 'htmx.ajax("POST", "/api/tasks/' + entity.id|string + '/complete", {target: "closest(.task-card)", swap: "outerHTML"})',
                        'title': 'Complete task'
                    },
                    {
                        'type': 'edit', 
                        'onclick': 'htmx.ajax("GET", "/modals/Task/' + entity.id|string + '/edit", {target: "body", swap: "beforeend"})',
                        'title': 'Edit task'
                    },
                    {
                        'type': 'delete',
                        'onclick': 'if(confirm("Are you sure you want to delete this task?")) htmx.ajax("DELETE", "/api/tasks/' + entity.id|string + '", {target: "closest(.task-card)", swap: "outerHTML"})',
                        'title': 'Delete task'
                    }
                ]
            },
            'body': {
                'type': 'fields',
                'layout': 'stacked',
                'entity': entity,
                'fields': [{'name': 'notes', 'type': 'text', 'classes': 'text-sm text-gray-700'}] if entity.notes else []
            }
        } %}
    {% elif entity_type == 'opportunity' %}
        {% set final_content = {
            'header': {
                'type': 'fields',
                'layout': 'stacked',
                'entity': entity,
                'fields': [
                    {'name': 'stage', 'type': 'badge', 'style': ('green' if entity.stage == 'Prospect' else 'blue')},
                    {'name': 'name', 'type': 'text', 'classes': 'text-lg font-medium text-gray-900'},
                    {'name': 'value', 'type': 'currency', 'classes': 'text-lg font-semibold text-gray-700'},
                    {'name': 'company', 'type': 'relationship', 'related_field': 'name', 'classes': 'text-gray-600'},
                    {'name': 'close_date', 'type': 'date', 'format': '%d/%m/%y', 'prefix': 'Close: ', 'classes': 'text-sm text-gray-500'},
                    {'name': 'probability', 'type': 'text', 'suffix': '% probability', 'classes': 'text-sm text-gray-500'}
                ]
            },
            'actions': {
                'type': 'buttons',
                'actions': [
                    {
                        'type': 'edit',
                        'onclick': 'htmx.ajax("GET", "/modals/Opportunity/' + entity.id|string + '/edit", {target: "body", swap: "beforeend"})',
                        'title': 'Edit opportunity'
                    },
                    {
                        'type': 'delete',
                        'onclick': 'if(confirm("Are you sure you want to delete this opportunity?")) htmx.ajax("DELETE", "/api/opportunities/' + entity.id|string + '", {target: "closest(.opportunity-card)", swap: "outerHTML"})',
                        'title': 'Delete opportunity'
                    }
                ]
            }
        } %}
    {% elif entity_type in ['contact', 'stakeholder'] %}
        {% set final_content = {
            'header': {
                'type': 'fields',
                'layout': 'stacked',
                'entity': entity,
                'fields': [
                    {'name': 'job_title', 'type': 'badge', 'style': 'blue'},
                    {'name': 'name', 'type': 'text', 'classes': 'text-lg font-medium text-gray-900'},
                    {'name': 'company', 'type': 'relationship', 'related_field': 'name', 'classes': 'text-gray-600'},
                    {'name': 'email', 'type': 'email', 'classes': 'text-blue-600 hover:text-blue-800'},
                    {'name': 'phone', 'type': 'phone', 'classes': 'text-sm text-gray-500'},
                    {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y', 'classes': 'text-sm text-gray-500'}
                ]
            },
            'actions': {
                'type': 'buttons',
                'actions': [
                    {
                        'type': 'edit',
                        'onclick': 'htmx.ajax("GET", "/modals/Stakeholder/' + entity.id|string + '/edit", {target: "body", swap: "beforeend"})',
                        'title': 'Edit stakeholder'
                    },
                    {
                        'type': 'delete',
                        'onclick': 'if(confirm("Are you sure you want to delete this stakeholder?")) htmx.ajax("DELETE", "/api/stakeholders/' + entity.id|string + '", {target: "closest(.stakeholder-card)", swap: "outerHTML"})',
                        'title': 'Delete stakeholder'
                    }
                ]
            }
        } %}
    {% else %}
        {# Generic fallback #}
        {% set final_content = {
            'header': {
                'type': 'fields',
                'layout': 'stacked',
                'entity': entity,
                'fields': [
                    {'name': 'name', 'type': 'text', 'classes': 'text-lg font-medium text-gray-900'},
                    {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y', 'classes': 'text-sm text-gray-500'}
                ]
            },
            'actions': {'type': 'buttons', 'actions': []}
        } %}
    {% endif %}
{% endif %}

{# Apply any overrides #}
{% for key, value in overrides.items() %}
    {% set _ = final_content.update({key: value}) %}
{% endfor %}

{{ card_container(entity_type, entity.id, expansion_enabled, card_classes, final_content) }}
{% endmacro %}


{# ========== LEGACY SYSTEM ========== #}

{#
  Auto Card - The new recommended way to create entity cards
  
  Automatically configures and renders cards based on entity type and conventions.
  Eliminates the need for manual parameter passing while maintaining full flexibility.
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact' | 'stakeholder' | 'company'
  - entity (required): Entity object
  - expansion_enabled (optional): Enable expand/collapse (default: true)
  - overrides (optional): Override default configuration
  - card_classes (optional): Additional CSS classes
  
  Usage:
  {{ auto_card('task', task) }}
  {{ auto_card('opportunity', opportunity, overrides={'badge_style': 'green'}) }}
  {{ auto_card('contact', contact, expansion_enabled=false) }}
#}
{% macro auto_card(entity_type, entity, expansion_enabled=true, overrides={}, card_classes='') %}
{# Backward compatibility wrapper - delegates to new card system #}
{{ card(entity_type, entity, expansion_enabled, card_classes, none, overrides) }}
{% endmacro %}

{# DEPRECATED: Legacy expandable_card macro - Use the new card() macro instead #}
{% macro expandable_card(card_type, entity, entity_id, expansion_enabled=true, progress_config=none, bulk_selection_enabled=false, card_classes='', field_config={}, model_class=none, badge_content='', title_content='', value_content='', secondary_info='', metadata_content='', action_buttons='', expanded_content='', notes_enabled=false) %}
{# Setup card styling and auto-field extraction #}
{%- set base_classes = card_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50', 
    'contact': 'ring-2 ring-green-200 bg-green-50',
    'stakeholder': 'ring-2 ring-green-200 bg-green-50',
    'company': 'ring-2 ring-blue-200 bg-blue-50'
} -%}

{# Auto-extract fields when field_config is provided #}
{{ auto_extract_fields(entity, field_config, title_content, badge_content, value_content, secondary_info, metadata_content) }}

{% if expansion_enabled %}
<details class="{{ base_classes }} {{ color_classes.get(card_type, 'ring-2 ring-gray-200 bg-gray-50') }} {{ card_classes }}" 
         data-{{ card_type }}-id="{{ entity_id }}" 
         {% if notes_enabled %}hx-trigger="toggle" hx-get="/api/{{ card_type }}s/{{ entity_id }}/notes" hx-target="#notes-{{ entity_id }}"{% endif %}>
    <summary class="cursor-pointer list-none flex items-center justify-between">
        <div class="flex-1 flex items-center justify-between">
            <!-- Left side content -->
            <div class="flex items-center space-x-3">
                {% if bulk_selection_enabled %}
                {{ bulk_selection_checkbox(entity_id) }}
                {% endif %}
                
                {{ card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) }}
            </div>
            
            <!-- Right side actions -->
            {% if action_buttons %}
            <div class="flex items-center space-x-2">{{ action_buttons|safe }}</div>
            {% endif %}
            
            <!-- Entity-specific action buttons -->
            {% if card_type == 'task' %}
                {{ reschedule_buttons_htmx(card_type, entity_id) }}
            {% endif %}
            
            <!-- Expand chevron -->
            <div class="ml-4 transition-transform duration-200 details-chevron">
                {{ icon('chevron-down', 'md', 'text-gray-400') }}
            </div>
        </div>
    </summary>
    
    <!-- Expanded content -->
    <div class="mt-4 pt-4 border-t border-gray-200">
        {% if expanded_content %}
        {{ expanded_content|safe }}
        {% endif %}
        
        {% if notes_enabled %}
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-900">Comments & Notes</h4>
            <div id="notes-{{ entity_id }}">
                <!-- Notes loaded via htmx -->
            </div>
            {{ notes_form_htmx(card_type, entity_id) }}
        </div>
        {% endif %}
        
        {% if caller %}
        {{ caller() }}
        {% endif %}
    </div>
</details>
{% else %}
<!-- Non-expandable version -->
<div class="{{ base_classes }} {{ color_classes.get(card_type, 'ring-2 ring-gray-200 bg-gray-50') }} {{ card_classes }}" data-{{ card_type }}-id="{{ entity_id }}">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-1">
            {% if bulk_selection_enabled %}
            {{ bulk_selection_checkbox(entity_id) }}
            {% endif %}
            
            {{ card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) }}
        </div>
        
        {% if action_buttons %}
        <div class="flex items-center space-x-2">{{ action_buttons|safe }}</div>
        {% endif %}
        
        <!-- Entity-specific action buttons -->
        {% if card_type == 'task' %}
            {{ reschedule_buttons_htmx(card_type, entity_id) }}
        {% endif %}
    </div>
</div>
{% endif %}

<style>
/* CSS for details chevron rotation - supports all card types */
details[data-task-id] summary::-webkit-details-marker,
details[data-opportunity-id] summary::-webkit-details-marker,
details[data-contact-id] summary::-webkit-details-marker,
details[data-stakeholder-id] summary::-webkit-details-marker,
details[data-company-id] summary::-webkit-details-marker {
    display: none;
}

details[open] .details-chevron {
    transform: rotate(90deg);
}
</style>
{% endmacro %}

{# ========== HELPER MACROS ========== #}

{# Auto-extract fields from entity when field_config is provided #}
{% macro auto_extract_fields(entity, field_config, title_content, badge_content, value_content, secondary_info, metadata_content) %}
{%- if field_config -%}
  {# Auto-extract title content #}
  {%- if not title_content -%}
    {%- set title_content = entity.name|default('') -%}
  {%- endif -%}
  
  {# Badge content based on entity type #}
  {%- if not badge_content -%}
    {%- set badge_value = entity.stage|default('') or entity.status|default('') or entity.job_title|default('') or entity.industry|default('') or entity.priority|default('') -%}
    {%- if badge_value -%}
      {%- set badge_css_class = 'bg-blue-100 text-blue-800' -%}
      {%- set badge_content = '<span class="px-2 py-1 text-xs font-medium rounded-full ' + badge_css_class + '">' + (badge_value|string|title) + '</span>' -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Value content (currency formatting for deals) #}
  {%- if not value_content -%}
    {%- set raw_value = entity.value|default(none) -%}
    {%- if raw_value is number -%}
      {%- set value_content = entity.value_formatted or '$0' -%}
    {%- elif raw_value -%}
      {%- set value_content = raw_value|string -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Secondary info from relationships #}
  {%- if not secondary_info -%}
    {%- set secondary_parts = [] -%}
    {%- if entity.company and entity.company.name -%}
      {%- set _ = secondary_parts.append('<span class="text-gray-600">' + entity.company.name + '</span>') -%}
    {%- endif -%}
    {%- if entity.email -%}
      {%- set _ = secondary_parts.append('<a href="mailto:' + entity.email + '" class="text-blue-600 hover:text-blue-800">' + entity.email + '</a>') -%}
    {%- endif -%}
    {%- if secondary_parts -%}
      {%- set secondary_info = secondary_parts | join(' • ') -%}
    {%- endif -%}
  {%- endif -%}
  
  {# Metadata from date fields #}
  {%- if not metadata_content -%}
    {%- set metadata_parts = [] -%}
    {%- if entity.created_at -%}
      {%- set _ = metadata_parts.append(entity.created_at_formatted) -%}
    {%- endif -%}
    {%- if entity.due_date -%}
      {%- set _ = metadata_parts.append('Due: ' + entity.due_date_formatted) -%}
    {%- endif -%}
    {%- if entity.expected_close_date -%}
      {%- set _ = metadata_parts.append('Close: ' + entity.expected_close_date_formatted) -%}
    {%- endif -%}
    {%- if metadata_parts -%}
      {%- set metadata_content = metadata_parts | join(' • ') -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}
{% endmacro %}

{# Reusable card content section #}
{% macro card_content_section(badge_content, title_content, value_content, secondary_info, progress_config, metadata_content) %}
<div class="flex-1">
    <!-- Badge content -->
    {% if badge_content %}
    <div class="mb-1">{{ badge_content|safe }}</div>
    {% endif %}
    
    <!-- Title and Value -->
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ title_content|safe }}</h3>
        {% if value_content %}
        <span class="text-lg font-semibold text-gray-700">{{ value_content|safe }}</span>
        {% endif %}
    </div>
    
    <!-- Secondary info -->
    {% if secondary_info %}
    <div class="mt-1">{{ secondary_info|safe }}</div>
    {% endif %}
    
    <!-- Progress bar -->
    {% if progress_config and progress_config.enabled %}
    <div class="mt-2">
        {{ progress_bar(progress_config.value, progress_config.max_value or 100, progress_config.color_scheme or 'blue', progress_config.label) }}
    </div>
    {% endif %}
    
    <!-- Metadata -->
    {% if metadata_content %}
    <div class="mt-2 text-sm text-gray-500">{{ metadata_content|safe }}</div>
    {% endif %}
</div>
{% endmacro %}

{# htmx-powered notes form #}
{% macro notes_form_htmx(card_type, entity_id) %}
<form hx-post="/api/{{ card_type }}s/{{ entity_id }}/notes" 
      hx-target="#notes-{{ entity_id }}" 
      hx-swap="afterbegin"
      hx-on::after-request="this.reset()">
    <div class="flex space-x-2">
        <input type="text" 
               name="content" 
               placeholder="Add a comment..." 
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               required>
        <input type="hidden" name="is_internal" value="true">
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Add
        </button>
    </div>
</form>
{% endmacro %}

{# htmx-powered task reschedule buttons #}
{% macro reschedule_buttons_htmx(entity_type, entity_id) %}
<div class="relative flex-shrink-0">
    <div class="flex items-center space-x-1">
        <button hx-post="/{{ entity_type }}s/{{ entity_id }}/reschedule" 
                hx-vals='{"days": -7}'
                hx-target="#{{ entity_type }}-metadata-{{ entity_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button hx-post="/{{ entity_type }}s/{{ entity_id }}/reschedule" 
                hx-vals='{"days": -1}'
                hx-target="#{{ entity_type }}-metadata-{{ entity_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button hx-post="/{{ entity_type }}s/{{ entity_id }}/reschedule" 
                hx-vals='{"days": 1}'
                hx-target="#{{ entity_type }}-metadata-{{ entity_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button hx-post="/{{ entity_type }}s/{{ entity_id }}/reschedule" 
                hx-vals='{"days": 7}'
                hx-target="#{{ entity_type }}-metadata-{{ entity_id }}"
                hx-swap="innerHTML"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
</div>
{% endmacro %}

{#
  Universal Field Renderer - Simplified approach for now
  
  We'll use the simplest working approach first, then optimize later.
  The goal was to eliminate if/elif chains in templates, but sometimes
  a small chain in infrastructure code is acceptable to keep the API clean.
#}
{% macro render_field_legacy(entity, field_config) %}
{%- if field_config.type == 'text' -%}
    {{ field_config.get('prefix', '') }}{{ entity[field_config.field] }}
{%- elif field_config.type == 'count' -%}
    {% set count = entity[field_config.field]|length %}
    {{ count }} {{ field_config.label }}{{ '' if count == 1 else 's' }}
{%- elif field_config.type == 'link' -%}
    {%- if entity[field_config.field] -%}
    <a href="{{ entity[field_config.field] }}" target="_blank" class="text-link hover:text-link-hover" onclick="event.stopPropagation()">{{ entity[field_config.field] }}</a>
    {%- else -%}
    <span class="text-gray-500">No link provided</span>
    {%- endif -%}
{%- elif field_config.type == 'badge' -%}
    <span class="badge-standard badge-{{ field_config.style }}">{{ entity[field_config.field] }}</span>
{%- elif field_config.type == 'date' -%}
    {{ entity[field_config.field + '_formatted'] or '' }}
{%- else -%}
    {{ entity[field_config.field] }}
{%- endif -%}
{% endmacro %}

{# ========== ENTITY-SPECIFIC CONTENT HELPERS ========== #}

{#
  Opportunity Header Content - Standardized opportunity header badge
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_header_content(opportunity) }}
#}
{% macro opportunity_header_content(opportunity) %}
{% from "macros/ui/list_section.html" import status_badge %}
{{ status_badge(opportunity.stage, 'green' if opportunity.stage == 'Prospect' else 'blue') }}
{% endmacro %}

{#
  Task Header Content - Standardized task header badge
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_header_content(task) }}
#}
{% macro task_header_content(task) %}
{% from "macros/ui/list_section.html" import status_badge %}
{% set priority_color = 'red' if task.priority == 'high' else
                      'yellow' if task.priority == 'medium' else
                      'green' %}
{{ status_badge(task.priority, priority_color) }}
{% endmacro %}

{# ========== ACTION BUTTON HELPERS ========== #}

{#
  Action Buttons Row - Standardized action buttons for cards
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'contact'
  - entity_id (required): Entity ID
  - actions (optional): List of action configs
  - disabled_condition (optional): Alpine.js condition for disabling
  
  Action Config:
  {
    'type': 'edit' | 'delete' | 'complete' | 'view' | 'custom',
    'icon': 'icon_html',
    'onclick': 'javascript_function',
    'title': 'tooltip_text',
    'classes': 'additional_css_classes'
  }
  
  Usage:
  {{ action_buttons_row('task', task.id) }}
  
  Or with custom actions:
  {{ action_buttons_row('task', task.id, actions=[
       {'type': 'edit', 'hx_get': '/modals/Task/' + task.id|string + '/edit', 'hx_target': 'body', 'hx_swap': 'beforeend'},
       {'type': 'delete', 'hx_delete': '/api/tasks/' + task.id|string, 'hx_confirm': 'Are you sure?', 'hx_target': 'closest(.task-card)', 'hx_swap': 'outerHTML'} 
     ]) }}
#}
{% macro action_buttons_row(entity_type, entity_id, actions=none, disabled_condition='') %}
{% from "macros/base/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_actions = {
    'task': [
        {'type': 'complete', 'icon': check_icon("w-4 h-4"), 'hx_post': '/api/tasks/' + entity_id|string + '/complete', 'hx_target': 'closest(.task-card)', 'hx_swap': 'outerHTML', 'title': 'Complete task', 'classes': 'text-green-600 hover:text-green-800 hover:bg-green-50'},
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'hx_get': '/modals/Task/' + entity_id|string + '/edit', 'hx_target': 'body', 'hx_swap': 'beforeend', 'title': 'Edit task', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'hx_delete': '/api/tasks/' + entity_id|string, 'hx_confirm': 'Are you sure you want to delete this task?', 'hx_target': 'closest(.task-card)', 'hx_swap': 'outerHTML', 'title': 'Delete task', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ],
    'opportunity': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'hx_get': '/modals/Opportunity/' + entity_id|string + '/edit', 'hx_target': 'body', 'hx_swap': 'beforeend', 'title': 'Edit opportunity', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'hx_delete': '/api/opportunities/' + entity_id|string, 'hx_confirm': 'Are you sure you want to delete this opportunity?', 'hx_target': 'closest(.opportunity-card)', 'hx_swap': 'outerHTML', 'title': 'Delete opportunity', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ],
    'contact': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'hx_get': '/modals/Stakeholder/' + entity_id|string + '/edit', 'hx_target': 'body', 'hx_swap': 'beforeend', 'title': 'Edit contact', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'hx_delete': '/api/stakeholders/' + entity_id|string, 'hx_confirm': 'Are you sure you want to delete this contact?', 'hx_target': 'closest(.contact-card)', 'hx_swap': 'outerHTML', 'title': 'Delete contact', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ],
    'stakeholder': [
        {'type': 'edit', 'icon': pencil_icon("w-4 h-4"), 'hx_get': '/modals/Stakeholder/' + entity_id|string + '/edit', 'hx_target': 'body', 'hx_swap': 'beforeend', 'title': 'Edit stakeholder', 'classes': 'text-blue-600 hover:text-blue-800 hover:bg-blue-50'},
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'hx_delete': '/api/stakeholders/' + entity_id|string, 'hx_confirm': 'Are you sure you want to delete this stakeholder?', 'hx_target': 'closest(.stakeholder-card)', 'hx_swap': 'outerHTML', 'title': 'Delete stakeholder', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ],
    'note': [
        {'type': 'delete', 'icon': trash_icon("w-4 h-4"), 'hx_delete': '/api/notes/' + entity_id|string, 'hx_confirm': 'Delete this note?', 'hx_target': '#note-' + entity_id|string, 'hx_swap': 'outerHTML', 'title': 'Delete note', 'classes': 'text-red-600 hover:text-red-800 hover:bg-red-50'}
    ]
} -%}

{%- set button_actions = actions or default_actions.get(entity_type, []) -%}

<div class="flex items-center space-x-1" {% if disabled_condition %}:class="{ 'opacity-50 pointer-events-none': {{ disabled_condition }} }"{% endif %}>
    {% for action in button_actions %}
    <button {% if action.get('hx_get') %}hx-get="{{ action.hx_get }}"{% endif %}
            {% if action.get('hx_post') %}hx-post="{{ action.hx_post }}"{% endif %}
            {% if action.get('hx_delete') %}hx-delete="{{ action.hx_delete }}"{% endif %}
            {% if action.get('hx_target') %}hx-target="{{ action.hx_target }}"{% endif %}
            {% if action.get('hx_swap') %}hx-swap="{{ action.hx_swap }}"{% endif %}
            {% if action.get('hx_confirm') %}hx-confirm="{{ action.hx_confirm }}"{% endif %}
            onclick="event.stopPropagation()"
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.classes }}" 
            title="{{ action.title }}">
        {{ action.icon|safe }}
    </button>
    {% endfor %}
</div>
{% endmacro %}

{# ========== CONTENT GENERATION HELPERS ========== #}

{#
  Task Title Content - Task description with badges
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_title_content(task) }}
#}
{% macro task_title_content(task) %}
{{ task.description | style_task_description }}
{% if task.next_step_type %}
    <span class="text-badge-tag">{{ task.next_step_type }}</span>
{% endif %}
{% if task.is_overdue %}
    <span class="text-badge-overdue">OVERDUE</span>
{% endif %}
{% endmacro %}

{#
  Task Metadata Content - Standardized task metadata layout
  
  Parameters:
  - task (required): Task entity object
  
  Usage:
  {{ task_metadata_content(task) }}
#}
{% macro task_metadata_content(task) %}
<span class="text-gray-500" id="task-metadata-{{ task.id }}">
    {% if task.next_step_type %}
    {{ task.next_step_type }}
    {% endif %}
    {% if task.due_date %}
    • Due: <span>{{ task.due_date_formatted }}</span>
    {% endif %}
    {% if task.is_overdue %}
    • <span class="text-badge-overdue">OVERDUE</span>
    {% endif %}
</span>
{% endmacro %}

{#
  Opportunity Metadata Content - Standardized opportunity metadata layout
  
  Parameters:
  - opportunity (required): Opportunity entity object
  
  Usage:
  {{ opportunity_metadata_content(opportunity) }}
#}
{% macro opportunity_metadata_content(opportunity) %}
<span class="text-gray-500">
    <span class="text-gray-500">
        Close: {{ opportunity.close_date_formatted or 'TBD' }}
        {% if opportunity.days_until_close %}
            • {{ opportunity.days_until_close }} days to go
        {% endif %}
    </span>
</span>
 • 
<div class="text-metadata">
    {% if opportunity.company %}
        <span class="text-entity-base text-color-company">{{ opportunity.company.name }}</span> • 
    {% endif %}
    <span class="text-entity-base text-color-opportunity">{{ opportunity.name }}</span> • 
    {{ opportunity.stage }} • 
    <span class="text-entity-base text-color-deal">{{ opportunity.value_formatted or '$0' }}</span> • 
    {% if opportunity.contact %}
        <span class="text-entity-base text-color-stakeholder">{{ opportunity.contact.name }}</span> • 
    {% endif %}
    {{ opportunity.created_at.strftime('%d') if opportunity.created_at else '0' }} days old
</div>
{% endmacro %}

{#
  Task Reschedule Buttons - Reschedule functionality for tasks
  
  Parameters:
  - entity_id (required): Task ID for the reschedule actions
  
  Usage:
  {{ task_reschedule_buttons(task.id) }}
#}
{% macro task_reschedule_buttons(entity_id) %}
<div class="relative flex-shrink-0">
    <div class="flex items-center space-x-1">
        <button hx-post="/api/{{ entity_type }}s/{{ entity_id }}/reschedule"
                hx-vals='{"days": -7}'
                hx-target="closest(.task-card)"
                hx-swap="outerHTML"
                onclick="event.stopPropagation()"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 week">
            -1w
        </button>
        <button hx-post="/api/{{ entity_type }}s/{{ entity_id }}/reschedule"
                hx-vals='{"days": -1}'
                hx-target="closest(.task-card)"
                hx-swap="outerHTML"
                onclick="event.stopPropagation()"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule -1 day">
            -1d
        </button>
        <button hx-post="/api/{{ entity_type }}s/{{ entity_id }}/reschedule"
                hx-vals='{"days": 1}'
                hx-target="closest(.task-card)"
                hx-swap="outerHTML"
                onclick="event.stopPropagation()"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 day">
            +1d
        </button>
        <button hx-post="/api/{{ entity_type }}s/{{ entity_id }}/reschedule"
                hx-vals='{"days": 7}'
                hx-target="closest(.task-card)"
                hx-swap="outerHTML"
                onclick="event.stopPropagation()"
                class="px-1.5 py-0.5 rounded text-info-hover text-xs hover:bg-blue-50 transition-colors duration-200" 
                title="Reschedule +1 week">
            +1w
        </button>
    </div>
</div>

{% endmacro %}

{# ========== ENTITY-SPECIFIC HELPERS ========== #}

{# Company Helper Functions - for DRY entity system #}
{# Generic badge content for any field #}
{% macro entity_badge_content(entity, field, color='blue') %}
{% if entity[field] %}
    <span class="badge-standard badge-{{ color }}">{{ entity[field] }}</span>
{% endif %}
{% endmacro %}

{% macro company_header_content(company) %}
{{ entity_badge_content(company, 'industry') }}
{% endmacro %}

{# Generic title content for entities with 'name' field #}
{% macro entity_title_content(entity) %}
{{ entity.name }}
{% endmacro %}

{# Legacy aliases for backwards compatibility #}
{% macro company_title_content(company) %}{{ entity_title_content(company) }}{% endmacro %}
{% macro stakeholder_title_content(stakeholder) %}{{ entity_title_content(stakeholder) }}{% endmacro %}
{% macro opportunity_title_content(opportunity) %}{{ entity_title_content(opportunity) }}{% endmacro %}

{% macro company_metadata_content(company) %}
<div class="text-sm text-gray-500 flex items-center space-x-4">
    {% if company.contacts %}
        <span>{{ company.contacts|length }} contact{{ 's' if company.contacts|length != 1 else '' }}</span>
    {% endif %}
    {% if company.opportunities %}  
        <span>{{ company.opportunities|length }} opportunit{{ 'ies' if company.opportunities|length != 1 else 'y' }}</span>
    {% endif %}
    <span>{{ company.created_at_formatted or 'N/A' }}</span>
</div>
{% endmacro %}

{# Team Helper Functions #}
{% macro team_header_content(member) %}
{{ entity_badge_content(member, 'job_title') }}
{% endmacro %}

{% macro team_title_content(member) %}{{ entity_title_content(member) }}{% endmacro %}

{% macro team_metadata_content(member) %}
<div class="text-sm text-gray-500 flex items-center space-x-4">
    {% if member.email %}
        <span>{{ member.email }}</span>
    {% endif %}
    {% if member.company %}
        <span>{{ member.company.name }}</span>
    {% endif %}
    <span>{{ member.created_at_formatted or 'N/A' }}</span>
</div>
{% endmacro %}

{# ========== ADVANCED AUTOMATION ========== #}

{#
  Automatic Expandable Card - Fully DRY using Model Metadata
  
  Parameters:
  - entity_type (required): 'task' | 'opportunity' | 'stakeholder' | 'company'  
  - entity (required): Entity object
  - entity_id (required): Unique ID of the entity
  - expansion_enabled (optional): Enable expansion functionality (default: true)
  - bulk_selection_enabled (optional): Show bulk selection checkbox (default: true)
  
  This macro automatically:
  - Gets model configuration via ModelIntrospector
  - Extracts badge, title, secondary, metadata fields from model metadata
  - Uses appropriate CSS classes and icons from model.info
  - Generates correct action buttons for entity type
  
  Usage:
  {{ expandable_card_auto('stakeholder', stakeholder, stakeholder.id) }}
#}
{% macro expandable_card_auto(entity_type, entity, entity_id, expansion_enabled=true, bulk_selection_enabled=false) %}
{% set model_config = get_model_config(entity.__class__) %}

{# Auto-generate field configuration from model metadata #}
{% set auto_config = {
    'badge_field': none,
    'badge_style': 'blue',
    'title_field': 'name',
    'secondary_fields': [],
    'metadata_fields': []
} %}

{# Extract badge field from model metadata - look for groupable fields with choices #}
{% for field_name, field_info in model_config.fields.items() %}
    {% if field_info.choices and field_info.groupable and not auto_config.badge_field %}
        {% set _ = auto_config.update({'badge_field': field_name}) %}
    {% endif %}
{% endfor %}

{# Build secondary fields dynamically from model relationships #}
{% for field_name, field_info in model_config.fields.items() %}
    {% if field_info.type == 'relationship' and field_info.related_model %}
        {% set _ = auto_config.secondary_fields.append({'field': field_name + '.name', 'type': 'text'}) %}
    {% elif 'email' in field_name.lower() %}
        {% set _ = auto_config.secondary_fields.append({'field': field_name, 'type': 'text'}) %}
    {% endif %}
{% endfor %}

{# Build metadata fields dynamically from model introspection #}
{% for field_name, field_info in model_config.fields.items() %}
    {% if field_info.type == 'date' or field_name.endswith('_at') or 'date' in field_name.lower() %}
        {% set _ = auto_config.metadata_fields.append({'field': field_name, 'type': 'date'}) %}
    {% elif field_name == 'phone' or 'phone' in field_name.lower() %}
        {% set _ = auto_config.metadata_fields.append({'field': field_name, 'type': 'text'}) %}
    {% endif %}
{% endfor %}

{{ expandable_card(entity_type, entity, entity_id,
    expansion_enabled=expansion_enabled,
    bulk_selection_enabled=bulk_selection_enabled,
    field_config=auto_config,
    action_buttons=action_buttons_row(entity_type, entity_id)) }}
{% endmacro %}
{% from 'macros/base/icons.html' import icon %}
{# UI Controls - Interactive UI elements like search, selection, and navigation #}

{#
  Pluralized Count - Smart count display with automatic pluralization
  
  Parameters:
  - count (required): Number to display
  - singular (required): Singular form of the noun (e.g., 'opportunity')
  - plural (optional): Plural form if different from singular + 's' (e.g., 'opportunities')
  - short (optional): Use abbreviated form (e.g., 'opp' instead of 'opportunity')
  - show_zero (optional): Show count even when zero (default: true)
  
  Usage (dynamic - uses context data):
  {% set count = contact.opportunities|length %}
  {{ count }} {{ entity_name_singular if count == 1 else entity_name }}
  
  For relationships, use relationship_labels from context:
  {% set count = company.contacts|length %}
  {{ count }} {{ relationship_labels.contacts.singular if count == 1 else relationship_labels.contacts.plural }}
#}
{# 
  Pluralized Count functionality removed - use dynamic template logic instead
  Example: {{ count }} {{ entity_name_singular if count == 1 else entity_name }}
#}

{#
  Expand/Collapse Controls - Controls for expanding/collapsing sections
  
  Parameters:
  - target_sections (required): Sections to control
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ expand_collapse_controls(['tasks', 'opportunities']) }}
#}
{% macro expand_collapse_controls(target_sections, additional_classes='') %}
<div class="flex space-x-2 {{ additional_classes }}">
    <button data-action="expand-all"
            class="text-sm text-blue-600 hover:text-blue-800">
        Expand All
    </button>
    <span class="text-gray-300">|</span>
    <button data-action="collapse-all"
            class="text-sm text-blue-600 hover:text-blue-800">
        Collapse All
    </button>
</div>
{% endmacro %}

{#
  View Mode Toggle - Toggle between grid and list view
  
  Parameters:
  - current_mode (optional): Current view mode ('grid' or 'list')
  - grid_icon (optional): Custom grid icon HTML
  - list_icon (optional): Custom list icon HTML
  
  Usage:
  {{ view_mode_toggle('grid') }}
#}
{% macro view_mode_toggle(current_mode='grid', grid_icon=None, list_icon=None) %}
<div class="flex rounded-md shadow-sm">
    <button @click="viewMode = 'grid'"
            :class="viewMode === 'grid' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
            class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 text-sm font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
        {% if grid_icon %}
            {{ grid_icon|safe }}
        {% else %}
            {{ icon('squares-2x2', 'sm') }}
        {% endif %}
        <span class="ml-1">Grid</span>
    </button>
    <button @click="viewMode = 'list'"
            :class="viewMode === 'list' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
            class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 border-l-0 text-sm font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
        {% if list_icon %}
            {{ list_icon|safe }}
        {% else %}
            {{ icon('list-bullet', 'sm') }}
        {% endif %}
        <span class="ml-1">List</span>
    </button>
</div>
{% endmacro %}

{#
  Bulk Selection Checkbox - Checkbox for bulk selection
  
  Parameters:
  - item_id (required): Unique identifier for the item
  - model (optional): Alpine.js model name (default: 'selectedItems')
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ bulk_selection_checkbox(company.id) }}
  {{ bulk_selection_checkbox(contact.id, 'selectedStakeholders') }}
#}
{% macro bulk_selection_checkbox(item_id, model='selected_items', additional_classes='') %}
<input type="checkbox" 
       name="{{ model }}" 
       value="{{ item_id }}"
       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded {{ additional_classes }}"
       data-stop-propagation>
{% endmacro %}

{#
  Select All Checkbox - Master checkbox for bulk selection
  
  Parameters:
  - total_items (required): Total number of items that can be selected
  - model (optional): Alpine.js model name (default: 'selectedItems')
  - label (optional): Label text for the checkbox
  
  Usage:
  {{ select_all_checkbox(companies|length) }}
  {{ select_all_checkbox(contacts|length, 'selectedStakeholders', 'Select all contacts') }}
#}
{% macro select_all_checkbox(total_items, model='selectedItems', label='Select all') %}
<label class="flex items-center space-x-2">
    <input type="checkbox"
           :checked="{{ model }}.length === {{ total_items }} && {{ total_items }} > 0"
           :indeterminate="{{ model }}.length > 0 && {{ model }}.length < {{ total_items }}"
           @change="{{ model }} = $event.target.checked ? allItemIds : []"
           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
    <span class="text-sm text-gray-700">{{ label }}</span>
</label>
{% endmacro %}

{#
  Search Input - Consistent search input with icon
  
  Parameters:
  - placeholder (optional): Placeholder text
  - model (optional): Alpine.js model binding
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ search_input('Search companies...', 'searchTerm') }}
#}
{% macro search_input(placeholder='Search...', model='searchTerm', additional_classes='') %}
<div class="relative">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        {{ icon('magnifying-glass', 'md', 'text-gray-400') }}
    </div>
    <input type="text" 
           x-model="{{ model }}"
           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm {{ additional_classes }}"
           placeholder="{{ placeholder }}">
    <div x-show="{{ model }}.length > 0" class="absolute inset-y-0 right-0 pr-3 flex items-center">
        <button @click="{{ model }} = ''" class="text-gray-400 hover:text-gray-600">
            {{ icon('x-mark', 'sm') }}
        </button>
    </div>
</div>
{% endmacro %}

{#
  Loading Spinner - Consistent loading indicator
  
  Parameters:
  - size (optional): Size class ('sm', 'md', 'lg')
  - text (optional): Loading text to display
  
  Usage:
  {{ loading_spinner('md', 'Loading companies...') }}
#}
{% macro loading_spinner(size='md', text='') %}
{%- set size_classes = {'sm': 'h-4 w-4', 'md': 'h-6 w-6', 'lg': 'h-8 w-8'} -%}
<div class="flex items-center justify-center space-x-2">
    {{ icon('spinner', size or 'md', 'animate-spin text-blue-600') }}
    {% if text %}
    <span class="text-sm text-gray-600">{{ text }}</span>
    {% endif %}
</div>
{% endmacro %}

{#
  Empty State - Consistent empty state display
  
  Parameters:
  - title (required): Empty state title
  - description (optional): Empty state description
  - action_button (optional): Action button HTML
  - icon (optional): Icon HTML
  
  Usage:
  {{ empty_state('No companies found', 'Try adjusting your search criteria') }}
#}
{% macro empty_state(title, description='', action_button='', icon='') %}
<div class="text-center py-12">
    {% if icon %}
    <div class="mx-auto mb-4">
        {{ icon|safe }}
    </div>
    {% endif %}
    <h3 class="mt-2 text-sm font-medium text-gray-900">{{ title }}</h3>
    {% if description %}
    <p class="mt-1 text-sm text-gray-500">{{ description }}</p>
    {% endif %}
    {% if action_button %}
    <div class="mt-6">
        {{ action_button|safe }}
    </div>
    {% endif %}
</div>
{% endmacro %}

{#
  HTMX Dropdown Select - Pure HTMX dropdown with Tailwind styling
  
  Styled exactly like the provided example with Tailwind CSS.
  Uses pure CSS for dropdown behavior - no JavaScript needed.
  
  Parameters:
  - button_text (required): Text to display in the button (e.g., 'Sort by: Company')
  - options (required): List of options as [{'value': 'val', 'label': 'Label'}] or simple strings
  - name (optional): Form field name for HTMX submission
  - current_value (optional): Currently selected value
  - hx_target (optional): HTMX target for form submission
  - hx_post (optional): HTMX post URL
  - additional_classes (optional): Extra CSS classes for the container
  
  Usage:
  {{ htmx_dropdown_select('Sort by: Company', [{'value': 'company', 'label': 'Company'}, {'value': 'email', 'label': 'Email'}], hx_target='#content') }}
#}
{% macro htmx_dropdown_select(button_text, options, name=None, current_value=None, hx_target=None, hx_post=None, additional_classes='') %}
<div class="relative {{ additional_classes }}">
    <div class="group">
        <button type="button" 
                class="bg-white border border-gray-300 rounded-md px-4 py-2 text-left w-48 flex items-center justify-between hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 peer"
                tabindex="0">
            <span>{{ button_text }}</span>
            {{ icon('chevron-down', 'sm', 'ml-2 transition-[transform,translate,scale,rotate] group-focus-within:rotate-180') }}
        </button>
        
        <div class="absolute mt-1 w-48 bg-white border border-gray-300 rounded-md shadow-lg z-50 opacity-0 scale-95 pointer-events-none transition-all duration-200 peer-focus:opacity-100 peer-focus:scale-100 peer-focus:pointer-events-auto group-focus-within:opacity-100 group-focus-within:scale-100 group-focus-within:pointer-events-auto">
            {% for option in options %}
                {%- if option is mapping -%}
                    {%- set option_value = option.value -%}
                    {%- set option_label = option.label -%}
                {%- else -%}
                    {%- set option_value = option -%}
                    {%- set option_label = option|title -%}
                {%- endif -%}
                
                {% if name and hx_target %}
                    <button type="submit" 
                            name="{{ name }}" 
                            value="{{ option_value }}"
                            {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                            {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                            class="dropdown-option {% if option_value == current_value %}bg-blue-50 text-blue-700{% endif %}">
                        {{ option_label }}
                    </button>
                {% else %}
                    <a href="#" 
                       class="block px-4 py-2 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none {% if option_value == current_value %}bg-blue-50 text-blue-700{% endif %}">
                        {{ option_label }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{#
  HTMX Sort Dropdown - Pure HTMX dropdown for sorting with direction indicators
  
  Parameters:
  - current_sort (optional): Currently selected sort value
  - current_direction (optional): Current sort direction ('asc' or 'desc')
  - sort_options (required): List of sort options
  - hx_target (optional): HTMX target for form submission
  - hx_post (optional): HTMX post URL
  
  Usage:
  {{ htmx_sort_dropdown('name', 'asc', [{'value': 'name', 'label': 'Company'}], hx_target='#content') }}
#}
{% macro htmx_sort_dropdown(current_sort='', current_direction='asc', sort_options=[], hx_target=None, hx_post=None, additional_classes='') %}
{%- set button_text = 'Sort by: ' + (sort_options | selectattr('value', 'equalto', current_sort) | map(attribute='label') | first or 'Select') -%}
{%- set direction_indicator = ' ↑' if current_direction == 'asc' else ' ↓' -%}

<div class="relative {{ additional_classes }}">
    <div class="group">
        <button type="button" 
                class="bg-white border border-gray-300 rounded-md px-4 py-2 text-left w-48 flex items-center justify-between hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 peer"
                tabindex="0">
            <span>{{ button_text }}{{ direction_indicator if current_sort }}</span>
            {{ icon('chevron-down', 'sm', 'ml-2 transition-[transform,translate,scale,rotate] group-focus-within:rotate-180') }}
        </button>
        
        <div class="absolute mt-1 w-48 bg-white border border-gray-300 rounded-md shadow-lg z-50 opacity-0 scale-95 pointer-events-none transition-all duration-200 peer-focus:opacity-100 peer-focus:scale-100 peer-focus:pointer-events-auto group-focus-within:opacity-100 group-focus-within:scale-100 group-focus-within:pointer-events-auto">
            {% for option in sort_options %}
                <button type="submit" 
                        name="sort_by" 
                        value="{{ option.value }}"
                        {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                        {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                        class="dropdown-option {% if option.value == current_sort %}bg-blue-50 text-blue-700{% endif %}">
                    <span class="flex items-center justify-between">
                        <span>{{ option.label }}</span>
                        {% if option.value == current_sort %}
                            <span class="text-gray-500">{{ '↑' if current_direction == 'asc' else '↓' }}</span>
                        {% endif %}
                    </span>
                    <input type="hidden" name="sort_direction" value="{{ 'desc' if option.value == current_sort and current_direction == 'asc' else 'asc' }}">
                </button>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{# Dropdown implementations moved to macros/dropdowns.html for standardization #}
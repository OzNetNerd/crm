{# Universal Alpine.js Dropdown System - DRY Implementation with Proper UX #}
{% from 'macros/base/icons.html' import icon %}

{#
  Universal Alpine.js Dropdown - Handles both single and multi-select dropdowns
  
  Auto-detects mode based on parameters:
  - current_value provided → Single select mode
  - current_values provided → Multi select mode
  
  Features:
  - Auto-close on click outside
  - Keyboard navigation (ESC to close, arrow keys)
  - Smooth animations
  - Proper accessibility
  - HTMX integration
  
  Parameters:
  - button_text (required): Text to display in the dropdown button
  - options (required): List of {'value': 'val', 'label': 'Label'} dicts
  - name (required): Form field name for HTMX submission
  - current_value (optional): Currently selected value for single select
  - current_values (optional): List of currently selected values for multi select
  - hx_target (optional): HTMX target for form submission
  - hx_get (optional): HTMX GET endpoint
  - hx_post (optional): HTMX POST endpoint
  - placeholder (optional): Placeholder text when nothing selected
  - additional_classes (optional): Extra CSS classes for container
  
  Usage:
  Single select:
  {{ css_dropdown('Sort by', sort_options, name='sort_by', current_value=sort_by, hx_target='#content', hx_get='/companies/content') }}
  
  Multi select:
  {{ css_dropdown('All Industries', industry_options, name='primary_filter', current_values=primary_filter, hx_target='#content', hx_get='/companies/content') }}
#}
{% macro css_dropdown(
    button_text, 
    options, 
    name, 
    current_value=None,
    current_values=None,
    hx_target=None,
    hx_get=None,
    hx_post=None,
    placeholder='Select option',
    additional_classes=''
) %}

{# Auto-detect single vs multi mode #}
{% set is_multi = current_values is not none %}
{% set is_single = current_value is not none %}

{# Generate unique ID for this dropdown #}
{% set dropdown_id = 'dropdown-' + name + '-' + range(1000, 9999)|random|string %}

<div class="relative {{ additional_classes }}" 
     x-data="{
         open: false,
         selectedValues: {{ current_values | tojson if is_multi else '[]' }},
         selectedValue: '{{ current_value if is_single else '' }}',
         close() { this.open = false; },
         toggle() { this.open = !this.open; },
         selectSingle(value) {
             this.selectedValue = value;
             this.close();
             this.$nextTick(() => {
                 this.$refs.hiddenInput.dispatchEvent(new Event('change'));
                 // Dispatch custom event for modal validation
                 this.$refs.hiddenInput.dispatchEvent(new CustomEvent('dropdown:change', {
                     bubbles: true,
                     detail: { value: value }
                 }));
             });
         },
         toggleMulti(value) {
             if (this.selectedValues.includes(value)) {
                 this.selectedValues = this.selectedValues.filter(v => v !== value);
             } else {
                 this.selectedValues.push(value);
             }
             this.$nextTick(() => {
                 this.$refs.hiddenInput.dispatchEvent(new Event('change'));
                 // Dispatch custom event for modal validation
                 this.$refs.hiddenInput.dispatchEvent(new CustomEvent('dropdown:change', {
                     bubbles: true,
                     detail: { values: this.selectedValues }
                 }));
             });
         },
         getDisplayText() {
             {% if is_single %}
                 let found = null;
                 {% for option in options %}
                     {% set opt_val = option.value if option is mapping else option %}
                     {% set opt_label = option.label if option is mapping else option|string|title %}
                     if (this.selectedValue === '{{ opt_val }}') found = '{{ opt_label }}';
                 {% endfor %}
                 return found || '{{ options[0].label if options[0] is mapping else options[0]|string|title }}';
             {% elif is_multi %}
                 if (this.selectedValues.length === 0) return '{{ button_text }}';
                 if (this.selectedValues.length === 1) {
                     {% for option in options %}
                         {% set opt_val = option.value if option is mapping else option %}
                         {% set opt_label = option.label if option is mapping else option|string|title %}
                         if (this.selectedValues.includes('{{ opt_val }}')) return '{{ opt_label }}';
                     {% endfor %}
                 }
                 return this.selectedValues.length + ' selected';
             {% else %}
                 return '{{ options[0].label if options[0] is mapping else options[0]|string|title }}';
             {% endif %}
         }
     }"
     @click.away="close()"
     @keydown.escape="close()">
    
    <button type="button" @click="toggle()"
            class="dropdown-button">
        <span class="truncate dropdown-button-text" x-text="getDisplayText()"></span>
        <span :class="open ? 'rotate-180' : ''" class="dropdown-chevron transition-transform">{{ icon('chevron-down', 'sm') }}</span>
    </button>
    
    <div x-show="open"
         class="dropdown-menu"
         x-cloak
        {% if is_single %}
            {# Single select options #}
            {% for option in options %}
                {%- set option_value = option.value if option is mapping else option -%}
                {%- set option_label = option.label if option is mapping else option|string|title -%}
                
                <button type="button" @click="selectSingle('{{ option_value }}')"
                        class="dropdown-option"
                        :class="selectedValue === '{{ option_value }}' ? 'bg-blue-50 text-blue-700' : ''">
                    {{ option_label }}
                </button>
            {% endfor %}
        {% elif is_multi %}
            {# Multi select options #}
            <div class="py-1 max-h-48 overflow-y-auto">
                {% for option in options %}
                    {%- set option_value = option.value if option is mapping else option -%}
                    {%- set option_label = option.label if option is mapping else option|string|title -%}
                    
                    <label class="dropdown-option dropdown-option-checkbox">
                        <input type="checkbox" @click="toggleMulti('{{ option_value }}')"
                               :checked="selectedValues.includes('{{ option_value }}')"
                               class="dropdown-checkbox">
                        {{ option_label }}
                    </label>
                {% endfor %}
            </div>
        {% else %}
            {# Fallback - no current_value or current_values provided #}
            {% for option in options %}
                {%- set option_value = option.value if option is mapping else option -%}
                {%- set option_label = option.label if option is mapping else option|string|title -%}
                
                <button type="button" @click="selectSingle('{{ option_value }}')"
                        class="dropdown-option">
                    {{ option_label }}
                </button>
            {% endfor %}
        {% endif %}
    </div>
    
    {# Hidden inputs for form submission #}
    {% if is_single %}
        <input type="hidden" name="{{ name }}" :value="selectedValue" x-ref="hiddenInput"
               {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
               {% if hx_get %}hx-get="{{ hx_get }}"{% endif %}
               {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
               hx-trigger="change">
    {% elif is_multi %}
        <template x-for="value in selectedValues" :key="value">
            <input type="hidden" name="{{ name }}" :value="value" x-ref="hiddenInput"
                   {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                   {% if hx_get %}hx-get="{{ hx_get }}"{% endif %}
                   {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                   hx-trigger="change">
        </template>
    {% endif %}
</div>
{% endmacro %}

{#
  Simple Form Select → Styled Dropdown Converter

  Converts standard HTML select elements to styled dropdowns that match existing design.
  Maximizes DRY by reusing existing dropdown CSS classes and Alpine.js patterns.

  Parameters:
  - name (required): Form field name
  - options (required): List of {'value': 'val', 'label': 'Label'} dicts OR simple string list
  - current_value (optional): Currently selected value
  - placeholder (optional): Placeholder text when nothing selected
  - required (optional): Whether field is required
  - additional_classes (optional): Extra CSS classes for container

  Usage Examples:
  1. Industry dropdown:
     {{ form_select_dropdown('industry', [
         {'value': '', 'label': 'Select industry'},
         {'value': 'technology', 'label': 'Technology'},
         {'value': 'healthcare', 'label': 'Healthcare'}
     ]) }}

  2. Simple string list:
     {{ form_select_dropdown('status', ['active', 'inactive'], current_value='active') }}
#}
{% macro form_select_dropdown(
    name,
    options,
    current_value='',
    placeholder='Select option',
    required=false,
    additional_classes=''
) %}

{# Generate unique ID for this dropdown #}
{% set dropdown_id = 'dropdown-' + name + '-' + range(1000, 9999)|random|string %}

<div class="relative {{ additional_classes }}"
     x-data="{
         open: false,
         selectedValue: '{{ current_value }}',
         close() { this.open = false; },
         toggle() { this.open = !this.open; },
         selectOption(value) {
             this.selectedValue = value;
             this.close();
             this.$nextTick(() => {
                 this.$refs.hiddenInput.dispatchEvent(new Event('change'));
                 // Dispatch custom event for modal validation
                 this.$refs.hiddenInput.dispatchEvent(new CustomEvent('dropdown:change', {
                     bubbles: true,
                     detail: { value: value }
                 }));
             });
         },
         getDisplayText() {
             {% for option in options %}
                 {%- if option is mapping -%}
                     {%- set opt_val = option.value -%}
                     {%- set opt_label = option.label -%}
                 {%- else -%}
                     {%- set opt_val = option -%}
                     {%- set opt_label = option|string|title -%}
                 {%- endif -%}
                 if (this.selectedValue === '{{ opt_val }}') return '{{ opt_label }}';
             {% endfor %}
             return '{{ placeholder }}';
         }
     }"
     @click.away="close()"
     @keydown.escape="close()">

    <button type="button" @click="toggle()"
            class="dropdown-button">
        <span class="truncate dropdown-button-text" x-text="getDisplayText()"></span>
        <span :class="open ? 'rotate-180' : ''" class="dropdown-chevron transition-transform">{{ icon('chevron-down', 'sm') }}</span>
    </button>

    <div x-show="open"
         class="dropdown-menu"
         x-cloak

        {% for option in options %}
            {%- if option is mapping -%}
                {%- set option_value = option.value -%}
                {%- set option_label = option.label -%}
            {%- else -%}
                {%- set option_value = option -%}
                {%- set option_label = option|string|title -%}
            {%- endif -%}

            <button type="button" @click="selectOption('{{ option_value }}')"
                    class="dropdown-option"
                    :class="selectedValue === '{{ option_value }}' ? 'bg-blue-50 text-blue-700' : ''">
                {{ option_label }}
            </button>
        {% endfor %}
    </div>

    {# Hidden input for form submission #}
    <input type="hidden"
           name="{{ name }}"
           :value="selectedValue"
           x-ref="hiddenInput"
           {% if required %}required{% endif %}>
</div>
{% endmacro %}
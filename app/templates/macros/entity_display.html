{% from 'macros/base/icons.html' import icon %}
{# Entity Display System - Unified display management for all entity pages #}

{#
  Entity Display Container - Manages grid/list views and dynamic grouping
  
  Extracted from tasks page sophistication, this provides consistent
  display management across all entity types with client-side grouping,
  filtering, and view mode switching.
  
  Parameters:
  - entity_type (required): 'companies', 'contacts', 'opportunities', 'tasks'
  - render_item_macro (required): Name of macro to render individual items
  - render_group_macro (optional): Name of macro for custom group rendering
  - group_config (required): Configuration for grouping display
  - support_hierarchy (optional): Support parent/child relationships
  
  Usage:
  {{ entity_display_container('companies', 'render_company_card', group_config=company_groups) }}
#}
{% macro entity_display_container(entity_type, render_item_macro, render_group_macro=None, group_config=None, support_hierarchy=false) %}
<div id="{{ entity_type }}-content" class="entity-display-container">
    
    <!-- Grid View -->
    <div x-show="viewMode === 'grid'" class="space-y-6">
        <!-- Dynamic Client-Side Grouping -->
        <template x-for="group in getGroupedItems()" :key="group.key">
            <div class="entity-group-section mb-6">
                <!-- Group Section -->
                <div :class="group.containerClass">
                    <!-- Group Header -->
                    <div :class="group.headerBgClass" 
                         class="cursor-pointer"
                         @click="toggleSection(group.key)">
                        <div class="flex items-center justify-between">
                            <h3 :class="group.headerClass">
                                <span class="mr-2 transition-transform duration-200" 
                                      :class="expandedSections[group.key] ? 'rotate-90' : ''">
                                    {{ icon('chevron-right', 'sm') }}
                                </span>
                                <span x-html="group.icon" class="w-5 h-5 mr-1"></span>
                                <span x-text="group.title"></span>
                                <span class="ml-2 badge-standard" 
                                      :class="group.badgeClass" 
                                      x-text="group.items.length"></span>
                            </h3>
                        </div>
                    </div>
                    
                    <!-- Group Content -->
                    <div class="entity-group-content" 
                         x-show="expandedSections[group.key]" 
                         x-cloak 
                         x-transition>
                        <template x-if="group.items.length > 0">
                            <!-- Grid Layout for Items -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                                <template x-for="item in group.items" :key="item.id">
                                    <div x-html="renderItemCard(item, group.key, '{{ render_item_macro }}')"></div>
                                </template>
                            </div>
                        </template>
                        <template x-if="group.items.length === 0">
                            <p class="text-empty-state p-6">No matching items found</p>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- List View -->
    <div x-show="viewMode === 'list'" class="space-y-6">
        <!-- Dynamic Client-Side Grouping for List View -->
        <template x-for="group in getGroupedItems()" :key="group.key">
            <div class="entity-group-section mb-6">
                <!-- Group Section -->
                <div :class="group.containerClass">
                    <!-- Group Header (same as grid) -->
                    <div :class="group.headerBgClass" 
                         class="cursor-pointer"
                         @click="toggleSection(group.key)">
                        <div class="flex items-center justify-between">
                            <h3 :class="group.headerClass">
                                <span class="mr-2 transition-transform duration-200" 
                                      :class="expandedSections[group.key] ? 'rotate-90' : ''">
                                    {{ icon('chevron-right', 'sm') }}
                                </span>
                                <span x-html="group.icon" class="w-5 h-5 mr-1"></span>
                                <span x-text="group.title"></span>
                                <span class="ml-2 badge-standard" 
                                      :class="group.badgeClass" 
                                      x-text="group.items.length"></span>
                            </h3>
                        </div>
                    </div>
                    
                    <!-- Group Content -->
                    <div class="entity-group-content divide-y divide-gray-200" 
                         x-show="expandedSections[group.key]" 
                         x-cloak 
                         x-transition>
                        <template x-if="group.items.length > 0">
                            <div class="space-y-0">
                                <template x-for="item in group.items" :key="item.id">
                                    <div x-html="renderItemCard(item, group.key, '{{ render_item_macro }}', 'list')" class="border-b border-gray-200 last:border-b-0"></div>
                                </template>
                            </div>
                        </template>
                        <template x-if="group.items.length === 0">
                            <p class="text-empty-state p-6">No matching items found</p>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Hidden pre-rendered item cards for client-side use -->
    <div style="display: none;" id="{{ entity_type }}-cards-cache">
        {{ caller() if caller }}
    </div>

</div>
{% endmacro %}

{#
  Entity Display Manager - Core Alpine.js component for display management
  
  Provides the sophisticated display logic from tasks page in a reusable form.
  Handles grouping, view modes, and item rendering.
  
  Parameters:
  - entity_type (required): Type of entity
  - group_configs (required): Available grouping configurations
  - icon_map (required): Mapping of icons for groups
  
  Usage in script block:
  {{ entity_display_manager('companies', group_configs, icon_map) }}
#}
{% macro entity_display_manager(entity_type, group_configs, icon_map) %}
// Core display management methods
getGroupedItems() {
    // Filter items first
    let filteredItems = this.allItems.filter(item => this.shouldShowItem(item));
    
    // Sort items
    let sortedItems = this.sortItems(filteredItems);
    
    // Group by current groupBy setting
    return this.groupItemsByType(sortedItems, this.groupBy);
},

// Group items by the specified type
groupItemsByType(items, groupType) {
    const config = this.getGroupConfig(groupType);
    if (!config) return [];

    return config.groups.map(group => ({
        ...group,
        items: items.filter(item => this.itemMatchesGroup(item, group, config))
    }));
},

// Get configuration for a specific group type
getGroupConfig(groupType) {
    const configs = {
        {% for config_key, config in group_configs.items() %}
        '{{ config_key }}': {
            groups: [
                {% for group in config.groups %}
                {
                    key: '{{ group.key }}',
                    title: '{{ group.title }}',
                    containerClass: '{{ group.container_class }}',
                    headerClass: '{{ group.header_class }}',
                    headerBgClass: '{{ group.header_bg_class }}',
                    badgeClass: '{{ group.badge_class }}',
                    icon: this.getIconHTML('{{ group.icon }}'),
                    {% if group.filter_func %}
                    filterFunc: {{ group.filter_func }},
                    {% endif %}
                    {% if group.filter_field and group.filter_value %}
                    filterField: '{{ group.filter_field }}',
                    filterValue: '{{ group.filter_value }}',
                    {% endif %}
                },
                {% endfor %}
            ]
        },
        {% endfor %}
    };
    return configs[groupType];
},

// Check if item matches group criteria
itemMatchesGroup(item, group, config) {
    // Handle custom filter functions
    if (group.filterFunc) {
        return group.filterFunc(item);
    }
    
    // Handle field-based filtering
    if (group.filterField && group.filterValue !== undefined) {
        const itemValue = this.getNestedProperty(item, group.filterField);
        
        // Special handling for null/undefined values
        if (group.filterValue === null || group.filterValue === 'null') {
            return !itemValue;
        }
        
        return itemValue === group.filterValue;
    }
    
    return false;
},

// Helper to get nested object properties (e.g., 'company.name')
getNestedProperty(obj, path) {
    return path.split('.').reduce((current, key) => current?.[key], obj);
},

// Get pre-rendered item card HTML
renderItemCard(item, groupContext, macroName, viewMode = 'grid') {
    const cachedElement = document.getElementById(`{{ entity_type }}-card-${item.id}`);
    if (cachedElement) {
        return cachedElement.innerHTML;
    }
    
    // No cached element found - this indicates a configuration error
    throw new Error(`No cached element found for ${type} ${item.id}. Ensure proper entity display initialization.`);
},

// Helper to get icon HTML
getIconHTML(iconType) {
    const icons = {
        {% for icon_name, icon_html in icon_map.items() %}
        '{{ icon_name }}': '{{ icon_html|safe }}',
        {% endfor %}
    };
    return icons[iconType] || icons['default'] || '';
},
{% endmacro %}

{#
  Entity Card Cache - Pre-renders cards for client-side use
  
  Generates hidden HTML cache of all item cards for fast client-side rendering.
  Works with the display manager to provide instant filtering/grouping.
  
  Parameters:
  - entity_type (required): Type of entity  
  - items (required): List of items to cache
  - render_macro (required): Macro name for rendering cards
  - support_hierarchy (optional): Include hierarchy rendering
  
  Usage:
  {{ entity_card_cache('companies', companies, 'render_company_card') }}
#}
{% macro entity_card_cache(entity_type, items, render_macro, support_hierarchy=false) %}
<div style="display: none;" id="{{ entity_type }}-cards-cache">
    {% for item in items %}
        <div id="{{ entity_type }}-card-{{ item.id }}">
            {{ caller(item) if caller else render_macro(item) }}
        </div>
    {% endfor %}
</div>
{% endmacro %}

{#
  Simple Entity Grid - Basic grid layout without grouping
  
  For simpler entity displays that don't need the full grouping system.
  
  Parameters:
  - items (required): Items to display
  - cols (optional): Number of columns (default: 3)
  - gap (optional): Gap size (default: 6)
  
  Usage:
  {% call simple_entity_grid(companies, cols=4) %}
    {{ render_company_card(item) }}  
  {% endcall %}
#}
{% macro simple_entity_grid(items, cols=3, gap=6) %}
<div class="grid grid-cols-1 md:grid-cols-{{ cols }} gap-{{ gap }}">
    {% for item in items %}
        {{ caller(item) if caller }}
    {% else %}
        <div class="col-span-full text-center py-12">
            <p class="text-secondary mb-4">No items found</p>
        </div>
    {% endfor %}
</div>
{% endmacro %}

{#
  Entity List View - Simple list layout without grouping
  
  For list-style displays of entities.
  
  Parameters:
  - items (required): Items to display
  - divider (optional): Show dividers between items
  
  Usage:
  {% call simple_entity_list(contacts, divider=true) %}
    {{ render_contact_list_item(item) }}
  {% endcall %}  
#}
{% macro simple_entity_list(items, divider=true) %}
<div class="{% if divider %}divide-y divide-gray-200{% else %}space-y-4{% endif %}">
    {% for item in items %}
        {{ caller(item) if caller }}
    {% else %}
        <div class="text-center py-12">
            <p class="text-secondary">No items found</p>
        </div>
    {% endfor %}
</div>
{% endmacro %}
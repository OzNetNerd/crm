{#
Smart Field Filtering and Rendering for Modals
Handles field filtering, view/form modes, and special field types (entity search)
#}

{% macro render_filtered_fields(form, mode='form', model_name=None) %}
  {% from 'macros/base/forms.html' import render_wtforms_field %}
  {% from 'macros/widgets/search.html' import search_widget %}

  {% if hasattr(form, 'get_display_fields') %}
    {% set allowed_fields = form.get_display_fields() %}
  {% else %}
    {% set allowed_fields = form|selectattr('name', 'ne', 'csrf_token')|selectattr('name', 'ne', 'submit')|map(attribute='name')|list %}
  {% endif %}

  {# Define known entity types from MODEL_REGISTRY #}
  {% set entity_types = ['company', 'stakeholder', 'contact', 'opportunity', 'task', 'user'] %}

  {% for field in form %}
    {% if field.name in allowed_fields %}
      <div class="space-y-2">
        {% if mode == 'view' %}
          {# View Mode - Read Only #}
          <label class="block text-sm font-medium text-gray-700">{{ field.label.text }}</label>
          <div class="p-2 bg-gray-50 rounded-md border border-gray-200 text-sm text-gray-900 min-h-[2rem]">
            {% if field.type == 'SelectField' %}
              {% for value, label in field.choices %}
                {% if value == field.data %}{{ label }}{% endif %}
              {% endfor %}
              {% if not field.data or field.data == '' %}
                <span class="text-gray-400">Not set</span>
              {% endif %}
            {% elif field.type == 'TextAreaField' %}
              <div class="{% if (field.widget.rows | default(3)) == 3 %}min-h-[4.5rem]{% elif field.widget.rows == 4 %}min-h-[6rem]{% elif field.widget.rows == 5 %}min-h-[7.5rem]{% else %}min-h-[3rem]{% endif %}">
                {{ field.data if field.data else '' }}
              </div>
            {% else %}
              {{ field.data if field.data else '&nbsp;'|safe }}
            {% endif %}
          </div>
        {% elif field.name in entity_types %}
          {# Field name matches an entity type - it's an entity search field! #}
          <label class="block text-sm font-medium text-gray-700">{{ field.label.text }}</label>
          {{ search_widget(field, entity_type=field.name) }}
        {% elif field.name == 'entity' %}
          {# General entity search field - searches all entity types #}
          <label class="block text-sm font-medium text-gray-700">{{ field.label.text }}</label>
          {{ search_widget(field, entity_type='all') }}
        {% elif field.render_kw and 'Search' in field.render_kw.get('placeholder', '') %}
          {# Search field - use search widget (entity, company, etc.) #}
          <label class="block text-sm font-medium text-gray-700">{{ field.label.text }}</label>
          {{ search_widget(field, entity_type=field.name) }}
        {% else %}
          {# Regular form field #}
          {{ render_wtforms_field(field, fast_select=true, model_name=model_name) }}
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}
{% endmacro %}
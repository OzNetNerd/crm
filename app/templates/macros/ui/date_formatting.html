{#
  Enhanced Date Formatting - DRY date display with relative time and colors

  Provides consistent date formatting across cards with contextual colors:
  - Increment dates (time ago): subtle blue-gray
  - Decrement dates (time left): green
  - Overdue dates: red
  - Neutral dates: gray
#}

{% macro enhanced_date_with_status(date_value, context="due", label=none, today=none) %}
    {% if date_value %}
        {% set today = today or date_value.today() if hasattr(date_value, 'today') else none %}
        {% if today %}
            {% set days_diff = (date_value - today).days %}
            {% set is_overdue = days_diff < 0 %}
            {% set is_future = days_diff > 0 %}
            {% set is_today = days_diff == 0 %}
        {% else %}
            {% set is_overdue = false %}
            {% set is_future = false %}
            {% set is_today = false %}
        {% endif %}

        {# Determine context and label #}
        {% set display_label = label or ("Due" if context == "due" else "Created" if context == "created" else "Updated" if context == "updated" else "") %}

        {# Determine CSS class based on context and date relationship #}
        {% if is_overdue %}
            {% set date_class = "date-overdue" %}
        {% elif context in ["created", "updated"] %}
            {% set date_class = "date-increment" %}
        {% elif is_future %}
            {% set date_class = "date-decrement" %}
        {% else %}
            {% set date_class = "date-neutral" %}
        {% endif %}

        <span class="{{ date_class }}">
            {% if display_label %}{{ display_label }}: {% endif %}
            {{ date_value.strftime('%d/%m/%y') }}
            {% if hasattr(date_value, 'strftime') and date_value.hour is defined %}
                {{ date_value.strftime(' %H:%M') }}
            {% endif %}
            {% if today %}
                {% if is_overdue %}
                    ({{ (today - date_value).days }} day{{ 's' if (today - date_value).days != 1 else '' }} ago)
                {% elif is_today %}
                    (today)
                {% elif is_future %}
                    ({{ days_diff }} day{{ 's' if days_diff != 1 else '' }} left)
                {% endif %}
            {% endif %}
        </span>
    {% endif %}
{% endmacro %}

{% macro smart_date_display(date_value, context="neutral", today=none) %}
    {# Simplified version without labels for inline use #}
    {{ enhanced_date_with_status(date_value, context=context, label=none, today=today) }}
{% endmacro %}

{% macro relative_time_only(date_value, today=none) %}
    {# Just the relative time portion (X days ago/left) #}
    {% if date_value and today %}
        {% set days_diff = (date_value - today).days %}
        {% if days_diff < 0 %}
            <span class="date-increment">({{ (today - date_value).days }} day{{ 's' if (today - date_value).days != 1 else '' }} ago)</span>
        {% elif days_diff == 0 %}
            <span class="date-neutral">(today)</span>
        {% else %}
            <span class="date-decrement">({{ days_diff }} day{{ 's' if days_diff != 1 else '' }} left)</span>
        {% endif %}
    {% endif %}
{% endmacro %}
{# Simple card item macro for dashboard cards - DRY approach #}
{% from 'macros/ui/date_formatting.html' import smart_date_display %}

{% macro card_item(color='gray') %}
<div class="p-3 bg-{{ color }}-50 rounded-lg hover:bg-{{ color }}-100 transition-colors
            {%- if color == 'red' %} border border-red-200{% endif %}">
    {{ caller() }}
</div>
{% endmacro %}

{% macro task_card_item(task, color='gray', with_priority_badge=false) %}
{% if with_priority_badge %}
    {# Task card with priority badge on the right #}
    {% call card_item(color) %}
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="text-card-title">{{ task.description }}</div>
                <div class="text-card-meta-bold">
                    {{ smart_date_display(task.due_date, context="due") }}
                </div>
            </div>
            {% from "macros/ui/badges.html" import priority_badge %}
            <span class="ml-3">
                {{ priority_badge(task.priority) }}
            </span>
        </div>
    {% endcall %}
{% else %}
    {# Simple task card #}
    {% call card_item(color) %}
        <div class="text-card-title">{{ task.description }}</div>
        <div class="text-card-meta-bold">
            {{ smart_date_display(task.due_date, context="due") }}
        </div>
    {% endcall %}
{% endif %}
{% endmacro %}

{% macro note_card_item(note) %}
{% call card_item('gray') %}
    <div class="text-card-title line-clamp-3">{{ note.content }}</div>
    <div class="text-card-meta">
        {{ smart_date_display(note.created_at, context="created") }}
        {%- if note.entity_type == "company" and note.entity_name %}
            • <span class="text-company-name">{{ note.entity_name }}</span>
        {%- elif note.entity_type == "opportunity" and note.entity_name %}
            • <span class="text-opportunity-value">{{ note.entity_name }}</span>
            {%- if note.company_name %} • <span class="text-company-name">{{ note.company_name }}</span>{% endif %}
        {%- elif note.entity_type == "stakeholder" and note.entity_name %}
            • <span class="text-stakeholder-name">{{ note.entity_name }}</span>
            {%- if note.company_name %} • <span class="text-company-name">{{ note.company_name }}</span>{% endif %}
        {%- elif note.entity_name %}
            • {{ note.entity_name }}
        {%- endif %}
    </div>
{% endcall %}
{% endmacro %}

{% macro entity_card_with_badge(entity, subtitle_parts=[], badge_text=None, badge_type='status') %}
{# Generic card with badge - can be used for opportunities, deals, or any entity with status #}
{% call card_item('gray') %}
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <div class="text-card-title">{{ entity.name }}</div>
            {% if subtitle_parts %}
            <div class="text-card-meta">
                {% for part in subtitle_parts %}
                    {% if part.color %}
                        <span class="{{ part.color }}">{{ part.text }}</span>
                    {% else %}
                        {{ part }}
                    {% endif %}
                    {%- if not loop.last %} • {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% if badge_text %}
        {%- set normalized_badge = badge_text|string|lower|replace(' ', '-')|replace('_', '-') -%}
        <span class="ml-3 badge badge-{{ badge_type }}-{{ normalized_badge }}">
            {{ badge_text|title }}
        </span>
        {% endif %}
    </div>
{% endcall %}
{% endmacro %}

{% macro entity_card_item(entity, entity_type='opportunity') %}
{# Generic wrapper for any entity with status badge - DRY and reusable #}
{% if entity_type == 'opportunity' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.company_name, 'color': 'text-company-name'},
            {'text': entity.value_formatted, 'color': 'text-opportunity-value'}
        ],
        badge_text=entity.stage,
        badge_type='status'
    ) }}
{% elif entity_type == 'company' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.industry, 'color': 'text-gray-600'} if entity.industry else {},
            {'text': entity.company_size, 'color': 'text-gray-600'} if entity.company_size else {}
        ],
        badge_text=entity.status if entity.status else None,
        badge_type='status'
    ) }}
{% elif entity_type == 'stakeholder' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.company_name, 'color': 'text-company-name'} if entity.company_name else {},
            {'text': entity.role, 'color': 'text-gray-600'} if entity.role else {}
        ],
        badge_text=entity.status if entity.status else None,
        badge_type='status'
    ) }}
{% else %}
    {# Fallback for other entity types #}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[],
        badge_text=entity.status if entity.status else None,
        badge_type='status'
    ) }}
{% endif %}
{% endmacro %}

{% macro opportunity_card_item(opp) %}
{# Legacy wrapper for backward compatibility - use entity_card_item instead #}
{{ entity_card_item(opp, 'opportunity') }}
{% endmacro %}
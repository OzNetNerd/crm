{# Simple card item macro for dashboard cards - DRY approach #}
{% from 'macros/ui/date_formatting.html' import smart_date_display %}
{% from 'macros/ui/badges.html' import universal_badge %}

{% macro card_item(color='gray') %}
<div class="p-3 bg-{{ color }}-50 rounded-lg hover:bg-{{ color }}-100 transition-colors
            {%- if color == 'red' %} border border-red-200{% endif %}">
    {{ caller() }}
</div>
{% endmacro %}

{% macro task_card_item(task, color='gray', with_priority_badge=false) %}
{% if with_priority_badge %}
    {# Task card with priority badge on the right #}
    {% call card_item(color) %}
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="text-card-title">{{ task.description }}</div>
                <div class="text-card-meta-bold">
                    {{ smart_date_display(task.due_date, context="due") }}
                </div>
            </div>
            {% from "macros/ui/badges.html" import priority_badge %}
            <span class="ml-3">
                {{ priority_badge(task.priority) }}
            </span>
        </div>
    {% endcall %}
{% else %}
    {# Simple task card #}
    {% call card_item(color) %}
        <div class="text-card-title">{{ task.description }}</div>
        <div class="text-card-meta-bold">
            {{ smart_date_display(task.due_date, context="due") }}
        </div>
    {% endcall %}
{% endif %}
{% endmacro %}

{% macro note_card_item(note) %}
{% call card_item('gray') %}
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <div class="text-card-title line-clamp-3">{{ note.content }}</div>
            <div class="text-card-meta">
                {{ smart_date_display(note.created_at, context="created") }}
                {%- if note.entity_type == "company" and note.entity_name %}
                    • <span class="text-company-name">{{ note.entity_name }}</span>
                {%- elif note.entity_type == "opportunity" and note.entity_name %}
                    • <span class="text-opportunity-value">{{ note.entity_name }}</span>
                    {%- if note.company_name %} • <span class="text-company-name">{{ note.company_name }}</span>{% endif %}
                {%- elif note.entity_type == "stakeholder" and note.entity_name %}
                    • <span class="text-stakeholder-name">{{ note.entity_name }}</span>
                    {%- if note.company_name %} • <span class="text-company-name">{{ note.company_name }}</span>{% endif %}
                {%- elif note.entity_name %}
                    • {{ note.entity_name }}
                {%- endif %}
            </div>
        </div>
        {% if note.entity_type %}
        <span class="ml-3">
            {{ universal_badge(note.entity_type, badge_type='status', entity_type=note.entity_type) }}
        </span>
        {% endif %}
    </div>
{% endcall %}
{% endmacro %}

{% macro entity_card_with_badge(entity, subtitle_parts=[], badge_text=None, badge_display=None, badge_type='status', title_class='', title_field='name') %}
{# Generic card with badge - can be used for opportunities, deals, or any entity with status #}
{% call card_item('gray') %}
    <div class="flex items-start justify-between">
        <div class="flex-1">
            {%- if entity is mapping -%}
                {%- set entity_title = entity.get(title_field, entity.get('name', '')) -%}
            {%- else -%}
                {%- set entity_title = getattr(entity, title_field, getattr(entity, 'name', '')) -%}
            {%- endif -%}
            {%- set title_css = title_class if title_class else 'text-card-title' -%}
            <div class="{{ title_css }}">{{ entity_title }}</div>
            {% if subtitle_parts %}
            <div class="text-card-meta">
                {% for part in subtitle_parts %}
                    {% if part.color %}
                        <span class="{{ part.color }}">{{ part.text }}</span>
                    {% else %}
                        {{ part }}
                    {% endif %}
                    {%- if not loop.last %} • {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% if badge_text %}
        <span class="ml-3">
            {{ universal_badge(badge_text, badge_type=badge_type, display_text=badge_display) }}
        </span>
        {% endif %}
    </div>
{% endcall %}
{% endmacro %}

{% macro entity_card_item(entity, entity_type='opportunity') %}
{# Generic wrapper for any entity with status badge - DRY and reusable #}
{# Handle both dict (from to_display_dict) and object formats #}
{% if entity_type == 'opportunity' %}
    {%- if entity is mapping -%}
        {# Entity is a dict from to_display_dict() #}
        {%- set stage = entity.get('stage') or '' -%}
        {%- set stage_display = entity.get('stage_display') or '' -%}
        {%- set company_name = entity.get('company_name', '') -%}
        {%- set value_formatted = entity.get('value_formatted', '') -%}
    {%- else -%}
        {# Entity is an object #}
        {%- set stage = entity.stage -%}
        {%- set stage_display = entity.stage_display if entity.stage_display is defined else None -%}
        {%- set company_name = entity.company_name -%}
        {%- set value_formatted = entity.value_formatted -%}
    {%- endif -%}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': company_name, 'color': 'text-company-name'},
            {'text': value_formatted, 'color': 'text-opportunity-value'}
        ],
        badge_text=stage,
        badge_display=stage_display,
        badge_type='status'
    ) }}
{% elif entity_type == 'company' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.industry, 'color': 'text-gray-600'} if entity.industry else {},
            {'text': entity.company_size, 'color': 'text-gray-600'} if entity.company_size else {}
        ],
        badge_text=entity.status if entity.status else None,
        badge_display=entity.status_display if entity.status_display is defined else None,
        badge_type='status',
        title_class='text-card-title text-company-name'
    ) }}
{% elif entity_type == 'stakeholder' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.company_name, 'color': 'text-company-name'} if entity.company_name else {},
            {'text': entity.role, 'color': 'text-gray-600'} if entity.role else {}
        ],
        badge_text=entity.status if entity.status else None,
        badge_display=entity.status_display if entity.status_display is defined else None,
        badge_type='status',
        title_class='text-card-title text-stakeholder-name'
    ) }}
{% elif entity_type == 'task' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.due_date.strftime('%Y-%m-%d') if entity.due_date else 'No due date', 'color': 'text-gray-600'}
        ],
        badge_text=entity.status if entity.status else None,
        badge_display=entity.status_display if entity.status_display is defined else None,
        badge_type='status',
        title_class='text-card-title',
        title_field='description'
    ) }}
{% elif entity_type == 'team' %}
    {{ entity_card_with_badge(
        entity,
        subtitle_parts=[
            {'text': entity.description, 'color': 'text-gray-600'} if entity.description else {}
        ],
        badge_text=entity.status if entity.status else None,
        badge_display=entity.status_display if entity.status_display is defined else None,
        badge_type='status',
        title_class='text-card-title text-team-member'
    ) }}
{% endif %}
{% endmacro %}


{# 
  Card State Template Macros - Clean separation of template rendering from Alpine.js state
  
  Uses the cardState.js Alpine component for state management.
  These macros handle only template rendering and CSS classes.
#}

{#
  Card Container with State - Main wrapper for stateful cards
  
  Parameters:
  - card_type (required): Entity type for API endpoints and styling
  - entity (required): Entity data object 
  - entity_id (required): Unique entity identifier
  - expansion_enabled (optional): Enable expand/collapse (default: true)
  - notes_enabled (optional): Enable notes functionality (default: false) 
  - group_key (optional): Group identifier for bulk operations
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {% call card_with_state('task', task, task.id, notes_enabled=true) %}
    <!-- Card content here -->
  {% endcall %}
#}
{% macro card_with_state(card_type, entity, entity_id, expansion_enabled=true, notes_enabled=false, group_key='', additional_classes='') %}
<div x-data="cardState({
       cardType: '{{ card_type }}',
       entity: {{ entity | tojson }},
       entityId: {{ entity_id }},
       expansionEnabled: {{ expansion_enabled | lower }},
       notesEnabled: {{ notes_enabled | lower }},
       groupKey: '{{ group_key }}'
     })"
     {% if expansion_enabled %}
     @click="toggle()"
     {% if group_key %}
     @expand-all-{{ card_type }}s.window="expandAll($event.detail.group)"
     @collapse-all-{{ card_type }}s.window="collapseAll($event.detail.group)"
     {% endif %}
     {% endif %}
     {% if card_type == 'task' %}
     @reschedule-saved.window="cancelChanges()"
     {% endif %}
     :class="{ 'ring-2 ring-blue-200 bg-blue-50': {% if expansion_enabled %}expanded || {% endif %}isEditing }"
     class="card {{ additional_classes }}">
  {{ caller() }}
</div>
{% endmacro %}

{#
  Expandable Content Section - Reusable expandable content container
  
  Parameters:
  - title (optional): Section header title
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {% call expandable_section('Comments & Notes') %}
    <!-- Expandable content here -->
  {% endcall %}
#}
{% macro expandable_section(title='', additional_classes='') %}
<div x-show="expanded" 
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0 transform scale-95"
     x-transition:enter-end="opacity-100 transform scale-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100 transform scale-100"
     x-transition:leave-end="opacity-0 transform scale-95"
     class="mt-4 pt-4 border-t border-gray-100 {{ additional_classes }}">
  {% if title %}
  <h4 class="text-sm font-medium text-gray-900 mb-3">{{ title }}</h4>
  {% endif %}
  {{ caller() }}
</div>
{% endmacro %}

{#
  Card State Indicators - Visual indicators for card state
  
  Parameters:
  - show_expansion (optional): Show expand/collapse indicator (default: true)
  - show_editing (optional): Show editing state indicator (default: true)
  
  Usage:
  {{ card_state_indicators() }}
  {{ card_state_indicators(show_editing=false) }}
#}
{% macro card_state_indicators(show_expansion=true, show_editing=true) %}
{% if show_expansion %}
<div class="flex-shrink-0">
  <svg x-show="!expanded" class="w-5 h-5 text-gray-400 transition-transform" viewBox="0 0 20 20" fill="currentColor">
    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
  </svg>
  <svg x-show="expanded" class="w-5 h-5 text-gray-600 transition-transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
  </svg>
</div>
{% endif %}

{% if show_editing %}
<div x-show="isEditing" class="flex-shrink-0">
  <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
    Editing
  </span>
</div>
{% endif %}
{% endmacro %}

{#
  Notes Section Container - Template for notes/comments functionality
  
  Usage:
  {% call notes_section() %}
    <!-- Notes content will be inserted here -->
  {% endcall %}
#}
{% macro notes_section() %}
<template x-if="notesEnabled">
  <div class="notes-section">
    <!-- New comment form -->
    <div class="mb-4">
      <textarea x-model="newComment" 
                placeholder="Add a comment..." 
                class="w-full p-3 border border-gray-200 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows="2"></textarea>
      <div class="flex justify-end mt-2">
        <button @click="submitComment()" 
                :disabled="!newComment.trim() || saving"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
          <span x-show="!saving">Add Comment</span>
          <span x-show="saving">Adding...</span>
        </button>
      </div>
    </div>
    
    <!-- Comments list -->
    <div x-show="notes.length > 0">
      <template x-for="note in notes" :key="note.id">
        <div class="bg-gray-50 rounded-lg p-3 mb-3">
          <div class="flex justify-between items-start mb-2">
            <span class="text-sm font-medium text-gray-900" x-text="note.created_by"></span>
            <div class="flex space-x-2">
              <button @click="startEditComment(note.id, note.content)" 
                      class="text-xs text-gray-500 hover:text-blue-600">Edit</button>
              <button @click="deleteComment(note.id)" 
                      class="text-xs text-red-500 hover:text-red-700">Delete</button>
            </div>
          </div>
          
          <!-- Display mode -->
          <div x-show="editingCommentId !== note.id">
            <p class="text-sm text-gray-700" x-text="note.content"></p>
            <p class="text-xs text-gray-500 mt-1" x-text="note.created_at"></p>
          </div>
          
          <!-- Edit mode -->
          <div x-show="editingCommentId === note.id">
            <textarea x-model="editingCommentText" 
                      class="w-full p-2 border border-gray-200 rounded text-sm resize-none"
                      rows="2"></textarea>
            <div class="flex justify-end space-x-2 mt-2">
              <button @click="cancelEditComment()" 
                      class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
              <button @click="saveEditComment()" 
                      :disabled="saving"
                      class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                <span x-show="!saving">Save</span>
                <span x-show="saving">Saving...</span>
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>
    
    <!-- Empty state -->
    <div x-show="notes.length === 0 && notesLoaded" class="text-center text-gray-500 text-sm py-4">
      No comments yet. Be the first to add one!
    </div>
  </div>
</template>
{% endmacro %}
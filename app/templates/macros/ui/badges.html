{# Badge Components - DRY badge system with helper macros #}

{# Helper macro for consistent text normalization #}
{% macro normalize_badge_value(value) -%}
{%- if value -%}
  {%- set normalized = value|string|lower|replace(' ', '-')|replace('_', '-') -%}
  {%- set display = value|string|replace('-', ' ')|replace('_', ' ')|title -%}
  {{ {'normalized': normalized, 'display': display} }}
{%- else -%}
  {{ {'normalized': 'unknown', 'display': 'Unknown'} }}
{%- endif -%}
{% endmacro %}

{# Universal badge macro following ADR-011 dynamic class pattern #}
{% macro universal_badge(value, badge_type='status', entity_type=None, size='md', additional_classes='', display_text=None) -%}
{%- set norm = normalize_badge_value(value) -%}
{%- if norm.normalized in ['high', 'medium', 'low'] and badge_type == 'status' -%}
  {%- set badge_type = 'priority' -%}
{%- endif -%}
<span class="badge badge-{{ badge_type }}-{{ norm.normalized }}{% if entity_type %} badge-entity-{{ entity_type|lower }}{% endif %} {{ additional_classes }}">
  {{ display_text if display_text else norm.display }}
</span>
{%- endmacro %}

{#
  Stakeholder Info Badge - Display contact information status
  
  Parameters:
  - contact (required): Stakeholder object with email and phone attributes
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ contact_info_badge(contact) }}
#}
{% macro contact_info_badge(contact, additional_classes='') %}
{% set info_type = get_contact_info_type(contact) %}
{% set badge_configs = get_contact_badge_configs() %}
<span class="badge-standard badge-contact-{{ info_type }} {{ additional_classes }}">{{ badge_configs[info_type].label }}</span>
{% endmacro %}

{% macro get_contact_info_type(contact) %}
{%- if contact.email and contact.phone -%}complete
{%- elif contact.email -%}email_only
{%- elif contact.phone -%}phone_only
{%- else -%}missing
{%- endif -%}
{% endmacro %}

{% macro get_contact_badge_configs() %}
{
    'complete': {'label': 'Complete Info'},
    'email_only': {'label': 'Email Only'}, 
    'phone_only': {'label': 'Phone Only'},
    'missing': {'label': 'Missing Info'}
}
{% endmacro %}

{#
  Status Badge - Consistent status indicator using universal badge system

  Parameters:
  - status (required): Status value
  - entity_type (optional): Entity type for CSS theming
  - badge_type (optional): Badge type ('status', 'priority')
  - additional_classes (optional): Extra CSS classes

  Usage:
  {{ status_badge(task.status) }}
  {{ status_badge(task.priority, badge_type='priority') }}
  {{ status_badge(company.status, entity_type='company') }}
#}
{% macro status_badge(status, entity_type=None, badge_type='status', additional_classes='') %}
{{ universal_badge(status, badge_type=badge_type, entity_type=entity_type, additional_classes=additional_classes) }}
{% endmacro %}

{#
  Priority Badge - Simplified wrapper for priority values

  Parameters:
  - priority (required): Priority value (high, medium, low)
  - entity_type (optional): Entity type for CSS theming

  Usage:
  {{ priority_badge(task.priority) }}
  {{ priority_badge(task.priority, entity_type='task') }}
#}
{% macro priority_badge(priority, entity_type=None) %}
{{ universal_badge(priority, badge_type='priority', entity_type=entity_type) }}
{% endmacro %}

{#
  DRY Filter Helper - Unified filtering logic for task collections
#}
{% macro apply_task_filter(tasks, filter_type, filter_value=None, show_completed=False) -%}
{%- if filter_type == 'status' -%}
  {%- set filtered = tasks|selectattr('status', 'equalto', filter_value) -%}
{%- elif filter_type == 'priority' -%}
  {%- set filtered = tasks|selectattr('priority', 'equalto', filter_value) -%}
{%- elif filter_type == 'overdue' -%}
  {%- set filtered = tasks|selectattr('is_overdue', 'equalto', True) -%}
{%- elif filter_type == 'due_today' -%}
  {%- set filtered = tasks|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete') -%}
{%- elif filter_type == 'no_date' -%}
  {%- set filtered = tasks|selectattr('due_date', 'none') -%}
  {%- if not show_completed -%}
    {%- set filtered = filtered|selectattr('status', 'ne', 'complete') -%}
  {%- endif -%}
{%- elif filter_type == 'entity' -%}
  {%- if filter_value == 'unrelated' -%}
    {%- set filtered = tasks|selectattr('entity_type', 'none') -%}
  {%- else -%}
    {%- set filtered = tasks|selectattr('entity_type', 'equalto', filter_value) -%}
  {%- endif -%}
  {%- if not show_completed -%}
    {%- set filtered = filtered|selectattr('status', 'ne', 'complete') -%}
  {%- endif -%}
{%- else -%}
  {%- set filtered = [] -%}
{%- endif -%}
{{ filtered|list|length }}
{%- endmacro %}

{#
  Badge Count Helper - Simplified using DRY filter logic

  Parameters:
  - filter_type (required): Type of filtering ('status', 'priority', 'overdue', 'due_today', 'no_date', 'entity')
  - filter_value (optional): Value to filter by
  - color (required): Badge color class
  - show_completed (optional): Include completed tasks (default: False)
  - custom_count (optional): Pre-calculated count

  Usage:
  {{ badge_count_helper('status', 'todo', 'blue') }}
  {{ badge_count_helper('priority', 'high', 'red') }}
  {{ badge_count_helper('overdue', color='red') }}
#}
{% macro badge_count_helper(filter_type, filter_value=None, color='gray', show_completed=False, custom_count=None) %}
{%- if custom_count is not none -%}
  {%- set count = custom_count -%}
{%- else -%}
  {%- set count = apply_task_filter(tasks_objects, filter_type, filter_value, show_completed) -%}
{%- endif -%}
<span class="ml-2 badge-standard badge-count-{{ color }}">{{ count }}</span>
{%- endmacro %}

{#
  Task Section Badge Helper - Generate badge HTML using existing badge_count_helper
  
  Parameters:
  - filter_config (required): Filter configuration object
  - badge_color (required): Badge color class
  
  Usage:
  {{ task_section_badge(filter_config, 'blue') }}
#}
{% macro task_section_badge(filter_config, badge_color) %}
{%- if filter_config -%}
    {%- if filter_config.type == 'custom_due_week' or filter_config.type == 'custom_due_later' -%}
        {{ badge_count_helper(filter_config.type, color=badge_color, custom_count=filter_config.custom_count) }}
    {%- else -%}
        {{ badge_count_helper(filter_config.type, filter_config.value, badge_color) }}
    {%- endif -%}
{%- else -%}
    <span class="ml-2 badge-standard badge-count-{{ badge_color }}">0</span>
{%- endif -%}
{% endmacro %}

{# Status colors now use dynamic CSS classes: badge-status-{status} #}
{# Badge Components - Consistent badge and status indicators #}

{#
  Stakeholder Info Badge - Display contact information status
  
  Parameters:
  - contact (required): Stakeholder object with email and phone attributes
  - additional_classes (optional): Extra CSS classes
  
  Usage:
  {{ contact_info_badge(contact) }}
#}
{% macro contact_info_badge(contact, additional_classes='') %}
{% set info_type = get_contact_info_type(contact) %}
{% set badge_configs = get_contact_badge_configs() %}
<span class="c-badge c-badge--{{ badge_configs[info_type].color }} {{ additional_classes }}">{{ badge_configs[info_type].label }}</span>
{% endmacro %}

{% macro get_contact_info_type(contact) %}
{%- if contact.email and contact.phone -%}complete
{%- elif contact.email -%}email_only
{%- elif contact.phone -%}phone_only
{%- else -%}missing
{%- endif -%}
{% endmacro %}

{% macro get_contact_badge_configs() %}
{
    'complete': {'color': 'green', 'label': 'Complete Info'},
    'email_only': {'color': 'blue', 'label': 'Email Only'}, 
    'phone_only': {'color': 'yellow', 'label': 'Phone Only'},
    'missing': {'color': 'red', 'label': 'Missing Info'}
}
{% endmacro %}

{#
  Status Badge - Consistent status indicator
  
  Parameters:
  - status (required): Status value
  - color_map (optional): Dict mapping status to colors
  - size (optional): Badge size ('sm', 'md', 'lg')
  
  Usage:
  {{ status_badge(task.status) }}
  {{ status_badge(company.status, {'active': 'green', 'inactive': 'red'}) }}
#}
{% macro status_badge(status, color_map=None, size='md') %}
{%- set color = get_status_color(status, color_map) -%}

{%- set size_classes = {'sm': 'px-2 py-1 text-xs', 'md': 'px-2.5 py-0.5 text-sm', 'lg': 'px-3 py-1 text-base'} -%}

<span class="c-badge c-badge--{{ color }}">
    {{ status|title }}
</span>
{% endmacro %}

{#
  Badge Count Helper - DRY macro for task count badges with consistent formatting
  
  Parameters:
  - filter_type (required): Type of filtering ('status', 'priority', 'due_date', 'entity', 'overdue', 'custom')
  - filter_value (optional): Specific value to filter by (e.g., 'todo', 'high', 'company')
  - color (required): Badge color class ('blue', 'red', 'green', etc.)
  - tasks_list (optional): Tasks list to use (default: 'tasks')
  - show_completed (optional): Whether to include completed tasks (default: varies by type)
  - custom_count (optional): Pre-calculated count for complex filters
  
  Usage:
  {{ badge_count_helper('status', 'todo', 'blue') }}
  {{ badge_count_helper('priority', 'high', 'red') }}
  {{ badge_count_helper('custom', color='gray', custom_count=custom_task_list|length) }}
#}
{% macro badge_count_helper(filter_type, filter_value=None, color='gray', tasks_list='tasks_objects', show_completed=None, custom_count=None) %}
{%- if custom_count is not none -%}
    {%- set count = custom_count -%}
{%- elif filter_type == 'status' -%}
    {%- set count = (tasks_objects|selectattr('status', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'priority' -%}
    {%- set count = (tasks_objects|selectattr('priority', 'equalto', filter_value)|list|length) -%}
{%- elif filter_type == 'overdue' -%}
    {%- set count = (tasks_objects|selectattr('is_overdue', 'equalto', True)|list|length) -%}
{%- elif filter_type == 'due_today' -%}
    {%- set count = (tasks_objects|selectattr('due_date', 'equalto', today)|selectattr('status', 'ne', 'complete')|list|length) -%}
{%- elif filter_type == 'no_date' -%}
    {%- if show_completed -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|list|length) -%}
    {%- else -%}
        {%- set count = (tasks_objects|selectattr('due_date', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
    {%- endif -%}
{%- elif filter_type == 'entity' -%}
    {%- if filter_value == 'unrelated' -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'none')|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- else -%}
        {%- if show_completed -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|list|length) -%}
        {%- else -%}
            {%- set count = (tasks_objects|selectattr('entity_type', 'equalto', filter_value)|selectattr('status', 'ne', 'complete')|list|length) -%}
        {%- endif -%}
    {%- endif -%}
{%- else -%}
    {%- set count = 0 -%}
{%- endif -%}
<span class="u-m-left-sm c-badge c-badge--{{ color }}">{{ count }}</span>
{%- endmacro %}

{#
  Task Section Badge Helper - Generate badge HTML using existing badge_count_helper
  
  Parameters:
  - filter_config (required): Filter configuration object
  - badge_color (required): Badge color class
  
  Usage:
  {{ task_section_badge(filter_config, 'blue') }}
#}
{% macro task_section_badge(filter_config, badge_color) %}
{%- if filter_config -%}
    {%- if filter_config.type == 'custom_due_week' or filter_config.type == 'custom_due_later' -%}
        {{ badge_count_helper(filter_config.type, color=badge_color, custom_count=filter_config.custom_count) }}
    {%- else -%}
        {{ badge_count_helper(filter_config.type, filter_config.value, badge_color) }}
    {%- endif -%}
{%- else -%}
    <span class="u-m-left-sm c-badge c-badge--{{ badge_color }}">0</span>
{%- endif -%}
{% endmacro %}

{#
  Helper macro for status color determination - eliminates if/elif chains
#}
{% macro get_status_color(status, color_map=None) %}
{%- if color_map -%}
    {{ color_map.get(status, 'gray') }}
{%- else -%}
    {% set default_colors = get_default_status_colors() %}
    {% set found_color = '' %}
    {% for color_group, statuses in default_colors.items() %}
        {% if status in statuses and not found_color %}
            {% set found_color = color_group %}
        {% endif %}
    {% endfor %}
    {{ found_color or 'gray' }}
{%- endif -%}
{% endmacro %}

{% macro get_default_status_colors() %}
{
    'green': ['complete', 'completed', 'done', 'active', 'open'],
    'yellow': ['in-progress', 'in_progress', 'pending', 'working'],
    'red': ['overdue', 'late', 'failed', 'error'],
    'blue': ['todo', 'new', 'draft']
}
{% endmacro %}
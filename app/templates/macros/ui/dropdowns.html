{# Universal CSS Dropdown System - Pure CSS, DRY Implementation #}

{#
  Universal CSS Dropdown - Handles both single and multi-select dropdowns
  
  Auto-detects mode based on parameters:
  - current_value provided → Single select mode
  - current_values provided → Multi select mode
  
  Parameters:
  - button_text (required): Text to display in the dropdown button
  - options (required): List of {'value': 'val', 'label': 'Label'} dicts
  - name (required): Form field name for HTMX submission
  - current_value (optional): Currently selected value for single select
  - current_values (optional): List of currently selected values for multi select
  - hx_target (optional): HTMX target for form submission
  - hx_get (optional): HTMX GET endpoint
  - hx_post (optional): HTMX POST endpoint
  - placeholder (optional): Placeholder text when nothing selected
  - additional_classes (optional): Extra CSS classes for container
  
  Usage:
  Single select:
  {{ css_dropdown('Sort by', sort_options, name='sort_by', current_value=sort_by, hx_target='#content', hx_get='/companies/content') }}
  
  Multi select:
  {{ css_dropdown('All Industries', industry_options, name='primary_filter', current_values=primary_filter, hx_target='#content', hx_get='/companies/content') }}
#}
{% macro css_dropdown(
    button_text, 
    options, 
    name, 
    current_value=None,
    current_values=None,
    hx_target=None,
    hx_get=None,
    hx_post=None,
    placeholder='Select option',
    additional_classes=''
) %}

{# Auto-detect single vs multi mode #}
{% set is_multi = current_values is not none %}
{% set is_single = current_value is not none %}

{# Generate unique ID for this dropdown #}
{% set dropdown_id = 'dropdown-' + name + '-' + range(1000, 9999)|random|string %}

<div class="relative {{ additional_classes }} dropdown-container" 
     hx-on:htmx:after-request="this.querySelector('input[type=checkbox]').checked = false"
     tabindex="0"
     onblur="if (!this.contains(event.relatedTarget)) this.querySelector('input[type=checkbox]').checked = false">
    <input type="checkbox" id="{{ dropdown_id }}" class="hidden peer">
    
    <label for="{{ dropdown_id }}" 
           class="bg-white border border-gray-300 rounded-md px-4 py-2 text-left flex items-center justify-between hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer min-w-[12rem]">
        <span class="truncate" id="{{ dropdown_id }}-label">
            {% if is_single %}
                {# Single select display logic #}
                {% set found = namespace(value=false) %}
                {% for option in options %}
                    {% if (option.value if option is mapping else option) == current_value and not found.value %}
                        {{ option.label if option is mapping else option|title }}
                        {% set found.value = true %}
                    {% endif %}
                {% endfor %}
                {% if not found.value %}{{ options[0].label if options[0] is mapping else options[0]|title }}{% endif %}
            {% elif is_multi %}
                {# Multi select display logic #}
                {% if current_values|length == 0 %}
                    {{ button_text }}
                {% elif current_values|length == 1 %}
                    {% set found = namespace(value=false) %}
                    {% for option in options %}
                        {% set opt_value = option.value if option is mapping else option %}
                        {% if opt_value in current_values and not found.value %}
                            {{ option.label if option is mapping else option|title }}
                            {% set found.value = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not found.value %}{{ current_values[0] }}{% endif %}
                {% else %}
                    {{ current_values|length }} selected
                {% endif %}
            {% else %}
                {{ options[0].label if options[0] is mapping else options[0]|title }}
            {% endif %}
        </span>
        <svg class="w-4 h-4 ml-2 transition-[transform,translate,scale,rotate] peer-checked:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </label>
    
    <div class="dropdown-content absolute mt-1 min-w-[12rem] bg-white border border-gray-300 rounded-md shadow-lg z-20 opacity-0 scale-95 pointer-events-none transition-all duration-200 peer-checked:opacity-100 peer-checked:scale-100 peer-checked:pointer-events-auto">
        {% if is_single %}
            {# Single select options #}
            {% for option in options %}
                {%- set option_value = option.value if option is mapping else option -%}
                {%- set option_label = option.label if option is mapping else option|title -%}
                
                <label>
                    <input type="radio" 
                           name="{{ name }}" 
                           value="{{ option_value }}"
                           class="sr-only peer"
                           {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                           {% if hx_get %}hx-get="{{ hx_get }}"{% endif %}
                           {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                           hx-trigger="change"
                           {% if option_value == current_value %}checked{% endif %}
>
                    <span class="block w-full text-left px-4 py-2 hover:bg-gray-100 peer-focus:bg-gray-100 cursor-pointer peer-checked:bg-blue-50 peer-checked:text-blue-700">
                        {{ option_label }}
                    </span>
                </label>
            {% endfor %}
        {% elif is_multi %}
            {# Multi select options #}
            <div class="py-1 max-h-48 overflow-y-auto">
                {% for option in options %}
                    {%- set option_value = option.value if option is mapping else option -%}
                    {%- set option_label = option.label if option is mapping else option|title -%}
                    
                    <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" 
                               name="{{ name }}"
                               value="{{ option_value }}"
                               {% if option_value in (current_values or []) %}checked{% endif %}
                               class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                               {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                               {% if hx_get %}hx-get="{{ hx_get }}"{% endif %}
                               {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                               hx-trigger="change delay:1s"
>
                        {{ option_label }}
                    </label>
                {% endfor %}
            </div>
        {% else %}
            {# Fallback - no current_value or current_values provided #}
            {% for option in options %}
                {%- set option_value = option.value if option is mapping else option -%}
                {%- set option_label = option.label if option is mapping else option|title -%}
                
                <label>
                    <input type="radio" 
                           name="{{ name }}" 
                           value="{{ option_value }}"
                           class="sr-only peer"
                           {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                           {% if hx_get %}hx-get="{{ hx_get }}"{% endif %}
                           {% if hx_post %}hx-post="{{ hx_post }}"{% endif %}
                           hx-trigger="change"
>
                    <span class="block w-full text-left px-4 py-2 hover:bg-gray-100 peer-focus:bg-gray-100 cursor-pointer peer-checked:bg-blue-50 peer-checked:text-blue-700">
                        {{ option_label }}
                    </span>
                </label>
            {% endfor %}
        {% endif %}
    </div>
</div>
{% endmacro %}
{#
  Unified Modal System - Consolidated modal components

  Single source of truth for all modal functionality.
  Supports both HTMX and Alpine.js patterns.
#}

{% from 'macros/base/icons.html' import icon %}

{#
  Modal - Main modal macro supporting both HTMX and Alpine modes

  Parameters:
  - modal_id (optional): ID for the modal (for Alpine mode)
  - backdrop_close (optional): Allow closing on backdrop click (default: true)
  - max_width (optional): Maximum width class (default: 'max-w-2xl')
  - mode (optional): 'htmx' or 'alpine' (default: 'htmx')

  Usage:
  {% call modal() %}
    {% call modal_header('Edit Task') %}{% endcall %}
    {% call modal_body() %}Content here{% endcall %}
    {% call modal_footer() %}Buttons here{% endcall %}
  {% endcall %}
#}
{% macro modal(modal_id='', backdrop_close=true, max_width='max-w-2xl', mode='htmx') %}
{% if mode == 'htmx' %}
<div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center"
     tabindex="-1"
     onkeydown="if(event.key === 'Escape') this.remove()">
    <!-- Backdrop -->
    <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"
         {% if backdrop_close %}onclick="this.parentElement.remove()"{% endif %}></div>

    <!-- Modal Content -->
    <div class="modal-content relative bg-white rounded-xl shadow-2xl {{ max_width }} w-full mx-4 max-h-[90vh] overflow-y-auto transform transition-all">
        {{ caller() }}
    </div>
</div>
{% else %}
<div id="{{ modal_id }}"
     class="modal-overlay hidden fixed inset-0 z-50 overflow-y-auto"
     aria-labelledby="{{ modal_id }}-title"
     role="dialog"
     aria-modal="true">

    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"
             {% if backdrop_close %}onclick="closeModal('{{ modal_id }}')"{% endif %}></div>

        <div class="modal-content relative bg-white rounded-xl shadow-2xl {{ max_width }} w-full transform transition-all"
             onclick="event.stopPropagation()">
            {{ caller() }}
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}

{#
  Modal Header - Unified header for all modal types

  Parameters:
  - title (required): Modal title text
  - entity_icon (optional): Entity type for icon display
  - close_action (optional): Custom close action (default: auto-detect)
#}
{% macro modal_header(title, entity_icon=none, close_action=none) %}
<div class="modal-header flex items-center justify-between p-6 border-b bg-gray-50 rounded-t-xl">
    <div class="flex items-center gap-3">
        {% if entity_icon %}
        <div class="entity-icon">
            <span class="icon-{{ entity_icon }} c-icon c-icon--md"></span>
        </div>
        {% endif %}
        <h3 class="modal-title text-lg font-semibold text-gray-900">
            {{ title }}
        </h3>
    </div>
    <button {% if close_action %}onclick="{{ close_action }}"{% else %}onclick="this.closest('.modal-overlay').remove()"{% endif %}
            class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition-colors">
        {{ icon('x-mark', 'lg') }}
    </button>
</div>
{% endmacro %}

{#
  Modal Body - Content area for modal

  Parameters:
  - padding (optional): Padding classes (default: 'p-6')
#}
{% macro modal_body(padding='p-6') %}
<div class="modal-body {{ padding }}">
    {{ caller() }}
</div>
{% endmacro %}

{#
  Modal Footer - Action buttons area

  Parameters:
  - align (optional): Button alignment ('left', 'center', 'right' - default: 'right')
  - padding (optional): Padding classes (default: 'p-6')
#}
{% macro modal_footer(align='right', padding='p-6') %}
<div class="modal-footer flex items-center {{ padding }} border-t bg-gray-50 rounded-b-xl space-x-3
            {%- if align == 'center' %} justify-center
            {%- elif align == 'left' %} justify-start
            {%- else %} justify-end{% endif %}">
    {{ caller() }}
</div>
{% endmacro %}

{#
  Confirmation Modal - Specialized modal for confirmations

  Parameters:
  - title (optional): Modal title (default: 'Confirm Action')
  - message (required): Confirmation message
  - confirm_text (optional): Confirm button text (default: 'Confirm')
  - confirm_action (required): Action to execute on confirm
  - type (optional): 'warning', 'error', 'success', 'info' (default: 'warning')
  - show_cancel (optional): Show cancel button (default: true)
#}
{% macro confirmation_modal(title='Confirm Action', message='', confirm_text='Confirm',
                           confirm_action='', type='warning', show_cancel=true) %}
{% set icon_config = {
    'warning': {'bg': 'bg-yellow-100', 'text': 'text-yellow-600', 'icon': 'exclamation-triangle', 'btn': 'bg-yellow-600 hover:bg-yellow-700'},
    'error': {'bg': 'bg-red-100', 'text': 'text-red-600', 'icon': 'x-mark', 'btn': 'bg-red-600 hover:bg-red-700'},
    'success': {'bg': 'bg-green-100', 'text': 'text-green-600', 'icon': 'check', 'btn': 'bg-green-600 hover:bg-green-700'},
    'info': {'bg': 'bg-blue-100', 'text': 'text-blue-600', 'icon': 'information-circle', 'btn': 'bg-blue-600 hover:bg-blue-700'}
} %}
{% set config = icon_config[type] %}

{% call modal(backdrop_close=true, max_width='max-w-lg') %}
    <div class="p-6">
        <div class="flex items-start">
            <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full {{ config.bg }} {{ config.text }}">
                {{ icon(config.icon, 'lg') }}
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">{{ title }}</h3>
                {% if message %}
                <p class="mt-2 text-sm text-gray-500">{{ message }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% call modal_footer(padding='px-6 py-4') %}
        {% if show_cancel %}
        <button onclick="this.closest('.modal-overlay').remove()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
        </button>
        {% endif %}
        <button onclick="{{ confirm_action }}; this.closest('.modal-overlay').remove()"
                class="px-4 py-2 text-sm font-medium text-white {{ config.btn }} rounded-md">
            {{ confirm_text }}
        </button>
    {% endcall %}
{% endcall %}
{% endmacro %}

{#
  Modal Container - Placeholder for dynamic modal content

  Usage: Add to page for HTMX modal support
  {{ modal_container() }}
#}
{% macro modal_container() %}
<div id="modal-container"
     hx-target="this"
     hx-swap="innerHTML"
     role="dialog"
     aria-live="polite"
     aria-label="Modal dialogs"></div>
{% endmacro %}
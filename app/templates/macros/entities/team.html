{% from "macros/expandable_card.html" import expandable_card, action_buttons_row %}
{% from "macros/ui_elements.html" import pluralized_count %}

{# Team member field configuration - clean, declarative setup #}
{% set team_field_config = {
    'badge_field': 'job_title',
    'badge_style': 'green',
    'title_field': 'name',
    'secondary_fields': [
        {'field': 'email', 'type': 'email'},
        {'field': 'company_assignments', 'type': 'count', 'label': 'company assignment'},
        {'field': 'opportunity_assignments', 'type': 'count', 'label': 'opportunity assignment'}
    ],
    'metadata_fields': [
        {'field': 'created_at', 'type': 'date', 'format': '%m/%d/%y'}
    ],
    'expanded_sections': [
        {
            'title': 'Team Member Details',
            'fields': [
                {'field': 'job_title', 'type': 'text', 'icon': 'user', 'label': 'Role'},
                {'field': 'email', 'type': 'email', 'icon': 'mail', 'label': 'Email'}
            ]
        },
        {
            'title': 'Quick Actions',
            'actions': [
                {'label': 'Assign to Company', 'onclick': 'assignToCompany(' + '{{ member.id }}' + ')', 'style': 'primary'},
                {'label': 'Assign to Opportunity', 'onclick': 'assignToOpportunity(' + '{{ member.id }}' + ')', 'style': 'secondary'},
                {'label': 'Create Task', 'onclick': 'createTask(\'user\', ' + '{{ member.id }}' + ')', 'style': 'accent'}
            ],
            'stats': [
                {'field': 'company_assignments', 'type': 'count', 'label': 'company assignment'},
                {'field': 'opportunity_assignments', 'type': 'count', 'label': 'opportunity assignment'}
            ]
        }
    ]
} %}

{% macro render_team_member(member) %}
{{ expandable_card('team', member, member.id,
    expansion_enabled=true,
    field_config=team_field_config,
    action_buttons=action_buttons_row('team', member.id)) }}
{% endmacro %}

{% macro team_member_expanded_content(member) %}
<div class="expanded-content-grid">
    <!-- Team Member Details -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Team Member Details</h4>
        <div class="space-y-2 text-sm">
            {% if member.job_title %}
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>{{ member.job_title }}</span>
                </div>
            {% endif %}
            {% if member.email %}
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <a href="mailto:{{ member.email }}" class="text-blue-600 hover:text-blue-800">
                        {{ member.email }}
                    </a>
                </div>
            {% endif %}
            {% if not member.job_title and not member.email %}
                <p class="text-gray-500 italic">No additional member information available</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Assignments and Quick Actions -->
    <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Assignments & Actions</h4>
        
        <!-- Current Assignments -->
        <div class="mb-4">
            {% set company_count = member.get_company_assignments()|length if member.get_company_assignments else 0 %}
            {% set opportunity_count = member.get_opportunity_assignments()|length if member.get_opportunity_assignments else 0 %}
            
            <div class="flex flex-wrap gap-2 mb-3">
                {% if company_count > 0 %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm">
                        {{ pluralized_count(company_count, 'company assignment') }}
                    </span>
                {% endif %}
                {% if opportunity_count > 0 %}
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-md text-sm">
                        {{ pluralized_count(opportunity_count, 'opportunity assignment') }}
                    </span>
                {% endif %}
                {% if company_count == 0 and opportunity_count == 0 %}
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-md text-sm">
                        No assignments
                    </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions-grid">
            <button @click.stop="assignToCompany({{ member.id }})" 
                    class="quick-action-btn quick-action-btn-primary">
                Assign to Company
            </button>
            <button @click.stop="assignToOpportunity({{ member.id }})" 
                    class="quick-action-btn quick-action-btn-secondary">
                Assign to Opportunity
            </button>
            <button @click.stop="createTask('user', {{ member.id }})" 
                    class="quick-action-btn quick-action-btn-accent">
                Create Task
            </button>
        </div>
    </div>
</div>
{% endmacro %}
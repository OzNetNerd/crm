{#
  Generic Task Section Renderer - DRY solution for tasks/_content.html
  
  Eliminates massive code duplication by handling all section types through configuration.
  Replaces ~300 lines of repetitive code with single configurable macro.
  
  Uses Jinja's include/extend capabilities and proper template inheritance patterns.
#}
{% from "macros/expandable_card.html" import expandable_card, task_header_content, task_title_content, task_metadata_content, action_buttons_row %}
{% from "macros/ui_elements.html" import section_group_header %}
{% from "macros/base/icons.html" import clipboard_list_icon, bolt_icon, check_circle_icon_solid, fire_icon_solid, exclamation_triangle_icon, exclamation_circle_icon_solid, calendar_days_icon, calendar_icon, chart_bar_icon, question_mark_circle_icon, building_office_icon, user_icon, currency_dollar_icon %}

{#
  Generic task section renderer - handles all section types
  
  Parameters:
  - section_key: unique identifier (e.g., 'todo', 'high', 'overdue')
  - section_title: display title  
  - section_icon: icon HTML content
  - card_classes: CSS classes for container
  - colors: dict with border_color, bg_color, hover_color, text_class, badge_color
  - filter_type: 'status'|'priority'|'entity'|'date'
  - filter_value: value to match (for status/priority/entity) or date condition (for date)
  - filtered_tasks: list of task objects
  - group_key: group identifier
  - today: today's date
  - special_styling: optional additional classes
  - task_count: pre-calculated count (for date sections)
#}
{% macro render_task_section(section_key, section_title, section_icon, card_classes, colors, filter_type, filter_value, filtered_tasks, group_key, today, special_styling='', task_count=none) %}
<div class="{{ card_classes }}">
    {{ section_group_header(
        section_key,
        section_title,
        section_icon|safe,
        '<span class="ml-2 badge-standard badge-' + colors.badge_color + '">' + (task_count|string if task_count is not none else get_section_count(filtered_tasks, filter_type, filter_value, today)|string) + '</span>',
        colors.border_color,
        colors.bg_color,
        colors.hover_color,
        colors.text_class
    ) }}
    <div class="p-6" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% set rendered_tasks = [] %}
        {% for task in filtered_tasks %}
            {% if task.task_type != 'child' and should_show_task(task, filter_type, filter_value, today) %}
                {% set _ = rendered_tasks.append(task) %}
                <div {% if special_styling %}class="{{ special_styling }}"{% endif %}>
                    {{ expandable_card('task', task, task.id,
                        expansion_enabled=true,
                        group_key=group_key,
                        badge_content=task_header_content(task),
                        title_content=task_title_content(task),
                        metadata_content=task_metadata_content(task),
                        action_buttons=action_buttons_row('task', task.id)) }}
                </div>
            {% endif %}
        {% endfor %}
        {% if rendered_tasks|length == 0 %}
            <p class="text-empty-state">No matching tasks found</p>
        {% endif %}
    </div>
</div>
{% endmacro %}

{#
  Helper function to determine if a task should be shown based on filter criteria
#}
{% macro should_show_task(task, filter_type, filter_value, today) %}
    {% if filter_type == 'status' %}
        {{ task.status == filter_value }}
    {% elif filter_type == 'priority' %}
        {{ task.priority == filter_value }}
    {% elif filter_type == 'entity' %}
        {% if filter_value == 'unrelated' %}
            {{ not task.entity_type or task.entity_type == 'unrelated' }}
        {% else %}
            {{ task.entity_type == filter_value }}
        {% endif %}
    {% elif filter_type == 'date_overdue' %}
        {{ task.due_date and (task.due_date - today).days < 0 }}
    {% elif filter_type == 'date_today' %}
        {{ task.due_date and (task.due_date - today).days == 0 }}
    {% elif filter_type == 'date_this_week' %}
        {{ task.due_date and (task.due_date - today).days > 0 and (task.due_date - today).days <= 7 }}
    {% elif filter_type == 'date_later' %}
        {{ task.due_date and (task.due_date - today).days > 7 }}
    {% elif filter_type == 'date_no_date' %}
        {{ not task.due_date }}
    {% else %}
        {{ false }}
    {% endif %}
{% endmacro %}

{#
  Helper function to get section count
#}
{% macro get_section_count(filtered_tasks, filter_type, filter_value, today) %}
    {% set count = 0 %}
    {% for task in filtered_tasks %}
        {% if should_show_task(task, filter_type, filter_value, today) and task.task_type != 'child' %}
            {% set count = count + 1 %}
        {% endif %}
    {% endfor %}
    {{ count }}
{% endmacro %}

{#
  Status Sections - Three simple macro calls replace ~75 lines
#}
{% macro render_status_sections(filtered_tasks, today, show_completed=false) %}
    {{ render_task_section('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), 'card',
        {'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-header', 'badge_color': 'blue'},
        'status', 'todo', filtered_tasks, 'todo', today) }}

    {{ render_task_section('in-progress', 'In Progress', bolt_icon("w-5 h-5 mr-1"), 'card',
        {'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-header', 'badge_color': 'yellow'},
        'status', 'in-progress', filtered_tasks, 'in-progress', today) }}

    {% if show_completed %}
    {{ render_task_section('complete', 'Completed', check_circle_icon_solid("w-5 h-5 mr-1"), 'card',
        {'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-header', 'badge_color': 'green'},
        'status', 'complete', filtered_tasks, 'complete', today, special_styling='opacity-60') }}
    {% endif %}
{% endmacro %}

{#
  Priority Sections - Three macro calls replace ~75 lines
#}
{% macro render_priority_sections(filtered_tasks, today) %}
    {{ render_task_section('high', 'High Priority', fire_icon_solid("w-5 h-5 mr-1"), 'card-danger',
        {'border_color': 'red', 'bg_color': 'red', 'hover_color': 'red', 'text_class': 'text-status-overdue', 'badge_color': 'red'},
        'priority', 'high', filtered_tasks, 'high', today) }}

    {{ render_task_section('medium', 'Medium Priority', exclamation_triangle_icon("w-5 h-5 mr-1"), 'card-warning',
        {'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-warning', 'badge_color': 'yellow'},
        'priority', 'medium', filtered_tasks, 'medium', today) }}

    {{ render_task_section('low', 'Low Priority', clipboard_list_icon("w-5 h-5 mr-1"), 'card-success',
        {'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-success', 'badge_color': 'green'},
        'priority', 'low', filtered_tasks, 'low', today) }}
{% endmacro %}

{#
  Due Date Sections - Five macro calls replace ~150 lines
  Pre-calculate counts manually since Jinja filter chains are complex
#}
{% macro render_due_date_sections(filtered_tasks, today) %}
    {# Pre-calculate counts manually #}
    {% set overdue_count = [] %}
    {% set today_count = [] %}
    {% set this_week_count = [] %}
    {% set later_count = [] %}
    {% set no_date_count = [] %}
    
    {% for task in filtered_tasks %}
        {% if task.task_type != 'child' %}
            {% if task.due_date %}
                {% set days_diff = (task.due_date - today).days %}
                {% if days_diff < 0 %}{% set _ = overdue_count.append(task) %}
                {% elif days_diff == 0 %}{% set _ = today_count.append(task) %}
                {% elif days_diff <= 7 %}{% set _ = this_week_count.append(task) %}
                {% else %}{% set _ = later_count.append(task) %}
                {% endif %}
            {% else %}
                {% set _ = no_date_count.append(task) %}
            {% endif %}
        {% endif %}
    {% endfor %}

    {{ render_task_section('overdue', 'Overdue', exclamation_circle_icon_solid("w-5 h-5 mr-1"), 'card-danger',
        {'border_color': 'red', 'bg_color': 'red', 'hover_color': 'red', 'text_class': 'text-status-overdue', 'badge_color': 'red'},
        'date_overdue', '', filtered_tasks, 'overdue', today, task_count=overdue_count|length) }}

    {{ render_task_section('today', 'Due Today', calendar_days_icon("w-5 h-5 mr-1"), 'card-orange',
        {'border_color': 'orange', 'bg_color': 'orange', 'hover_color': 'orange', 'text_class': 'text-status-warning', 'badge_color': 'orange'},
        'date_today', '', filtered_tasks, 'today', today, task_count=today_count|length) }}

    {{ render_task_section('this_week', 'This Week', calendar_icon("w-5 h-5 mr-1"), 'card-info',
        {'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-info', 'badge_color': 'blue'},
        'date_this_week', '', filtered_tasks, 'this_week', today, task_count=this_week_count|length) }}

    {{ render_task_section('later', 'Later', chart_bar_icon("w-5 h-5 mr-1"), 'card-neutral',
        {'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral', 'badge_color': 'gray'},
        'date_later', '', filtered_tasks, 'later', today, task_count=later_count|length) }}

    {{ render_task_section('no_date', 'No Due Date', question_mark_circle_icon("w-5 h-5 mr-1"), 'card-neutral',
        {'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral', 'badge_color': 'gray'},
        'date_no_date', '', filtered_tasks, 'no_date', today, task_count=no_date_count|length) }}
{% endmacro %}

{#
  Entity Sections - Four macro calls replace ~75 lines  
#}
{% macro render_entity_sections(filtered_tasks, today) %}
    {{ render_task_section('company', 'Company Tasks', building_office_icon("w-5 h-5 mr-1"), 'card-info',
        {'border_color': 'blue', 'bg_color': 'blue', 'hover_color': 'blue', 'text_class': 'text-status-info', 'badge_color': 'blue'},
        'entity', 'company', filtered_tasks, 'company', today) }}

    {{ render_task_section('contact', 'Stakeholder Tasks', user_icon("w-5 h-5 mr-1"), 'card-success',
        {'border_color': 'green', 'bg_color': 'green', 'hover_color': 'green', 'text_class': 'text-status-success', 'badge_color': 'green'},
        'entity', 'contact', filtered_tasks, 'contact', today) }}

    {{ render_task_section('opportunity', 'Opportunity Tasks', currency_dollar_icon("w-5 h-5 mr-1"), 'card-warning',
        {'border_color': 'yellow', 'bg_color': 'yellow', 'hover_color': 'yellow', 'text_class': 'text-status-warning', 'badge_color': 'yellow'},
        'entity', 'opportunity', filtered_tasks, 'opportunity', today) }}

    {{ render_task_section('unrelated', 'General Tasks', clipboard_list_icon("w-5 h-5 mr-1"), 'card-neutral',
        {'border_color': 'gray', 'bg_color': 'gray', 'hover_color': 'gray', 'text_class': 'text-status-neutral', 'badge_color': 'gray'},
        'entity', 'unrelated', filtered_tasks, 'unrelated', today) }}
{% endmacro %}
{#
  Entity Linker Widget - Clean macro for entity search and selection
  
  Uses the entityLinker Alpine.js component for state management.
  Provides a clean separation between template rendering and JavaScript logic.
#}

{% from 'macros/base/icons.html' import icon %}

{% macro entity_linker(field_name, placeholder="Search companies, contacts, opportunities...", selected_entities=[], entity_types="company,contact,opportunity") %}
<div x-data="entityLinker({
       fieldName: '{{ field_name }}',
       selectedEntities: {{ selected_entities | tojson }},
       entityTypes: '{{ entity_types }}'
     })"
     @click.away="closeDropdown()"
     @keydown="onKeydown($event)">
    
    <!-- Selected Entities (Badges) -->
    <div class="mb-2" x-show="selectedEntities.length > 0">
        <div class="flex flex-wrap gap-2">
            <template x-for="(entity, index) in selectedEntities" :key="`${entity.type}-${entity.id}`">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border"
                      :class="getEntityTypeBadgeClass(entity.type)">
                    <span x-text="getEntityTypeIcon(entity.type)" class="mr-1"></span>
                    <span x-text="entity.name"></span>
                    <button @click="removeEntity(index)" 
                            type="button"
                            class="ml-1 text-current hover:text-red-600">
                        {{ icon('x-mark', 'xs') }}
                    </button>
                </span>
            </template>
        </div>
    </div>
    
    <!-- Search Input -->
    <div class="relative">
        <input type="text" 
               x-model="search"
               @input.debounce.300ms="searchEntities()"
               @focus="searchEntities(true)"
               placeholder="{{ placeholder }}"
               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               autocomplete="off">
        
        <!-- Loading indicator -->
        <div x-show="isSearching" class="absolute right-3 top-2">
            {{ icon('spinner', 'sm', 'animate-spin text-gray-400') }}
        </div>
        
        <!-- Dropdown -->
        <div x-show="showDropdown" 
             class="absolute z-[9999] w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
            <template x-for="(suggestion, index) in suggestions" :key="`${suggestion.type}-${suggestion.id}`">
                <button type="button"
                        @click="selectEntity(suggestion)"
                        class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center space-x-2 border-b border-gray-100 last:border-b-0">
                    <span x-text="getEntityTypeIcon(suggestion.type)" class="text-sm"></span>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate" x-text="suggestion.title"></div>
                        <div class="text-xs-gray-500 truncate" x-text="suggestion.subtitle"></div>
                    </div>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                          :class="getEntityTypeBadgeClass(suggestion.type)"
                          x-text="suggestion.type">
                    </span>
                </button>
            </template>
            
            <div x-show="suggestions.length === 0 && search.length >= 2 && !isSearching" 
                 class="px-3 py-2 text-sm text-gray-500">
                No results found
            </div>
        </div>
    </div>
    
    <!-- Hidden field to store the selected entities as JSON -->
    <input type="hidden" name="{{ field_name }}" :value="JSON.stringify(selectedEntities)">
</div>
{% endmacro %}
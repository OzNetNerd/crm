{#
  Simplified Card System - Consolidated card macros

  30% code reduction by merging scattered card components.
  Two main macros: simple_card for 80% of cases, advanced_card for complex needs.
#}

{% from 'macros/icons.html' import icon %}
{% from 'macros/ui/badges.html' import status_badge, priority_badge %}
{% from 'macros/ui/date_formatting.html' import smart_date_display %}

{#
  Simple Card - Covers 80% of card use cases

  Parameters:
  - entity (required): Entity object to display
  - show_actions (optional): Show action buttons (default: true)
  - expandable (optional): Allow expand/collapse (default: false)
  - class (optional): Additional CSS classes

  Usage:
  {{ simple_card(task) }}
  {{ simple_card(company, show_actions=false) }}
#}
{% macro simple_card(entity, show_actions=true, expandable=false, class='') %}
{% set entity_type = entity.__class__.__name__.lower() %}
{% set metadata = get_model_metadata(entity_type) if get_model_metadata else {} %}

<div class="card bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow {{ class }}"
     data-entity-type="{{ entity_type }}"
     data-entity-id="{{ entity.id }}">

    {# Card Header #}
    <div class="card-header flex items-start justify-between mb-3">
        <div class="flex-1">
            {# Title with entity icon #}
            <div class="flex items-center gap-2 mb-1">
                <span class="icon-{{ entity_type }} c-icon c-icon--sm"></span>
                <h3 class="text-base font-semibold text-gray-900 truncate">
                    {{ entity.name or entity.title or entity.subject or 'Untitled' }}
                </h3>
            </div>

            {# Subtitle/Description #}
            {% if entity.description or entity.company_name or entity.email %}
            <p class="text-sm text-gray-600 truncate">
                {{ entity.description or entity.company_name or entity.email }}
            </p>
            {% endif %}
        </div>

        {# Status/Priority Badge #}
        {% if entity.status %}
        <div class="ml-2">
            {{ status_badge(entity.status, entity_type=entity_type) }}
        </div>
        {% elif entity.priority %}
        <div class="ml-2">
            {{ priority_badge(entity.priority) }}
        </div>
        {% endif %}
    </div>

    {# Card Body - Key Fields #}
    <div class="card-body space-y-2 text-sm">
        {# Date field if exists #}
        {% if entity.due_date or entity.created_at or entity.last_contact %}
        <div class="flex items-center text-gray-600">
            {{ icon('calendar', 'w-4 h-4', 'mr-1') }}
            {{ smart_date_display(entity.due_date or entity.created_at or entity.last_contact) }}
        </div>
        {% endif %}

        {# Value/Amount field if exists #}
        {% if entity.value or entity.amount %}
        <div class="flex items-center text-gray-600">
            {{ icon('currency-dollar', 'w-4 h-4', 'mr-1') }}
            ${{ "{:,.2f}".format(entity.value or entity.amount) }}
        </div>
        {% endif %}

        {# Owner/Assigned field if exists #}
        {% if entity.owner or entity.assigned_to %}
        <div class="flex items-center text-gray-600">
            {{ icon('user', 'w-4 h-4', 'mr-1') }}
            {{ entity.owner or entity.assigned_to }}
        </div>
        {% endif %}
    </div>

    {# Card Actions #}
    {% if show_actions %}
    <div class="card-actions flex items-center justify-end mt-3 pt-3 border-t space-x-2">
        <button onclick="window.dispatchEvent(new CustomEvent('open-detail-{{ entity_type }}-modal', { detail: { id: {{ entity.id }}, readOnly: true } }))"
                class="text-blue-600 hover:text-blue-800 p-1" title="View">
            {{ icon('eye', 'w-4 h-4') }}
        </button>
        <button onclick="window.dispatchEvent(new CustomEvent('open-detail-{{ entity_type }}-modal', { detail: { id: {{ entity.id }} } }))"
                class="text-gray-600 hover:text-gray-800 p-1" title="Edit">
            {{ icon('pencil', 'w-4 h-4') }}
        </button>
        <button hx-delete="/api/{{ entity_type }}s/{{ entity.id }}"
                hx-confirm="Are you sure you want to delete this {{ entity_type }}?"
                class="text-red-600 hover:text-red-800 p-1" title="Delete">
            {{ icon('trash', 'w-4 h-4') }}
        </button>
    </div>
    {% endif %}

    {# Expandable Section #}
    {% if expandable %}
    <div x-data="{ expanded: false }" class="mt-3">
        <button @click="expanded = !expanded" class="text-sm text-blue-600 hover:text-blue-800">
            <span x-show="!expanded">Show more {{ icon('chevron-down', 'w-3 h-3', 'inline') }}</span>
            <span x-show="expanded">Show less {{ icon('chevron-up', 'w-3 h-3', 'inline') }}</span>
        </button>
        <div x-show="expanded" x-collapse class="mt-3 pt-3 border-t">
            {{ caller() if caller else '' }}
        </div>
    </div>
    {% endif %}
</div>
{% endmacro %}

{#
  Advanced Card - For complex card requirements

  Parameters:
  - entity (required): Entity object
  - header (optional): Custom header content
  - body (optional): Custom body content
  - footer (optional): Custom footer content
  - config (optional): Configuration object for advanced features

  Usage:
  {% call advanced_card(entity) %}
    {% set header %}Custom header content{% endset %}
    {% set body %}Custom body content{% endset %}
    {% set footer %}Custom footer content{% endset %}
  {% endcall %}
#}
{% macro advanced_card(entity, header='', body='', footer='', config={}) %}
{% set entity_type = entity.__class__.__name__.lower() %}
{% set default_config = {
    'expandable': true,
    'collapsible': false,
    'show_actions': true,
    'custom_actions': [],
    'class': '',
    'header_class': '',
    'body_class': '',
    'footer_class': ''
} %}
{% set final_config = default_config.update(config) or default_config %}

<div class="advanced-card bg-white rounded-lg shadow-sm border border-gray-200 {{ final_config.class }}"
     {% if final_config.collapsible %}x-data="{ collapsed: false }"{% endif %}
     data-entity-type="{{ entity_type }}"
     data-entity-id="{{ entity.id }}">

    {# Card Header #}
    <div class="card-header p-4 {{ final_config.header_class }}">
        {% if header %}
            {{ header }}
        {% else %}
            <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold text-gray-900">
                    {{ entity.name or entity.title or 'Untitled' }}
                </h3>
                {% if final_config.collapsible %}
                <button @click="collapsed = !collapsed" class="text-gray-400 hover:text-gray-600">
                    {{ icon('chevron-down', 'w-5 h-5', 'transform transition-transform" :class="{\'rotate-180\': collapsed}') }}
                </button>
                {% endif %}
            </div>
        {% endif %}
    </div>

    {# Card Body #}
    <div class="card-body p-4 border-t {{ final_config.body_class }}"
         {% if final_config.collapsible %}x-show="!collapsed" x-collapse{% endif %}>
        {% if body %}
            {{ body }}
        {% else %}
            {{ caller() if caller else 'No content' }}
        {% endif %}
    </div>

    {# Card Footer #}
    {% if footer or final_config.show_actions %}
    <div class="card-footer p-4 border-t bg-gray-50 {{ final_config.footer_class }}">
        {% if footer %}
            {{ footer }}
        {% elif final_config.show_actions %}
            <div class="flex items-center justify-end space-x-2">
                {% for action in final_config.custom_actions %}
                <button onclick="{{ action.onclick }}" class="{{ action.class }}" title="{{ action.title }}">
                    {{ icon(action.icon, 'w-4 h-4') if action.icon else action.text }}
                </button>
                {% endfor %}
                {% if not final_config.custom_actions %}
                <button class="btn-sm btn-secondary">View</button>
                <button class="btn-sm btn-primary">Edit</button>
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endmacro %}

{#
  Card Grid - Container for card layouts

  Parameters:
  - cards (required): List of entities to display as cards
  - columns (optional): Number of columns (1-4, default: 3)
  - card_macro (optional): Which card macro to use (default: 'simple_card')

  Usage:
  {{ card_grid(tasks) }}
  {{ card_grid(companies, columns=4) }}
#}
{% macro card_grid(cards, columns=3, card_macro='simple_card') %}
{% set grid_class = {
    1: 'grid-cols-1',
    2: 'grid-cols-1 md:grid-cols-2',
    3: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
    4: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'
} %}
<div class="card-grid grid {{ grid_class[columns] }} gap-4">
    {% for entity in cards %}
        {% if card_macro == 'simple_card' %}
            {{ simple_card(entity) }}
        {% else %}
            {{ advanced_card(entity) }}
        {% endif %}
    {% endfor %}
</div>
{% endmacro %}
{#
  Modular Card System - Flexible container-based approach with object composition
  
  This system provides:
  - Universal card container that accepts content objects
  - Composable content blocks (header, body, actions, footer)
  - Field renderers for all common data types
  - Smart entity configuration system
  - Full backwards compatibility via adapter macros
  
  Core Philosophy:
  Instead of one massive macro with 20+ parameters, we use:
  1. A simple card container
  2. Content objects that define what to display
  3. Flexible field renderers that work with any data
  4. Configuration-driven approach for DRY code
#}

{% from "macros/ui_elements.html" import bulk_selection_checkbox, pluralized_count %}
{% from "macros/ui/progress.html" import progress_bar %}

{# ========== CORE CARD CONTAINER ========== #}

{#
  Universal Card Container - The foundation of the new system
  
  This replaces the massive expandable_card macro with a simple, flexible container
  that accepts content objects to define what gets displayed.
  
  Parameters:
  - card_type (required): Entity type for styling and data attributes
  - entity_id (required): Unique identifier
  - expansion_enabled (optional): Allow expand/collapse (default: true)
  - card_classes (optional): Additional CSS classes
  - content (required): Content object with sections
  
  Content Object Structure:
  {
    'header': { /* header content config */ },
    'body': { /* body content config */ },
    'actions': { /* action buttons config */ },
    'footer': { /* footer content config */ },
    'expanded': { /* expanded content config */ }
  }
  
  Usage:
  {{ card_container('task', task.id, content=task_content_config) }}
#}
{% macro card_container(card_type, entity_id, expansion_enabled=true, card_classes='', content={}) %}
{%- set base_classes = card_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50', 
    'contact': 'ring-2 ring-green-200 bg-green-50',
    'stakeholder': 'ring-2 ring-green-200 bg-green-50',
    'company': 'ring-2 ring-blue-200 bg-blue-50'
} -%}

{% if expansion_enabled %}
<details class="{{ base_classes }} {{ color_classes.get(card_type, '') }} {{ card_classes }}" 
         data-{{ card_type }}-id="{{ entity_id }}">
    <summary class="cursor-pointer list-none flex items-center justify-between">
        <div class="flex-1 flex items-center justify-between">
            <!-- Header content -->
            <div class="flex items-center space-x-3">
                {% if content.get('bulk_selection', true) %}
                {{ bulk_selection_checkbox(entity_id) }}
                {% endif %}
                
                {% if content.header %}
                {{ render_content_section(content.header) }}
                {% endif %}
            </div>
            
            <!-- Action buttons -->
            {% if content.actions %}
            <div class="flex items-center space-x-2">
                {{ render_action_section(content.actions) }}
            </div>
            {% endif %}
            
            <!-- Expand chevron -->
            <div class="ml-4 transition-transform duration-200 details-chevron">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </summary>
    
    <!-- Expanded content -->
    <div class="mt-4 pt-4 border-t border-gray-200">
        {% if content.body %}
        {{ render_content_section(content.body) }}
        {% endif %}
        
        {% if content.expanded %}
        {{ render_content_section(content.expanded) }}
        {% endif %}
        
        {% if content.footer %}
        {{ render_content_section(content.footer) }}
        {% endif %}
        
        {% if caller %}
        {{ caller() }}
        {% endif %}
    </div>
</details>
{% else %}
<!-- Non-expandable version -->
<div class="{{ base_classes }} {{ color_classes.get(card_type, '') }} {{ card_classes }}" 
     data-{{ card_type }}-id="{{ entity_id }}">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-1">
            {% if content.get('bulk_selection', true) %}
            {{ bulk_selection_checkbox(entity_id) }}
            {% endif %}
            
            {% if content.header %}
            {{ render_content_section(content.header) }}
            {% endif %}
        </div>
        
        {% if content.actions %}
        <div class="flex items-center space-x-2">
            {{ render_action_section(content.actions) }}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<style>
/* Universal chevron rotation for all card types */
details[data-task-id] summary::-webkit-details-marker,
details[data-opportunity-id] summary::-webkit-details-marker,
details[data-contact-id] summary::-webkit-details-marker,
details[data-stakeholder-id] summary::-webkit-details-marker,
details[data-company-id] summary::-webkit-details-marker {
    display: none;
}
details[open] .details-chevron {
    transform: rotate(180deg);
}
</style>
{% endmacro %}

{# ========== CONTENT RENDERERS ========== #}

{#
  Content Section Renderer - Renders any content section based on its configuration
  
  Supports multiple content types:
  - 'fields': Array of field configurations to render
  - 'html': Raw HTML content
  - 'template': Template path to include
  - 'composite': Multiple sub-sections
  
  Parameters:
  - section_config: Configuration object defining what to render
  
  Usage:
  {{ render_content_section({'type': 'fields', 'fields': field_array, 'entity': entity}) }}
#}
{% macro render_content_section(section_config) %}
{% if section_config.type == 'fields' %}
    {{ render_field_section(section_config) }}
{% elif section_config.type == 'html' %}
    {{ section_config.content|safe }}
{% elif section_config.type == 'template' %}
    {% include section_config.template %}
{% elif section_config.type == 'composite' %}
    {% for subsection in section_config.sections %}
        {{ render_content_section(subsection) }}
    {% endfor %}
{% endif %}
{% endmacro %}

{#
  Field Section Renderer - Renders an array of fields with layout
  
  Parameters:
  - section_config: Must contain 'fields' array and 'entity' object
  - layout options: 'inline', 'stacked', 'grid'
  
  Usage:
  {{ render_field_section({
      'fields': [
          {'name': 'title', 'type': 'text', 'classes': 'text-lg font-medium'},
          {'name': 'status', 'type': 'badge', 'style': 'blue'}
      ],
      'entity': task,
      'layout': 'inline'
  }) }}
#}
{% macro render_field_section(section_config) %}
{%- set layout = section_config.get('layout', 'stacked') -%}
{%- set entity = section_config.entity -%}

{% if layout == 'inline' %}
<div class="flex items-center space-x-2">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% elif layout == 'grid' %}
<div class="grid grid-cols-2 gap-4">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% else %} {# stacked layout #}
<div class="space-y-2">
    {% for field in section_config.fields %}
        <div class="{{ field.get('classes', '') }}">
            {{ render_field(entity, field) }}
        </div>
    {% endfor %}
</div>
{% endif %}
{% endmacro %}

{# ========== ENHANCED FIELD RENDERER ========== #}

{#
  Enhanced Universal Field Renderer - Handles all data types with flexible configuration
  
  Supported field types:
  - text: Simple text display with optional prefix/suffix
  - badge: Status/category badges with color schemes
  - date: Date formatting with multiple format options
  - currency: Money formatting with symbols
  - count: Pluralized counting with custom labels
  - link: Clickable links with optional icons
  - email: Email links with mailto
  - phone: Phone links with tel
  - progress: Progress bars with percentages
  - relationship: Nested object field access
  - custom: Custom rendering function
  
  Parameters:
  - entity: Source object containing the data
  - field_config: Configuration object defining how to render
  
  Field Config Structure:
  {
    'name': 'field_name',          // Field name on entity (required)
    'type': 'text',                // Renderer type (required)
    'label': 'Display Label',      // Optional label
    'classes': 'css-classes',      // Additional CSS classes
    'prefix': '$',                 // Text before value
    'suffix': '/month',            // Text after value
    'format': '%m/%d/%y',          // Date format string
    'style': 'blue',               // Badge color style
    'default': 'N/A',              // Default when field is empty
    'link_class': 'text-blue-600', // Link styling
    'render_fn': 'custom_function' // Custom renderer name
  }
#}
{% macro render_field(entity, field_config) %}
{%- set field_name = field_config.name -%}
{%- set field_value = entity[field_name] if field_name in entity else None -%}
{%- set field_type = field_config.get('type', 'text') -%}
{%- set default_value = field_config.get('default', '') -%}

{% if not field_value and field_type != 'custom' %}
    {% if default_value %}
        <span class="text-gray-500">{{ default_value }}</span>
    {% endif %}
{% else %}
    {% if field_type == 'text' %}
        {{ field_config.get('prefix', '') }}{{ field_value }}{{ field_config.get('suffix', '') }}
    
    {% elif field_type == 'badge' %}
        <span class="badge-standard badge-{{ field_config.get('style', 'blue') }}">
            {{ field_value }}
        </span>
    
    {% elif field_type == 'date' %}
        {% if field_value %}
            {{ field_value.strftime(field_config.get('format', '%m/%d/%y')) }}
        {% endif %}
    
    {% elif field_type == 'currency' %}
        {% if field_value is number %}
            {{ field_config.get('symbol', '$') }}{{ "{:,.0f}".format(field_value) }}
        {% else %}
            {{ field_value }}
        {% endif %}
    
    {% elif field_type == 'count' %}
        {% if field_value is iterable %}
            {{ pluralized_count(field_value|length, field_config.get('label', 'item')) }}
        {% else %}
            {{ pluralized_count(field_value, field_config.get('label', 'item')) }}
        {% endif %}
    
    {% elif field_type == 'link' %}
        {% if field_value %}
            <a href="{{ field_value }}" target="_blank" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_config.get('text', field_value) }}
            </a>
        {% endif %}
    
    {% elif field_type == 'email' %}
        {% if field_value %}
            <a href="mailto:{{ field_value }}" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_value }}
            </a>
        {% endif %}
    
    {% elif field_type == 'phone' %}
        {% if field_value %}
            <a href="tel:{{ field_value }}" 
               class="{{ field_config.get('link_class', 'text-blue-600 hover:text-blue-800') }}"
               onclick="event.stopPropagation()">
                {{ field_value }}
            </a>
        {% endif %}
    
    {% elif field_type == 'progress' %}
        {% if field_value is number %}
            {{ progress_bar(
                field_value, 
                field_config.get('max_value', 100),
                field_config.get('color_scheme', 'blue'),
                field_config.get('label')
            ) }}
        {% endif %}
    
    {% elif field_type == 'relationship' %}
        {% set related_object = field_value %}
        {% set related_field = field_config.get('related_field', 'name') %}
        {% if related_object and related_field in related_object %}
            {{ related_object[related_field] }}
        {% endif %}
    
    {% elif field_type == 'custom' %}
        {# Custom rendering - call named macro if specified #}
        {% set render_fn = field_config.get('render_fn') %}
        {% if render_fn == 'task_priority' %}
            {{ render_task_priority(entity) }}
        {% elif render_fn == 'opportunity_stage' %}
            {{ render_opportunity_stage(entity) }}
        {% else %}
            {{ field_value }}
        {% endif %}
    
    {% else %}
        {# Fallback to simple text display #}
        {{ field_value }}
    {% endif %}
{% endif %}
{% endmacro %}

{# ========== ACTION SECTION RENDERER ========== #}

{#
  Action Section Renderer - Renders action buttons based on configuration
  
  Parameters:
  - action_config: Configuration object with action definitions
  
  Action Config Structure:
  {
    'type': 'buttons',             // Action section type
    'actions': [                   // Array of action definitions
        {
            'type': 'edit',        // Action type (edit, delete, custom)
            'onclick': 'fn(id)',   // JavaScript function call
            'icon': 'icon_html',   // Icon HTML
            'title': 'tooltip',    // Hover tooltip
            'classes': 'css'       // Additional CSS classes
        }
    ]
  }
#}
{% macro render_action_section(action_config) %}
{% if action_config.type == 'buttons' %}
    <div class="flex items-center space-x-1">
        {% for action in action_config.actions %}
            {{ render_action_button(action) }}
        {% endfor %}
    </div>
{% elif action_config.type == 'dropdown' %}
    {# Future enhancement: dropdown action menus #}
    <!-- Dropdown actions not yet implemented -->
{% elif action_config.type == 'custom' %}
    {{ action_config.content|safe }}
{% endif %}
{% endmacro %}

{#
  Individual Action Button Renderer
#}
{% macro render_action_button(action) %}
{% from "macros/base/icons.html" import pencil_icon, trash_icon, check_icon %}

{%- set default_icons = {
    'edit': pencil_icon("w-4 h-4"),
    'delete': trash_icon("w-4 h-4"), 
    'complete': check_icon("w-4 h-4")
} -%}

{%- set default_classes = {
    'edit': 'text-info-hover hover:bg-blue-50',
    'delete': 'text-danger-hover hover:bg-red-50',
    'complete': 'text-success-hover hover:bg-green-50'
} -%}

<button @click.stop="{{ action.onclick }}" 
        class="px-2 py-1 rounded text-action-sm transition-colors duration-200 {{ action.get('classes', default_classes.get(action.type, '')) }}" 
        title="{{ action.get('title', action.type.title()) }}">
    {{ action.get('icon', default_icons.get(action.type, ''))|safe }}
</button>
{% endmacro %}

{# ========== ENTITY CONFIGURATION SYSTEM ========== #}

{#
  Auto Card - Simplified approach that directly renders the card
  
  This is much simpler than trying to build complex data structures in Jinja.
  Instead, we directly render the content based on entity type and configuration.
  
  Parameters:
  - entity_type: Type of entity (task, opportunity, contact, etc.)
  - entity: Entity object
  - expansion_enabled: Enable expand/collapse (default: true)
  - card_classes: Additional CSS classes
  - overrides: Optional configuration overrides
#}
{% macro auto_entity_card(entity_type, entity, expansion_enabled=true, card_classes='', overrides={}) %}
{%- set base_classes = entity_type + '-card card-padded relative mb-3' -%}
{%- set color_classes = {
    'task': 'ring-2 ring-gray-200 bg-gray-50',
    'opportunity': 'ring-2 ring-blue-200 bg-blue-50', 
    'contact': 'ring-2 ring-green-200 bg-green-50',
    'stakeholder': 'ring-2 ring-green-200 bg-green-50',
    'company': 'ring-2 ring-blue-200 bg-blue-50',
    'team': 'ring-2 ring-purple-200 bg-purple-50'
} -%}

{% if expansion_enabled %}
<details class="{{ base_classes }} {{ color_classes.get(entity_type, '') }} {{ card_classes }}" 
         data-{{ entity_type }}-id="{{ entity.id }}">
    <summary class="cursor-pointer list-none flex items-center justify-between">
        <div class="flex-1 flex items-center justify-between">
            <!-- Header content -->
            <div class="flex items-center space-x-3">
                {{ bulk_selection_checkbox(entity.id) }}
                
                <div class="flex-1">
                    {{ render_entity_header(entity_type, entity) }}
                </div>
            </div>
            
            <!-- Action buttons -->
            <div class="flex items-center space-x-2">
                {{ render_entity_actions(entity_type, entity.id) }}
            </div>
            
            <!-- Expand chevron -->
            <div class="ml-4 transition-transform duration-200 details-chevron">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </summary>
    
    <!-- Expanded content -->
    <div class="mt-4 pt-4 border-t border-gray-200">
        {{ render_entity_body(entity_type, entity) }}
    </div>
</details>
{% else %}
<!-- Non-expandable version -->
<div class="{{ base_classes }} {{ color_classes.get(entity_type, '') }} {{ card_classes }}" 
     data-{{ entity_type }}-id="{{ entity.id }}">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-1">
            {{ bulk_selection_checkbox(entity.id) }}
            
            <div class="flex-1">
                {{ render_entity_header(entity_type, entity) }}
            </div>
        </div>
        
        <div class="flex items-center space-x-2">
            {{ render_entity_actions(entity_type, entity.id) }}
        </div>
    </div>
</div>
{% endif %}

<style>
/* Universal chevron rotation for all card types */
details[data-task-id] summary::-webkit-details-marker,
details[data-opportunity-id] summary::-webkit-details-marker,
details[data-contact-id] summary::-webkit-details-marker,
details[data-stakeholder-id] summary::-webkit-details-marker,
details[data-company-id] summary::-webkit-details-marker,
details[data-team-id] summary::-webkit-details-marker {
    display: none;
}
details[open] .details-chevron {
    transform: rotate(180deg);
}
</style>
{% endmacro %}

{# ========== ENTITY RENDERERS ========== #}

{#
  Entity Header Renderer - Renders the main header content for each entity type
#}
{% macro render_entity_header(entity_type, entity) %}
{% if entity_type == 'task' %}
    <!-- Task header -->
    {% if entity.priority %}
        <div class="mb-1">
            <span class="badge-standard badge-{{ 'red' if entity.priority == 'high' else ('yellow' if entity.priority == 'medium' else 'green') }}">
                {{ entity.priority|title }}
            </span>
        </div>
    {% endif %}
    
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.description or entity.name or 'Untitled Task' }}</h3>
    </div>
    
    {% if entity.next_step_type %}
    <div class="mt-1 text-gray-600">{{ entity.next_step_type }}</div>
    {% endif %}
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.due_date %}Due: {{ entity.due_date.strftime('%d/%m/%y') }}{% endif %}
        {% if entity.created_at %}{% if entity.due_date %} • {% endif %}{{ entity.created_at.strftime('%m/%d/%y') }}{% endif %}
    </div>

{% elif entity_type == 'opportunity' %}
    <!-- Opportunity header -->
    {% if entity.stage %}
        <div class="mb-1">
            <span class="badge-standard badge-{{ 'green' if entity.stage == 'Prospect' else 'blue' }}">
                {{ entity.stage }}
            </span>
        </div>
    {% endif %}
    
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.name or 'Untitled Opportunity' }}</h3>
        {% if entity.value %}
        <span class="text-lg font-semibold text-gray-700">${{ "{:,.0f}".format(entity.value) }}</span>
        {% endif %}
    </div>
    
    {% if entity.company %}
    <div class="mt-1 text-gray-600">{{ entity.company.name }}</div>
    {% endif %}
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.close_date %}Close: {{ entity.close_date.strftime('%d/%m/%y') }}{% endif %}
        {% if entity.probability %}{% if entity.close_date %} • {% endif %}{{ entity.probability }}% probability{% endif %}
    </div>

{% elif entity_type == 'contact' or entity_type == 'stakeholder' %}
    <!-- Contact/Stakeholder header -->
    {% if entity.job_title %}
        <div class="mb-1">
            <span class="badge-standard badge-blue">{{ entity.job_title }}</span>
        </div>
    {% endif %}
    
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.name or 'Untitled Contact' }}</h3>
    </div>
    
    <div class="mt-1 space-y-1">
        {% if entity.company %}
        <div class="text-gray-600">{{ entity.company.name }}</div>
        {% endif %}
        {% if entity.email %}
        <div>
            <a href="mailto:{{ entity.email }}" class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation()">
                {{ entity.email }}
            </a>
        </div>
        {% endif %}
    </div>
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.phone %}{{ entity.phone }}{% endif %}
        {% if entity.created_at %}{% if entity.phone %} • {% endif %}{{ entity.created_at.strftime('%m/%d/%y') }}{% endif %}
    </div>

{% elif entity_type == 'company' %}
    <!-- Company header -->
    {% if entity.industry %}
        <div class="mb-1">
            <span class="badge-standard badge-blue">{{ entity.industry }}</span>
        </div>
    {% endif %}
    
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.name or 'Untitled Company' }}</h3>
    </div>
    
    {% if entity.website %}
    <div class="mt-1">
        <a href="{{ entity.website }}" target="_blank" class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation()">
            {{ entity.website }}
        </a>
    </div>
    {% endif %}
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.contacts %}{{ entity.contacts|length }} contact{{ 's' if entity.contacts|length != 1 else '' }}{% endif %}
        {% if entity.opportunities %}{% if entity.contacts %} • {% endif %}{{ entity.opportunities|length }} opportunit{{ 'ies' if entity.opportunities|length != 1 else 'y' }}{% endif %}
        {% if entity.created_at %}{% if entity.contacts or entity.opportunities %} • {% endif %}{{ entity.created_at.strftime('%m/%d/%y') }}{% endif %}
    </div>

{% elif entity_type == 'team' %}
    <!-- Team member header -->
    {% if entity.job_title %}
        <div class="mb-1">
            <span class="badge-standard badge-purple">{{ entity.job_title }}</span>
        </div>
    {% endif %}
    
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.name or 'Untitled Team Member' }}</h3>
    </div>
    
    <div class="mt-1 space-y-1">
        {% if entity.email %}
        <div>
            <a href="mailto:{{ entity.email }}" class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation()">
                {{ entity.email }}
            </a>
        </div>
        {% endif %}
        {% if entity.company %}
        <div class="text-gray-600">{{ entity.company.name }}</div>
        {% endif %}
    </div>
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.created_at %}{{ entity.created_at.strftime('%m/%d/%y') }}{% endif %}
    </div>

{% else %}
    <!-- Generic entity header -->
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">{{ entity.name or entity.title or 'Untitled' }}</h3>
    </div>
    
    <div class="mt-2 text-sm text-gray-500">
        {% if entity.created_at %}{{ entity.created_at.strftime('%m/%d/%y') }}{% endif %}
    </div>
{% endif %}
{% endmacro %}

{#
  Entity Body Renderer - Renders expanded content for each entity type
#}
{% macro render_entity_body(entity_type, entity) %}
{% if entity_type == 'task' %}
    <!-- Task expanded content -->
    {% if entity.notes %}
    <div class="text-sm text-gray-700">
        {{ entity.notes }}
    </div>
    {% endif %}

{% elif entity_type == 'opportunity' %}
    <!-- Opportunity expanded content -->
    {% if entity.description %}
    <div class="text-sm text-gray-700 mb-3">
        {{ entity.description }}
    </div>
    {% endif %}

{% elif entity_type == 'contact' or entity_type == 'stakeholder' %}
    <!-- Contact expanded content -->
    {% if entity.notes %}
    <div class="text-sm text-gray-700">
        {{ entity.notes }}
    </div>
    {% endif %}

{% elif entity_type == 'company' %}
    <!-- Company expanded content -->
    {% if entity.description %}
    <div class="text-sm text-gray-700">
        {{ entity.description }}
    </div>
    {% endif %}

{% else %}
    <!-- Generic expanded content -->
    {% if entity.description %}
    <div class="text-sm text-gray-700">
        {{ entity.description }}
    </div>
    {% endif %}
{% endif %}
{% endmacro %}

{#
  Entity Actions Renderer - Renders action buttons for each entity type
#}
{% macro render_entity_actions(entity_type, entity_id) %}
{% from "macros/base/icons.html" import pencil_icon, trash_icon, check_icon %}

{% if entity_type == 'task' %}
    <button @click.stop="completeTask({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-success-hover hover:bg-green-50" 
            title="Complete task">
        {{ check_icon("w-4 h-4") }}
    </button>
    <button @click.stop="editTask({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-info-hover hover:bg-blue-50" 
            title="Edit task">
        {{ pencil_icon("w-4 h-4") }}
    </button>
    <button @click.stop="deleteTask({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-danger-hover hover:bg-red-50" 
            title="Delete task">
        {{ trash_icon("w-4 h-4") }}
    </button>

{% elif entity_type == 'opportunity' %}
    <button @click.stop="editOpportunity({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-info-hover hover:bg-blue-50" 
            title="Edit opportunity">
        {{ pencil_icon("w-4 h-4") }}
    </button>

{% elif entity_type == 'contact' or entity_type == 'stakeholder' %}
    <button @click.stop="openStakeholderModal({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-info-hover hover:bg-blue-50" 
            title="Edit {{ entity_type }}">
        {{ pencil_icon("w-4 h-4") }}
    </button>
    <button @click.stop="deleteStakeholder({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-danger-hover hover:bg-red-50" 
            title="Delete {{ entity_type }}">
        {{ trash_icon("w-4 h-4") }}
    </button>

{% elif entity_type == 'company' %}
    <button @click.stop="editCompany({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-info-hover hover:bg-blue-50" 
            title="Edit company">
        {{ pencil_icon("w-4 h-4") }}
    </button>

{% elif entity_type == 'team' %}
    <button @click.stop="editTeamMember({{ entity_id }})" 
            class="px-2 py-1 rounded text-action-sm transition-colors duration-200 text-info-hover hover:bg-blue-50" 
            title="Edit team member">
        {{ pencil_icon("w-4 h-4") }}
    </button>

{% endif %}
{% endmacro %}

{# ========== ENTITY CONFIGURATIONS ========== #}

{#
  Entity Configuration Registry - Default configurations for each entity type
  
  This centralizes all entity-specific knowledge in one place, making it easy
  to add new entity types or modify existing ones.
#}
{% macro get_entity_config(entity_type) %}
{% if entity_type == 'task' %}
    {{- {
        'badge_field': 'priority',
        'badge_style': 'blue',
        'title_field': 'description',
        'secondary_fields': [
            {'name': 'next_step_type', 'type': 'text', 'classes': 'text-gray-600'}
        ],
        'metadata_fields': [
            {'name': 'due_date', 'type': 'date', 'format': '%d/%m/%y', 'prefix': 'Due: '},
            {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y'}
        ]
    } -}}
{% elif entity_type == 'opportunity' %}
    {{- {
        'badge_field': 'stage',
        'badge_style': 'green',
        'title_field': 'name',
        'value_field': 'value',
        'value_type': 'currency',
        'secondary_fields': [
            {'name': 'company', 'type': 'relationship', 'related_field': 'name', 'classes': 'text-gray-600'}
        ],
        'metadata_fields': [
            {'name': 'close_date', 'type': 'date', 'format': '%d/%m/%y', 'prefix': 'Close: '},
            {'name': 'probability', 'type': 'text', 'suffix': '%', 'prefix': 'Prob: '}
        ]
    } -}}
{% elif entity_type == 'contact' or entity_type == 'stakeholder' %}
    {{- {
        'badge_field': 'job_title',
        'badge_style': 'blue',
        'title_field': 'name',
        'secondary_fields': [
            {'name': 'company', 'type': 'relationship', 'related_field': 'name', 'classes': 'text-gray-600'},
            {'name': 'email', 'type': 'email', 'classes': 'text-blue-600'}
        ],
        'metadata_fields': [
            {'name': 'phone', 'type': 'phone'},
            {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y'}
        ]
    } -}}
{% elif entity_type == 'company' %}
    {{- {
        'badge_field': 'industry',
        'badge_style': 'blue',
        'title_field': 'name',
        'secondary_fields': [
            {'name': 'website', 'type': 'link', 'classes': 'text-blue-600'}
        ],
        'metadata_fields': [
            {'name': 'contacts', 'type': 'count', 'label': 'contact'},
            {'name': 'opportunities', 'type': 'count', 'label': 'opportunity'},
            {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y'}
        ]
    } -}}
{% else %}
    {{- {
        'title_field': 'name',
        'metadata_fields': [
            {'name': 'created_at', 'type': 'date', 'format': '%m/%d/%y'}
        ]
    } -}}
{% endif %}
{% endmacro %}

{#
  Entity Actions Registry - Default actions for each entity type
#}
{% macro get_entity_actions(entity_type, entity_id) %}
{% if entity_type == 'task' %}
    {{- [
        {'type': 'complete', 'onclick': 'completeTask(' + entity_id|string + ')'},
        {'type': 'edit', 'onclick': 'editTask(' + entity_id|string + ')'},
        {'type': 'delete', 'onclick': 'deleteTask(' + entity_id|string + ')'}
    ] -}}
{% elif entity_type == 'opportunity' %}
    {{- [
        {'type': 'edit', 'onclick': 'editOpportunity(' + entity_id|string + ')'}
    ] -}}
{% elif entity_type == 'contact' or entity_type == 'stakeholder' %}
    {{- [
        {'type': 'edit', 'onclick': 'openStakeholderModal(' + entity_id|string + ')'},
        {'type': 'delete', 'onclick': 'deleteStakeholder(' + entity_id|string + ')'}
    ] -}}
{% elif entity_type == 'company' %}
    {{- [
        {'type': 'edit', 'onclick': 'editCompany(' + entity_id|string + ')'}
    ] -}}
{% else %}
    {{- [] -}}
{% endif %}
{% endmacro %}

{# ========== UTILITY FUNCTIONS ========== #}

{#
  Config Merger - Deep merge configurations with override support
#}
{% macro merge_configs(base_config, overrides) %}
{%- set merged = base_config.copy() -%}
{% for key, value in overrides.items() %}
    {%- set _ = merged.update({key: value}) -%}
{% endfor %}
{{- merged -}}
{% endmacro %}

{# ========== BACKWARDS COMPATIBILITY ADAPTER ========== #}

{#
  Legacy Expandable Card Adapter - Provides backwards compatibility
  
  This macro maintains the same API as the old expandable_card but internally
  uses the new card system. This allows existing code to work unchanged while
  new code can use the better system.
#}
{% macro expandable_card_legacy(card_type, entity, entity_id, expansion_enabled=true, progress_config=none, bulk_selection_enabled=true, card_classes='', badge_content='', title_content='', value_content='', secondary_info='', metadata_content='', action_buttons='', expanded_content='', notes_enabled=false) %}

{# Convert legacy parameters to new content structure #}
{%- set content = {
    'header': {
        'type': 'composite',
        'sections': []
    },
    'actions': {
        'type': 'custom',
        'content': action_buttons
    },
    'bulk_selection': bulk_selection_enabled
} -%}

{# Build header sections from legacy parameters #}
{% if badge_content or title_content or value_content %}
    {%- set header_html = '' -%}
    {% if badge_content %}
        {%- set header_html = header_html + '<div class="mb-1">' + badge_content + '</div>' -%}
    {% endif %}
    
    {% if title_content or value_content %}
        {%- set header_html = header_html + '<div class="flex items-center justify-between">' -%}
        {% if title_content %}
            {%- set header_html = header_html + '<h3 class="text-lg font-medium text-gray-900">' + title_content + '</h3>' -%}
        {% endif %}
        {% if value_content %}
            {%- set header_html = header_html + '<span class="text-lg font-semibold text-gray-700">' + value_content + '</span>' -%}
        {% endif %}
        {%- set header_html = header_html + '</div>' -%}
    {% endif %}
    
    {% if secondary_info %}
        {%- set header_html = header_html + '<div class="mt-1">' + secondary_info + '</div>' -%}
    {% endif %}
    
    {% if progress_config and progress_config.enabled %}
        {%- set header_html = header_html + '<div class="mt-2">' + progress_bar(progress_config.value, progress_config.max_value or 100, progress_config.color_scheme or 'blue', progress_config.label) + '</div>' -%}
    {% endif %}
    
    {% if metadata_content %}
        {%- set header_html = header_html + '<div class="mt-2 text-sm text-gray-500">' + metadata_content + '</div>' -%}
    {% endif %}
    
    {%- set _ = content.header.sections.append({
        'type': 'html',
        'content': header_html
    }) -%}
{% endif %}

{# Add expanded content if provided #}
{% if expanded_content %}
    {%- set _ = content.update({
        'expanded': {
            'type': 'html',
            'content': expanded_content
        }
    }) -%}
{% endif %}

{# Render using new system #}
{{ card_container(card_type, entity_id, expansion_enabled, card_classes, content) }}
{% endmacro %}
{% from 'macros/base/icons.html' import icon %}
{# Common UI Elements - Reusable macros for consistent interface components #}

{# action_button removed - use the one from macros/base/buttons.html instead #}

{# enhanced_button removed - use the one from macros/base/buttons.html instead #}

{# pluralized_count removed - use the one from macros/ui/controls.html instead #}

{# CSS expand/collapse controls moved to macros/ui/utilities.html #}


{# CSS details section moved to macros/ui/sections.html #}

{# Contact info badge components moved to macros/ui/badges.html #}

{# Entity link button moved to macros/ui/utilities.html #}


{# Section group header moved to macros/ui/sections.html #}



{# Badge count helper moved to macros/ui/badges.html #}

{# Task section badge helper moved to macros/ui/badges.html #}

{# Task filter helper moved to macros/ui/sections.html #}

{#
  Task Section Group - DRY macro for complete task sections with filtering
  
  Comprehensive macro that handles all task grouping types and eliminates repetitive code.
  
  Parameters:
  - section_key (required): Key for expandedSections and group identifier
  - title (required): Section title
  - icon_html (required): Icon HTML from icon macros
  - card_class (optional): Card CSS class (default: 'card')
  - colors (required): Object with {badge_color, border_color, bg_color, hover_color, text_class}
  - x_show_condition (optional): Additional x-show condition (e.g., 'showCompleted')
  - filter_config (required): Object with filtering configuration
    - {type: 'status', value: 'todo'} - Filter by status
    - {type: 'priority', value: 'high'} - Filter by priority  
    - {type: 'entity', value: 'company'} - Filter by entity type
    - {type: 'overdue'} - Filter overdue tasks
    - {type: 'due_today'} - Filter tasks due today
    - {type: 'no_date'} - Filter tasks with no due date
    - {type: 'custom', filter_func: 'custom_filter_function'} - Custom filtering
  - additional_classes (optional): Extra CSS classes for rendered tasks
  
  Usage:
  {{ task_section_group('todo', 'To Do', clipboard_list_icon("w-5 h-5 mr-1"), 
       colors={badge_color: 'blue', border_color: 'blue', bg_color: 'blue', hover_color: 'blue', text_class: 'text-status-header'}, 
       filter_config={type: 'status', value: 'todo'}) }}
#}
{% macro task_section_group(section_key, title, icon_html, card_class='card', colors=None, x_show_condition='', filter_config=None, additional_classes='') %}
<div {% if x_show_condition %}x-show="{{ x_show_condition }}" x-cloak {% endif %}class="{{ card_class }}">
    {{ section_group_header(
        section_key,
        title,
        icon_html|safe, 
        task_section_badge(filter_config, colors.badge_color),
        colors.border_color,
        colors.bg_color,
        colors.hover_color, 
        colors.text_class
    ) }}
    <div class="p-6" x-show="expandedSections['{{ section_key }}']" x-cloak x-transition>
        {% set has_tasks = [] %}
        {% for task in tasks_objects %}
            {% if task_matches_filter(task, filter_config) == 'true' %}
                {% set _ = has_tasks.append(task) %}
                <div x-show="shouldShowTask({priority: '{{ task.priority }}', entity_type: {{ "'" + task.entity_type + "'" if task.entity_type else "'unrelated'" }}, status: '{{ task.status }}'})" {% if additional_classes %}class="{{ additional_classes }}"{% endif %}>
                    {% call expandable_card('task', task, task.id,
                                           expansion_enabled=true,
                                           group_key=section_key,
                                           action_content=task_reschedule_buttons(task.id)) %}
                        {{ task_header_content(task) }}
                    {% endcall %}
                </div>
            {% endif %}
        {% endfor %}
        {% if has_tasks|length == 0 %}
            <p class="text-empty-state">No matching tasks found</p>
        {% endif %}
    </div>
</div>
{% endmacro %}

{# view_mode_toggle removed - use the one from macros/ui/controls.html instead #}

{# Bulk selection checkbox moved to macros/base/forms.html #}

{# Select all checkbox moved to macros/base/forms.html #}

{# Search input moved to macros/base/forms.html #}

{# Loading spinner moved to macros/ui/utilities.html #}

{# Empty state moved to macros/ui/utilities.html #}

{# Status badge moved to macros/ui/badges.html #}

{#
  GENERIC ENTITY MANAGER COMPONENTS - DRY multiselect system for all entity types
#}


{# Dynamic entity section moved to macros/ui/sections.html #}

{# Bulk actions bar moved to macros/ui/utilities.html #}

{# Status color helpers moved to macros/ui/badges.html #}


{#
  HTMX Enhanced Filter Controls - Pure CSS version of enhanced_filter_controls
  
  Parameters:
  - Same as enhanced_filter_controls but uses pure CSS components
  
  Usage:
  {{ htmx_enhanced_filter_controls(...) }}
#}
{% from "macros/dropdowns.html" import css_dropdown %}
{% from "macros/utilities.html" import css_expand_collapse_controls %}

{#
  HTMX Dropdown Helper - Reduces repetition in filter controls
  
  Parameters:
  - label: Display label for dropdown
  - options: List of dropdown options  
  - name: Form field name
  - current_value: Currently selected value
  - current_values: Currently selected values (for multiselect)
  - target: HTMX target (default: '#content')
  - get_url: HTMX get URL (default: request.url)
#}
{% macro htmx_dropdown_helper(label, options, name, current_value=None, current_values=None, target='#content', get_url=None) %}
{{ css_dropdown(label, options, name, 
                current_value=current_value, 
                current_values=current_values, 
                hx_target=target, 
                hx_get=get_url or request.url) }}
{% endmacro %}

{% macro htmx_enhanced_filter_controls(
    group_options, 
    sort_options,
    show_completed_label='Show Completed',
    show_completed_name='show_completed',
    show_completed_value=false,
    primary_filter_options=None,
    primary_filter_label='All Filters',
    primary_filter_values=[],
    secondary_filter_options=None,
    secondary_filter_label='All Filters',
    secondary_filter_values=[],
    entity_filter_options=None,
    entity_filter_label='All Entities',
    entity_filter_values=[],
    group_by='',
    sort_by='',
    sort_direction='asc'
) %}
<div class="card-padded-lg filter-section-enhanced">
    <div class="flex flex-col space-y-4">
        <!-- First row: Group by, Sort by, and Filters -->
        <div class="flex flex-wrap items-center gap-6">
            <label class="text-label-dark">Group by:</label>
            {{ htmx_dropdown_helper('Group by', group_options, 'group_by', current_value=group_by) }}
            
            <label class="text-label-dark">Sort by:</label>
            {{ htmx_dropdown_helper('Sort by', sort_options, 'sort_by', current_value=sort_by) }}
            {{ htmx_dropdown_helper('Order', [{'value': 'asc', 'label': 'Ascending'}, {'value': 'desc', 'label': 'Descending'}], 'sort_direction', current_value=sort_direction) }}
            
            {% if primary_filter_options or secondary_filter_options or entity_filter_options %}
            <label class="text-label-dark">Filters:</label>
            {% endif %}
            
            {% if primary_filter_options %}
            {{ htmx_dropdown_helper(primary_filter_label, primary_filter_options, 'primary_filter', current_values=primary_filter_values) }}
            {% endif %}
            
            {% if secondary_filter_options %}
            {{ htmx_dropdown_helper(secondary_filter_label, secondary_filter_options, 'secondary_filter', current_values=secondary_filter_values) }}
            {% endif %}
            
            {% if entity_filter_options %}
            {{ htmx_dropdown_helper(entity_filter_label, entity_filter_options, 'entity_filter', current_values=entity_filter_values) }}
            {% endif %}
        </div>
        
        <!-- Second row: Show completed and Expand/Collapse controls -->
        <div class="flex flex-wrap items-center gap-6">
            {% if show_completed_label %}
            <label class="flex items-center">
                <input type="checkbox" 
                       name="{{ show_completed_name }}"
                       value="true"
                       {% if show_completed_value %}checked{% endif %}
                       class="mr-2"
>
                <span class="text-secondary-dark">{{ show_completed_label }}</span>
            </label>
            {% endif %}

            {{ css_expand_collapse_controls() }}
        </div>
    </div>
</div>

{% endmacro %}


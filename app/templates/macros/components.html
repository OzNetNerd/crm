{#
    Component Macros - Modals, Dropdowns, Search
#}

{% from 'macros/ui.html' import icon %}

{# ============================================
   CARD
   ============================================ #}
{% macro card(title='', entity_type=None, compact=false, class='') %}
    {# Dynamic class generation following ADR pattern #}
    {% set card_class = "card" %}
    {% if entity_type %}
        {% set card_class = card_class + " card-" + entity_type %}
    {% endif %}
    {% if compact %}
        {% set card_class = card_class + " card-compact" %}
    {% endif %}

    <div class="{{ card_class }} {{ class }}">
        {% if title %}
        <div class="card-header">
            <h3 class="card-title">{{ title }}</h3>
        </div>
        {% endif %}
        <div class="card-body">
            {{ caller() }}
        </div>
    </div>
{% endmacro %}

{# ============================================
   MODAL
   ============================================ #}
{% macro modal(id='modal', title='', size='md', closable=true) %}
    <div id="{{ id }}" class="modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-content-{{ size }}">
            <div class="modal-header">
                <h3 class="modal-title">{{ title }}</h3>
                {% if closable %}
                    <button class="modal-close" data-modal-id="{{ id }}">
                        {{ icon('x-mark') }}
                    </button>
                {% endif %}
            </div>
            <div class="modal-body">
                {{ caller() }}
            </div>
        </div>
    </div>
{% endmacro %}

{# ============================================
   CONFIRMATION MODAL
   ============================================ #}
{% macro confirmation_modal(id='confirm-modal', title='Confirm Action', type='warning') %}
    <div id="{{ id }}" class="modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-confirmation">
            <div class="modal-confirmation-content">
                <div class="modal-confirmation-icon modal-confirmation-icon-{{ type }}">
                    {% if type == 'warning' %}
                        {{ icon('exclamation-triangle') }}
                    {% elif type == 'error' %}
                        {{ icon('x-mark') }}
                    {% elif type == 'success' %}
                        {{ icon('check') }}
                    {% else %}
                        {{ icon('information-circle') }}
                    {% endif %}
                </div>
                <div class="modal-confirmation-text">
                    <h3 class="modal-confirmation-title">{{ title }}</h3>
                    <p class="modal-confirmation-message">{{ caller() }}</p>
                </div>
            </div>
            <div class="modal-confirmation-footer">
                <button class="btn btn-secondary modal-cancel" data-modal-id="{{ id }}">Cancel</button>
                <button class="btn btn-primary modal-confirm" data-modal-id="{{ id }}">Confirm</button>
            </div>
        </div>
    </div>
{% endmacro %}

{# ============================================
   DROPDOWN
   ============================================ #}
{% macro dropdown(id, trigger_text='Options', items=[], align='left') %}
    <div class="dropdown" data-dropdown-id="{{ id }}">
        <button class="dropdown-trigger" data-dropdown-id="{{ id }}">
            {{ trigger_text }}
            {{ icon('chevron-down') }}
        </button>
        <div id="{{ id }}" class="dropdown-menu dropdown-menu-{{ align }}">
            {% for item in items %}
                {% if item.divider %}
                    <div class="dropdown-divider"></div>
                {% else %}
                    <a href="{{ item.url or '#' }}"
                       class="dropdown-item{% if item.danger %} dropdown-item-danger{% endif %}"
                       {% if item.action %}data-action="{{ item.action }}"{% endif %}>
                        {% if item.icon %}{{ icon(item.icon) }}{% endif %}
                        {{ item.text }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   SEARCH WIDGET
   ============================================ #}
{% macro search_widget(placeholder='Search...', id='search', mode='modal') %}
    <div class="relative">
        <input type="text"
               id="{{ id }}"
               name="q"
               class="search-input w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="{{ placeholder }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="input changed delay:300ms, focus"
               hx-target="#{{ id }}-results"
               hx-include="this"
               hx-vals='{"mode": "{{ mode }}"}'>
        <button class="absolute right-2 top-2 text-gray-400 hover:text-gray-600">
            {{ icon('magnifying-glass') }}
        </button>
        <div id="{{ id }}-results" class="absolute top-full mt-1 w-[32rem] max-w-2xl bg-white border border-gray-200 rounded-md shadow-lg hidden z-50"></div>
    </div>
{% endmacro %}

{# ============================================
   ENTITY DROPDOWN CONTROLS - Ultra DRY
   Uses Alpine.js dropdown component for consistent styling
   ============================================ #}
{% macro entity_dropdown_controls(dropdowns={}) %}
    <div class="flex flex-wrap gap-3 items-center">
        {% for dropdown_key, config in dropdowns.items() %}
            {% if config.options %}
                <div class="min-w-48">
                    {% if config.label is defined %}
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ config.label }}
                        </label>
                    {% endif %}

                    <div class="dropdown"
                         x-data="dropdown({
                             name: {{ (config.name or dropdown_key) | tojson }},
                             options: {{ config.options | tojson }},
                             selected: {{ (config.current_value or '') | tojson }},
                             placeholder: {{ (config.placeholder or 'Select...') | tojson }},
                             searchable: {{ config.searchable | default(false) | tojson }},
                             htmx: {
                                 trigger: true
                             }
                         })">

                        <button @click="toggle()" class="dropdown-trigger">
                            <span x-text="displayText" class="truncate"></span>
                            <svg class="dropdown-icon" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div x-show="open" @click.away="close()" class="dropdown-menu" x-cloak>
                            {% raw %}
                            <template x-if="searchable">
                                <div class="dropdown-search">
                                    <input type="text"
                                           x-model="search"
                                           x-ref="searchInput"
                                           placeholder="Search..."
                                           class="dropdown-search-input">
                                </div>
                            </template>

                            <template x-for="option in filteredOptions">
                                <button @click="select(option.value)"
                                        class="dropdown-option"
                                        :class="{'dropdown-option-selected': isSelected(option.value)}">
                                    <span x-text="option.label"></span>
                                </button>
                            </template>
                            {% endraw %}
                        </div>

                        <!-- Hidden input for HTMX -->
                        <input type="hidden"
                               :name="name"
                               :value="selected"
                               x-ref="hiddenInput">
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}

{# ============================================
   LEGACY FILTER CONTROLS - Deprecated
   Use entity_dropdown_controls instead
   ============================================ #}
{% macro filter_controls(filters=[]) %}
    {# Convert legacy format to new format for backwards compatibility #}
    {% set dropdown_configs = {} %}
    {% for filter in filters %}
        {% set _ = dropdown_configs.update({
            loop.index0: {
                'name': filter.name,
                'label': filter.label,
                'options': filter.options,
                'current_value': filter.current_value or '',
                'placeholder': filter.placeholder or 'Select...',
                'searchable': filter.searchable or false
            }
        }) %}
    {% endfor %}
    {{ entity_dropdown_controls(dropdown_configs) }}
{% endmacro %}
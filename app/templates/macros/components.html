{#
    Component Macros - Modals, Dropdowns, Search
#}

{% from 'macros/ui.html' import icon %}

{# ============================================
   CARD
   ============================================ #}
{% macro card(title='', entity_type=None, compact=false, class='') %}
    {# Dynamic class generation following ADR pattern #}
    {% set card_class = "card" %}
    {% if entity_type %}
        {% set card_class = card_class + " card-" + entity_type %}
    {% endif %}
    {% if compact %}
        {% set card_class = card_class + " card-compact" %}
    {% endif %}

    <div class="{{ card_class }} {{ class }}">
        {% if title %}
        <div class="card-header">
            <h3 class="card-title">{{ title }}</h3>
        </div>
        {% endif %}
        <div class="card-body">
            {{ caller() }}
        </div>
    </div>
{% endmacro %}

{# ============================================
   MODAL
   ============================================ #}
{% macro modal(id='modal', title='', size='md', closable=true) %}
    <div id="{{ id }}" class="modal modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-content-{{ size }}">
            <div class="modal-header">
                <h3 class="modal-title">{{ title }}</h3>
                {% if closable %}
                    <button class="modal-close" data-modal-id="{{ id }}">
                        {{ icon('x-mark') }}
                    </button>
                {% endif %}
            </div>
            <div class="modal-body">
                {{ caller() }}
            </div>
        </div>
    </div>
{% endmacro %}

{# ============================================
   CONFIRMATION MODAL
   ============================================ #}
{% macro confirmation_modal(id='confirm-modal', title='Confirm Action', type='warning') %}
    <div id="{{ id }}" class="modal modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-confirmation">
            <div class="modal-confirmation-content">
                <div class="modal-confirmation-icon modal-confirmation-icon-{{ type }}">
                    {% if type == 'warning' %}
                        {{ icon('exclamation-triangle') }}
                    {% elif type == 'error' %}
                        {{ icon('x-mark') }}
                    {% elif type == 'success' %}
                        {{ icon('check') }}
                    {% else %}
                        {{ icon('information-circle') }}
                    {% endif %}
                </div>
                <div class="modal-confirmation-text">
                    <h3 class="modal-confirmation-title">{{ title }}</h3>
                    <p class="modal-confirmation-message">{{ caller() }}</p>
                </div>
            </div>
            <div class="modal-confirmation-footer">
                <button class="btn btn-secondary modal-cancel" data-modal-id="{{ id }}">Cancel</button>
                <button class="btn btn-primary modal-confirm" data-modal-id="{{ id }}">Confirm</button>
            </div>
        </div>
    </div>
{% endmacro %}

{# ============================================
   DROPDOWN
   ============================================ #}
{% macro dropdown(id, trigger_text='Options', items=[], align='left') %}
    <div class="dropdown" data-dropdown-id="{{ id }}">
        <button class="dropdown-trigger" data-dropdown-id="{{ id }}">
            {{ trigger_text }}
            {{ icon('chevron-down') }}
        </button>
        <div id="{{ id }}" class="dropdown-menu dropdown-menu-{{ align }}">
            {% for item in items %}
                {% if item.divider %}
                    <div class="dropdown-divider"></div>
                {% else %}
                    <a href="{{ item.url or '#' }}"
                       class="dropdown-item{% if item.danger %} dropdown-item-danger{% endif %}"
                       {% if item.action %}data-action="{{ item.action }}"{% endif %}>
                        {% if item.icon %}{{ icon(item.icon) }}{% endif %}
                        {{ item.text }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endmacro %}

{# ============================================
   SEARCH WIDGET
   ============================================ #}
{% macro search_widget(placeholder='Search...', id='search', mode='modal') %}
    <div class="relative">
        <input type="text"
               id="{{ id }}"
               name="q"
               class="search-input w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="{{ placeholder }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="focus, input changed delay:300ms"
               hx-target="#{{ id }}-results"
               hx-include="this"
               hx-vals='{"mode": "{{ mode }}"}'>
        <button class="absolute right-2 top-2 text-gray-400 hover:text-gray-600">
            {{ icon('magnifying-glass') }}
        </button>
        <div id="{{ id }}-results" class="absolute top-full mt-1 w-[32rem] max-w-2xl bg-white border border-gray-200 rounded-md shadow-lg hidden z-50"></div>
    </div>
{% endmacro %}

{# ============================================
   ENTITY SEARCH DROPDOWN - Using working global search pattern
   ============================================ #}
{% macro entity_search_dropdown(name, entity_type, value='', search_value='', label='', required=false, placeholder='Search...') %}
    {% if label %}
        <label for="{{ name }}_search" class="form-label{% if required %} form-label-required{% endif %}">
            {{ label }}
        </label>
    {% endif %}
    <div class="relative">
        <input type="text"
               id="{{ name }}_search"
               name="q"
               class="search-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="{{ placeholder }}"
               value="{{ search_value }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="focus, input changed delay:300ms"
               hx-target="#{{ name }}_search-results"
               hx-include="this"
               hx-vals='{"mode": "select", "type": "{{ entity_type }}", "field_name": "{{ name }}"}'>
        <input type="hidden" name="{{ name }}" id="{{ name }}" value="{{ value }}"{% if required %} required{% endif %}>
        <div id="{{ name }}_search-results" class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden z-50"></div>
    </div>
{% endmacro %}

{# ============================================
   CHOICE SEARCH DROPDOWN - For searchable choice fields
   ============================================ #}
{% macro choice_search_dropdown(name, choices, value='', search_value='', label='', required=false, placeholder='Search...') %}
    {{ entity_search_dropdown(name, 'choice:' + name, value, search_value, label, required, placeholder) }}
{% endmacro %}

{# ============================================
   MULTI-SELECT ENTITY SEARCH - Using working global search pattern
   ============================================ #}
{% macro multi_entity_search_dropdown(name, entity_type, value='[]', label='', required=false, placeholder='Search...', company_id='') %}
    {% if label %}
        <label for="{{ name }}_search" class="form-label{% if required %} form-label-required{% endif %}">
            {{ label }}
        </label>
    {% endif %}
    <div class="relative">
        <input type="text"
               id="{{ name }}_search"
               name="q"
               class="search-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="{{ placeholder }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="focus, input changed delay:300ms"
               hx-target="#{{ name }}_search-results"
               hx-include="this"
               hx-vals='{"mode": "select", "type": "{{ entity_type }}", "field_name": "{{ name }}", "multiple": "true"{% if company_id %}, "company_id": "{{ company_id }}"{% endif %}}'>
        <input type="hidden" id="{{ name }}-data" name="{{ name }}" value="{{ value }}">
        <div id="{{ name }}_search-results" class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden z-50"></div>
    </div>
    <div id="{{ name }}-badges" class="mt-2 flex flex-wrap gap-1"></div>
{% endmacro %}

{# ============================================
   MULTIPLE CHOICE SEARCH DROPDOWN - Using working global search pattern
   ============================================ #}
{% macro multiple_choice_search_dropdown(name, choices, value='[]', label='', required=false, placeholder='Search...') %}
    {% if label %}
        <label for="{{ name }}_search" class="form-label{% if required %} form-label-required{% endif %}">
            {{ label }}
        </label>
    {% endif %}
    <div class="relative">
        <input type="text"
               id="{{ name }}_search"
               name="q"
               class="search-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="{{ placeholder }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="focus, input changed delay:300ms"
               hx-target="#{{ name }}_search-results"
               hx-include="this"
               hx-vals='{"mode": "select", "type": "choice:{{ name }}", "field_name": "{{ name }}"}'>
        <input type="hidden" name="selected" id="{{ name }}-selected" value="">
        <input type="hidden" name="{{ name }}" id="{{ name }}-data" value="{{ value }}"{% if required %} required{% endif %}>
        <div id="{{ name }}_search-results" class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden z-50"></div>
        <div id="{{ name }}-badges" class="mt-2 flex flex-wrap gap-1"></div>
    </div>
{% endmacro %}

{# ============================================
   MULTI-SELECT FORM DROPDOWN - Reusable multi-select with checkboxes
   ============================================ #}
{% macro multi_select_dropdown(name, choices, value='', label='', required=false, placeholder='Select...') %}
    {% if label %}
        <label for="{{ name }}" class="form-label{% if required %} form-label-required{% endif %}">
            {{ label }}
        </label>
    {% endif %}

    <div class="relative" x-data="multiSelectDropdown{{ name|replace('_', '') }}()">
        <button type="button"
                @click="open = !open"
                class="form-input w-full text-left flex items-center justify-between">
            <span x-show="selected.length === 0">{{ placeholder }}</span>
            <span x-show="selected.length > 0" x-text="selectedLabels.join(', ')"></span>
            <span class="ml-2 pointer-events-none">
                {{ icon('chevron-down') }}
            </span>
        </button>

        <div x-show="open"
             @click.outside="open = false"
             @click.stop
             class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"
             style="display: none;">
            {% for choice_key, choice_data in choices.items() %}
                <label class="flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox"
                           value="{{ choice_key }}"
                           x-model="selected"
                           class="mr-2">
                    <span>{{ choice_data.label }}</span>
                </label>
            {% endfor %}
        </div>

        <input type="hidden"
               id="{{ name }}"
               name="{{ name }}"
               :value="JSON.stringify(selected.map(val => ({id: val, name: val.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()), type: 'choice'})))">
    </div>

    <script>
    function multiSelectDropdown{{ name|replace('_', '') }}() {
        return {
            open: false,
            selected: {{ (value|default('[]', true) if value else '[]')|safe }},
            get selectedLabels() {
                const choices = {{ choices|tojson|safe }};
                return this.selected.map(val => {
                    return choices[val] ? choices[val].label : val;
                });
            }
        }
    }
    </script>
{% endmacro %}

{# ============================================
   SEARCHABLE DROPDOWN - Dynamic dropdown with search
   ============================================ #}
{% macro searchable_dropdown(name, options, current_value='', label='', placeholder='Search...', dropdown_type='', entity_type='') %}
    {# Find the current label for the selected value #}
    {% set current_label = '' %}
    {% for option in options %}
        {% if option.value == current_value %}
            {% set current_label = option.label %}
        {% endif %}
    {% endfor %}

    <div class="relative">
        <input type="text"
               id="{{ name }}_search"
               name="q"
               class="search-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="{{ placeholder }}"
               autocomplete="off"
               hx-get="{{ url_for('search.htmx_search') }}"
               hx-trigger="focus, input changed delay:300ms"
               hx-target="#{{ name }}_results"
               hx-swap="innerHTML"
               hx-vals='{"mode": "select", "type": "dropdown:{{ dropdown_type or name }}", "field_name": "{{ name }}"}'
               value="{{ current_label }}">
        <input type="hidden" name="{{ name }}" id="{{ name }}" value="{{ current_value }}">
        <div id="{{ name }}_results"
             class="search-results absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto"
             hidden></div>
    </div>
{% endmacro %}

{# ============================================
   ENTITY DROPDOWN CONTROLS - Simple HTML Select
   ============================================ #}
{% macro entity_dropdown_controls(dropdowns={}, entity_type='') %}
    <div class="flex flex-wrap gap-3 items-center">
        {% for dropdown_key, config in dropdowns.items() %}
            {% if config.options %}
                <div class="min-w-48">
                    {% if config.label %}
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ config.label }}
                        </label>
                    {% endif %}

                    {% if config.searchable %}
                        {# Use searchable dropdown for dynamic search #}
                        {{ searchable_dropdown(
                            name=config.name or dropdown_key,
                            options=config.options,
                            current_value=config.current_value,
                            placeholder=config.placeholder or 'Search...',
                            dropdown_type=dropdown_key,
                            entity_type=entity_type
                        ) }}
                    {% else %}
                        {% if config.multiple %}
                            {# Multi-select checkbox dropdown #}
                            <div class="relative" x-data="{ open: false, selected: {{ (config.current_value.split(',') if config.current_value else [])|tojson }} }">
                                <button type="button"
                                        @click="open = !open"
                                        class="dropdown-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex items-center justify-between">
                                    <span x-show="selected.length === 0">{{ config.placeholder or 'Select...' }}</span>
                                    <span x-show="selected.length > 0" x-text="selected.length + ' selected'"></span>
                                    <span class="ml-2 pointer-events-none">
                                        {{ icon('chevron-down') }}
                                    </span>
                                </button>
                                <div x-show="open"
                                     @click.away="open = false"
                                     class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                    {% for option in config.options %}
                                        {% if option.value %}
                                        <label class="flex items-center px-3 py-2 hover:bg-gray-100">
                                            <input type="checkbox"
                                                   value="{{ option.value }}"
                                                   x-model="selected"
                                                   class="mr-2">
                                            <span>{{ option.label }}</span>
                                        </label>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="{{ config.name or dropdown_key }}" :value="selected.join(',')">
                            </div>
                        {% else %}
                            {# Regular single-select dropdown #}
                            <select name="{{ config.name or dropdown_key }}"
                                    class="dropdown-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    autocomplete="off">
                                {% for option in config.options %}
                                    <option value="{{ option.value }}"
                                            {% if option.value == config.current_value %}selected{% endif %}>
                                        {{ option.label }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}
{#
  Simplified Card System - Flattened from 3-file chain

  Combines functionality from:
  - macros/cards.html
  - macros/cards/container.html
  - macros/cards/content_renderers.html

  Eliminates complex abstraction layers for simpler, more maintainable code.
#}

{% from 'macros/base/icons.html' import icon %}
{% from "macros/base/forms.html" import bulk_selection_checkbox %}

{#
  Entity Card - Simplified card for entity display

  Parameters:
  - entity (required): Entity data object
  - show_checkbox (optional): Show bulk selection checkbox (default: true)
  - expandable (optional): Allow expand/collapse (default: true)
  - extra_classes (optional): Additional CSS classes
  - actions (optional): Action buttons array

  Usage:
  {{ entity_card(task) }}
  {{ entity_card(company, expandable=false, actions=company_actions) }}
#}
{% macro entity_card(entity, show_checkbox=true, expandable=true, extra_classes='', actions=None) %}
{# Get entity type from metadata #}
{% set metadata = get_model_metadata(entity.__class__.__name__.lower()) %}
{% set entity_type = metadata.display_name.lower() %}
{% set card_class = 'card-' + entity_type %}

{% if expandable %}
<details class="{{ card_class }} {{ extra_classes }} relative mb-4 group"
         data-{{ entity_type }}-id="{{ entity.id }}">
    <summary class="cursor-pointer list-none">
        <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center space-x-4">
                {% if show_checkbox %}
                <div class="flex-shrink-0">
                    {{ bulk_selection_checkbox(entity.id) }}
                </div>
                {% endif %}

                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 p-2 rounded-lg bg-white/50 backdrop-blur-sm">
                        {{ icon(entity_type, 'lg', 'text-' + entity_type + '-600') }}
                    </div>
                    <div class="min-w-0 flex-1">
                        <h3 class="font-bold text-lg text-gray-900 group-hover:text-{{ entity_type }}-600 transition-colors">
                            {{ entity.name or entity.title or entity.subject or entity.id }}
                        </h3>
                        {% if entity.description or entity.company_name or entity.status %}
                        <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                            {{ entity.description or entity.company_name or entity.status }}
                        </p>
                        {% endif %}
                        {% if entity.status %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-{{ entity_type }}-100 text-{{ entity_type }}-800 mt-2">
                            {{ entity.status }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-3">
                {% if actions %}
                <div class="flex items-center space-x-2">
                    {% for action in actions %}
                        <a href="{{ action.url }}" class="btn-{{ entity_type }} btn-sm opacity-0 group-hover:opacity-100 transition-opacity">
                            {{ action.text }}
                        </a>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="flex-shrink-0 p-2 rounded-lg bg-white/30 backdrop-blur-sm transition-transform duration-200 details-chevron group-hover:bg-white/50">
                    {{ icon('chevron-down', 'md', 'text-gray-500 group-hover:text-' + entity_type + '-600') }}
                </div>
            </div>
        </div>
    </summary>

    <!-- Modern expanded content -->
    <div class="mt-6 pt-6 border-t border-white/30 backdrop-blur-sm bg-white/20 rounded-lg p-4">
        {{ caller() if caller else render_entity_details(entity) }}
    </div>
</details>
{% else %}
<!-- Modern non-expandable card -->
<div class="{{ card_class }} {{ extra_classes }} relative mb-4 group"
     data-{{ entity_type }}-id="{{ entity.id }}">
    <div class="flex items-center justify-between relative z-10">
        <div class="flex items-center space-x-4">
            {% if show_checkbox %}
            <div class="flex-shrink-0">
                {{ bulk_selection_checkbox(entity.id) }}
            </div>
            {% endif %}

            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0 p-2 rounded-lg bg-white/50 backdrop-blur-sm">
                    {{ icon(entity_type, 'lg', 'text-' + entity_type + '-600') }}
                </div>
                <div class="min-w-0 flex-1">
                    <h3 class="font-bold text-lg text-gray-900 group-hover:text-{{ entity_type }}-600 transition-colors">
                        {{ entity.name or entity.title or entity.subject or entity.id }}
                    </h3>
                    {% if entity.description or entity.company_name or entity.status %}
                    <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                        {{ entity.description or entity.company_name or entity.status }}
                    </p>
                    {% endif %}
                    {% if entity.status %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-{{ entity_type }}-100 text-{{ entity_type }}-800 mt-2">
                        {{ entity.status }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if actions %}
        <div class="flex items-center space-x-2">
            {% for action in actions %}
                <a href="{{ action.url }}" class="btn-{{ entity_type }} btn-sm opacity-0 group-hover:opacity-100 transition-opacity">
                    {{ action.text }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endmacro %}

{#
  Simple Card - Non-expandable entity card

  Convenience macro for non-expandable cards.
#}
{% macro simple_card(entity, show_checkbox=false, extra_classes='', actions=None) %}
{{ entity_card(entity, show_checkbox=show_checkbox, expandable=false, extra_classes=extra_classes, actions=actions) }}
{% endmacro %}

{#
  Render Entity Details - Auto-render entity details based on common fields

  Provides sensible defaults for common entity fields.
  Can be overridden by providing caller() content to entity_card.
#}
{% macro render_entity_details(entity) %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% if entity.description and entity.description != entity.name %}
    <div class="md:col-span-2">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
        <div class="p-3 bg-white/70 backdrop-blur-sm rounded-lg border border-white/30 text-gray-800">
            {{ entity.description }}
        </div>
    </div>
    {% endif %}

    {% if entity.status %}
    <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
        <div class="p-3 bg-white/70 backdrop-blur-sm rounded-lg border border-white/30">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-{{ entity.__class__.__name__.lower() }}-100 text-{{ entity.__class__.__name__.lower() }}-800">
                {{ entity.status }}
            </span>
        </div>
    </div>
    {% endif %}

    {% if entity.created_at %}
    <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Created</label>
        <div class="p-3 bg-white/70 backdrop-blur-sm rounded-lg border border-white/30 text-gray-800 font-mono text-sm">
            {{ entity.created_at.strftime('%Y-%m-%d %H:%M') }}
        </div>
    </div>
    {% endif %}

    {% if entity.updated_at and entity.updated_at != entity.created_at %}
    <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Last Updated</label>
        <div class="p-3 bg-white/70 backdrop-blur-sm rounded-lg border border-white/30 text-gray-800 font-mono text-sm">
            {{ entity.updated_at.strftime('%Y-%m-%d %H:%M') }}
        </div>
    </div>
    {% endif %}
</div>
{% endmacro %}

{#
  Card List - Render a list of entities as cards

  Parameters:
  - entities (required): List of entity objects
  - show_checkboxes (optional): Show bulk selection checkboxes (default: true)
  - expandable (optional): Make cards expandable (default: true)
  - actions (optional): Action buttons for each card
  - empty_message (optional): Message when no entities

  Usage:
  {{ card_list(tasks, actions=task_actions) }}
  {{ card_list(companies, expandable=false, empty_message="No companies found") }}
#}
{% macro card_list(entities, show_checkboxes=true, expandable=true, actions=None, empty_message="No items found") %}
{% if entities %}
    <div class="space-y-3">
        {% for entity in entities %}
            {{ entity_card(entity, show_checkbox=show_checkboxes, expandable=expandable, actions=actions) }}
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-8">
        <p class="text-gray-500">{{ empty_message }}</p>
    </div>
{% endif %}
{% endmacro %}
{#
  Card Content Builders - Generate complete content configurations
  
  Provides high-level functions to build content objects for different entity types.
  Separates entity-specific logic from generic rendering logic.
#}

{% from "macros/cards/container.html" import card_container %}
{% from "macros/core/entity_helpers.html" import entity_icon, entity_label %}

{#
  Universal Card Builder - Main entry point for card creation
  
  Parameters:
  - entity_type (required): Type of entity (task, company, etc.)
  - entity (required): Entity data object
  - expansion_enabled (optional): Allow expansion (default: true)
  - card_classes (optional): Additional CSS classes
  - content (optional): Custom content override
  - overrides (optional): Override specific content sections
  
  Usage:
  {{ card('task', task) }}
  {{ card('company', company, expansion_enabled=false) }}
#}
{% macro card(entity_type, entity, expansion_enabled=true, card_classes='', content=none, overrides={}) %}
{% if content is none %}
    {% set content = build_entity_content(entity_type, entity, overrides) %}
{% endif %}

{{ card_container(entity_type, entity.id, expansion_enabled, card_classes, content) }}
{% endmacro %}

{#
  Entity Content Builder - Build content configuration for specific entity types
  
  Parameters:
  - entity_type (required): Type of entity
  - entity (required): Entity data object  
  - overrides (optional): Override specific sections
  
  Returns content object with appropriate sections for the entity type.
#}
{% macro build_entity_content(entity_type, entity, overrides={}) %}
{% if entity_type == 'task' %}
    {% set content = build_task_content(entity, overrides) %}
{% elif entity_type == 'company' %}
    {% set content = build_company_content(entity, overrides) %}
{% elif entity_type == 'stakeholder' %}
    {% set content = build_stakeholder_content(entity, overrides) %}
{% elif entity_type == 'opportunity' %}
    {% set content = build_opportunity_content(entity, overrides) %}
{% elif entity_type == 'user' %}
    {% set content = build_user_content(entity, overrides) %}
{% else %}
    {% set content = build_generic_content(entity_type, entity, overrides) %}
{% endif %}

{{ content }}
{% endmacro %}

{#
  Task Content Builder - Specific content configuration for tasks
#}
{% macro build_task_content(task, overrides={}) %}
{%- set content = {
    'header': {
        'type': 'fields',
        'layout': 'horizontal',
        'entity': task,
        'fields': [
            {'name': 'name', 'type': 'text', 'classes': 'font-medium text-gray-900'},
            {'name': 'priority', 'type': 'badge', 'color': 'red' if task.priority == 'high' else 'blue'},
            {'name': 'status', 'type': 'badge', 'color': 'green' if task.status == 'completed' else 'gray'}
        ]
    },
    'actions': {
        'layout': 'horizontal', 
        'actions': [
            {'type': 'link', 'url': url_for('tasks.edit', id=task.id), 'icon': 'pencil', 'text': 'Edit', 'classes': 'btn btn-sm btn-outline'},
            {'type': 'button', 'onclick': 'deleteTask(' + task.id|string + ')', 'icon': 'trash', 'text': 'Delete', 'classes': 'btn btn-sm btn-danger'}
        ]
    },
    'body': {
        'type': 'fields',
        'layout': 'vertical',
        'entity': task,
        'fields': [
            {'name': 'description', 'type': 'text', 'show_label': true},
            {'name': 'due_date', 'type': 'date', 'show_label': true}
        ]
    },
    'expanded': {
        'type': 'fields',
        'layout': 'vertical', 
        'entity': task,
        'fields': [
            {'name': 'created_at', 'type': 'date', 'show_label': true},
            {'name': 'updated_at', 'type': 'date', 'show_label': true}
        ]
    }
} -%}

{# Apply overrides #}
{% for section, override_config in overrides.items() %}
    {% do content.update({section: override_config}) %}
{% endfor %}

{{ content }}
{% endmacro %}

{#
  Company Content Builder - Specific content configuration for companies
#}
{% macro build_company_content(company, overrides={}) %}
{%- set content = {
    'header': {
        'type': 'fields',
        'layout': 'horizontal',
        'entity': company,
        'fields': [
            {'name': 'name', 'type': 'text', 'classes': 'font-medium text-gray-900'},
            {'name': 'size', 'type': 'badge', 'color': 'blue'},
            {'name': 'industry', 'type': 'text', 'classes': 'text-gray-600'}
        ]
    },
    'actions': {
        'layout': 'horizontal',
        'actions': [
            {'type': 'link', 'url': url_for('companies.show', id=company.id), 'icon': 'eye', 'text': 'View', 'classes': 'btn btn-sm btn-outline'},
            {'type': 'link', 'url': url_for('companies.edit', id=company.id), 'icon': 'pencil', 'text': 'Edit', 'classes': 'btn btn-sm btn-outline'}
        ]
    },
    'body': {
        'type': 'fields',
        'layout': 'vertical',
        'entity': company,
        'fields': [
            {'name': 'website', 'type': 'link', 'show_label': true, 'url': company.website if company.website else '#'},
            {'name': 'description', 'type': 'text', 'show_label': true}
        ]
    }
} -%}

{# Apply overrides #}
{% for section, override_config in overrides.items() %}
    {% do content.update({section: override_config}) %}
{% endfor %}

{{ content }}
{% endmacro %}

{#
  Stakeholder Content Builder - Specific content configuration for stakeholders
#}
{% macro build_stakeholder_content(stakeholder, overrides={}) %}
{%- set content = {
    'header': {
        'type': 'fields',
        'layout': 'horizontal',
        'entity': stakeholder,
        'fields': [
            {'name': 'name', 'type': 'text', 'classes': 'font-medium text-gray-900'},
            {'name': 'role', 'type': 'badge', 'color': 'green'},
            {'name': 'company_name', 'type': 'text', 'classes': 'text-gray-600'}
        ]
    },
    'actions': {
        'layout': 'horizontal',
        'actions': [
            {'type': 'link', 'url': url_for('stakeholders.show', id=stakeholder.id), 'icon': 'eye', 'text': 'View', 'classes': 'btn btn-sm btn-outline'},
            {'type': 'link', 'url': url_for('stakeholders.edit', id=stakeholder.id), 'icon': 'pencil', 'text': 'Edit', 'classes': 'btn btn-sm btn-outline'}
        ]
    },
    'body': {
        'type': 'fields',
        'layout': 'vertical',
        'entity': stakeholder,
        'fields': [
            {'name': 'email', 'type': 'link', 'show_label': true, 'url': 'mailto:' + (stakeholder.email or ''), 'text': stakeholder.email},
            {'name': 'phone', 'type': 'text', 'show_label': true}
        ]
    }
} -%}

{# Apply overrides #}
{% for section, override_config in overrides.items() %}
    {% do content.update({section: override_config}) %}
{% endfor %}

{{ content }}
{% endmacro %}

{#
  Opportunity Content Builder - Specific content configuration for opportunities
#}
{% macro build_opportunity_content(opportunity, overrides={}) %}
{%- set content = {
    'header': {
        'type': 'fields',
        'layout': 'horizontal',
        'entity': opportunity,
        'fields': [
            {'name': 'name', 'type': 'text', 'classes': 'font-medium text-gray-900'},
            {'name': 'stage', 'type': 'badge', 'color': 'blue'},
            {'name': 'value', 'type': 'currency'}
        ]
    },
    'actions': {
        'layout': 'horizontal',
        'actions': [
            {'type': 'link', 'url': url_for('opportunities.show', id=opportunity.id), 'icon': 'eye', 'text': 'View', 'classes': 'btn btn-sm btn-outline'},
            {'type': 'link', 'url': url_for('opportunities.edit', id=opportunity.id), 'icon': 'pencil', 'text': 'Edit', 'classes': 'btn btn-sm btn-outline'}
        ]
    },
    'body': {
        'type': 'fields',
        'layout': 'vertical',
        'entity': opportunity,
        'fields': [
            {'name': 'close_date', 'type': 'date', 'show_label': true},
            {'name': 'probability', 'type': 'progress', 'show_label': true, 'max_value': 100}
        ]
    }
} -%}

{# Apply overrides #}
{% for section, override_config in overrides.items() %}
    {% do content.update({section: override_config}) %}
{% endfor %}

{{ content }}
{% endmacro %}

{#
  Generic Content Builder - Fallback for unknown entity types
#}
{% macro build_generic_content(entity_type, entity, overrides={}) %}
{%- set content = {
    'header': {
        'type': 'fields',
        'layout': 'horizontal',
        'entity': entity,
        'fields': [
            {'name': 'name', 'type': 'text', 'classes': 'font-medium text-gray-900'}
        ]
    },
    'actions': {
        'layout': 'horizontal',
        'actions': [
            {'type': 'link', 'url': '#', 'icon': 'eye', 'text': 'View', 'classes': 'btn btn-sm btn-outline'}
        ]
    }
} -%}

{# Apply overrides #}
{% for section, override_config in overrides.items() %}
    {% do content.update({section: override_config}) %}
{% endfor %}

{{ content }}
{% endmacro %}
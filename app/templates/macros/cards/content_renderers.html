{#
  Card Content Renderers - Composable content section renderers
  
  Handles rendering of different content types within cards.
  Separated from container logic for maintainability and reusability.
#}

{% from 'macros/base/icons.html' import icon %}
{% from "macros/ui/progress.html" import progress_bar %}
{% from "macros/ui/date_formatting.html" import enhanced_date_with_status, smart_date_display %}

{#
  Content Section Renderer - Renders different types of content sections
  
  Parameters:
  - section_config (required): Configuration object defining the content type and data
  
  Section Types:
  - fields: Multiple field display
  - field: Single field display
  - text: Plain text content
  - html: Raw HTML content
  - custom: Custom template content
#}
{% macro render_content_section(section_config) %}
{% if section_config.type == 'fields' %}
    {{ render_field_section(section_config) }}
{% elif section_config.type == 'field' %}
    {{ render_single_field(section_config) }}
{% elif section_config.type == 'text' %}
    <span class="{{ section_config.get('classes', 'text-gray-900') }}">{{ section_config.content }}</span>
{% elif section_config.type == 'html' %}
    {{ section_config.content | safe }}
{% elif section_config.type == 'custom' %}
    {% include section_config.template with context %}
{% endif %}
{% endmacro %}

{#
  Field Section Renderer - Renders multiple fields in a section
  
  Parameters:
  - section_config (required): Config with fields array and layout options
#}
{% macro render_field_section(section_config) %}
{% set layout = section_config.get('layout', 'horizontal') %}
{% set fields = section_config.get('fields', []) %}

{% if layout == 'horizontal' %}
<div class="flex items-center space-x-4">
{% elif layout == 'vertical' %}
<div class="space-y-2">
{% else %}
<div>
{% endif %}

{% for field_config in fields %}
    {{ render_field(section_config.entity, field_config) }}
{% endfor %}

</div>
{% endmacro %}

{#
  Single Field Renderer - Renders individual field with appropriate formatting
  
  Parameters:
  - field_config (required): Field configuration object
  - entity (required): Entity object containing the field data
#}
{% macro render_single_field(section_config) %}
{{ render_field(section_config.entity, section_config.field) }}
{% endmacro %}

{#
  Field Renderer - Core field rendering logic with type-specific formatting
  
  Parameters:
  - entity (required): Entity object
  - field_config (required): Field configuration
#}
{% macro render_field(entity, field_config) %}
{% set field_name = field_config.name %}
{% set field_type = field_config.get('type', 'text') %}
{% set field_label = field_config.get('label', field_name.replace('_', ' ').title()) %}
{% set field_value = getattr(entity, field_name, '') %}
{% set show_label = field_config.get('show_label', false) %}
{% set classes = field_config.get('classes', '') %}

<div class="field-{{ field_type }} {{ classes }}">
    {% if show_label %}
    <label class="field-label text-sm font-medium text-gray-600">{{ field_label }}:</label>
    {% endif %}
    
    {% if field_type == 'text' %}
        <span class="field-value">{{ field_value or '-' }}</span>
    {% elif field_type == 'badge' %}
        {% if field_value %}
        {%- set normalized_value = field_value|lower|replace(' ', '-') -%}
        {%- set badge_type = field_config.get('badge_type', 'status') -%}
        {%- set display_text = field_value|replace('-', ' ')|replace('_', ' ')|title -%}
        <span class="badge badge-{{ badge_type }}-{{ normalized_value }}">
            {{ display_text }}
        </span>
        {% endif %}
    {% elif field_type == 'date' %}
        {% if field_value %}
        {%- set date_context = "due" if field_name in ["due_date", "expected_close_date", "close_date"] else "created" if field_name == "created_at" else "updated" if field_name == "updated_at" else "neutral" -%}
        <time class="field-value" datetime="{{ field_value.isoformat() if field_value.isoformat else field_value }}">
            {{ smart_date_display(field_value, context=date_context) }}
        </time>
        {% else %}
        <span class="field-value text-gray-500">-</span>
        {% endif %}
    {% elif field_type == 'currency' %}
        {% if field_value %}
        <span class="field-value font-medium text-green-600">
            ${{ "{:,.2f}".format(field_value) }}
        </span>
        {% else %}
        <span class="field-value text-gray-500">-</span>
        {% endif %}
    {% elif field_type == 'progress' %}
        {% if field_value is not none %}
        {{ progress_bar(field_value, field_config.get('max_value', 100)) }}
        {% endif %}
    {% elif field_type == 'link' %}
        {% set link_url = field_config.get('url', '#') %}
        {% set link_text = field_config.get('text', field_value) %}
        {% if field_value %}
        <a href="{{ link_url }}" class="field-value text-blue-600 hover:text-blue-800 underline">
            {{ link_text }}
        </a>
        {% endif %}
    {% elif field_type == 'icon' %}
        {% set icon_name = field_config.get('icon', 'document') %}
        {% set icon_size = field_config.get('size', 'md') %}
        {{ icon(icon_name, icon_size, 'field-icon') }}
        {% if field_value %}
        <span class="field-value ml-2">{{ field_value }}</span>
        {% endif %}
    {% elif field_type == 'boolean' %}
        {% if field_value %}
        {{ icon('check-circle', 'sm', 'text-green-500') }}
        {% else %}
        {{ icon('x-circle', 'sm', 'text-gray-400') }}
        {% endif %}
    {% else %}
        <!-- Fallback for unknown field types -->
        <span class="field-value">{{ field_value or '-' }}</span>
    {% endif %}
</div>
{% endmacro %}

{#
  Action Section Renderer - Renders action buttons and controls
  
  Parameters:
  - action_config (required): Action configuration object
#}
{% macro render_action_section(action_config) %}
{% set actions = action_config.get('actions', []) %}
{% set layout = action_config.get('layout', 'horizontal') %}

{% if layout == 'horizontal' %}
<div class="flex items-center space-x-2">
{% else %}
<div class="space-y-2">
{% endif %}

{% for action in actions %}
    {{ render_action_button(action) }}
{% endfor %}

</div>
{% endmacro %}

{#
  Action Button Renderer - Individual action button rendering
  
  Parameters:
  - action (required): Action configuration object
#}
{% macro render_action_button(action) %}
{% set button_type = action.get('type', 'button') %}
{% set button_text = action.get('text', 'Action') %}
{% set button_icon = action.get('icon') %}
{% set button_classes = action.get('classes', 'btn btn-sm') %}
{% set button_url = action.get('url', '#') %}
{% set button_onclick = action.get('onclick', '') %}

{% if button_type == 'link' %}
<a href="{{ button_url }}" class="{{ button_classes }}">
    {% if button_icon %}{{ icon(button_icon, 'sm') }}{% endif %}
    {{ button_text }}
</a>
{% elif button_type == 'button' %}
<button type="button" 
        class="{{ button_classes }}"
        {% if button_onclick %}onclick="{{ button_onclick }}"{% endif %}>
    {% if button_icon %}{{ icon(button_icon, 'sm') }}{% endif %}
    {{ button_text }}
</button>
{% endif %}
{% endmacro %}